<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Avanzado de Inspección de Buses</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Colores principales */
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1e40af;
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-200: #bfdbfe;
      --primary-300: #93c5fd;
      --primary-400: #60a5fa;
      
      /* Estados */
      --success: #059669;
      --success-light: #10b981;
      --success-50: #ecfdf5;
      --warning: #d97706;
      --warning-light: #f59e0b;
      --warning-50: #fffbeb;
      --danger: #dc2626;
      --danger-light: #ef4444;
      --danger-50: #fef2f2;
      --info: #0284c7;
      --info-light: #0ea5e9;
      --info-50: #f0f9ff;
      
      /* Escalas de grises */
      --dark: #0f172a;
      --dark-light: #1e293b;
      --text: #334155;
      --text-light: #64748b;
      --text-lighter: #94a3b8;
      --bg: #f8fafc;
      --bg-darker: #f1f5f9;
      --bg-panel: #ffffff;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      
      /* Componentes */
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
      --shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 8px 10px rgba(0,0,0,0.05), 0 3px 6px rgba(0,0,0,0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.01);
      
      --radius-sm: 0.375rem;
      --radius: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      
      --transition-fast: all 0.15s ease;
      --transition: all 0.25s ease;
      --transition-slow: all 0.4s ease;
      
      /* Espaciados */
      --spacing-1: 0.25rem;
      --spacing-2: 0.5rem;
      --spacing-3: 0.75rem;
      --spacing-4: 1rem;
      --spacing-5: 1.25rem;
      --spacing-6: 1.5rem;
      --spacing-8: 2rem;
      --spacing-10: 2.5rem;
      --spacing-12: 3rem;
      
      /* Tipografía */
      --font-family: 'Outfit', system-ui, sans-serif;
    }

    /* Tema oscuro */
    .dark-mode {
      --primary: #3b82f6;
      --primary-light: #60a5fa;
      --primary-dark: #1d4ed8;
      --primary-50: #172554;
      --primary-100: #1e3a8a;
      --primary-200: #1e40af;
      --primary-300: #2563eb;
      --primary-400: #3b82f6;
      
      --success: #10b981;
      --success-light: #34d399;
      --success-50: #064e3b;
      
      --warning: #f59e0b;
      --warning-light: #fbbf24;
      --warning-50: #78350f;
      
      --danger: #ef4444;
      --danger-light: #f87171;
      --danger-50: #7f1d1d;
      
      --info: #0ea5e9;
      --info-light: #38bdf8;
      --info-50: #0c4a6e;
      
      --dark: #f8fafc;
      --dark-light: #f1f5f9;
      --text: #cbd5e1;
      --text-light: #94a3b8;
      --text-lighter: #64748b;
      --bg: #0f172a;
      --bg-darker: #1e293b;
      --bg-panel: #1e293b;
      --border: #334155;
      --border-light: #1e293b;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      font-family: var(--font-family);
      font-size: 0.9375rem;
      line-height: 1.5;
      color: var(--text);
      background-color: var(--bg);
      min-height: 100vh;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: var(--transition);
    }

    /* Tipografía */
    h1, h2, h3, h4, h5, h6 {
      color: var(--dark);
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 0.5rem;
      letter-spacing: -0.025em;
    }
    
    h1 { font-size: 2rem; }
    h2 { font-size: 1.75rem; }
    h3 { font-size: 1.5rem; }
    h4 { font-size: 1.25rem; }
    h5 { font-size: 1.125rem; }
    h6 { font-size: 1rem; }
    
    p { margin-bottom: 1rem; }
    
    strong, b { font-weight: 600; }

    /* Contenedores y layout */
    .app-container {
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
    }

    .main-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      height: calc(100vh - 64px);
      position: relative;
    }

    .content-area {
      padding: var(--spacing-6);
      overflow-y: auto;
      display: grid;
      gap: var(--spacing-6);
    }

    /* Tarjetas y paneles */
    .card {
      background-color: var(--bg-panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: var(--spacing-6);
      transition: var(--transition);
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: var(--spacing-5);
      margin-bottom: var(--spacing-6);
      border-bottom: 1px solid var(--border-light);
    }

    .card-title {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--dark);
      margin: 0;
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: var(--spacing-6);
    }

    .stat-card {
      background-color: var(--bg-panel);
      border-radius: var(--radius-lg);
      padding: var(--spacing-6);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-3);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
      background: var(--primary);
      opacity: 0.8;
    }

    .stat-card.success::before {
      background: var(--success);
    }

    .stat-card.warning::before {
      background: var(--warning);
    }

    .stat-card.danger::before {
      background: var(--danger);
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .stat-value {
      font-size: 2.25rem;
      font-weight: 800;
      color: var(--dark);
      line-height: 1;
      margin: var(--spacing-2) 0;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-light);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-change {
      margin-left: auto;
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.125rem 0.5rem;
      border-radius: var(--radius-sm);
    }

    .stat-change-positive {
      background-color: var(--success-50);
      color: var(--success);
    }

    .stat-change-negative {
      background-color: var(--danger-50);
      color: var(--danger);
    }

    .stat-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.25rem;
      border-radius: var(--radius);
      background-color: var(--primary-50);
      color: var(--primary);
    }

    .stat-icon.success {
      background-color: var(--success-50);
      color: var(--success);
    }

    .stat-icon.warning {
      background-color: var(--warning-50);
      color: var(--warning);
    }

    .stat-icon.danger {
      background-color: var(--danger-50);
      color: var(--danger);
    }

    .stat-footer {
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
      margin-top: auto;
      padding-top: var(--spacing-3);
      border-top: 1px solid var(--border-light);
      font-size: 0.875rem;
      color: var(--text-light);
    }

    /* Navegación y cabecera */
    .app-header {
      background: linear-gradient(to right, var(--primary-dark), var(--primary));
      color: white;
      height: 64px;
      display: flex;
      align-items: center;
      padding: 0 var(--spacing-6);
      box-shadow: var(--shadow);
      position: relative;
      z-index: 20;
    }

    .header-brand {
      font-weight: 800;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      margin-right: auto;
      gap: var(--spacing-3);
    }

    .header-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
    }

    .header-actions {
      display: flex;
      gap: var(--spacing-4);
      align-items: center;
    }

    .sidebar {
      background-color: var(--bg-panel);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: var(--spacing-5);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-8);
      box-shadow: var(--shadow-sm);
      z-index: 10;
    }

    .sidebar-section {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-1);
    }

    .sidebar-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-light);
      padding: var(--spacing-2) var(--spacing-3);
      margin-bottom: var(--spacing-1);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      padding: var(--spacing-3) var(--spacing-4);
      border-radius: var(--radius);
      color: var(--text);
      font-weight: 500;
      transition: var(--transition);
      text-decoration: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .nav-item:hover {
      background-color: var(--bg-darker);
      color: var(--primary);
    }

    .nav-item.active {
      background-color: var(--primary-50);
      color: var(--primary);
      font-weight: 600;
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background-color: var(--primary);
      border-radius: 0 var(--radius) var(--radius) 0;
    }

    .nav-item i {
      font-size: 1.25rem;
      width: 1.5rem;
      text-align: center;
    }

    .nav-item .badge {
      margin-left: auto;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1.25rem;
      padding: var(--spacing-2);
      border-radius: var(--radius);
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
    }

    .mobile-nav-toggle {
      display: none;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
    }

    /* Elementos de formulario */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--spacing-5);
      margin-bottom: var(--spacing-6);
    }

    .col-12 { grid-column: span 12; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }
    .col-2 { grid-column: span 2; }

    .form-group {
      margin-bottom: var(--spacing-4);
    }

    .form-label {
      display: block;
      margin-bottom: var(--spacing-2);
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text);
    }

    .form-control {
      display: block;
      width: 100%;
      padding: var(--spacing-3) var(--spacing-4);
      font-size: 0.875rem;
      line-height: 1.5;
      color: var(--dark);
      background-color: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: var(--transition);
    }

    .d-flex > .form-control {
      flex: 1 1 auto;
      min-width: 0;
      width: auto;
    }

    .d-flex > .btn,
    .d-flex > button {
      flex: 0 0 auto;
    }

    .search-form {
      width: 100%;
      margin: 0;
    }

    .search-action-btn {
      position: relative;
      z-index: 10;
      pointer-events: auto;
    }

    .form-control:focus {
      border-color: var(--primary-light);
      outline: 0;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }

    .form-control:disabled {
      background-color: var(--border-light);
      opacity: 1;
    }

    .form-control.invalid {
      border-color: var(--danger);
      background-color: var(--danger-50);
    }

    .form-error {
      color: var(--danger);
      font-size: 0.75rem;
      margin-top: var(--spacing-1);
      display: none;
      font-weight: 500;
    }

    .form-control.invalid + .form-error {
      display: block;
    }

    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px;
      padding-right: 2.5rem;
    }

    .dark-mode select.form-control {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    }

    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }

    /* Botones */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-3) var(--spacing-6);
      font-size: 0.875rem;
      font-weight: 600;
      line-height: 1.5;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      user-select: none;
      border: 1px solid transparent;
      border-radius: var(--radius);
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }
    
    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(100, 100);
        opacity: 0;
      }
    }
    
    .btn:active::after {
      animation: ripple 0.6s ease-out;
    }

    .btn-sm {
      padding: var(--spacing-2) var(--spacing-4);
      font-size: 0.8125rem;
    }

    .btn-lg {
      padding: var(--spacing-4) var(--spacing-8);
      font-size: 1rem;
    }

    .btn i {
      margin-right: var(--spacing-2);
    }

    .btn-primary {
      color: #fff;
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-outline-primary {
      color: var(--primary);
      background-color: transparent;
      border-color: var(--primary);
    }

    .btn-outline-primary:hover {
      color: #fff;
      background-color: var(--primary);
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    .btn-success {
      color: #fff;
      background-color: var(--success);
      border-color: var(--success);
    }

    .btn-success:hover {
      background-color: var(--success);
      border-color: var(--success);
      filter: brightness(90%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-warning {
      color: #fff;
      background-color: var(--warning);
      border-color: var(--warning);
    }

    .btn-warning:hover {
      filter: brightness(90%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-danger {
      color: #fff;
      background-color: var(--danger);
      border-color: var(--danger);
    }

    .btn-danger:hover {
      filter: brightness(90%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-light {
      color: var(--dark);
      background-color: var(--bg-panel);
      border-color: var(--border);
    }

    .btn-light:hover {
      background-color: var(--border-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-icon {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0;
      border-radius: var(--radius);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon i {
      margin-right: 0;
    }

    .btn-icon.btn-sm {
      width: 2rem;
      height: 2rem;
    }

    /* Badges y chips */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.35em 0.65em;
      font-size: 0.75em;
      font-weight: 600;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 50rem;
    }

    .badge-primary {
      color: #fff;
      background-color: var(--primary);
    }

    .badge-success {
      color: #fff;
      background-color: var(--success);
    }

    .badge-warning {
      color: #fff;
      background-color: var(--warning);
    }

    .badge-danger {
      color: #fff;
      background-color: var(--danger);
    }

    .badge-light {
      color: var(--dark);
      background-color: var(--border-light);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: var(--spacing-2) var(--spacing-3);
      font-size: 0.8125rem;
      line-height: 1.5;
      white-space: nowrap;
      vertical-align: middle;
      border-radius: 50rem;
      background-color: var(--border-light);
      color: var(--text);
      font-weight: 600;
      gap: var(--spacing-2);
    }

    .chip i {
      font-size: 0.875rem;
    }

    .chip-primary {
      background-color: var(--primary-50);
      color: var(--primary);
    }

    .chip-success {
      background-color: var(--success-50);
      color: var(--success);
    }

    .chip-warning {
      background-color: var(--warning-50);
      color: var(--warning);
    }

    .chip-danger {
      background-color: var(--danger-50);
      color: var(--danger);
    }

    /* Tablas */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      width: 100%;
    }

    .table {
      width: 100%;
      margin-bottom: 0;
      color: var(--text);
      border-collapse: collapse;
      white-space: nowrap;
    }

    .table thead th {
      position: sticky;
      top: 0;
      padding: var(--spacing-4);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background-color: var(--bg-darker);
      color: var(--text-light);
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .table tbody td {
      padding: var(--spacing-4);
      vertical-align: middle;
      border-bottom: 1px solid var(--border-light);
      transition: var(--transition-fast);
    }

    .table tbody tr:last-child td {
      border-bottom: none;
    }

    .table tbody tr {
      transition: var(--transition-fast);
    }

    .table tbody tr:hover {
      background-color: var(--bg-darker);
    }

    .table-sm thead th,
    .table-sm tbody td {
      padding: var(--spacing-3);
    }

    .table-status {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-2);
      font-weight: 600;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot-success { background-color: var(--success); }
    .status-dot-warning { background-color: var(--warning); }
    .status-dot-danger { background-color: var(--danger); }
    .status-dot-primary { background-color: var(--primary); }

    /* Modals */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1040;
      width: 100vw;
      height: 100vh;
      background-color: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(4px);
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      pointer-events: none;
    }

    .modal-backdrop.show {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1050;
      display: flex;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      outline: 0;
      opacity: 0;
      transform: scale(0.95);
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .modal.show {
      opacity: 1;
      transform: scale(1);
      pointer-events: all;
    }

    .modal-dialog {
      position: relative;
      width: auto;
      margin: auto;
      max-width: 500px;
      transition: var(--transition);
      pointer-events: none;
    }
    
    .modal.show .modal-dialog {
      pointer-events: auto;
    }

    .modal-content {
      position: relative;
      display: flex;
      flex-direction: column;
      width: 100%;
      background-color: var(--bg-panel);
      background-clip: padding-box;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      pointer-events: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-5) var(--spacing-6);
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--dark);
    }

    .modal-close {
      background: transparent;
      border: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-close:hover {
      color: var(--primary);
    }

    .modal-body {
      position: relative;
      flex: 1 1 auto;
      padding: var(--spacing-6);
      max-height: 70vh;
      overflow-y: auto;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      padding: var(--spacing-5) var(--spacing-6);
      border-top: 1px solid var(--border);
      gap: var(--spacing-3);
    }

    /* Navegación móvil */
    .mobile-nav-toggle {
      display: none;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      z-index: 30;
    }

    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--bg-panel);
      border-top: 1px solid var(--border);
      padding: var(--spacing-2);
      z-index: 30;
      box-shadow: var(--shadow-lg);
    }

    .mobile-bottom-nav .nav-items {
      display: flex;
      justify-content: space-between;
    }

    .mobile-bottom-nav .nav-item {
      flex-direction: column;
      padding: var(--spacing-3) var(--spacing-2);
      gap: var(--spacing-1);
      font-size: 0.75rem;
      text-align: center;
    }

    .mobile-bottom-nav .nav-item i {
      font-size: 1.25rem;
      margin-right: 0;
      width: auto;
    }

    .fab-button {
      display: none;
      position: fixed;
      right: var(--spacing-6);
      bottom: 5rem;
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
      z-index: 40;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .fab-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(30, 64, 175, 0.5);
    }

    .toggle-icon {
      position: relative;
      width: 18px;
      height: 14px;
    }
    
    .toggle-icon span {
      position: absolute;
      height: 2px;
      width: 100%;
      background: white;
      border-radius: 2px;
      display: block;
      transition: all 0.3s ease-in-out;
    }
    
    .toggle-icon span:nth-child(1) { top: 0; }
    .toggle-icon span:nth-child(2) { top: 6px; }
    .toggle-icon span:nth-child(3) { top: 12px; }

    .toggle-active span:nth-child(1) {
      transform: rotate(45deg);
      top: 6px;
    }
    
    .toggle-active span:nth-child(2) {
      opacity: 0;
    }
    
    .toggle-active span:nth-child(3) {
      transform: rotate(-45deg);
      top: 6px;
    }

    /* Selector de semana */
    .week-selector {
      display: flex;
      align-items: center;
      gap: var(--spacing-4);
      margin-bottom: var(--spacing-6);
      padding: var(--spacing-4);
      background-color: var(--bg-panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .week-label {
      font-weight: 600;
      color: var(--dark);
    }

    .date-nav {
      display: flex;
      gap: var(--spacing-2);
    }

    .date-nav-btn {
      background-color: var(--bg-darker);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
    }

    .date-nav-btn:hover {
      background-color: var(--primary-50);
      color: var(--primary);
    }

    /* Buscador global */
    .global-search {
      position: relative;
      margin-right: var(--spacing-4);
    }

    .search-input {
      padding: var(--spacing-2) var(--spacing-4);
      padding-left: 2.5rem;
      background-color: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: var(--radius);
      color: white;
      width: 250px;
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .search-input:focus {
      outline: none;
      background-color: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    }

    .search-icon {
      position: absolute;
      left: var(--spacing-3);
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.7);
    }

    /* Notificación */
    .notification-container {
      position: fixed;
      top: var(--spacing-4);
      right: var(--spacing-4);
      z-index: 1060;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-3);
      max-width: 400px;
      width: 100%;
    }

    .notification {
      background-color: var(--bg-panel);
      border-radius: var(--radius);
      border-left: 4px solid var(--primary);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      padding: var(--spacing-4);
      animation: slide-in 0.3s ease-out forwards, fade-out 0.3s ease-in forwards 3.7s;
      opacity: 0;
      transform: translateX(100%);
      position: relative;
    }

    @keyframes slide-in {
      0% { 
        transform: translateX(100%);
        opacity: 0;
      }
      100% { 
        transform: translateX(0%);
        opacity: 1;
      }
    }

    @keyframes fade-out {
      0% { 
        opacity: 1;
        transform: scale(1);
      }
      100% { 
        opacity: 0;
        transform: scale(0.9);
      }
    }

    .notification-success { border-left-color: var(--success); }
    .notification-warning { border-left-color: var(--warning); }
    .notification-danger { border-left-color: var(--danger); }

    .notification-icon {
      font-size: 1.25rem;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notification-success .notification-icon {
      color: var(--success);
    }

    .notification-warning .notification-icon {
      color: var(--warning);
    }

    .notification-danger .notification-icon {
      color: var(--danger);
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--dark);
      line-height: 1.2;
    }

    .notification-message {
      font-size: 0.875rem;
      color: var(--text);
      margin: 0;
    }

    .notification-close {
      position: absolute;
      top: var(--spacing-2);
      right: var(--spacing-2);
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 0.875rem;
      cursor: pointer;
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: var(--transition);
    }

    .notification-close:hover {
      opacity: 1;
      color: var(--text);
    }

    /* Loader */
    .loader-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(15, 23, 42, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1070;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .loader-container.show {
      opacity: 1;
      visibility: visible;
    }

    .loader {
      position: relative;
      width: 50px;
      height: 50px;
    }

    .loader::before,
    .loader::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }

    .loader::before {
      border: 3px solid rgba(255, 255, 255, 0.2);
    }

    .loader::after {
      border: 3px solid transparent;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    .loader-text {
      position: absolute;
      bottom: -30px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .btn .spinner,
    .form-control + .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
      display: inline-block;
      margin-left: 8px;
      vertical-align: middle;
    }

    .form-control + .spinner {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      border-color: rgba(203, 213, 225, 0.5);
      border-top-color: var(--text-light);
    }

    /* Filtros avanzados */
    .filters-container {
      margin-bottom: var(--spacing-6);
      background-color: var(--bg-panel);
      border-radius: var(--radius-lg);
      padding: var(--spacing-5);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--spacing-5);
    }

    .filter-title {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
      margin-bottom: var(--spacing-2);
    }

    .filter-title h5 {
      margin: 0;
      font-size: 1rem;
    }

    .filter-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-3);
    }

    .toggle-filters {
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
      padding: var(--spacing-2) var(--spacing-4);
      background-color: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
      transition: var(--transition);
    }

    .toggle-filters:hover {
      background-color: var(--bg-darker);
    }

    .toggle-filters i {
      transition: transform 0.3s ease;
    }

    .toggle-filters.active i {
      transform: rotate(180deg);
    }

    /* Componentes específicos de la aplicación */
    .bus-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-5);
      padding: var(--spacing-5);
      background-color: var(--bg-darker);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-6);
    }

    .bus-info-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-2);
    }

    .bus-info-label {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-light);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .bus-info-value {
      font-weight: 600;
      color: var(--dark);
      font-size: 1.125rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      margin-bottom: var(--spacing-4);
      color: var(--primary-dark);
    }

    .section-header i {
      font-size: 1.5rem;
      background-color: var(--primary-50);
      color: var(--primary);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
    }

    .section-header h4 {
      margin: 0;
    }

    .inspection-status {
      display: inline-flex;
      align-items: center;
      padding: var(--spacing-2) var(--spacing-4);
      border-radius: var(--radius);
      font-weight: 600;
      margin-left: auto;
    }

    .status-pending {
      background-color: var(--warning-50);
      color: var(--warning);
    }

    .status-completed {
      background-color: var(--success-50);
      color: var(--success);
    }

    .status-critical {
      background-color: var(--danger-50);
      color: var(--danger);
    }

    .toggle-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-3);
      padding: var(--spacing-4);
      background-color: var(--bg-panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      margin-bottom: var(--spacing-4);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .toggle-section:hover {
      background-color: var(--bg-darker);
      border-color: var(--primary-200);
    }
    
    .toggle-section i {
      transition: transform 0.3s ease;
    }
    
    .toggle-section.active i {
      transform: rotate(180deg);
    }
    
    .toggle-section-title {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      font-weight: 600;
      color: var(--dark);
    }
    
    .toggle-section-title .section-icon {
      width: 32px;
      height: 32px;
      background-color: var(--primary-50);
      color: var(--primary);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .toggle-section-content {
      padding: 0 var(--spacing-4) var(--spacing-4);
      display: none;
    }
    
    .toggle-section-content.show {
      display: block;
    }

    /* Calendario */
    .calendar-widget {
      display: flex;
      flex-direction: column;
      background-color: var(--bg-panel);
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--border);
    }
    
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-4);
      background-color: var(--primary);
      color: white;
    }
    
    .calendar-title {
      font-weight: 600;
      font-size: 1.125rem;
    }
    
    .calendar-nav {
      display: flex;
      gap: var(--spacing-2);
    }
    
    .calendar-nav-btn {
      width: 30px;
      height: 30px;
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: var(--radius);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .calendar-nav-btn:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      padding: var(--spacing-4);
    }
    
    .calendar-day-name {
      text-align: center;
      font-weight: 500;
      font-size: 0.75rem;
      color: var(--text-light);
      padding: var(--spacing-2) 0;
    }
    
    .calendar-day {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: var(--radius);
      margin: 2px;
      position: relative;
      transition: var(--transition);
    }
    
    .calendar-day:hover {
      background-color: var(--bg-darker);
    }
    
    .calendar-day.current {
      font-weight: 600;
      background-color: var(--primary-50);
      color: var(--primary);
    }
    
    .calendar-day.inactive {
      color: var(--text-lighter);
      opacity: 0.5;
    }
    
    .calendar-day.has-event::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background-color: var(--primary);
    }
    
    .calendar-day.selected {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
    }

    /* Recent Activity */
    .activity-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-3);
    }
    
    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-3);
      padding: var(--spacing-3);
      background-color: var(--bg-panel);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      transition: var(--transition);
    }
    
    .activity-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow);
    }
    
    .activity-icon {
      width: 36px;
      height: 36px;
      background-color: var(--primary-50);
      color: var(--primary);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    .activity-icon.success {
      background-color: var(--success-50);
      color: var(--success);
    }
    
    .activity-icon.warning {
      background-color: var(--warning-50);
      color: var(--warning);
    }
    
    .activity-icon.danger {
      background-color: var(--danger-50);
      color: var(--danger);
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-title {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 2px;
    }
    
    .activity-details {
      font-size: 0.8125rem;
      color: var(--text-light);
    }
    
    .activity-time {
      font-size: 0.75rem;
      color: var(--text-lighter);
    }

    /* Utilidades */
    .d-flex { display: flex !important; }
    .align-center { align-items: center !important; }
    .align-start { align-items: flex-start !important; }
    .align-end { align-items: flex-end !important; }
    .justify-between { justify-content: space-between !important; }
    .justify-center { justify-content: center !important; }
    .justify-start { justify-content: flex-start !important; }
    .justify-end { justify-content: flex-end !important; }
    .flex-column { flex-direction: column !important; }
    .flex-wrap { flex-wrap: wrap !important; }
    .gap-1 { gap: var(--spacing-1) !important; }
    .gap-2 { gap: var(--spacing-2) !important; }
    .gap-3 { gap: var(--spacing-3) !important; }
    .gap-4 { gap: var(--spacing-4) !important; }
    .gap-5 { gap: var(--spacing-5) !important; }
    .gap-6 { gap: var(--spacing-6) !important; }
    .mb-0 { margin-bottom: 0 !important; }
    .mb-1 { margin-bottom: var(--spacing-1) !important; }
    .mb-2 { margin-bottom: var(--spacing-2) !important; }
    .mb-3 { margin-bottom: var(--spacing-3) !important; }
    .mb-4 { margin-bottom: var(--spacing-4) !important; }
    .mb-5 { margin-bottom: var(--spacing-5) !important; }
    .mb-6 { margin-bottom: var(--spacing-6) !important; }
    .mt-1 { margin-top: var(--spacing-1) !important; }
    .mt-2 { margin-top: var(--spacing-2) !important; }
    .mt-3 { margin-top: var(--spacing-3) !important; }
    .mt-4 { margin-top: var(--spacing-4) !important; }
    .mt-5 { margin-top: var(--spacing-5) !important; }
    .mt-6 { margin-top: var(--spacing-6) !important; }
    .ml-auto { margin-left: auto !important; }
    .mr-auto { margin-right: auto !important; }
    .mx-auto { margin-left: auto !important; margin-right: auto !important; }
    .text-success { color: var(--success) !important; }
    .text-warning { color: var(--warning) !important; }
    .text-danger { color: var(--danger) !important; }
    .text-primary { color: var(--primary) !important; }
    .text-info { color: var(--info) !important; }
    .fw-bold { font-weight: 700 !important; }
    .fw-medium { font-weight: 600 !important; }
    .fw-normal { font-weight: 400 !important; }
    .hidden { display: none !important; }
    .text-center { text-align: center !important; }
    .text-left { text-align: left !important; }
    .text-right { text-align: right !important; }
    .text-truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .section-divider {
      height: 1px;
      background-color: var(--border);
      margin: var(--spacing-6) 0;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background-color: var(--bg-darker);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--primary);
    }
    
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--dark);
      color: white;
      padding: var(--spacing-2) var(--spacing-3);
      border-radius: var(--radius);
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
      margin-top: var(--spacing-2);
      box-shadow: var(--shadow-md);
    }
    
    .tooltip:hover::before {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 4px solid var(--dark);
      z-index: 10;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        position: fixed;
        top: 64px;
        left: -280px;
        height: calc(100vh - 64px);
        width: 280px;
        z-index: 40;
        transition: var(--transition);
        box-shadow: var(--shadow-lg);
      }
      
      .sidebar.show {
        left: 0;
      }
      
      .mobile-nav-toggle {
        display: block;
      }
      
      .mobile-bottom-nav {
        display: block;
      }
      
      .fab-button {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .content-area {
        padding: var(--spacing-4);
        padding-bottom: 5rem;
      }
      
      .global-search {
        display: none;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-3);
      }
      
      .col-md-6 { grid-column: span 6; }
      .col-md-12 { grid-column: span 12; }
      
      .form-grid {
        grid-template-columns: repeat(6, 1fr);
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .filters-container {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .week-selector {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-3);
      }
      
      .activity-item {
        flex-direction: column;
      }
      
      .activity-icon {
        margin-bottom: var(--spacing-1);
      }
    }

    @media (max-width: 768px) {
      .app-header {
        padding: 0 var(--spacing-3);
      }
      
      .header-brand {
        font-size: 1rem;
      }
      
      .header-actions {
        gap: var(--spacing-2);
      }
      
      .content-area {
        padding: var(--spacing-3);
      }
      
      .col-sm-12 { grid-column: span 12; }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: var(--spacing-4);
      }
      
      .card-header {
        padding-bottom: var(--spacing-3);
        margin-bottom: var(--spacing-4);
      }
      
      .filters-container {
        grid-template-columns: 1fr;
      }
      
      .modal-dialog {
        margin: var(--spacing-3);
        max-width: calc(100% - 2 * var(--spacing-3));
      }
      
      .calendar-day {
        height: 32px;
      }
      
      .calendar-day-name {
        font-size: 0.675rem;
      }
    }

    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes scaleIn {
      from { 
        opacity: 0;
        transform: scale(0.95);
      }
      to { 
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .scaleIn {
      animation: scaleIn 0.3s ease-out;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-darker);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-lighter);
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div class="loader-container" id="loaderContainer">
    <div class="loader"></div>
    <div class="loader-text" id="loaderText">Cargando...</div>
  </div>

  <!-- Notificaciones -->
  <div class="notification-container" id="notificationContainer"></div>

  <div class="app-container">
    <!-- Cabecera -->
    <header class="app-header">
      <button class="mobile-nav-toggle" id="sidebarToggle">
        <div class="toggle-icon">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>

      <div class="header-brand">
        <div class="header-logo">
          <i class="fas fa-bus-alt"></i>
        </div>
        <span>Inspección de Buses</span>
      </div>

      <div class="global-search">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="globalSearch" placeholder="Buscar por PPU o #interno...">
      </div>

      <div class="header-actions">
        <div class="chip chip-primary">
          <i class="fas fa-calendar-week"></i>
          <span id="currentWeekLabel"></span>
        </div>
        <button class="btn btn-outline-primary btn-sm" id="btnShowPending">
          <i class="fas fa-clipboard-list"></i>
          Pendientes <span class="badge badge-primary" id="pendingCount">0</span>
        </button>
        <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
          <i class="fas fa-moon"></i>
        </button>
        <div class="chip" id="userInfoChip">
          <i class="fas fa-user-hard-hat"></i>
          <span id="userInfo">—</span>
        </div>
      </div>
    </header>

    <!-- Layout Principal -->
    <div class="main-layout">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-title">Operación</div>
          <div class="nav-item active" data-section="inspection-form">
            <i class="fas fa-clipboard-check"></i>
            <span>Formulario de Inspección</span>
          </div>
          <div class="nav-item" data-section="dashboard">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-title">Informes</div>
          <div class="nav-item" data-section="cameras-report">
            <i class="fas fa-video"></i>
            <span>Cámaras</span>
            <span class="badge badge-light" id="cameraCount">0</span>
          </div>
          <div class="nav-item" data-section="tag-report">
            <i class="fas fa-tag"></i>
            <span>TAG</span>
            <span class="badge badge-light" id="tagCount">0</span>
          </div>
          <div class="nav-item" data-section="mobileye-report">
            <i class="fas fa-eye"></i>
            <span>Mobileye</span>
            <span class="badge badge-light" id="mobiCount">0</span>
          </div>
          <div class="nav-item" data-section="odometer-report">
            <i class="fas fa-tachometer-alt"></i>
            <span>Odómetro</span>
            <span class="badge badge-light" id="odoCount">0</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-title">Gestión</div>
          <div class="nav-item" data-section="maintenance-tickets">
            <i class="fas fa-ticket-alt"></i>
            <span>Tickets de Mantenimiento</span>
          </div>
          <div class="nav-item" data-section="fleet-status">
            <i class="fas fa-bus"></i>
            <span>Estado de Flota</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-title">Configuración</div>
          <div class="nav-item" data-section="user-settings">
            <i class="fas fa-cog"></i>
            <span>Preferencias</span>
          </div>
          <div class="nav-item" data-section="help">
            <i class="fas fa-question-circle"></i>
            <span>Ayuda</span>
          </div>
          <div class="nav-item" id="btnLogout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Cerrar Sesión</span>
          </div>
        </div>
      </aside>

      <!-- Área de Contenido -->
      <main class="content-area">
        <!-- DASHBOARD -->
        <section id="section-dashboard" class="hidden">
          <div class="d-flex justify-between align-center mb-5">
            <h2>Dashboard de Inspección Semanal</h2>
            <div class="date-nav">
              <button class="date-nav-btn" id="prevWeekDash">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="date-nav-btn" id="nextWeekDash">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
          
          <div class="week-selector">
            <div class="d-flex align-center gap-3">
              <h4 class="mb-0">Semana:</h4>
              <select id="dashboardWeekSelector" class="form-control">
                <!-- Opciones de semana serán agregadas por JS -->
              </select>
            </div>
            
            <div class="d-flex align-center gap-3">
              <label class="form-label mb-0">Terminal:</label>
              <select id="dashboardTerminalFilter" class="form-control">
                <option value="">Todos los Terminales</option>
                <option>El Roble</option>
                <option>La Reina</option>
                <option>Maria Angelica</option>
                <option>El Descanso</option>
              </select>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-icon">
                  <i class="fas fa-bus"></i>
                </div>
                <div class="stat-change stat-change-positive">
                  <i class="fas fa-arrow-up"></i> 3%
                </div>
              </div>
              <div class="stat-label">Flota Total</div>
              <div class="stat-value" id="totalFleetCount">0</div>
              <div class="stat-footer">
                <div class="chip">
                  <span class="status-dot status-dot-success"></span>
                  <span>Operativos: <strong id="operationalCount">0</strong></span>
                </div>
              </div>
            </div>
            
            <div class="stat-card success">
              <div class="stat-card-header">
                <div class="stat-icon success">
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="stat-change stat-change-positive">
                  <i class="fas fa-arrow-up"></i> 5%
                </div>
              </div>
              <div class="stat-label">Inspecciones</div>
              <div class="stat-value" id="inspectionCount">0</div>
              <div class="stat-footer">
                <div class="chip">
                  <span>Avance: <strong id="inspectionPercentage">0%</strong></span>
                </div>
              </div>
            </div>
            
            <div class="stat-card warning">
              <div class="stat-card-header">
                <div class="stat-icon warning">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-change stat-change-negative">
                  <i class="fas fa-arrow-down"></i> 2%
                </div>
              </div>
              <div class="stat-label">Problemas Encontrados</div>
              <div class="stat-value" id="issuesCount">0</div>
              <div class="stat-footer">
                <div class="chip">
                  <span class="status-dot status-dot-danger"></span>
                  <span>Críticos: <strong id="criticalIssuesCount">0</strong></span>
                </div>
              </div>
            </div>
            
            <div class="stat-card danger">
              <div class="stat-card-header">
                <div class="stat-icon danger">
                  <i class="fas fa-ticket-alt"></i>
                </div>
                <div class="stat-change stat-change-negative">
                  <i class="fas fa-arrow-up"></i> 8%
                </div>
              </div>
              <div class="stat-label">Tickets de Mantenimiento</div>
              <div class="stat-value" id="ticketsCount">0</div>
              <div class="stat-footer">
                <div class="chip">
                  <span class="status-dot status-dot-warning"></span>
                  <span>Abiertos: <strong id="openTicketsCount">0</strong></span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card mt-5 scaleIn">
            <div class="card-header">
              <h3 class="card-title">Estado de Inspección por Terminal</h3>
            </div>
            <div id="inspectionByTerminalChart" style="height: 300px;"></div>
          </div>
          
          <div class="form-grid mt-5">
            <div class="col-6 col-md-12">
              <div class="card scaleIn">
                <div class="card-header">
                  <h3 class="card-title">Problemas Recientes</h3>
                  <button class="btn btn-outline-primary btn-sm">Ver Todo</button>
                </div>
                <div class="table-container">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>PPU Bus</th>
                        <th>Componente</th>
                        <th>Problema</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                      </tr>
                    </thead>
                    <tbody id="recentIssuesTable">
                      <!-- Será poblado por JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <div class="col-6 col-md-12">
              <div class="card mt-0 mt-md-5 scaleIn">
                <div class="card-header">
                  <h3 class="card-title">Buses Pendientes de Inspección</h3>
                </div>
                <div class="table-container">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>PPU</th>
                        <th># Interno</th>
                        <th>Terminal</th>
                        <th>Estado</th>
                        <th>Acción</th>
                      </tr>
                    </thead>
                    <tbody id="pendingInspectionTable">
                      <!-- Será poblado por JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card mt-5 scaleIn">
            <div class="card-header">
              <h3 class="card-title">Actividad Reciente</h3>
            </div>
            <div class="activity-list" id="activityList">
              <!-- Será poblado por JS -->
            </div>
          </div>
        </section>

        <!-- FORMULARIO DE INSPECCIÓN -->
        <section id="section-inspection-form">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Inspección Semanal de Buses</h3>
              <div class="d-flex align-center gap-3">
                <div class="date-nav">
                  <button class="date-nav-btn" id="prevWeekForm">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <select id="weekSelector" class="form-control">
                    <!-- Opciones de semana serán agregadas por JS -->
                  </select>
                  <button class="date-nav-btn" id="nextWeekForm">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                <span class="chip chip-primary" id="statusBadge">Listo</span>
              </div>
            </div>
            
            <!-- Búsqueda de Bus -->
            <div class="form-grid mb-0">
              <div class="col-6 col-md-12 form-group">
                <label class="form-label">Buscar por PPU</label>
                <form class="search-form d-flex gap-2" id="searchPPUForm" novalidate>
                  <input type="text" class="form-control" id="searchPPU" placeholder="ej., XXYY11" autocomplete="off">
                  <button type="submit" class="btn btn-primary search-action-btn" id="btnSearchPPU">
                    <i class="fas fa-search"></i> Buscar
                  </button>
                </form>
              </div>
              
              <div class="col-6 col-md-12 form-group">
                <label class="form-label">Buscar por # Interno</label>
                <form class="search-form d-flex gap-2" id="searchInternalForm" novalidate>
                  <input type="text" class="form-control" id="searchInternal" placeholder="ej., 1234" autocomplete="off">
                  <button type="submit" class="btn btn-primary search-action-btn" id="btnSearchInternal">
                    <i class="fas fa-search"></i> Buscar
                  </button>
                </form>
              </div>
            </div>
            
            <!-- Información del Bus (inicialmente oculto) -->
            <div id="busInfoSection" class="hidden">
              <div class="section-divider"></div>
              
              <div class="d-flex justify-between align-center mb-4">
                <h4>Información del Bus</h4>
                <div class="chip" id="inspectionStatus">
                  <i class="fas fa-clock"></i>
                  <span>Sin inspección aún</span>
                </div>
              </div>
              
              <div class="bus-info">
                <div class="bus-info-item">
                  <div class="bus-info-label">PPU</div>
                  <div class="bus-info-value" id="ppuDisplay">—</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label"># Interno</div>
                  <div class="bus-info-value" id="internalDisplay">—</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label">Marca</div>
                  <div class="bus-info-value" id="makeDisplay">—</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label">Modelo</div>
                  <div class="bus-info-value" id="modelDisplay">—</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label">Año</div>
                  <div class="bus-info-value" id="yearDisplay">—</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label">Terminal</div>
                  <div class="bus-info-value" id="terminalDisplay">—</div>
                </div>
              </div>
              
              <!-- Secciones Plegables -->
              <div class="toggle-section" id="toggleCameras">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-video"></i>
                  </div>
                  <span>Cámaras</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="camerasSection">
                <div class="form-grid">
                  <div class="col-6 col-md-12 form-group">
                    <label class="form-label">Monitor de Cámaras (¿todas las cámaras visibles?)</label>
                    <select class="form-control" id="monitorCamera">
                      <option value="">— Seleccionar —</option>
                      <option value="SI">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-monitor">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-6 col-md-12 form-group">
                    <label class="form-label">Detalles del Monitor</label>
                    <input type="text" class="form-control" id="monitorDetail" placeholder="ej., Todo OK / Cámara 2 sin señal">
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Cámara Delantera</label>
                    <select class="form-control" id="frontCamera">
                      <option>tiene</option>
                      <option>no tiene</option>
                      <option>dañada</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Cámara de Cabina</label>
                    <select class="form-control" id="cabinCamera">
                      <option>tiene</option>
                      <option>no tiene</option>
                      <option>dañada</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Cámaras Interiores</label>
                    <select class="form-control" id="interiorCamera">
                      <option>tiene</option>
                      <option>no tiene</option>
                      <option>dañada</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Cámara Trasera</label>
                    <select class="form-control" id="rearCamera">
                      <option>tiene</option>
                      <option>no tiene</option>
                      <option>dañada</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¿Todas las cámaras son visibles en el monitor?</label>
                    <select class="form-control" id="allVisible">
                      <option value="">— Seleccionar —</option>
                      <option value="SI">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-all">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¿La cámara trasera se activa con la marcha atrás?</label>
                    <select class="form-control" id="reverseActive">
                      <option value="">— Seleccionar —</option>
                      <option value="SI">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-rev">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¿Las cámaras de las puertas se activan al abrirse?</label>
                    <select class="form-control" id="doorsOpen">
                      <option value="">— Seleccionar —</option>
                      <option value="SI">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-open">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¿Se muestran todas las cámaras con puertas cerradas?</label>
                    <select class="form-control" id="doorsClosed">
                      <option value="">— Seleccionar —</option>
                      <option value="SI">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-closed">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-12 form-group">
                    <label class="form-label">Observaciones de Cámaras</label>
                    <textarea class="form-control" id="cameraObservations" placeholder="Detalle cualquier hallazgo"></textarea>
                  </div>
                </div>
              </div>
              
              <div class="toggle-section" id="toggleTag">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-tag"></i>
                  </div>
                  <span>TAG</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="tagSection">
                <div class="form-grid">
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¿Tiene TAG?</label>
                    <select class="form-control" id="hasTag">
                      <option value="yes">sí</option>
                      <option value="no">no</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Serie del TAG (editable)</label>
                    <input type="text" class="form-control" id="tagSerial" placeholder="Serie del TAG">
                  </div>
                  
                  <div class="col-6 col-sm-12 form-group">
                    <label class="form-label">Observaciones del TAG</label>
                    <input type="text" class="form-control" id="tagObservations" placeholder="Detalles">
                  </div>
                </div>
              </div>
              
              <!-- Sección Mobileye (condicionalmente visible) -->
              <div id="mobileyeSection">
                <div class="toggle-section" id="toggleMobileye">
                  <div class="toggle-section-title">
                    <div class="section-icon">
                      <i class="fas fa-eye"></i>
                    </div>
                    <span>Mobileye (solo VOLVO)</span>
                  </div>
                  <i class="fas fa-chevron-down"></i>
                </div>
                
                <div class="toggle-section-content" id="mobileyeContentSection">
                  <div class="form-grid">
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Estado Mobileye</label>
                      <select class="form-control" id="mobileyeStatus">
                        <option value="">— Seleccionar —</option>
                        <option>tiene</option>
                        <option>no tiene</option>
                        <option>dañado</option>
                      </select>
                      <div class="form-error" id="w-me">El estado de Mobileye es obligatorio.</div>
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Alerta IZQUIERDA</label>
                      <input type="text" class="form-control" id="leftAlert">
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Alerta DERECHA</label>
                      <input type="text" class="form-control" id="rightAlert">
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Consola</label>
                      <input type="text" class="form-control" id="console">
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor Frontal</label>
                      <input type="text" class="form-control" id="frontSensor">
                    </div>
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor IZQUIERDO</label>
                      <input type="text" class="form-control" id="leftSensor">
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor DERECHO</label>
                      <input type="text" class="form-control" id="rightSensor">
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor Trasero IZQUIERDO (ART)</label>
                      <input type="text" class="form-control" id="rearLeftSensor">
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor Trasero DERECHO (ART)</label>
                      <input type="text" class="form-control" id="rearRightSensor">
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Fecha de Incidente</label>
                      <input type="date" class="form-control" id="incidentDate">
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">N° de Incidente</label>
                      <input type="text" class="form-control" id="incidentNumber">
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="toggle-section" id="toggleOdometer">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-tachometer-alt"></i>
                  </div>
                  <span>Odómetro</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="odometerSection">
                <div class="form-grid">
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Lectura de Odómetro (km)</label>
                    <input type="number" class="form-control" id="odometerReading" min="0" step="1" placeholder="ej., 123456">
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Estado del Odómetro</label>
                    <select class="form-control" id="odometerStatus">
                      <option>funcionando</option>
                      <option>no funciona</option>
                      <option>dañado</option>
                    </select>
                  </div>
                  
                  <div class="col-6 col-sm-12 form-group">
                    <label class="form-label">Observaciones del Odómetro</label>
                    <input type="text" class="form-control" id="odometerObservations" placeholder="Detalles">
                  </div>
                </div>
              </div>
              
              <div class="toggle-section" id="toggleSummary">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-save"></i>
                  </div>
                  <span>Resumen y Guardar</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="summarySection">
                <div class="form-grid">
                  <div class="col-4 col-sm-12 form-group">
                    <label class="form-label">Estado General</label>
                    <select class="form-control" id="globalStatus">
                      <option>OK</option>
                      <option>Observaciones</option>
                      <option>Crítico</option>
                    </select>
                  </div>
                  
                  <div class="col-8 col-sm-12 form-group">
                    <label class="form-label">Observaciones Generales</label>
                    <input type="text" class="form-control" id="generalObservations" placeholder="Notas generales de la inspección">
                  </div>
                  
                  <div class="col-12 d-flex gap-3">
                    <button class="btn btn-primary" id="btnSave">
                      <i class="fas fa-save"></i> Guardar/Actualizar Inspección
                    </button>
                    <span class="chip" id="saveMsg">—</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- INFORME DE CÁMARAS -->
        <section id="section-cameras-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Informe de Cámaras</h3>
              <div class="d-flex align-center gap-3">
                <span class="chip">Registros: <strong id="cameraReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportCameras">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="camerasFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="camerasTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Marca</label>
                <select class="form-control" id="camerasMakeFilter">
                  <option value="">Todas</option>
                  <option>Volvo</option>
                  <option>Mercedes-Benz</option>
                  <option>Scania</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado Monitor</label>
                <select class="form-control" id="camerasMonitorFilter">
                  <option value="">Todos</option>
                  <option value="SI">Funcional</option>
                  <option value="NO">Con Problemas</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetCamerasFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyCamerasFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="camerasTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>PPU</th>
                    <th>Terminal</th>
                    <th>Asignación</th>
                    <th>Modelo Chasis</th>
                    <th>Marca</th>
                    <th>Año</th>
                    <th>Monitor Cámara</th>
                    <th>Cámara Delantera</th>
                    <th>Cámara Cabina</th>
                    <th>Cámaras Interiores</th>
                    <th>Cámara Trasera</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- INFORME DE TAG -->
        <section id="section-tag-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Informe de TAG</h3>
              <div class="d-flex align-center gap-3">
                <span class="chip">Registros: <strong id="tagReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportTag">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="tagFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="tagTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado TAG</label>
                <select class="form-control" id="tagStatusFilter">
                  <option value="">Todos</option>
                  <option value="yes">Con TAG</option>
                  <option value="no">Sin TAG</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetTagFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyTagFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="tagTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>PPU</th>
                    <th>TAG</th>
                    <th>Serie TAG</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- INFORME DE MOBILEYE -->
        <section id="section-mobileye-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Informe de Mobileye</h3>
              <div class="d-flex align-center gap-3">
                <span class="chip">Registros: <strong id="mobileyeReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportMobileye">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="mobileyeFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="mobileyeTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado Mobileye</label>
                <select class="form-control" id="mobileyeStatusFilter">
                  <option value="">Todos</option>
                  <option value="tiene">Funcional</option>
                  <option value="no tiene">Sin Mobileye</option>
                  <option value="dañado">Dañado</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetMobileyeFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyMobileyeFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="mobileyeTable">
                <thead>
                  <tr>
                    <th>PPU</th>
                    <th>Modelo</th>
                    <th>Marca</th>
                    <th>Año</th>
                    <th>Terminal</th>
                    <th>Tipo</th>
                    <th>Alerta IZQUIERDA</th>
                    <th>Alerta DERECHA</th>
                    <th>Consola</th>
                    <th>Sensor Frontal</th>
                    <th>Sensor IZQUIERDO</th>
                    <th>Sensor DERECHO</th>
                    <th>Sensor Trasero IZQUIERDO (ART)</th>
                    <th>Sensor Trasero DERECHO (ART)</th>
                    <th>Fecha Incidente</th>
                    <th>N° Incidente</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- INFORME DE ODÓMETRO -->
        <section id="section-odometer-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Informe de Odómetro</h3>
              <div class="d-flex align-center gap-3">
                <span class="chip">Registros: <strong id="odometerReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportOdometer">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="odometerFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="odometerTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado Odómetro</label>
                <select class="form-control" id="odometerStatusFilter">
                  <option value="">Todos</option>
                  <option value="funcionando">Funcional</option>
                  <option value="no funciona">No Funciona</option>
                  <option value="dañado">Dañado</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetOdometerFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyOdometerFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="odometerTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>PPU</th>
                    <th>Terminal</th>
                    <th>Asignación</th>
                    <th>Modelo Chasis</th>
                    <th>Marca</th>
                    <th>Año</th>
                    <th>Lectura Odómetro (km)</th>
                    <th>Estado Odómetro</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- TICKETS DE MANTENIMIENTO -->
        <section id="section-maintenance-tickets" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Tickets de Mantenimiento</h3>
              <div class="d-flex align-center gap-3 flex-wrap">
                <select id="ticketStatusFilter" class="form-control">
                  <option value="">Todos los Estados</option>
                  <option value="open">Abierto</option>
                  <option value="in_progress">En Progreso</option>
                  <option value="closed">Cerrado</option>
                </select>
                <button class="btn btn-success btn-sm" id="btnNewTicket">
                  <i class="fas fa-plus"></i> Nuevo Ticket
                </button>
                <button class="btn btn-primary btn-sm" id="btnExportTickets">
                  <i class="fas fa-file-excel"></i> Exportar Tickets
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="ticketsFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros Avanzados</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="ticketsTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Componente</label>
                <select class="form-control" id="ticketsComponentFilter">
                  <option value="">Todos</option>
                  <option>Cámaras</option>
                  <option>TAG</option>
                  <option>Mobileye</option>
                  <option>Odómetro</option>
                  <option>Motor</option>
                  <option>Frenos</option>
                  <option>Transmisión</option>
                  <option>Otro</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Prioridad</label>
                <select class="form-control" id="ticketsPriorityFilter">
                  <option value="">Todas</option>
                  <option value="low">Baja</option>
                  <option value="medium">Media</option>
                  <option value="high">Alta</option>
                  <option value="critical">Crítica</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Fecha Desde</label>
                <input type="date" class="form-control" id="ticketsDateFrom">
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetTicketsFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyTicketsFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="ticketsTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>PPU</th>
                    <th>Terminal</th>
                    <th>Componente</th>
                    <th>Descripción</th>
                    <th>Prioridad</th>
                    <th>Estado</th>
                    <th>Creado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
        
        <!-- ESTADO DE FLOTA -->
        <section id="section-fleet-status" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Resumen de Estado de Flota</h3>
              <div class="d-flex align-center gap-3">
                <select id="fleetTerminalFilter" class="form-control">
                  <option value="">Todos los Terminales</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
                <button class="btn btn-primary btn-sm" id="btnExportFleet">
                  <i class="fas fa-file-excel"></i> Exportar Datos de Flota
                </button>
              </div>
            </div>
            
            <!-- Estadísticas de Flota -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-card-header">
                  <div class="stat-icon">
                    <i class="fas fa-bus"></i>
                  </div>
                </div>
                <div class="stat-label">Total de Buses</div>
                <div class="stat-value" id="fleetTotalCount">0</div>
              </div>
              
              <div class="stat-card success">
                <div class="stat-card-header">
                  <div class="stat-icon success">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </div>
                <div class="stat-label">Operativos</div>
                <div class="stat-value text-success" id="fleetOperationalCount">0</div>
              </div>
              
              <div class="stat-card warning">
                <div class="stat-card-header">
                  <div class="stat-icon warning">
                    <i class="fas fa-tools"></i>
                  </div>
                </div>
                <div class="stat-label">En Mantenimiento</div>
                <div class="stat-value text-warning" id="fleetMaintenanceCount">0</div>
              </div>
              
              <div class="stat-card danger">
                <div class="stat-card-header">
                  <div class="stat-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                </div>
                <div class="stat-label">Problemas Críticos</div>
                <div class="stat-value text-danger" id="fleetCriticalCount">0</div>
              </div>
            </div>
            
            <div class="filters-container mt-4" id="fleetFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Marca</label>
                <select class="form-control" id="fleetMakeFilter">
                  <option value="">Todas</option>
                  <option>Volvo</option>
                  <option>Mercedes-Benz</option>
                  <option>Scania</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado</label>
                <select class="form-control" id="fleetStatusFilter">
                  <option value="">Todos</option>
                  <option value="Operational">Operativo</option>
                  <option value="Maintenance">En Mantenimiento</option>
                  <option value="Critical">Problemas Críticos</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Año</label>
                <select class="form-control" id="fleetYearFilter">
                  <option value="">Todos</option>
                  <!-- Se llenará dinámicamente -->
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetFleetFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyFleetFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container mt-4">
              <table class="table" id="fleetStatusTable">
                <thead>
                  <tr>
                    <th>PPU</th>
                    <th># Interno</th>
                    <th>Marca/Modelo</th>
                    <th>Año</th>
                    <th>Terminal</th>
                    <th>Última Inspección</th>
                    <th>Estado</th>
                    <th>Odómetro</th>
                    <th>Problemas Abiertos</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
        
        <!-- PREFERENCIAS DE USUARIO -->
        <section id="section-user-settings" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Preferencias de Usuario</h3>
            </div>
            
            <div class="form-grid">
              <div class="col-6 col-md-12">
                <div class="form-group">
                  <label class="form-label">Nombre del Inspector</label>
                  <input type="text" class="form-control" id="settingsName">
                </div>
                
                <div class="form-group">
                  <label class="form-label">Terminal Predeterminado</label>
                  <select class="form-control" id="settingsTerminal">
                    <option value="">— Seleccionar —</option>
                    <option>El Roble</option>
                    <option>La Reina</option>
                    <option>Maria Angelica</option>
                    <option>El Descanso</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Tema</label>
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input type="radio" id="themeLight" name="theme" value="light" class="form-check">
                      <label for="themeLight">Claro</label>
                    </div>
                    <div class="form-check">
                      <input type="radio" id="themeDark" name="theme" value="dark" class="form-check">
                      <label for="themeDark">Oscuro</label>
                    </div>
                    <div class="form-check">
                      <input type="radio" id="themeSystem" name="theme" value="system" class="form-check">
                      <label for="themeSystem">Sistema</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-6 col-md-12">
                <div class="form-group">
                  <label class="form-label">Notificaciones</label>
                  <div class="d-flex flex-column gap-2">
                    <div class="form-check">
                      <input type="checkbox" id="notifTickets" class="form-check">
                      <label for="notifTickets">Nuevos tickets de mantenimiento</label>
                    </div>
                    <div class="form-check">
                      <input type="checkbox" id="notifInspections" class="form-check">
                      <label for="notifInspections">Inspecciones pendientes</label>
                    </div>
                    <div class="form-check">
                      <input type="checkbox" id="notifCritical" class="form-check">
                      <label for="notifCritical">Problemas críticos</label>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Vista Predeterminada</label>
                  <select class="form-control" id="settingsDefaultView">
                    <option value="inspection-form">Formulario de Inspección</option>
                    <option value="dashboard">Dashboard</option>
                    <option value="fleet-status">Estado de Flota</option>
                  </select>
                </div>
              </div>
              
              <div class="col-12 d-flex justify-end mt-4">
                <button class="btn btn-light" id="btnResetSettings">
                  <i class="fas fa-undo"></i> Restablecer
                </button>
                <button class="btn btn-primary ml-3" id="btnSaveSettings">
                  <i class="fas fa-save"></i> Guardar Preferencias
                </button>
              </div>
            </div>
          </div>
        </section>
        
        <!-- AYUDA -->
        <section id="section-help" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Ayuda y Soporte</h3>
            </div>
            
            <div class="toggle-section active">
              <div class="toggle-section-title">
                <div class="section-icon">
                  <i class="fas fa-question-circle"></i>
                </div>
                <span>¿Cómo empezar?</span>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="toggle-section-content show">
              <p>Para comenzar a utilizar el Sistema de Inspección de Buses, sigue estos pasos:</p>
              <ol>
                <li>Inicia sesión con tu nombre y terminal asignado</li>
                <li>Selecciona la semana de inspección actual</li>
                <li>Busca un bus por su PPU o número interno</li>
                <li>Completa el formulario de inspección para cada sección</li>
                <li>Guarda los cambios utilizando el botón "Guardar/Actualizar Inspección"</li>
              </ol>
              <p>Los registros se guardarán automáticamente y estarán disponibles en los informes correspondientes.</p>
            </div>
            
            <div class="toggle-section">
              <div class="toggle-section-title">
                <div class="section-icon">
                  <i class="fas fa-file-alt"></i>
                </div>
                <span>Informes Disponibles</span>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="toggle-section-content">
              <p>El sistema ofrece varios informes que te ayudarán a analizar el estado de la flota:</p>
              <ul>
                <li><strong>Informe de Cámaras:</strong> Estado y funcionamiento de todas las cámaras en los buses.</li>
                <li><strong>Informe de TAG:</strong> Revisión de presencia y funcionamiento de dispositivos TAG.</li>
                <li><strong>Informe de Mobileye:</strong> Estado de los sistemas Mobileye en buses Volvo.</li>
                <li><strong>Informe de Odómetro:</strong> Registro de lecturas y estado del odómetro.</li>
              </ul>
              <p>Todos los informes pueden filtrarse y exportarse a Excel para análisis adicional.</p>
            </div>
            
            <div class="toggle-section">
              <div class="toggle-section-title">
                <div class="section-icon">
                  <i class="fas fa-ticket-alt"></i>
                </div>
                <span>Sistema de Tickets</span>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="toggle-section-content">
              <p>El sistema de tickets de mantenimiento permite seguir y resolver problemas detectados durante las inspecciones:</p>
              <ul>
                <li>Los tickets se crean automáticamente cuando se detectan problemas en la inspección</li>
                <li>También puedes crear tickets manualmente para reportar otros problemas</li>
                <li>Cada ticket tiene un estado (Abierto, En Progreso, Cerrado) y una prioridad</li>
                <li>Puedes actualizar el estado y añadir notas de resolución</li>
              </ul>
              <p>Mantén actualizados los tickets para asegurar que todos los problemas sean atendidos oportunamente.</p>
            </div>
            
            <div class="toggle-section">
              <div class="toggle-section-title">
                <div class="section-icon">
                  <i class="fas fa-cog"></i>
                </div>
                <span>Contacto de Soporte</span>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="toggle-section-content">
              <p>Si necesitas ayuda adicional o encuentras algún problema con el sistema:</p>
              <div class="d-flex flex-column gap-2 mt-3">
                <div><i class="fas fa-envelope"></i> <strong>Email:</strong> soporte@sisteminspeccion.cl</div>
                <div><i class="fas fa-phone"></i> <strong>Teléfono:</strong> +56 2 2123 4567</div>
                <div><i class="fas fa-headset"></i> <strong>Horario de atención:</strong> Lunes a Viernes, 8:00 - 18:00</div>
              </div>
              <p class="mt-3">Por favor, incluye detalles específicos sobre cualquier problema que experimentes para ayudarnos a resolverlo rápidamente.</p>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Navegación Móvil -->
  <div class="mobile-bottom-nav">
    <div class="nav-items">
      <div class="nav-item active" data-section="inspection-form">
        <i class="fas fa-clipboard-check"></i>
        <span>Inspección</span>
      </div>
      <div class="nav-item" data-section="dashboard">
        <i class="fas fa-chart-line"></i>
        <span>Dashboard</span>
      </div>
      <div class="nav-item" data-section="cameras-report">
        <i class="fas fa-video"></i>
        <span>Cámaras</span>
      </div>
      <div class="nav-item" data-section="tag-report">
        <i class="fas fa-tag"></i>
        <span>Tag</span>
      </div>
      <div class="nav-item" data-section="fleet-status">
        <i class="fas fa-bus"></i>
        <span>Flota</span>
      </div>
    </div>
  </div>

  <!-- Botón FAB -->
  <button class="fab-button" id="fabSave">
    <i class="fas fa-save"></i>
  </button>

  <!-- MODALES -->
  <!-- Fondo de Modal -->
  <div class="modal-backdrop" id="modalBackdrop"></div>

  <!-- Modal de Inicio de Sesión -->
  <div class="modal" id="loginModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Iniciar Registro</h4>
          <button class="modal-close" id="loginModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group mb-4">
            <label class="form-label">Nombre del Inspector</label>
            <input type="text" class="form-control" id="inspectorName">
          </div>
          <div class="form-group">
            <label class="form-label">Terminal</label>
            <select class="form-control" id="inspectorTerminal">
              <option value="">— Seleccionar —</option>
              <option>El Roble</option>
              <option>La Reina</option>
              <option>Maria Angelica</option>
              <option>El Descanso</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="btnStartSession">Iniciar Sesión</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Inspecciones Pendientes -->
  <div class="modal" id="pendingModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Inspecciones Pendientes</h4>
          <button class="modal-close" id="pendingModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-between align-center mb-4">
            <span class="chip chip-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <span id="pendingListCount">0</span> inspecciones pendientes
            </span>
            <select class="form-control" id="pendingFilterTerminal">
              <option value="">Todos los terminales</option>
              <option>El Roble</option>
              <option>La Reina</option>
              <option>Maria Angelica</option>
              <option>El Descanso</option>
            </select>
          </div>
          <div id="pendingList">
            <!-- Será poblado por JS -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" id="btnClosePending">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Estado del Bus -->
  <div class="modal" id="busStatusModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Estado del Bus</h4>
          <button class="modal-close" id="busStatusModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¿El bus está operativo o fuera de servicio?</label>
            <select class="form-control" id="busPanneStatus">
              <option value="operational">Operativo</option>
              <option value="out_of_service">Fuera de Servicio</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="btnConfirmBusStatus">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalles de Ticket -->
  <div class="modal" id="ticketDetailsModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Detalles del Ticket de Mantenimiento</h4>
          <button class="modal-close" id="ticketDetailsModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-between align-center mb-4">
            <span class="chip" id="ticketIdChip">Ticket #<span id="ticketIdDisplay">0</span></span>
            <span class="chip" id="ticketDateChip"><i class="fas fa-calendar"></i> <span id="ticketDateDisplay">—</span></span>
          </div>
          
          <div class="form-group mb-3">
            <label class="form-label">PPU del Bus</label>
            <input type="text" class="form-control" id="ticketBusPPU" disabled>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Componente</label>
            <input type="text" class="form-control" id="ticketComponent" disabled>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Descripción del Problema</label>
            <textarea class="form-control" id="ticketDescription" disabled></textarea>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Prioridad</label>
            <select class="form-control" id="ticketPriority">
              <option value="low">Baja</option>
              <option value="medium">Media</option>
              <option value="high">Alta</option>
              <option value="critical">Crítica</option>
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Estado</label>
            <select class="form-control" id="ticketStatus">
              <option value="open">Abierto</option>
              <option value="in_progress">En Progreso</option>
              <option value="closed">Cerrado</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Notas de Resolución</label>
            <textarea class="form-control" id="ticketResolution" placeholder="Detalles sobre la resolución o progreso"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="btnDeleteTicket">
            <i class="fas fa-trash"></i> Eliminar
          </button>
          <button class="btn btn-success" id="btnUpdateTicket">
            <i class="fas fa-check-circle"></i> Actualizar Ticket
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Nuevo Ticket -->
  <div class="modal" id="newTicketModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Crear Nuevo Ticket de Mantenimiento</h4>
          <button class="modal-close" id="newTicketModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group mb-3">
            <label class="form-label">PPU del Bus</label>
            <div class="d-flex gap-2">
              <input type="text" class="form-control" id="newTicketPPU" placeholder="Ej. XXYY11">
              <button type="button" class="btn btn-light" id="btnSearchTicketBus">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div id="newTicketBusInfo" class="hidden mb-3">
            <div class="chip chip-primary" id="newTicketBusDisplay">
              <i class="fas fa-bus"></i>
              <span>—</span>
            </div>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Componente</label>
            <select class="form-control" id="newTicketComponent">
              <option value="">— Seleccionar —</option>
              <option>Cámaras</option>
              <option>TAG</option>
              <option>Mobileye</option>
              <option>Odómetro</option>
              <option>Motor</option>
              <option>Frenos</option>
              <option>Transmisión</option>
              <option>Otro</option>
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Descripción del Problema</label>
            <textarea class="form-control" id="newTicketDescription" placeholder="Describa el problema en detalle..."></textarea>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Prioridad</label>
            <select class="form-control" id="newTicketPriority">
              <option value="low">Baja</option>
              <option value="medium">Media</option>
              <option value="high">Alta</option>
              <option value="critical">Crítica</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" id="btnCancelNewTicket">Cancelar</button>
          <button class="btn btn-primary" id="btnCreateTicket">Crear Ticket</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencias: Supabase JS, SheetJS, y Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <script>
    // ===================== CONFIGURACIÓN =====================
    const SUPABASE_URL = "https://wvcplgwemvqhvtstlqmt.supabase.co";  // TODO: Reemplazar con URL de Supabase
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2Y3BsZ3dlbXZxaHZ0c3RscW10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjIyMDUsImV4cCI6MjA3NTkzODIwNX0.K1YOv5lRn9fOous3AyG2gPxsQBzqOXRfYHgrCmO5zxk";  // TODO: Reemplazar con clave anónima de Supabase
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // Encabezados para informes
    const HEADERS_CAMERA = ["#", "PPU", "TERMINAL", "ASIGNACIÓN", "MODELO CHASIS", "MARCA", "AÑO", "MONITOR CÁMARA", "CÁMARA DELANTERA", "CÁMARA CABINA", "CÁMARAS INTERIORES", "CÁMARA TRASERA", "OBSERVACIONES"];
    const HEADERS_TAG = ["#", "PPU", "TAG", "SERIE TAG", "OBSERVACIONES"];
    const HEADERS_MOBILEYE = ["PPU", "MODELO", "MARCA", "AÑO", "TERMINAL", "TIPO", "ALERTA IZQUIERDA", "ALERTA DERECHA", "CONSOLA", "SENSOR FRONTAL", "SENSOR IZQUIERDO", "SENSOR DERECHO", "SENSOR TRASERO IZQUIERDO (ART)", "SENSOR TRASERO DERECHO (ART)", "FECHA INCIDENTE", "N° INCIDENTE"];
    const HEADERS_ODOMETER = ["#", "PPU", "TERMINAL", "ASIGNACIÓN", "MODELO CHASIS", "MARCA", "AÑO", "LECTURA ODÓMETRO (KM)", "ESTADO ODÓMETRO", "OBSERVACIONES"];

    // ===================== ESTADO =====================
    let SESSION = {
      inspector: "",
      terminal: "",
      week: getISOWeek(),
      theme: localStorage.getItem('theme') || 'light'
    };

    let CURRENT_BUS = null;  // Bus seleccionado
    let INSPECTION_ID = null;  // ID de inspección actual
    let FILTER_STATES = {
      cameras: {},
      tag: {},
      mobileye: {},
      odometer: {},
      tickets: {},
      fleet: {}
    };

    // ===================== REFERENCIAS DOM =====================
    // Elementos comunes
    const currentWeekLabel = document.getElementById('currentWeekLabel');
    const weekSelector = document.getElementById('weekSelector');
    const dashboardWeekSelector = document.getElementById('dashboardWeekSelector');
    const userInfo = document.getElementById('userInfo');
    const pendingCount = document.getElementById('pendingCount');
    const sidebarElement = document.getElementById('sidebar');
    const busInfoSection = document.getElementById('busInfoSection');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const loaderContainer = document.getElementById('loaderContainer');
    const loaderText = document.getElementById('loaderText');
    const notificationContainer = document.getElementById('notificationContainer');
    const themeToggle = document.getElementById('themeToggle');

    // Modales
    const loginModal = document.getElementById('loginModal');
    const pendingModal = document.getElementById('pendingModal');
    const pendingFilterTerminal = document.getElementById('pendingFilterTerminal');
    const pendingListCount = document.getElementById('pendingListCount');
    const busStatusModal = document.getElementById('busStatusModal');
    const ticketDetailsModal = document.getElementById('ticketDetailsModal');
    const newTicketModal = document.getElementById('newTicketModal');

    // Entradas de formulario
    const formInputs = {
      // Campos de búsqueda
      searchPPU: document.getElementById('searchPPU'),
      searchInternal: document.getElementById('searchInternal'),
      
      // Visualización de info del bus
      ppuDisplay: document.getElementById('ppuDisplay'),
      internalDisplay: document.getElementById('internalDisplay'),
      makeDisplay: document.getElementById('makeDisplay'),
      modelDisplay: document.getElementById('modelDisplay'),
      yearDisplay: document.getElementById('yearDisplay'),
      terminalDisplay: document.getElementById('terminalDisplay'),
      inspectionStatus: document.getElementById('inspectionStatus'),
      
      // Sección de cámaras
      monitorCamera: document.getElementById('monitorCamera'),
      monitorDetail: document.getElementById('monitorDetail'),
      frontCamera: document.getElementById('frontCamera'),
      cabinCamera: document.getElementById('cabinCamera'),
      interiorCamera: document.getElementById('interiorCamera'),
      rearCamera: document.getElementById('rearCamera'),
      allVisible: document.getElementById('allVisible'),
      reverseActive: document.getElementById('reverseActive'),
      doorsOpen: document.getElementById('doorsOpen'),
      doorsClosed: document.getElementById('doorsClosed'),
      cameraObservations: document.getElementById('cameraObservations'),
      
      // Sección de TAG
      hasTag: document.getElementById('hasTag'),
      tagSerial: document.getElementById('tagSerial'),
      tagObservations: document.getElementById('tagObservations'),
      
      // Sección de Mobileye
      mobileyeStatus: document.getElementById('mobileyeStatus'),
      leftAlert: document.getElementById('leftAlert'),
      rightAlert: document.getElementById('rightAlert'),
      console: document.getElementById('console'),
      frontSensor: document.getElementById('frontSensor'),
      leftSensor: document.getElementById('leftSensor'),
      rightSensor: document.getElementById('rightSensor'),
      rearLeftSensor: document.getElementById('rearLeftSensor'),
      rearRightSensor: document.getElementById('rearRightSensor'),
      incidentDate: document.getElementById('incidentDate'),
      incidentNumber: document.getElementById('incidentNumber'),
      
      // Sección de odómetro
      odometerReading: document.getElementById('odometerReading'),
      odometerStatus: document.getElementById('odometerStatus'),
      odometerObservations: document.getElementById('odometerObservations'),
      
      // Sección de resumen
      globalStatus: document.getElementById('globalStatus'),
      generalObservations: document.getElementById('generalObservations'),
      saveMsg: document.getElementById('saveMsg')
    };

    // Contadores de informes
    const cameraCount = document.getElementById('cameraCount');
    const tagCount = document.getElementById('tagCount');
    const mobiCount = document.getElementById('mobiCount');
    const odoCount = document.getElementById('odoCount');

    const cameraReportCount = document.getElementById('cameraReportCount');
    const tagReportCount = document.getElementById('tagReportCount');
    const mobileyeReportCount = document.getElementById('mobileyeReportCount');
    const odometerReportCount = document.getElementById('odometerReportCount');

    // Secciones
    const sections = {
      'inspection-form': document.getElementById('section-inspection-form'),
      'dashboard': document.getElementById('section-dashboard'),
      'cameras-report': document.getElementById('section-cameras-report'),
      'tag-report': document.getElementById('section-tag-report'),
      'mobileye-report': document.getElementById('section-mobileye-report'),
      'odometer-report': document.getElementById('section-odometer-report'),
      'maintenance-tickets': document.getElementById('section-maintenance-tickets'),
      'fleet-status': document.getElementById('section-fleet-status'),
      'user-settings': document.getElementById('section-user-settings'),
      'help': document.getElementById('section-help')
    };
    
    // Secciones de formulario plegables
    const toggleSections = {
      'cameras': {
        toggle: document.getElementById('toggleCameras'),
        content: document.getElementById('camerasSection')
      },
      'tag': {
        toggle: document.getElementById('toggleTag'),
        content: document.getElementById('tagSection')
      },
      'mobileye': {
        toggle: document.getElementById('toggleMobileye'),
        content: document.getElementById('mobileyeContentSection')
      },
      'odometer': {
        toggle: document.getElementById('toggleOdometer'),
        content: document.getElementById('odometerSection')
      },
      'summary': {
        toggle: document.getElementById('toggleSummary'),
        content: document.getElementById('summarySection')
      }
    };

    // ===================== UTILIDADES ISO SEMANA =====================
    function getISOWeek(date = new Date()) {
      const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = tmp.getUTCDay() || 7;  // 1..7
      tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
      return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
    }

    function getISOWeeksForSelect(range = 12) {
      const list = [];
      const now = new Date();
      for (let i = 0; i <= range; i++) {
        const d = new Date(now);
        d.setDate(d.getDate() - (i * 7));
        list.push(getISOWeek(d));
      }
      return list;
    }

    function getWeekRange(isoWeek) {
      const [year, week] = isoWeek.split('-W').map(v => parseInt(v, 10));
      
      // Encontrar primer día de la semana (lunes)
      const firstDayOfYear = new Date(year, 0, 1);
      const firstMonday = new Date(firstDayOfYear);
      firstMonday.setDate(firstDayOfYear.getDate() + (8 - firstDayOfYear.getDay()) % 7);
      
      // Calcular el lunes de la semana solicitada
      const weekStartDate = new Date(firstMonday);
      weekStartDate.setDate(firstMonday.getDate() + (week - 1) * 7);
      
      // Calcular el domingo de la semana
      const weekEndDate = new Date(weekStartDate);
      weekEndDate.setDate(weekStartDate.getDate() + 6);
      
      // Formatear fechas
      const formatDate = (date) => {
        return date.toLocaleDateString('es-ES', { 
          day: '2-digit', 
          month: '2-digit'
        });
      };
      
      return `${formatDate(weekStartDate)} - ${formatDate(weekEndDate)}`;
    }

    // ===================== UTILIDADES UI =====================
    function showLoader(message = 'Cargando...') {
      loaderText.textContent = message;
      loaderContainer.classList.add('show');
    }

    function hideLoader() {
      loaderContainer.classList.remove('show');
    }

    function showNotification(type, title, message, duration = 4000) {
      const notificationId = 'notif-' + Date.now();
      
      const notificationHTML = `
        <div class="notification notification-${type}" id="${notificationId}">
          <div class="notification-icon">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
          </div>
          <div class="notification-content">
            <div class="notification-title">${title}</div>
            <p class="notification-message">${message}</p>
          </div>
          <button class="notification-close" onclick="document.getElementById('${notificationId}').remove()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      notificationContainer.insertAdjacentHTML('beforeend', notificationHTML);
      
      // Auto-ocultar después de la duración
      setTimeout(() => {
        const notification = document.getElementById(notificationId);
        if (notification) {
          notification.remove();
        }
      }, duration);
    }

    // ===================== UTILIDADES TABLA =====================
    function setTableHeader(tableId, headers) {
      const thead = document.querySelector(`#${tableId} thead tr`);
      thead.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
      document.querySelector(`#${tableId} tbody`).innerHTML = '';
    }

    function exportTableToXLSX(name, headers, tableId) {
      const rows = Array.from(document.querySelectorAll(`#${tableId} tbody tr`))
        .map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
      
      const aoa = [headers, ...rows];
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Informe');
      XLSX.writeFile(wb, `${name}.xlsx`);
      
      showNotification('success', 'Exportación Completa', 'Datos exportados con éxito a Excel');
    }

    // ===================== NAVEGACIÓN =====================
    // Lógica de cambio de secciones
    function showSection(sectionId) {
      // Ocultar todas las secciones
      Object.values(sections).forEach(section => {
        if (section) section.classList.add('hidden');
      });
      
      // Mostrar la sección solicitada
      if (sections[sectionId]) {
        sections[sectionId].classList.remove('hidden');
      }
      
      // Actualizar elementos de navegación activos
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.section === sectionId) {
          item.classList.add('active');
        }
      });
      
      // Cargar datos específicos de la sección
      if (sectionId === 'dashboard') {
        refreshDashboardData();
      } else if (sectionId === 'maintenance-tickets') {
        loadMaintenanceTickets();
      } else if (sectionId === 'fleet-status') {
        loadFleetStatus();
      } else if (sectionId === 'cameras-report') {
        refreshCamerasReport();
      } else if (sectionId === 'tag-report') {
        refreshTagReport();
      } else if (sectionId === 'mobileye-report') {
        refreshMobileyeReport();
      } else if (sectionId === 'odometer-report') {
        refreshOdometerReport();
      } else if (sectionId === 'user-settings') {
        loadUserSettings();
      }
    }

    // Configurar oyentes de eventos de navegación
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        if (item.id === 'btnLogout') {
          handleLogout();
          return;
        }
        
        const section = item.dataset.section;
        showSection(section);
        
        // En móvil, cerrar sidebar después de la navegación
        if (window.innerWidth <= 1024) {
          sidebarElement.classList.remove('show');
          document.querySelector('.toggle-icon').classList.remove('toggle-active');
        }
        
        // Guardar la última sección visitada en localStorage
        localStorage.setItem('lastSection', section);
      });
    });

    // Alternar sidebar en móvil
    document.getElementById('sidebarToggle').addEventListener('click', () => {
      sidebarElement.classList.toggle('show');
      modalBackdrop.classList.toggle('show');
      document.querySelector('.toggle-icon').classList.toggle('toggle-active');
    });
    
    // Cerrar sidebar al hacer clic en el fondo modal
    modalBackdrop.addEventListener('click', () => {
      sidebarElement.classList.remove('show');
      modalBackdrop.classList.remove('show');
      document.querySelector('.toggle-icon').classList.remove('toggle-active');
    });

    // ===================== TEMA =====================
    // Cargar tema guardado
    function applyTheme(theme) {
      if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        document.body.classList.remove('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      }
    }

    // Alternar tema
    themeToggle.addEventListener('click', () => {
      const currentTheme = localStorage.getItem('theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      localStorage.setItem('theme', newTheme);
      SESSION.theme = newTheme;
      applyTheme(newTheme);
    });

    // Escuchar cambios en preferencia de sistema
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      if (localStorage.getItem('theme') === 'system') {
        applyTheme('system');
      }
    });

    // ===================== SECCIONES PLEGABLES =====================
    // Configurar oyentes para secciones plegables
    Object.values(toggleSections).forEach(section => {
      section.toggle.addEventListener('click', () => {
        section.toggle.classList.toggle('active');
        section.content.classList.toggle('show');
        
        // Cambiar icono
        const icon = section.toggle.querySelector('i.fas.fa-chevron-down');
        icon.style.transform = section.content.classList.contains('show') ? 'rotate(180deg)' : '';
      });
    });

    // Configurar secciones plegables en ayuda
    document.querySelectorAll('.toggle-section').forEach(section => {
      if (!Object.values(toggleSections).some(s => s.toggle === section)) {
        section.addEventListener('click', () => {
          section.classList.toggle('active');
          const content = section.nextElementSibling;
          if (content && content.classList.contains('toggle-section-content')) {
            content.classList.toggle('show');
            
            // Cambiar icono
            const icon = section.querySelector('i.fas.fa-chevron-down');
            if (icon) {
              icon.style.transform = content.classList.contains('show') ? 'rotate(180deg)' : '';
            }
          }
        });
      }
    });

    // ===================== INICIALIZACIÓN =====================
    function initialize() {
      // Inicializar selectores de semana
      const weeks = getISOWeeksForSelect(12);
      
      weekSelector.innerHTML = weeks.map(w => {
        const range = getWeekRange(w);
        return `<option value="${w}">${w} (${range})</option>`;
      }).join('');
      weekSelector.value = SESSION.week;
      
      dashboardWeekSelector.innerHTML = weeks.map(w => {
        const range = getWeekRange(w);
        return `<option value="${w}">${w} (${range})</option>`;
      }).join('');
      dashboardWeekSelector.value = SESSION.week;
      
      currentWeekLabel.textContent = getWeekRange(SESSION.week);
      
      // Inicializar tablas de informes
      setTableHeader('camerasTable', HEADERS_CAMERA);
      setTableHeader('tagTable', HEADERS_TAG);
      setTableHeader('mobileyeTable', HEADERS_MOBILEYE);
      setTableHeader('odometerTable', HEADERS_ODOMETER);
      
      // Aplicar tema
      applyTheme(SESSION.theme);
      
      // Cargar sesión guardada
      const savedSession = localStorage.getItem('session');
      if (savedSession) {
        try {
          const session = JSON.parse(savedSession);
          SESSION.inspector = session.inspector;
          SESSION.terminal = session.terminal;
          userInfo.textContent = `${session.inspector} · ${session.terminal}`;
          
          // No mostrar modal de login
          refreshPendingInspections();
          refreshReportTables();
          loadRecentActivity();
        } catch (e) {
          console.error('Error cargando sesión guardada:', e);
          // Mostrar modal de inicio de sesión
          openLoginModal();
        }
      } else {
        // Mostrar modal de inicio de sesión
        openLoginModal();
      }
      
      // Restaurar última sección visitada o usar predeterminada
      const lastSection = localStorage.getItem('lastSection') || 'inspection-form';
      showSection(lastSection);
      
      // Inicializar filtros
      setupFilters();
      setupSearchHandlers();
    }

    // ===================== GESTIÓN DE SESIÓN =====================
    document.getElementById('btnStartSession').addEventListener('click', () => {
      const name = document.getElementById('inspectorName').value.trim();
      const terminal = document.getElementById('inspectorTerminal').value.trim();
      
      if (!name || !terminal) {
        showNotification('error', 'Error', 'Por favor, complete tanto el nombre como el terminal');
        return;
      }
      
      SESSION.inspector = name;
      SESSION.terminal = terminal;
      userInfo.textContent = `${name} · ${terminal}`;
      
      // Guardar sesión
      localStorage.setItem('session', JSON.stringify({
        inspector: name,
        terminal: terminal
      }));
      
      hideModal(loginModal);
      refreshPendingInspections();
      refreshReportTables();
      loadRecentActivity();
      
      showNotification('success', 'Sesión Iniciada', 'Has iniciado sesión y puedes comenzar las inspecciones');
    });

    function handleLogout() {
      // Mostrar diálogo de confirmación
      if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
        // Limpiar sesión
        SESSION.inspector = "";
        SESSION.terminal = "";
        localStorage.removeItem('session');
        
        // Limpiar formulario
        clearForm();
        
        // Actualizar UI
        userInfo.textContent = "—";
        showNotification('info', 'Sesión Cerrada', 'Has cerrado sesión correctamente');
        
        // Mostrar modal de inicio de sesión
        openLoginModal();
      }
    }

    // Oyentes de eventos para selección de semana
    weekSelector.addEventListener('change', () => {
      SESSION.week = weekSelector.value;
      dashboardWeekSelector.value = SESSION.week;
      currentWeekLabel.textContent = getWeekRange(SESSION.week);
      
      if (CURRENT_BUS) {
        loadWeeklyInspection(CURRENT_BUS.id);
      }
      
      refreshPendingInspections();
      refreshReportTables();
    });

    dashboardWeekSelector.addEventListener('change', () => {
      SESSION.week = dashboardWeekSelector.value;
      weekSelector.value = SESSION.week;
      currentWeekLabel.textContent = getWeekRange(SESSION.week);
      
      refreshDashboardData();
      refreshPendingInspections();
      loadRecentActivity();
    });

    document.getElementById('dashboardTerminalFilter').addEventListener('change', () => {
      refreshDashboardData();
    });

    // Navegación de semanas
    document.getElementById('prevWeekForm').addEventListener('click', () => {
      const weeks = getISOWeeksForSelect(12);
      const currentIndex = weeks.indexOf(SESSION.week);
      if (currentIndex < weeks.length - 1) {
        SESSION.week = weeks[currentIndex + 1];
        weekSelector.value = SESSION.week;
        dashboardWeekSelector.value = SESSION.week;
        currentWeekLabel.textContent = getWeekRange(SESSION.week);
        
        if (CURRENT_BUS) {
          loadWeeklyInspection(CURRENT_BUS.id);
        }
        
        refreshPendingInspections();
        refreshReportTables();
      }
    });

    document.getElementById('nextWeekForm').addEventListener('click', () => {
      const weeks = getISOWeeksForSelect(12);
      const currentIndex = weeks.indexOf(SESSION.week);
      if (currentIndex > 0) {
        SESSION.week = weeks[currentIndex - 1];
        weekSelector.value = SESSION.week;
        dashboardWeekSelector.value = SESSION.week;
        currentWeekLabel.textContent = getWeekRange(SESSION.week);
        
        if (CURRENT_BUS) {
          loadWeeklyInspection(CURRENT_BUS.id);
        }
        
        refreshPendingInspections();
        refreshReportTables();
      }
    });

    document.getElementById('prevWeekDash').addEventListener('click', () => {
      const weeks = getISOWeeksForSelect(12);
      const currentIndex = weeks.indexOf(SESSION.week);
      if (currentIndex < weeks.length - 1) {
        SESSION.week = weeks[currentIndex + 1];
        weekSelector.value = SESSION.week;
        dashboardWeekSelector.value = SESSION.week;
        currentWeekLabel.textContent = getWeekRange(SESSION.week);
        
        refreshDashboardData();
        refreshPendingInspections();
        loadRecentActivity();
      }
    });

    document.getElementById('nextWeekDash').addEventListener('click', () => {
      const weeks = getISOWeeksForSelect(12);
      const currentIndex = weeks.indexOf(SESSION.week);
      if (currentIndex > 0) {
        SESSION.week = weeks[currentIndex - 1];
        weekSelector.value = SESSION.week;
        dashboardWeekSelector.value = SESSION.week;
        currentWeekLabel.textContent = getWeekRange(SESSION.week);
        
        refreshDashboardData();
        refreshPendingInspections();
        loadRecentActivity();
      }
    });

    // Búsqueda global
    document.getElementById('globalSearch').addEventListener('keyup', function(e) {
      if (e.key === 'Enter') {
        const searchTerm = this.value.trim();
        if (searchTerm) {
          showLoader('Buscando buses...');
          
          Promise.all([
            sb.from('revision_semanal_buses').select('*').ilike('ppu', `%${searchTerm}%`).limit(1),
            sb.from('revision_semanal_buses').select('*').ilike('numero_interno', `%${searchTerm}%`).limit(1)
          ]).then(([ppuResults, internalResults]) => {
            hideLoader();
            
            if (ppuResults.data && ppuResults.data.length > 0) {
              selectBus(ppuResults.data[0]);
              showSection('inspection-form');
            } else if (internalResults.data && internalResults.data.length > 0) {
              selectBus(internalResults.data[0]);
              showSection('inspection-form');
            } else {
              showNotification('warning', 'Bus No Encontrado', 'No se encontró ningún bus con ese PPU o # interno');
            }
            
            // Limpiar campo de búsqueda
            this.value = '';
          }).catch(err => {
            hideLoader();
            console.error('Error en búsqueda global:', err);
            showNotification('error', 'Error', 'No se pudo completar la búsqueda');
          });
        }
      }
    });

    // ===================== SELECCIÓN DE BUS =====================
    function setupSearchHandlers() {
      const searchPPUButton = document.getElementById('btnSearchPPU');
      const searchInternalButton = document.getElementById('btnSearchInternal');
      const searchPPUForm = document.getElementById('searchPPUForm');
      const searchInternalForm = document.getElementById('searchInternalForm');
      
      if (searchPPUForm) {
        searchPPUForm.addEventListener('submit', (event) => {
          event.preventDefault();
          handlePPUSearch();
        });
      }
      
      if (searchPPUButton) {
        searchPPUButton.addEventListener('click', (event) => {
          event.preventDefault();
          handlePPUSearch();
        });
      }
      
      if (formInputs.searchPPU) {
        formInputs.searchPPU.addEventListener('keyup', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            handlePPUSearch();
          }
        });
      }
      
      if (searchInternalButton) {
        searchInternalButton.addEventListener('click', (event) => {
          event.preventDefault();
          handleInternalSearch();
        });
      }

      if (searchInternalForm) {
        searchInternalForm.addEventListener('submit', (event) => {
          event.preventDefault();
          handleInternalSearch();
        });
      }
      
      if (formInputs.searchInternal) {
        formInputs.searchInternal.addEventListener('keyup', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            handleInternalSearch();
          }
        });
      }
    }

    async function handlePPUSearch() {
      const rawValue = formInputs.searchPPU ? formInputs.searchPPU.value.trim() : '';
      if (!rawValue) {
        showNotification('warning', 'Advertencia', 'Por favor ingrese un PPU para buscar');
        return;
      }
      
      const normalizedValue = rawValue.toUpperCase().replace(/\s+/g, '');
      if (formInputs.searchPPU) {
        formInputs.searchPPU.value = normalizedValue;
      }
      
      await searchBus('ppu', normalizedValue, 'No se encontraron buses con ese PPU');
    }

    async function handleInternalSearch() {
      const rawValue = formInputs.searchInternal ? formInputs.searchInternal.value.trim() : '';
      if (!rawValue) {
        showNotification('warning', 'Advertencia', 'Por favor ingrese un número interno para buscar');
        return;
      }
      
      const normalizedValue = rawValue.replace(/\s+/g, '');
      if (formInputs.searchInternal) {
        formInputs.searchInternal.value = normalizedValue;
      }
      
      await searchBus('numero_interno', normalizedValue, 'No se encontraron buses con ese número interno');
    }

    async function searchBus(field, value, notFoundMessage) {
      showLoader('Buscando bus...');
      
      try {
        const { data, error } = await sb
          .from('revision_semanal_buses')
          .select('*')
          .ilike(field, `%${value}%`)
          .limit(1);
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          selectBus(data[0]);
        } else {
          showNotification('error', 'No Encontrado', notFoundMessage);
        }
      } catch (err) {
        console.error(`Error buscando por ${field}:`, err);
        showNotification('error', 'Error', 'No se pudo completar la búsqueda de buses');
      } finally {
        hideLoader();
      }
    }

    // Delegar clics en caso de que los oyentes directos no se adjunten
    document.addEventListener('click', (event) => {
      const ppuBtn = event.target.closest('#btnSearchPPU');
      const internalBtn = event.target.closest('#btnSearchInternal');
      
      if (ppuBtn) {
        event.preventDefault();
        handlePPUSearch();
      } else if (internalBtn) {
        event.preventDefault();
        handleInternalSearch();
      }
    });

    function selectBus(bus) {
      CURRENT_BUS = bus;
      
      // Mostrar info del bus
      formInputs.ppuDisplay.textContent = bus.ppu || '—';
      formInputs.internalDisplay.textContent = bus.numero_interno || '—';
      formInputs.makeDisplay.textContent = bus.marca || '—';
      formInputs.modelDisplay.textContent = bus.modelo_chasis || '—';
      formInputs.yearDisplay.textContent = bus.anio || '—';
      formInputs.terminalDisplay.textContent = bus.terminal || '—';
      
      // Mostrar/ocultar sección Mobileye según marca
      document.getElementById('mobileyeSection').classList.toggle('hidden', (bus.marca || '').toUpperCase() !== 'VOLVO');
      
      // Mostrar la sección de info del bus
      busInfoSection.classList.remove('hidden');
      
      // Expandir primera sección plegable
      if (toggleSections.cameras) {
        toggleSections.cameras.toggle.classList.add('active');
        toggleSections.cameras.content.classList.add('show');
        toggleSections.cameras.toggle.querySelector('i.fas.fa-chevron-down').style.transform = 'rotate(180deg)';
      }
      
      // Preguntar sobre estado operativo
      showModal(busStatusModal);
    }

    function showBusStatusModal() {
      document.getElementById('busPanneStatus').value = 'operational';
      showModal(busStatusModal);
    }

    document.getElementById('btnConfirmBusStatus').addEventListener('click', () => {
      const status = document.getElementById('busPanneStatus').value;
      
      if (status === 'out_of_service') {
        formInputs.inspectionStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Bus fuera de servicio — inspección pendiente`;
        formInputs.inspectionStatus.className = 'chip status-warning';
      } else {
        formInputs.inspectionStatus.innerHTML = `<i class="fas fa-clock"></i> Sin inspección aún`;
        formInputs.inspectionStatus.className = 'chip';
      }
      
      hideModal(busStatusModal);
      loadWeeklyInspection(CURRENT_BUS.id);
    });

    // ===================== CARGA/GUARDADO DE INSPECCIÓN =====================
    async function loadWeeklyInspection(busId) {
      clearForm();
      
      showLoader('Cargando inspección...');
      
      try {
        const { data, error } = await sb
          .from('revision_semanal_inspecciones')
          .select('id, fecha_inspeccion, inspector_nombre, estado_global, observacion_general')
          .eq('bus_id', busId)
          .eq('semana_iso', SESSION.week)
          .maybeSingle();
        
        if (error) throw error;
        
        hideLoader();
        
        if (data) {
          INSPECTION_ID = data.id;
          
          const inspectionDate = new Date(data.fecha_inspeccion).toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          formInputs.inspectionStatus.innerHTML = `<i class="fas fa-check-circle"></i> Inspeccionado el ${inspectionDate} por ${data.inspector_nombre}`;
          formInputs.inspectionStatus.className = 'chip status-completed';
          
          formInputs.globalStatus.value = data.estado_global || 'OK';
          formInputs.generalObservations.value = data.observacion_general || '';
          
          await loadInspectionSections(data.id);
        } else {
          INSPECTION_ID = null;
        }
      } catch (err) {
        hideLoader();
        console.error('Error cargando inspección:', err);
        showNotification('error', 'Error', 'No se pudo cargar los datos de la inspección');
      }
    }

    async function loadInspectionSections(inspectionId) {
      try {
        showLoader('Cargando datos de la inspección...');
        
        // Cargar datos de cámara
        const { data: cameraData } = await sb
          .from('revision_semanal_camara_inspeccion')
          .select('*')
          .eq('inspeccion_id', inspectionId)
          .maybeSingle();
        
        if (cameraData) {
          formInputs.monitorCamera.value = cameraData.monitor_camara ? 'SI' : 'NO';
          formInputs.monitorDetail.value = cameraData.monitor_detalle || '';
          formInputs.frontCamera.value = cameraData.camara_frontal || 'tiene';
          formInputs.cabinCamera.value = cameraData.camara_cabina || 'tiene';
          formInputs.interiorCamera.value = cameraData.camaras_interior || 'tiene';
          formInputs.rearCamera.value = cameraData.camara_trasera || 'tiene';
          formInputs.cameraObservations.value = cameraData.observacion || '';
          
          formInputs.allVisible.value = cameraData.q_all_visible || '';
          formInputs.reverseActive.value = cameraData.q_reverse || '';
          formInputs.doorsOpen.value = cameraData.q_doors_open || '';
          formInputs.doorsClosed.value = cameraData.q_doors_closed || '';
        }
        
        // Cargar datos de tag
        const { data: tagData } = await sb
          .from('revision_semanal_tag_inspeccion')
          .select('*')
          .eq('inspeccion_id', inspectionId)
          .maybeSingle();
        
        if (tagData) {
          formInputs.hasTag.value = tagData.tag_tiene ? 'yes' : 'no';
          formInputs.tagSerial.value = tagData.tag_serie || '';
          formInputs.tagObservations.value = tagData.observacion || '';
        }
        
        // Cargar datos de Mobileye (si es VOLVO)
        if ((CURRENT_BUS.marca || '').toUpperCase() === 'VOLVO') {
          const { data: mobileyeData } = await sb
            .from('revision_semanal_movileye_inspeccion')
            .select('*')
            .eq('inspeccion_id', inspectionId)
            .maybeSingle();
          
          if (mobileyeData) {
            formInputs.mobileyeStatus.value = mobileyeData.estado || '';
            formInputs.leftAlert.value = mobileyeData.alerta_izq || '';
            formInputs.rightAlert.value = mobileyeData.alerta_der || '';
            formInputs.console.value = mobileyeData.consola || '';
            formInputs.frontSensor.value = mobileyeData.sensor_frontal || '';
            formInputs.leftSensor.value = mobileyeData.sensor_izq || '';
            formInputs.rightSensor.value = mobileyeData.sensor_der || '';
            formInputs.rearLeftSensor.value = mobileyeData.sensor_traser_izq_art || '';
            formInputs.rearRightSensor.value = mobileyeData.sensor_traser_der_art || '';
            
            if (mobileyeData.fecha_siniestro) {
              formInputs.incidentDate.value = mobileyeData.fecha_siniestro.substring(0, 10);
            } else {
              formInputs.incidentDate.value = '';
            }
            
            formInputs.incidentNumber.value = mobileyeData.nro_siniestro || '';
          }
        }
        
        // Cargar datos de odómetro
        const { data: odometerData } = await sb
          .from('revision_semanal_odometro_inspeccion')
          .select('*')
          .eq('inspeccion_id', inspectionId)
          .maybeSingle();
        
        if (odometerData) {
          formInputs.odometerReading.value = odometerData.lectura_km || '';
          formInputs.odometerStatus.value = odometerData.estado_odometro || 'funcionando';
          formInputs.odometerObservations.value = odometerData.observacion || '';
        }
        
        hideLoader();
      } catch (err) {
        hideLoader();
        console.error('Error cargando secciones de la inspección:', err);
        showNotification('error', 'Error', 'No se pudieron cargar los datos completos de la inspección');
      }
    }

    function clearForm() {
      // Restablecer valores del formulario
      formInputs.monitorCamera.value = '';
      formInputs.monitorDetail.value = '';
      formInputs.frontCamera.value = 'tiene';
      formInputs.cabinCamera.value = 'tiene';
      formInputs.interiorCamera.value = 'tiene';
      formInputs.rearCamera.value = 'tiene';
      formInputs.allVisible.value = '';
      formInputs.reverseActive.value = '';
      formInputs.doorsOpen.value = '';
      formInputs.doorsClosed.value = '';
      formInputs.cameraObservations.value = '';
      
      formInputs.hasTag.value = 'yes';
      formInputs.tagSerial.value = '';
      formInputs.tagObservations.value = '';
      
      formInputs.mobileyeStatus.value = '';
      formInputs.leftAlert.value = '';
      formInputs.rightAlert.value = '';
      formInputs.console.value = '';
      formInputs.frontSensor.value = '';
      formInputs.leftSensor.value = '';
      formInputs.rightSensor.value = '';
      formInputs.rearLeftSensor.value = '';
      formInputs.rearRightSensor.value = '';
      formInputs.incidentDate.value = '';
      formInputs.incidentNumber.value = '';
      
      formInputs.odometerReading.value = '';
      formInputs.odometerStatus.value = 'funcionando';
      formInputs.odometerObservations.value = '';
      
      formInputs.globalStatus.value = 'OK';
      formInputs.generalObservations.value = '';
      formInputs.saveMsg.textContent = '—';
      
      // Limpiar errores de validación
      document.querySelectorAll('.form-control.invalid').forEach(el => {
        el.classList.remove('invalid');
      });
      
      document.querySelectorAll('.form-error').forEach(el => {
        el.style.display = 'none';
      });
    }

    // ===================== VALIDACIÓN DE FORMULARIO =====================
    function validateForm() {
      let errors = 0;
      
      // Función auxiliar para marcar campos como inválidos
      function markInvalid(input, errorId) {
        if (!input) return 0;
        
        if (!input.value) {
          input.classList.add('invalid');
          const errorElement = document.getElementById(errorId);
          if (errorElement) errorElement.style.display = 'block';
          return 1;
        }
        
        input.classList.remove('invalid');
        const errorElement = document.getElementById(errorId);
        if (errorElement) errorElement.style.display = 'none';
        return 0;
      }
      
      // Campos de cámara obligatorios
      errors += markInvalid(formInputs.monitorCamera, 'w-monitor');
      errors += markInvalid(formInputs.allVisible, 'w-all');
      errors += markInvalid(formInputs.reverseActive, 'w-rev');
      errors += markInvalid(formInputs.doorsOpen, 'w-open');
      errors += markInvalid(formInputs.doorsClosed, 'w-closed');
      
      // Estado de Mobileye si es VOLVO
      if ((CURRENT_BUS.marca || '').toUpperCase() === 'VOLVO') {
        errors += markInvalid(formInputs.mobileyeStatus, 'w-me');
      }
      
      return errors;
    }

    function evaluateCriticality() {
      // Comenzar con estado predeterminado
      let status = 'OK';
      
      // Verificar cámaras para problemas
      const cameraIssues = [];
      
      if (formInputs.monitorCamera.value === 'NO') {
        cameraIssues.push('El monitor no muestra todas las cámaras');
      }
      
      if (formInputs.allVisible.value === 'NO') {
        cameraIssues.push('No todas las cámaras son visibles en el monitor');
      }
      
      if (formInputs.reverseActive.value === 'NO') {
        cameraIssues.push('La cámara trasera no se activa con la marcha atrás');
      }
      
      if (formInputs.doorsOpen.value === 'NO') {
        cameraIssues.push('Las cámaras de las puertas no se activan al abrirse');
      }
      
      if (formInputs.doorsClosed.value === 'NO') {
        cameraIssues.push('No se muestran todas las cámaras con las puertas cerradas');
      }
      
      ['frontCamera', 'cabinCamera', 'interiorCamera', 'rearCamera'].forEach(key => {
        const value = formInputs[key].value;
        if (value === 'dañada' || value === "no tiene") {
          const cameraName = key.replace('Camera', '').replace('front', 'delantera').replace('cabin', 'cabina').replace('interior', 'interiores').replace('rear', 'trasera');
          cameraIssues.push(`cámara ${cameraName}: ${value}`);
        }
      });
      
      if (cameraIssues.length > 0) {
        status = 'Observaciones';
      }
      
      // Verificar estado del TAG
      if (formInputs.hasTag.value === 'no') {
        status = 'Observaciones';
      }
      
      // Verificar Mobileye para buses VOLVO
      if ((CURRENT_BUS.marca || '').toUpperCase() === 'VOLVO') {
        if (formInputs.mobileyeStatus.value === 'dañado' || formInputs.mobileyeStatus.value === "no tiene") {
          status = 'Observaciones';
        }
      }
      
      // Verificar estado del odómetro
      if (formInputs.odometerStatus.value === 'dañado' || formInputs.odometerStatus.value === 'no funciona') {
        status = 'Observaciones';
      }
      
      // Actualizar campo de estado si es necesario
      if (status !== 'OK' && formInputs.globalStatus.value === 'OK') {
        formInputs.globalStatus.value = status;
      }
    }

    // ===================== GUARDAR INSPECCIÓN =====================
    // Conectar botones de guardar
    document.getElementById('fabSave').addEventListener('click', saveInspection);
    document.getElementById('btnSave').addEventListener('click', saveInspection);

    async function saveInspection() {
      // Validación básica
      if (!SESSION.inspector || !SESSION.terminal) {
        showNotification('error', 'Sesión Requerida', 'Debes iniciar una sesión primero');
        openLoginModal();
        return;
      }
      
      if (!CURRENT_BUS) {
        showNotification('warning', 'Bus No Seleccionado', 'Por favor, seleccione un bus para inspeccionar');
        return;
      }
      
      const validationErrors = validateForm();
      if (validationErrors > 0) {
        showNotification('error', 'Error de Validación', `Hay ${validationErrors} preguntas sin responder. Por favor, revise los campos destacados.`);
        return;
      }
      
      // Auto-evaluar criticidad basada en respuestas
      evaluateCriticality();
      
      // Mostrar indicador de guardado
      formInputs.saveMsg.textContent = 'Guardando...';
      
      showLoader('Guardando inspección...');
      
      try {
        // Crear o actualizar el registro principal de inspección
        const inspectionPayload = {
          bus_id: CURRENT_BUS.id,
          semana_iso: SESSION.week,
          fecha_inspeccion: new Date().toISOString(),
          inspector_nombre: SESSION.inspector,
          terminal: SESSION.terminal,
          observacion_general: formInputs.generalObservations.value || null,
          estado_global: formInputs.globalStatus.value
        };
        
        const { data: inspData, error: inspError } = await sb
          .from('revision_semanal_inspecciones')
          .upsert(inspectionPayload, { onConflict: 'bus_id,semana_iso' })
          .select('id')
          .maybeSingle();
        
        if (inspError) throw inspError;
        
        const inspectionId = inspData?.id;
        INSPECTION_ID = inspectionId;
        
        // Guardar sección de cámaras
        await sb.from('revision_semanal_camara_inspeccion').upsert({
          inspeccion_id: inspectionId,
          monitor_camara: formInputs.monitorCamera.value === 'SI',
          monitor_detalle: formInputs.monitorDetail.value || null,
          camara_frontal: formInputs.frontCamera.value,
          camara_cabina: formInputs.cabinCamera.value,
          camaras_interior: formInputs.interiorCamera.value,
          camara_trasera: formInputs.rearCamera.value,
          q_all_visible: formInputs.allVisible.value || null,
          q_reverse: formInputs.reverseActive.value || null,
          q_doors_open: formInputs.doorsOpen.value || null,
          q_doors_closed: formInputs.doorsClosed.value || null,
          observacion: formInputs.cameraObservations.value || null
        }, { onConflict: 'inspeccion_id' });
        
        // Guardar sección de TAG
        await sb.from('revision_semanal_tag_inspeccion').upsert({
          inspeccion_id: inspectionId,
          tag_tiene: formInputs.hasTag.value === 'yes',
          tag_serie: formInputs.tagSerial.value || null,
          observacion: formInputs.tagObservations.value || null
        }, { onConflict: 'inspeccion_id' });
        
        // Guardar sección de Mobileye (si es VOLVO)
        if ((CURRENT_BUS.marca || '').toUpperCase() === 'VOLVO') {
          await sb.from('revision_semanal_movileye_inspeccion').upsert({
            inspeccion_id: inspectionId,
            estado: formInputs.mobileyeStatus.value || null,
            alerta_izq: formInputs.leftAlert.value || null,
            alerta_der: formInputs.rightAlert.value || null,
            consola: formInputs.console.value || null,
            sensor_frontal: formInputs.frontSensor.value || null,
            sensor_izq: formInputs.leftSensor.value || null,
            sensor_der: formInputs.rightSensor.value || null,
            sensor_traser_izq_art: formInputs.rearLeftSensor.value || null,
            sensor_traser_der_art: formInputs.rearRightSensor.value || null,
            fecha_siniestro: formInputs.incidentDate.value ? new Date(formInputs.incidentDate.value).toISOString() : null,
            nro_siniestro: formInputs.incidentNumber.value || null
          }, { onConflict: 'inspeccion_id' });
        }
        
        // Guardar sección de odómetro
        await sb.from('revision_semanal_odometro_inspeccion').upsert({
          inspeccion_id: inspectionId,
          lectura_km: formInputs.odometerReading.value ? Number(formInputs.odometerReading.value) : null,
          estado_odometro: formInputs.odometerStatus.value,
          observacion: formInputs.odometerObservations.value || null
        }, { onConflict: 'inspeccion_id' });
        
        // Generar tickets de mantenimiento automáticamente
        await createMaintenanceTickets(inspectionId);
        
        // Actualizar UI
        hideLoader();
        formInputs.saveMsg.textContent = 'Guardado ✅';
        formInputs.inspectionStatus.innerHTML = `<i class="fas fa-check-circle"></i> Inspeccionado el ${new Date().toLocaleDateString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })} por ${SESSION.inspector}`;
        formInputs.inspectionStatus.className = 'chip status-completed';
        
        showNotification('success', 'Guardado Exitoso', 'Datos de la inspección guardados correctamente');
        
        // Actualizar datos
        refreshPendingInspections();
        refreshReportTables();
        
        // Registrar actividad
        logActivity({
          type: 'inspection',
          action: INSPECTION_ID ? 'update' : 'create',
          ppu: CURRENT_BUS.ppu,
          status: formInputs.globalStatus.value
        });
      } catch (err) {
        hideLoader();
        console.error('Error guardando inspección:', err);
        formInputs.saveMsg.textContent = '¡Error al guardar!';
        showNotification('error', 'Error de Guardado', 'No se pudieron guardar los datos de la inspección');
      }
    }

    // ===================== GENERACIÓN DE TICKETS DE MANTENIMIENTO =====================
    async function createMaintenanceTickets(inspectionId) {
      if (!inspectionId || !CURRENT_BUS) return;
      
      const tickets = [];
      
      // Problemas de cámaras
      const cameraIssues = [];
      
      if (formInputs.monitorCamera.value === 'NO') {
        cameraIssues.push('Monitor no muestra todas las cámaras');
      }
      
      if (formInputs.allVisible.value === 'NO') {
        cameraIssues.push('No todas las cámaras son visibles en el monitor');
      }
      
      if (formInputs.reverseActive.value === 'NO') {
        cameraIssues.push('Cámara trasera no se activa con marcha atrás');
      }
      
      if (formInputs.doorsOpen.value === 'NO') {
        cameraIssues.push('Cámaras de puertas no se activan al abrirse');
      }
      
      if (formInputs.doorsClosed.value === 'NO') {
        cameraIssues.push('No se muestran todas las cámaras con puertas cerradas');
      }
      
      ['frontCamera', 'cabinCamera', 'interiorCamera', 'rearCamera'].forEach(key => {
        const value = formInputs[key].value;
        if (value === 'dañada' || value === "no tiene") {
          const cameraName = key.replace('Camera', '').replace('front', 'delantera').replace('cabin', 'cabina').replace('interior', 'interiores').replace('rear', 'trasera');
          cameraIssues.push(`cámara ${cameraName}: ${value}`);
        }
      });
      
      if (cameraIssues.length > 0) {
        tickets.push({
          origin: 'cameras',
          component: 'Cámaras',
          description: `Reportar a SRL — ${cameraIssues.join('; ')}. Detalle del monitor: ${formInputs.monitorDetail.value || '—'}. Observaciones: ${formInputs.cameraObservations.value || '—'}`
        });
      }
      
      // Problemas de TAG
      if (formInputs.hasTag.value === 'no') {
        tickets.push({
          origin: 'tag',
          component: 'TAG',
          description: `Bus sin TAG. Observaciones: ${formInputs.tagObservations.value || '—'}`
        });
      }
      
      // Problemas de Mobileye (si es VOLVO)
      if ((CURRENT_BUS.marca || '').toUpperCase() === 'VOLVO') {
        if (formInputs.mobileyeStatus.value === 'dañado' || formInputs.mobileyeStatus.value === "no tiene") {
          tickets.push({
            origin: 'mobileye',
            component: 'Mobileye',
            description: `Estado: ${formInputs.mobileyeStatus.value}. Consola:${formInputs.console.value || '—'}; Sensores F:${formInputs.frontSensor.value || '—'} IZQ:${formInputs.leftSensor.value || '—'} DER:${formInputs.rightSensor.value || '—'} TIZQ:${formInputs.rearLeftSensor.value || '—'} TDER:${formInputs.rearRightSensor.value || '—'}.`
          });
        }
      }
      
      // Problemas de odómetro
      if (formInputs.odometerStatus.value === 'dañado' || formInputs.odometerStatus.value === 'no funciona') {
        tickets.push({
          origin: 'odometer',
          component: 'Odómetro',
          description: `Lectura:${formInputs.odometerReading.value || '—'} km; Estado:${formInputs.odometerStatus.value}. ${formInputs.odometerObservations.value || ''}`
        });
      }
      
      // Insertar tickets
      for (const ticket of tickets) {
        await sb.from('revision_semanal_tickets_mantencion').insert({
          inspeccion_id: inspectionId,
          bus_id: CURRENT_BUS.id,
          terminal: CURRENT_BUS.terminal || SESSION.terminal,
          origen: ticket.origin,
          componente: ticket.component,
          descripcion_falla: ticket.description,
          prioridad: 'medium',
          estado: 'open'
        });
      }
      
      if (tickets.length > 0) {
        showNotification('info', 'Tickets de Mantenimiento', `Se han creado automáticamente ${tickets.length} tickets de mantenimiento`);
      }
    }

    // ===================== INSPECCIONES PENDIENTES =====================
    document.getElementById('btnShowPending').addEventListener('click', () => {
      showModal(pendingModal);
      document.getElementById('pendingFilterTerminal').value = SESSION.terminal || '';
      refreshPendingList();
    });
    
    document.getElementById('btnClosePending').addEventListener('click', () => {
      hideModal(pendingModal);
    });

    document.getElementById('pendingFilterTerminal').addEventListener('change', function() {
      refreshPendingList();
    });

    async function refreshPendingList() {
      const pendingListElement = document.getElementById('pendingList');
      const selectedTerminal = document.getElementById('pendingFilterTerminal').value || SESSION.terminal;
      
      showLoader('Cargando buses pendientes...');
      
      try {
        // Obtener todos los buses del terminal
        let busQuery = sb.from('revision_semanal_buses').select('id, ppu, numero_interno, terminal, marca, modelo_chasis');
        
        if (selectedTerminal) {
          busQuery = busQuery.eq('terminal', selectedTerminal);
        }
        
        const { data: buses } = await busQuery;
        
        // Obtener inspecciones realizadas para la semana actual
        const { data: inspections } = await sb
          .from('revision_semanal_inspecciones')
          .select('bus_id, terminal')
          .eq('semana_iso', SESSION.week);
        
        // Crear un conjunto de IDs de buses inspeccionados
        const inspectedBuses = new Set((inspections || []).map(i => i.bus_id));
        
        // Filtrar buses que necesitan inspección
        const pendingBuses = (buses || []).filter(b => !inspectedBuses.has(b.id));
        
        hideLoader();
        
        pendingListCount.textContent = pendingBuses.length.toString();
        pendingCount.textContent = pendingBuses.length.toString();
        
        // Actualizar lista en el modal
        if (pendingBuses.length > 0) {
          pendingListElement.innerHTML = pendingBuses.map((bus, index) => `
            <div class="d-flex justify-between align-center" style="padding: 0.75rem 0; border-bottom: 1px solid var(--border)">
              <div class="d-flex flex-column">
                <strong>${bus.ppu}</strong>
                <span class="text-light">${bus.numero_interno || '—'} | ${bus.terminal} | ${bus.marca || '—'} ${bus.modelo_chasis || '—'}</span>
              </div>
              <button class="btn btn-primary btn-sm" data-ppu="${bus.ppu}">
                <i class="fas fa-clipboard-check"></i> Inspeccionar
              </button>
            </div>
          `).join('');
          
          // Agregar oyentes a botones de inspección
          pendingListElement.querySelectorAll('button[data-ppu]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const ppu = e.currentTarget.dataset.ppu;
              
              try {
                showLoader('Cargando bus...');
                
                const { data } = await sb
                  .from('revision_semanal_buses')
                  .select('*')
                  .eq('ppu', ppu)
                  .maybeSingle();
                
                hideLoader();
                
                if (data) {
                  selectBus(data);
                  hideModal(pendingModal);
                  showSection('inspection-form');
                }
              } catch (err) {
                hideLoader();
                console.error('Error seleccionando bus:', err);
                showNotification('error', 'Error', 'No se pudo cargar datos del bus');
              }
            });
          });
        } else {
          pendingListElement.innerHTML = '<div class="chip success" style="margin: 1rem 0; justify-content: center; width: 100%">¡No hay inspecciones pendientes! 🎉</div>';
        }
      } catch (err) {
        hideLoader();
        console.error('Error actualizando inspecciones pendientes:', err);
        pendingCount.textContent = '?';
        pendingListElement.innerHTML = '<div class="chip danger" style="margin: 1rem 0">Error al cargar inspecciones pendientes</div>';
      }
    }

    async function refreshPendingInspections() {
      if (!SESSION.terminal) {
        pendingCount.textContent = '0';
        return;
      }
      
      try {
        const { data: buses } = await sb
          .from('revision_semanal_buses')
          .select('id, terminal')
          .eq('terminal', SESSION.terminal);
        
        const { data: inspections } = await sb
          .from('revision_semanal_inspecciones')
          .select('bus_id')
          .eq('semana_iso', SESSION.week)
          .eq('terminal', SESSION.terminal);
        
        // Crear un conjunto de IDs de buses inspeccionados
        const inspectedBuses = new Set((inspections || []).map(i => i.bus_id));
        
        // Filtrar buses que necesitan inspección
        const pendingBuses = (buses || []).filter(b => !inspectedBuses.has(b.id));
        
        pendingCount.textContent = pendingBuses.length.toString();
      } catch (err) {
        console.error('Error actualizando inspecciones pendientes:', err);
        pendingCount.textContent = '?';
      }
    }

    // ===================== TABLAS DE INFORMES =====================
    // Configuración de botones de exportación
    document.getElementById('btnExportCameras').addEventListener('click', () => {
      exportTableToXLSX(`Camaras_${SESSION.week}`, HEADERS_CAMERA, 'camerasTable');
    });
    
    document.getElementById('btnExportTag').addEventListener('click', () => {
      exportTableToXLSX(`TAG_${SESSION.week}`, HEADERS_TAG, 'tagTable');
    });
    
    document.getElementById('btnExportMobileye').addEventListener('click', () => {
      exportTableToXLSX(`Mobileye_${SESSION.week}`, HEADERS_MOBILEYE, 'mobileyeTable');
    });
    
    document.getElementById('btnExportOdometer').addEventListener('click', () => {
      exportTableToXLSX(`Odometro_${SESSION.week}`, HEADERS_ODOMETER, 'odometerTable');
    });

    // Funciones para cargar datos de informes
    async function refreshReportTables() {
      if (!SESSION.terminal) return;
      
      await Promise.all([
        refreshCamerasReport(),
        refreshTagReport(),
        refreshMobileyeReport(),
        refreshOdometerReport()
      ]);
    }

    async function refreshCamerasReport(filters = {}) {
      try {
        showLoader('Cargando informe de cámaras...');
        
        // Obtener datos de inspección con join a buses
        let query = sb
          .from('revision_semanal_inspecciones')
          .select('id, bus:revision_semanal_buses(ppu, asignacion, modelo_chasis, marca, anio, terminal)')
          .eq('semana_iso', SESSION.week);
        
        // Aplicar filtros si existen
        if (SESSION.terminal && !filters.terminal) {
          query = query.eq('terminal', SESSION.terminal);
        } else if (filters.terminal) {
          query = query.eq('terminal', filters.terminal);
        }
        
        const { data: inspectionJoin, error } = await query;
        
        if (error) throw error;
        
        if (!inspectionJoin) {
          console.error('No se retornaron datos de inspección');
          hideLoader();
          return;
        }
        
        // Extraer IDs de inspección y crear mapa de inspección a bus
        const inspectionIds = inspectionJoin.map(r => r.id);
        const busesByInspection = new Map(inspectionJoin.map(r => [r.id, r.bus]));
        
        // Obtener datos de cámaras
        let cameraQuery = sb
          .from('revision_semanal_camara_inspeccion')
          .select('*, inspeccion_id')
          .in('inspeccion_id', inspectionIds);
        
        // Aplicar filtros específicos de cámara
        if (filters.monitor) {
          cameraQuery = cameraQuery.eq('monitor_camara', filters.monitor === 'SI');
        }
        
        const { data: cameraRows } = await cameraQuery;
        
        // Aplicar filtros del lado del cliente para marca
        let filteredCameraRows = cameraRows || [];
        
        if (filters.make) {
          filteredCameraRows = filteredCameraRows.filter(row => {
            const bus = busesByInspection.get(row.inspeccion_id) || {};
            return (bus.marca || '').toLowerCase() === filters.make.toLowerCase();
          });
        }
        
        // Actualizar el conteo
        cameraReportCount.textContent = filteredCameraRows.length.toString();
        cameraCount.textContent = filteredCameraRows.length.toString();
        
        // Actualizar tabla
        const cameraTableBody = document.querySelector('#camerasTable tbody');
        
        if (filteredCameraRows.length > 0) {
          cameraTableBody.innerHTML = filteredCameraRows.map((row, index) => {
            const bus = busesByInspection.get(row.inspeccion_id) || {};
            const monitorStatus = row.monitor_camara ? 'SÍ' : 'NO';
            
            return `<tr>
              <td>${index + 1}</td>
              <td>${bus.ppu || ''}</td>
              <td>${bus.terminal || ''}</td>
              <td>${bus.asignacion || ''}</td>
              <td>${bus.modelo_chasis || ''}</td>
              <td>${bus.marca || ''}</td>
              <td>${bus.anio || ''}</td>
              <td class="${monitorStatus === 'NO' ? 'text-danger fw-bold' : ''}">${monitorStatus}</td>
              <td>${row.camara_frontal || ''}</td>
              <td>${row.camara_cabina || ''}</td>
              <td>${row.camaras_interior || ''}</td>
              <td>${row.camara_trasera || ''}</td>
              <td>${row.observacion || ''}</td>
            </tr>`;
          }).join('');
        } else {
          cameraTableBody.innerHTML = '<tr><td colspan="13" class="text-center">No hay datos disponibles</td></tr>';
        }
        
        hideLoader();
      } catch (err) {
        hideLoader();
        console.error('Error actualizando informe de cámaras:', err);
        showNotification('error', 'Error', 'No se pudo cargar el informe de cámaras');
      }
    }

    async function refreshTagReport(filters = {}) {
      try {
        showLoader('Cargando informe de TAG...');
        
        // Obtener datos de inspección con join a buses
        let query = sb
          .from('revision_semanal_inspecciones')
          .select('id, bus:revision_semanal_buses(ppu, terminal)')
          .eq('semana_iso', SESSION.week);
        
        // Aplicar filtros si existen
        if (SESSION.terminal && !filters.terminal) {
          query = query.eq('terminal', SESSION.terminal);
        } else if (filters.terminal) {
          query = query.eq('terminal', filters.terminal);
        }
        
        const { data: inspectionJoin } = await query;
        
        if (!inspectionJoin) {
          console.error('No se retornaron datos de inspección');
          hideLoader();
          return;
        }
        
        // Extraer IDs de inspección y crear mapa de inspección a bus
        const inspectionIds = inspectionJoin.map(r => r.id);
        const busesByInspection = new Map(inspectionJoin.map(r => [r.id, r.bus]));
        
        // Obtener datos de TAG
        let tagQuery = sb
          .from('revision_semanal_tag_inspeccion')
          .select('*, inspeccion_id')
          .in('inspeccion_id', inspectionIds);
        
        // Aplicar filtros específicos de TAG
        if (filters.tagStatus) {
          tagQuery = tagQuery.eq('tag_tiene', filters.tagStatus === 'yes');
        }
        
        const { data: tagRows } = await tagQuery;
        
        // Actualizar conteo
        tagReportCount.textContent = (tagRows || []).length.toString();
        tagCount.textContent = (tagRows || []).length.toString();
        
        // Actualizar tabla
        const tagTableBody = document.querySelector('#tagTable tbody');
        
        if (tagRows && tagRows.length > 0) {
          tagTableBody.innerHTML = tagRows.map((row, index) => {
            const bus = busesByInspection.get(row.inspeccion_id) || {};
            const tagStatus = row.tag_tiene ? 'SÍ' : 'NO';
            
            return `<tr>
              <td>${index + 1}</td>
              <td>${bus.ppu || ''}</td>
              <td class="${!row.tag_tiene ? 'text-danger fw-bold' : ''}">${tagStatus}</td>
              <td>${row.tag_serie || ''}</td>
              <td>${row.observacion || ''}</td>
            </tr>`;
          }).join('');
        } else {
          tagTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No hay datos disponibles</td></tr>';
        }
        
        hideLoader();
      } catch (err) {
        hideLoader();
        console.error('Error actualizando informe de TAG:', err);
        showNotification('error', 'Error', 'No se pudo cargar el informe de TAG');
      }
    }

    async function refreshMobileyeReport(filters = {}) {
      try {
        showLoader('Cargando informe de Mobileye...');
        
        // Obtener datos de inspección con join a buses
        let query = sb
          .from('revision_semanal_inspecciones')
          .select('id, bus:revision_semanal_buses(ppu, modelo_chasis, marca, anio, terminal)')
          .eq('semana_iso', SESSION.week);
        
        // Aplicar filtros si existen
        if (SESSION.terminal && !filters.terminal) {
          query = query.eq('terminal', SESSION.terminal);
        } else if (filters.terminal) {
          query = query.eq('terminal', filters.terminal);
        }
        
        // Filtrar solo buses VOLVO si no hay filtro específico
        if (!filters.make) {
          query = query.eq('bus.marca', 'VOLVO');
        }
        
        const { data: inspectionJoin } = await query;
        
        if (!inspectionJoin) {
          console.error('No se retornaron datos de inspección');
          hideLoader();
          return;
        }
        
        // Extraer IDs de inspección y crear mapa de inspección a bus
        const inspectionIds = inspectionJoin.map(r => r.id);
        const busesByInspection = new Map(inspectionJoin.map(r => [r.id, r.bus]));
        
        // Obtener datos de Mobileye
        let mobileyeQuery = sb
          .from('revision_semanal_movileye_inspeccion')
          .select('*, inspeccion_id')
          .in('inspeccion_id', inspectionIds);
        
        // Aplicar filtros específicos de Mobileye
        if (filters.mobileyeStatus) {
          mobileyeQuery = mobileyeQuery.eq('estado', filters.mobileyeStatus);
        }
        
        const { data: mobileyeRows } = await mobileyeQuery;
        
        // Actualizar conteo
        mobileyeReportCount.textContent = (mobileyeRows || []).length.toString();
        mobiCount.textContent = (mobileyeRows || []).length.toString();
        
        // Actualizar tabla
        const mobileyeTableBody = document.querySelector('#mobileyeTable tbody');
        
        if (mobileyeRows && mobileyeRows.length > 0) {
          mobileyeTableBody.innerHTML = mobileyeRows.map((row) => {
            const bus = busesByInspection.get(row.inspeccion_id) || {};
            const incidentDate = row.fecha_siniestro ? new Date(row.fecha_siniestro).toLocaleDateString('es-ES') : '';
            
            // Aplicar clases para resaltar problemas
            const statusClass = row.estado === 'dañado' || row.estado === 'no tiene' ? 'text-danger fw-bold' : '';
            
            return `<tr>
              <td>${bus.ppu || ''}</td>
              <td>${row.modelo || bus.modelo_chasis || ''}</td>
              <td>${bus.marca || row.marca || ''}</td>
              <td>${bus.anio || row.anio || ''}</td>
              <td>${bus.terminal || row.terminal || ''}</td>
              <td>${row.tipo || ''}</td>
              <td>${row.alerta_izq || ''}</td>
              <td>${row.alerta_der || ''}</td>
              <td>${row.consola || ''}</td>
              <td>${row.sensor_frontal || ''}</td>
              <td>${row.sensor_izq || ''}</td>
              <td>${row.sensor_der || ''}</td>
              <td>${row.sensor_traser_izq_art || ''}</td>
              <td>${row.sensor_traser_der_art || ''}</td>
              <td>${incidentDate}</td>
              <td>${row.nro_siniestro || ''}</td>
            </tr>`;
          }).join('');
        } else {
          mobileyeTableBody.innerHTML = '<tr><td colspan="16" class="text-center">No hay datos disponibles</td></tr>';
        }
        
        hideLoader();
      } catch (err) {
        hideLoader();
        console.error('Error actualizando informe de Mobileye:', err);
        showNotification('error', 'Error', 'No se pudo cargar el informe de Mobileye');
      }
    }

    async function refreshOdometerReport(filters = {}) {
      try {
        showLoader('Cargando informe de odómetro...');
        
        // Obtener datos de inspección con join a buses
        let query = sb
          .from('revision_semanal_inspecciones')
          .select('id, bus:revision_semanal_buses(ppu, asignacion, modelo_chasis, marca, anio, terminal)')
          .eq('semana_iso', SESSION.week);
        
        // Aplicar filtros si existen
        if (SESSION.terminal && !filters.terminal) {
          query = query.eq('terminal', SESSION.terminal);
        } else if (filters.terminal) {
          query = query.eq('terminal', filters.terminal);
        }
        
        const { data: inspectionJoin } = await query;
        
        if (!inspectionJoin) {
          console.error('No se retornaron datos de inspección');
          hideLoader();
          return;
        }
        
        // Extraer IDs de inspección y crear mapa de inspección a bus
        const inspectionIds = inspectionJoin.map(r => r.id);
        const busesByInspection = new Map(inspectionJoin.map(r => [r.id, r.bus]));
        
        // Obtener datos de odómetro
        let odometerQuery = sb
          .from('revision_semanal_odometro_inspeccion')
          .select('*, inspeccion_id')
          .in('inspeccion_id', inspectionIds);
        
        // Aplicar filtros específicos de odómetro
        if (filters.odometerStatus) {
          odometerQuery = odometerQuery.eq('estado_odometro', filters.odometerStatus);
        }
        
        const { data: odometerRows } = await odometerQuery;
        
        // Actualizar conteo
        odometerReportCount.textContent = (odometerRows || []).length.toString();
        odoCount.textContent = (odometerRows || []).length.toString();
        
        // Actualizar tabla
        const odometerTableBody = document.querySelector('#odometerTable tbody');
        
        if (odometerRows && odometerRows.length > 0) {
          odometerTableBody.innerHTML = odometerRows.map((row, index) => {
            const bus = busesByInspection.get(row.inspeccion_id) || {};
            
            // Aplicar clases para resaltar problemas
            const statusClass = row.estado_odometro === 'dañado' || row.estado_odometro === 'no funciona' ? 'text-danger fw-bold' : '';
            
            return `<tr>
              <td>${index + 1}</td>
              <td>${bus.ppu || ''}</td>
              <td>${bus.terminal || ''}</td>
              <td>${bus.asignacion || ''}</td>
              <td>${bus.modelo_chasis || ''}</td>
              <td>${bus.marca || ''}</td>
              <td>${bus.anio || ''}</td>
              <td>${row.lectura_km !== null ? row.lectura_km.toLocaleString('es-ES') : ''}</td>
              <td class="${statusClass}">${row.estado_odometro || ''}</td>
              <td>${row.observacion || ''}</td>
            </tr>`;
          }).join('');
        } else {
          odometerTableBody.innerHTML = '<tr><td colspan="10" class="text-center">No hay datos disponibles</td></tr>';
        }
        
        hideLoader();
      } catch (err) {
        hideLoader();
        console.error('Error actualizando informe de odómetro:', err);
        showNotification('error', 'Error', 'No se pudo cargar el informe de odómetro');
      }
    }

    // ===================== DATOS DEL DASHBOARD =====================
    async function refreshDashboardData() {
      try {
        showLoader('Cargando dashboard...');
        
        // Filtrar por terminal si es necesario
        const terminalSelect = document.getElementById('dashboardTerminalFilter');
        const selectedTerminal = terminalSelect ? terminalSelect.value : '';
        const terminal = selectedTerminal || null;
        
        // Obtener conteo de flota
        let fleetQuery = sb
          .from('revision_semanal_buses')
          .select('id', { head: true, count: 'exact' });
        if (terminal) {
          fleetQuery = fleetQuery.eq('terminal', terminal);
        }
        const { count: totalFleet = 0, error: fleetError } = await fleetQuery;
        if (fleetError) throw fleetError;
        
        // Obtener datos de inspección para la semana actual
        let inspectionQuery = sb
          .from('revision_semanal_inspecciones')
          .select('id, bus_id, terminal, estado_global', { count: 'exact' })
          .eq('semana_iso', SESSION.week);
        
        if (terminal) {
          inspectionQuery = inspectionQuery.eq('terminal', terminal);
        }
        
        const { data: inspectionData, count: totalInspections = 0, error: inspectionError } = await inspectionQuery;
        if (inspectionError) throw inspectionError;
        
        const completionPercentage = totalFleet > 0 ? Math.round((totalInspections / totalFleet) * 100) : 0;
        
        // Contar problemas basados en estado_global
        let totalIssues = 0;
        let criticalIssues = 0;
        
        if (inspectionData) {
          totalIssues = inspectionData.filter(i => i.estado_global !== 'OK').length;
          criticalIssues = inspectionData.filter(i => i.estado_global === 'Crítico').length;
        }
        
        // Obtener datos de tickets de mantenimiento
        let ticketsQuery = sb
          .from('revision_semanal_tickets_mantencion')
          .select('id, estado, terminal', { count: 'exact' });
        if (terminal) {
          ticketsQuery = ticketsQuery.eq('terminal', terminal);
        }
        const { data: ticketsData, count: totalTickets = 0, error: ticketsError } = await ticketsQuery;
        if (ticketsError) throw ticketsError;
        
        const openTickets = ticketsData ? ticketsData.filter(t => t.estado === 'open').length : 0;
        
        // Actualizar KPIs del dashboard
        const operationalCount = Math.max(totalFleet - totalIssues, 0);
        document.getElementById('totalFleetCount').textContent = totalFleet;
        document.getElementById('operationalCount').textContent = operationalCount;
        document.getElementById('inspectionCount').textContent = totalInspections;
        document.getElementById('inspectionPercentage').textContent = `${completionPercentage}%`;
        document.getElementById('issuesCount').textContent = totalIssues;
        document.getElementById('criticalIssuesCount').textContent = criticalIssues;
        document.getElementById('ticketsCount').textContent = totalTickets;
        document.getElementById('openTicketsCount').textContent = openTickets;
        
        // Obtener datos para tabla de problemas recientes
        let recentIssuesQuery = sb
          .from('revision_semanal_tickets_mantencion')
          .select('id, bus_id, componente, descripcion_falla, estado, created_at, bus:revision_semanal_buses(ppu)');
        
        if (terminal) {
          recentIssuesQuery = recentIssuesQuery.eq('terminal', terminal);
        }
        
        const { data: recentIssues } = await recentIssuesQuery
          .order('created_at', { ascending: false })
          .limit(5);
        
        const recentIssuesTable = document.getElementById('recentIssuesTable');
        
        if (recentIssues && recentIssues.length > 0) {
          recentIssuesTable.innerHTML = recentIssues.map(issue => {
            const date = new Date(issue.created_at).toLocaleDateString('es-ES');
            let statusClass = '';
            let statusText = '';
            
            if (issue.estado === 'open') {
              statusClass = 'text-warning';
              statusText = 'Abierto';
            } else if (issue.estado === 'in_progress') {
              statusClass = 'text-primary';
              statusText = 'En Progreso';
            } else if (issue.estado === 'closed') {
              statusClass = 'text-success';
              statusText = 'Cerrado';
            }
            
            return `<tr>
              <td>${issue.bus?.ppu || '—'}</td>
              <td>${issue.componente || '—'}</td>
              <td class="text-truncate" style="max-width: 200px;">${issue.descripcion_falla ? issue.descripcion_falla.substring(0, 50) + (issue.descripcion_falla.length > 50 ? '...' : '') : '—'}</td>
              <td><span class="${statusClass} fw-bold">${statusText}</span></td>
              <td>${date}</td>
            </tr>`;
          }).join('');
        } else {
          recentIssuesTable.innerHTML = '<tr><td colspan="5" class="text-center">No hay problemas recientes</td></tr>';
        }
        
        // Obtener datos para buses pendientes de inspección
        const inspectedBusIds = new Set((inspectionData || []).map(i => i.bus_id));
        let pendingBusesQuery = sb
          .from('revision_semanal_buses')
          .select('id, ppu, numero_interno, terminal');
        
        if (terminal) {
          pendingBusesQuery = pendingBusesQuery.eq('terminal', terminal);
        }
        
        const { data: pendingBuses } = await pendingBusesQuery.limit(5);
        
        const pendingInspectionTable = document.getElementById('pendingInspectionTable');
        
        if (pendingBuses && pendingBuses.length > 0) {
          const filteredPendingBuses = pendingBuses.filter(bus => !inspectedBusIds.has(bus.id));
          
          if (filteredPendingBuses.length > 0) {
            pendingInspectionTable.innerHTML = filteredPendingBuses.map(bus => `
              <tr>
                <td>${bus.ppu || '—'}</td>
                <td>${bus.numero_interno || '—'}</td>
                <td>${bus.terminal || '—'}</td>
                <td><span class="chip chip-warning">Pendiente</span></td>
                <td>
                  <button class="btn btn-primary btn-sm" data-ppu="${bus.ppu}">Inspeccionar</button>
                </td>
              </tr>
            `).join('');
            
            // Agregar oyentes a botones de inspección
            pendingInspectionTable.querySelectorAll('button[data-ppu]').forEach(btn => {
              btn.addEventListener('click', async () => {
                const ppu = btn.dataset.ppu;
                
                try {
                  showLoader('Cargando bus...');
                  
                  const { data } = await sb
                    .from('revision_semanal_buses')
                    .select('*')
                    .eq('ppu', ppu)
                    .maybeSingle();
                  
                  hideLoader();
                  
                  if (data) {
                    selectBus(data);
                    showSection('inspection-form');
                  }
                } catch (err) {
                  hideLoader();
                  console.error('Error seleccionando bus:', err);
                  showNotification('error', 'Error', 'No se pudo cargar datos del bus');
                }
              });
            });
          } else {
            pendingInspectionTable.innerHTML = '<tr><td colspan="5" class="text-center">Todos los buses han sido inspeccionados</td></tr>';
          }
        } else {
          pendingInspectionTable.innerHTML = '<tr><td colspan="5" class="text-center">No se encontraron buses</td></tr>';
        }
        
        // Cargar lista de actividad reciente
        loadRecentActivity();
        
        // Si Chart.js está disponible, inicializar o actualizar el gráfico
        if (window.Chart && document.getElementById('inspectionByTerminalChart')) {
          // Obtener datos específicos por terminal
          const terminals = ['El Roble', 'La Reina', 'Maria Angelica', 'El Descanso'];
          const terminalCounts = [];
          
          for (const term of terminals) {
            // Obtener buses por terminal
            const { count: terminalBusCount = 0, error: terminalBusError } = await sb
              .from('revision_semanal_buses')
              .select('id', { head: true, count: 'exact' })
              .eq('terminal', term);
            if (terminalBusError) throw terminalBusError;
            
            // Obtener inspecciones por terminal
            const { count: terminalInspectionCount = 0, error: terminalInspectionError } = await sb
              .from('revision_semanal_inspecciones')
              .select('id', { head: true, count: 'exact' })
              .eq('semana_iso', SESSION.week)
              .eq('terminal', term);
            if (terminalInspectionError) throw terminalInspectionError;
            
            terminalCounts.push({
              terminal: term,
              total: terminalBusCount,
              inspected: terminalInspectionCount,
              pending: terminalBusCount - terminalInspectionCount
            });
          }
          
          // Si el gráfico ya existe, destruirlo primero
          if (window.dashboardChart) {
            window.dashboardChart.destroy();
          }
          
          // Crear nuevo gráfico
          const ctx = document.getElementById('inspectionByTerminalChart').getContext('2d');
          window.dashboardChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: terminalCounts.map(t => t.terminal),
              datasets: [
                {
                  label: 'Inspeccionados',
                  data: terminalCounts.map(t => t.inspected),
                  backgroundColor: '#3b82f6'
                },
                {
                  label: 'Pendientes',
                  data: terminalCounts.map(t => t.pending),
                  backgroundColor: '#f59e0b'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              },
              scales: {
                x: {
                  stacked: true
                },
                y: {
                  stacked: true,
                  beginAtZero: true
                }
              }
            }
          });
        }
        
        hideLoader();
      } catch (err) {
        hideLoader();
        console.error('Error actualizando dashboard:', err);
        showNotification('error', 'Error', 'No se pudo cargar los datos del dashboard');
      }
    }

    // ===================== ACTIVIDAD RECIENTE =====================
    async function loadRecentActivity() {
      const activityList = document.getElementById('activityList');
      if (!activityList) return;
      
      try {
        // Recuperar actividad reciente
        const activity = JSON.parse(localStorage.getItem('recentActivity') || '[]');
        
        if (activity.length === 0) {
          activityList.innerHTML = '<div class="text-center p-4">No hay actividad reciente para mostrar.</div>';
          return;
        }
        
        // Mostrar la actividad más reciente primero
        activity.sort((a, b) => b.timestamp - a.timestamp);
        
        // Limitar a 10 elementos
        const recentActivity = activity.slice(0, 10);
        
        // Generar HTML para cada elemento de actividad
        activityList.innerHTML = recentActivity.map(item => {
          let iconClass = 'primary';
          let icon = 'fa-clipboard-check';
          
          if (item.type === 'inspection') {
            icon = 'fa-clipboard-check';
            iconClass = item.status === 'OK' ? 'success' : item.status === 'Crítico' ? 'danger' : 'warning';
          } else if (item.type === 'ticket') {
            icon = 'fa-ticket-alt';
            iconClass = item.priority === 'critical' ? 'danger' : item.priority === 'high' ? 'warning' : 'primary';
          } else if (item.type === 'login') {
            icon = 'fa-user';
          } else if (item.type === 'logout') {
            icon = 'fa-sign-out-alt';
          }
          
          // Formatear la hora para mostrarla
          const date = new Date(item.timestamp);
          const timeStr = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
          const dateStr = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
          
          let title = '';
          let details = '';
          
          if (item.type === 'inspection') {
            title = `Inspección ${item.action === 'create' ? 'creada' : 'actualizada'}: ${item.ppu}`;
            details = `Estado: ${item.status}`;
          } else if (item.type === 'ticket') {
            title = `Ticket ${item.action}: ${item.component}`;
            details = `Bus: ${item.ppu} - Prioridad: ${item.priority}`;
          } else if (item.type === 'login') {
            title = `Sesión iniciada: ${item.inspector}`;
            details = `Terminal: ${item.terminal}`;
          } else if (item.type === 'logout') {
            title = `Sesión cerrada: ${item.inspector}`;
            details = `Terminal: ${item.terminal}`;
          }
          
          return `
            <div class="activity-item">
              <div class="activity-icon ${iconClass}">
                <i class="fas ${icon}"></i>
              </div>
              <div class="activity-content">
                <div class="activity-title">${title}</div>
                <div class="activity-details">${details}</div>
              </div>
              <div class="activity-time">${timeStr}<br>${dateStr}</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error cargando actividad reciente:', error);
        activityList.innerHTML = '<div class="text-center p-4 text-danger">Error cargando actividad reciente.</div>';
      }
    }

    function logActivity(activity) {
      try {
        // Recuperar actividad existente
        const existingActivity = JSON.parse(localStorage.getItem('recentActivity') || '[]');
        
        // Agregar nueva actividad con timestamp
        const newActivity = {
          ...activity,
          timestamp: Date.now()
        };
        
        existingActivity.unshift(newActivity);
        
        // Limitar a 50 actividades para no ocupar demasiado espacio
        if (existingActivity.length > 50) {
          existingActivity.length = 50;
        }
        
        // Guardar en localStorage
        localStorage.setItem('recentActivity', JSON.stringify(existingActivity));
      } catch (error) {
        console.error('Error guardando actividad:', error);
      }
    }

    // ===================== TICKETS DE MANTENIMIENTO =====================
    async function loadMaintenanceTickets(filters = {}) {
      try {
        showLoader('Cargando tickets de mantenimiento...');
        
        // Filtro de estado
        const statusFilter = document.getElementById('ticketStatusFilter').value || filters.status || '';
        
        // Consulta base
        let query = sb
          .from('revision_semanal_tickets_mantencion')
          .select('id, bus_id, origen, componente, descripcion_falla, prioridad, estado, created_at, updated_at, bus:revision_semanal_buses(ppu, terminal)')
          .order('created_at', { ascending: false });
        
        // Aplicar filtros
        if (SESSION.terminal && !filters.terminal) {
          query = query.eq('terminal', SESSION.terminal);
        } else if (filters.terminal) {
          query = query.eq('terminal', filters.terminal);
        }
        
        if (statusFilter) {
          query = query.eq('estado', statusFilter);
        }
        
        if (filters.component) {
          query = query.eq('componente', filters.component);
        }
        
        if (filters.priority) {
          query = query.eq('prioridad', filters.priority);
        }
        
        if (filters.dateFrom) {
          query = query.gte('created_at', filters.dateFrom);
        }
        
        const { data: tickets, error } = await query;
        
        if (error) throw error;
        
        hideLoader();
        
        const ticketsTable = document.getElementById('ticketsTable').querySelector('tbody');
        
        if (tickets && tickets.length > 0) {
          ticketsTable.innerHTML = tickets.map((ticket, index) => {
            const createdDate = new Date(ticket.created_at).toLocaleDateString('es-ES');
            let priorityClass = '';
            let priorityText = '';
            
            if (ticket.prioridad === 'low') {
              priorityClass = 'text-success';
              priorityText = 'Baja';
            } else if (ticket.prioridad === 'medium') {
              priorityClass = 'text-primary';
              priorityText = 'Media';
            } else if (ticket.prioridad === 'high') {
              priorityClass = 'text-warning';
              priorityText = 'Alta';
            } else if (ticket.prioridad === 'critical') {
              priorityClass = 'text-danger';
              priorityText = 'Crítica';
            }
            
            let statusDot = '';
            let statusText = '';
            if (ticket.estado === 'open') {
              statusDot = '<span class="status-dot status-dot-warning"></span>';
              statusText = 'Abierto';
            } else if (ticket.estado === 'in_progress') {
              statusDot = '<span class="status-dot status-dot-primary"></span>';
              statusText = 'En Progreso';
            } else if (ticket.estado === 'closed') {
              statusDot = '<span class="status-dot status-dot-success"></span>';
              statusText = 'Cerrado';
            }
            
            return `<tr>
              <td>${index + 1}</td>
              <td>${ticket.bus?.ppu || '—'}</td>
              <td>${ticket.bus?.terminal || '—'}</td>
              <td>${ticket.componente || '—'}</td>
              <td class="text-truncate" style="max-width: 300px;">${ticket.descripcion_falla || '—'}</td>
              <td class="${priorityClass} fw-bold">${priorityText}</td>
              <td><div class="table-status">${statusDot} ${statusText}</div></td>
              <td>${createdDate}</td>
              <td>
                <button class="btn btn-icon btn-light btn-sm" data-ticket="${ticket.id}" onclick="editTicket(${ticket.id})">
                  <i class="fas fa-edit"></i>
                </button>
              </td>
            </tr>`;
          }).join('');
          
          // Agregar oyentes a botones de edición
          ticketsTable.querySelectorAll('button[data-ticket]').forEach(btn => {
            btn.addEventListener('click', () => {
              const ticketId = btn.dataset.ticket;
              openTicketDetails(ticketId);
            });
          });
        } else {
          ticketsTable.innerHTML = '<tr><td colspan="9" class="text-center">No se encontraron tickets</td></tr>';
        }
      } catch (err) {
        hideLoader();
        console.error('Error cargando tickets de mantenimiento:', err);
        showNotification('error', 'Error', 'No se pudieron cargar los tickets de mantenimiento');
      }
    }

    async function openTicketDetails(ticketId) {
      try {
        showLoader('Cargando detalles del ticket...');
        
        const { data: ticket, error } = await sb
          .from('revision_semanal_tickets_mantencion')
          .select('*, bus:revision_semanal_buses(ppu)')
          .eq('id', ticketId)
          .maybeSingle();
        
        hideLoader();
        
        if (error) throw error;
        
        if (ticket) {
          // Mostrar la fecha del ticket
          const ticketDate = new Date(ticket.created_at).toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          // Poblar el modal de detalles del ticket
          document.getElementById('ticketIdDisplay').textContent = ticket.id;
          document.getElementById('ticketDateDisplay').textContent = ticketDate;
          document.getElementById('ticketBusPPU').value = ticket.bus?.ppu || '';
          document.getElementById('ticketComponent').value = ticket.componente || '';
          document.getElementById('ticketDescription').value = ticket.descripcion_falla || '';
          document.getElementById('ticketPriority').value = ticket.prioridad || 'medium';
          document.getElementById('ticketStatus').value = ticket.estado || 'open';
          document.getElementById('ticketResolution').value = ticket.resolucion || '';
          
          // Almacenar ID del ticket para operaciones de actualización/eliminación
          ticketDetailsModal.dataset.ticketId = ticketId;
          
          // Mostrar el modal
          showModal(ticketDetailsModal);
        } else {
          showNotification('error', 'Error', 'No se encontró el ticket');
        }
      } catch (err) {
        hideLoader();
        console.error('Error abriendo detalles del ticket:', err);
        showNotification('error', 'Error', 'No se pudieron cargar los detalles del ticket');
      }
    }

    document.getElementById('btnUpdateTicket').addEventListener('click', async () => {
      const ticketId = ticketDetailsModal.dataset.ticketId;
      
      if (!ticketId) {
        showNotification('error', 'Error', 'ID del ticket no encontrado');
        return;
      }
      
      try {
        showLoader('Actualizando ticket...');
        
        const priority = document.getElementById('ticketPriority').value;
        const status = document.getElementById('ticketStatus').value;
        const resolution = document.getElementById('ticketResolution').value;
        
        const { data, error } = await sb
          .from('revision_semanal_tickets_mantencion')
          .update({
            prioridad: priority,
            estado: status,
            resolucion: resolution,
            updated_at: new Date().toISOString()
          })
          .eq('id', ticketId)
          .select()
          .single();
        
        hideLoader();
        
        if (error) throw error;
        
        showNotification('success', 'Actualizado', 'Ticket actualizado correctamente');
        hideModal(ticketDetailsModal);
        loadMaintenanceTickets();
        
        // Registrar actividad
        logActivity({
          type: 'ticket',
          action: 'update',
          component: data.componente,
          ppu: document.getElementById('ticketBusPPU').value,
          priority: priority
        });
      } catch (err) {
        hideLoader();
        console.error('Error actualizando ticket:', err);
        showNotification('error', 'Error', 'No se pudo actualizar el ticket');
      }
    });

    document.getElementById('btnDeleteTicket').addEventListener('click', async () => {
      const ticketId = ticketDetailsModal.dataset.ticketId;
      
      if (!ticketId) {
        showNotification('error', 'Error', 'ID del ticket no encontrado');
        return;
      }
      
      if (confirm('¿Está seguro de que desea eliminar este ticket?')) {
        try {
          showLoader('Eliminando ticket...');
          
          // Guardar información para registro de actividad
          const component = document.getElementById('ticketComponent').value;
          const ppu = document.getElementById('ticketBusPPU').value;
          const priority = document.getElementById('ticketPriority').value;
          
          const { error } = await sb
            .from('revision_semanal_tickets_mantencion')
            .delete()
            .eq('id', ticketId);
          
          hideLoader();
          
          if (error) throw error;
          
          showNotification('success', 'Eliminado', 'Ticket eliminado correctamente');
          hideModal(ticketDetailsModal);
          loadMaintenanceTickets();
          
          // Registrar actividad
          logActivity({
            type: 'ticket',
            action: 'delete',
            component: component,
            ppu: ppu,
            priority: priority
          });
        } catch (err) {
          hideLoader();
          console.error('Error eliminando ticket:', err);
          showNotification('error', 'Error', 'No se pudo eliminar el ticket');
        }
      }
    });

    // ===================== NUEVO TICKET =====================
    document.getElementById('btnNewTicket').addEventListener('click', () => {
      // Limpiar formulario de nuevo ticket
      document.getElementById('newTicketPPU').value = '';
      document.getElementById('newTicketComponent').value = '';
      document.getElementById('newTicketDescription').value = '';
      document.getElementById('newTicketPriority').value = 'medium';
      document.getElementById('newTicketBusInfo').classList.add('hidden');
      document.getElementById('newTicketBusDisplay').textContent = '—';
      
      // Mostrar modal
      showModal(newTicketModal);
    });

    document.getElementById('btnSearchTicketBus').addEventListener('click', async () => {
      const ppu = document.getElementById('newTicketPPU').value.trim();
      if (!ppu) {
        showNotification('warning', 'Advertencia', 'Por favor, ingrese un PPU para buscar');
        return;
      }
      
      try {
        showLoader('Buscando bus...');
        
        const { data, error } = await sb
          .from('revision_semanal_buses')
          .select('*')
          .ilike('ppu', `%${ppu}%`)
          .limit(1);
        
        hideLoader();
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          const bus = data[0];
          document.getElementById('newTicketBusInfo').classList.remove('hidden');
          document.getElementById('newTicketBusDisplay').innerHTML = `
            <i class="fas fa-bus"></i>
            <span>${bus.ppu} | ${bus.marca || '—'} ${bus.modelo_chasis || '—'}</span>
          `;
          document.getElementById('newTicketPPU').dataset.busId = bus.id;
          document.getElementById('newTicketPPU').dataset.terminal = bus.terminal;
        } else {
          showNotification('error', 'No Encontrado', 'No se encontraron buses con ese PPU');
        }
      } catch (err) {
        hideLoader();
        console.error('Error buscando bus para nuevo ticket:', err);
        showNotification('error', 'Error', 'No se pudo buscar el bus');
      }
    });

    document.getElementById('btnCreateTicket').addEventListener('click', async () => {
      const busId = document.getElementById('newTicketPPU').dataset.busId;
      const terminal = document.getElementById('newTicketPPU').dataset.terminal || SESSION.terminal;
      const ppu = document.getElementById('newTicketPPU').value.trim();
      const component = document.getElementById('newTicketComponent').value;
      const description = document.getElementById('newTicketDescription').value;
      const priority = document.getElementById('newTicketPriority').value;
      
      if (!busId) {
        showNotification('warning', 'Advertencia', 'Por favor, busque y seleccione un bus válido');
        return;
      }
      
      if (!component) {
        showNotification('warning', 'Advertencia', 'Por favor, seleccione un componente');
        return;
      }
      
      if (!description) {
        showNotification('warning', 'Advertencia', 'Por favor, ingrese una descripción del problema');
        return;
      }
      
      try {
        showLoader('Creando ticket...');
        
        const { data, error } = await sb
          .from('revision_semanal_tickets_mantencion')
          .insert({
            bus_id: busId,
            terminal: terminal,
            origen: 'manual',
            componente: component,
            descripcion_falla: description,
            prioridad: priority,
            estado: 'open',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .select()
          .single();
        
        hideLoader();
        
        if (error) throw error;
        
        showNotification('success', 'Ticket Creado', 'Ticket de mantenimiento creado correctamente');
        hideModal(newTicketModal);
        loadMaintenanceTickets();
        
        // Registrar actividad
        logActivity({
          type: 'ticket',
          action: 'create',
          component: component,
          ppu: ppu,
          priority: priority
        });
      } catch (err) {
        hideLoader();
        console.error('Error creando ticket:', err);
        showNotification('error', 'Error', 'No se pudo crear el ticket');
      }
    });

    document.getElementById('btnCancelNewTicket').addEventListener('click', () => {
      hideModal(newTicketModal);
    });

    document.getElementById('newTicketModalClose').addEventListener('click', () => {
      hideModal(newTicketModal);
    });

    // ===================== ESTADO DE FLOTA =====================
    async function loadFleetStatus(filters = {}) {
      try {
        showLoader('Cargando estado de flota...');
        
        // Filtro de terminal
        const terminalFilter = document.getElementById('fleetTerminalFilter').value || filters.terminal || '';
        
        // Consulta base para buses
        let query = sb
          .from('revision_semanal_buses')
          .select('*');
        
        // Aplicar filtros
        if (SESSION.terminal && !terminalFilter) {
          query = query.eq('terminal', SESSION.terminal);
        } else if (terminalFilter) {
          query = query.eq('terminal', terminalFilter);
        }
        
        if (filters.make) {
          query = query.ilike('marca', `%${filters.make}%`);
        }
        
        if (filters.year) {
          query = query.eq('anio', filters.year);
        }
        
        const { data: buses, error } = await query;
        
        if (error) throw error;
        
        // Obtener datos de inspección para la semana actual
        const { data: inspections } = await sb
          .from('revision_semanal_inspecciones')
          .select('id, bus_id, estado_global, fecha_inspeccion')
          .eq('semana_iso', SESSION.week);
        
        // Crear un mapa de bus_id a datos de inspección
        const inspectionMap = new Map();
        if (inspections) {
          inspections.forEach(insp => inspectionMap.set(insp.bus_id, insp));
        }
        
        // Obtener datos de odómetro
        const { data: odometers } = await sb
          .from('revision_semanal_odometro_inspeccion')
          .select('inspeccion_id, lectura_km, estado_odometro')
          .eq('semana_iso', SESSION.week);
        
        // Crear un mapa de inspection_id a datos de odómetro
        const odometerMap = new Map();
        if (odometers) {
          odometers.forEach(odo => odometerMap.set(odo.inspeccion_id, odo));
        }
        
        // Obtener tickets de mantenimiento
        const { data: tickets } = await sb
          .from('revision_semanal_tickets_mantencion')
          .select('bus_id, estado')
          .neq('estado', 'closed');
        
        // Contar tickets abiertos por bus
        const ticketCountMap = new Map();
        if (tickets) {
          tickets.forEach(ticket => {
            const busId = ticket.bus_id;
            if (!ticketCountMap.has(busId)) {
              ticketCountMap.set(busId, 0);
            }
            ticketCountMap.set(busId, ticketCountMap.get(busId) + 1);
          });
        }
        
        hideLoader();
        
        // Actualizar estadísticas de flota
        const totalBuses = buses ? buses.length : 0;
        let operationalCount = 0;
        let maintenanceCount = 0;
        let criticalCount = 0;
        
        if (buses && inspections) {
          buses.forEach(bus => {
            const inspection = inspectionMap.get(bus.id);
            
            if (!inspection) {
              operationalCount++; // Asumir operativo si no está inspeccionado
            } else if (inspection.estado_global === 'OK') {
              operationalCount++;
            } else if (inspection.estado_global === 'Crítico') {
              criticalCount++;
            } else {
              maintenanceCount++;
            }
          });
        }
        
        document.getElementById('fleetTotalCount').textContent = totalBuses;
        document.getElementById('fleetOperationalCount').textContent = operationalCount;
        document.getElementById('fleetMaintenanceCount').textContent = maintenanceCount;
        document.getElementById('fleetCriticalCount').textContent = criticalCount;
        
        // Poblar el selector de años si es la primera vez
        const yearFilter = document.getElementById('fleetYearFilter');
        if (yearFilter.options.length <= 1) {
          const years = new Set();
          buses.forEach(bus => {
            if (bus.anio) {
              years.add(bus.anio.toString());
            }
          });
          
          const sortedYears = Array.from(years).sort().reverse();
          sortedYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
          });
        }
        
        // Filtrar por estado si es necesario
        let displayBuses = [...buses];
        if (filters.status) {
          displayBuses = displayBuses.filter(bus => {
            const inspection = inspectionMap.get(bus.id);
            if (filters.status === 'Operational') {
              return !inspection || inspection.estado_global === 'OK';
            } else if (filters.status === 'Maintenance') {
              return inspection && inspection.estado_global === 'Observaciones';
            } else if (filters.status === 'Critical') {
              return inspection && inspection.estado_global === 'Crítico';
            }
            return true;
          });
        }
        
        // Poblar tabla de estado de flota
        const fleetTable = document.getElementById('fleetStatusTable').querySelector('tbody');
        
        if (displayBuses.length > 0) {
          fleetTable.innerHTML = displayBuses.map(bus => {
            const inspection = inspectionMap.get(bus.id);
            const inspectionDate = inspection ? new Date(inspection.fecha_inspeccion).toLocaleDateString('es-ES') : '—';
            
            let status = 'Operativo';
            let statusClass = 'text-success';
            
            if (inspection) {
              if (inspection.estado_global === 'Crítico') {
                status = 'Problemas Críticos';
                statusClass = 'text-danger';
              } else if (inspection.estado_global === 'Observaciones') {
                status = 'Mantenimiento Necesario';
                statusClass = 'text-warning';
              }
            } else {
              status = 'Sin Inspección';
              statusClass = '';
            }
            
            // Obtener lectura del odómetro
            let odometerReading = '—';
            if (inspection) {
              const odometer = odometerMap.get(inspection.id);
              if (odometer && odometer.lectura_km !== null) {
                odometerReading = `${odometer.lectura_km.toLocaleString('es-ES')} km`;
              }
            }
            
            // Obtener conteo de tickets abiertos
            const openTickets = ticketCountMap.get(bus.id) || 0;
            
            return `<tr>
              <td>${bus.ppu || '—'}</td>
              <td>${bus.numero_interno || '—'}</td>
              <td>${bus.marca || '—'} ${bus.modelo_chasis || '—'}</td>
              <td>${bus.anio || '—'}</td>
              <td>${bus.terminal || '—'}</td>
              <td>${inspectionDate}</td>
              <td class="${statusClass} fw-bold">${status}</td>
              <td>${odometerReading}</td>
              <td>${openTickets > 0 ? `<span class="badge badge-warning">${openTickets}</span>` : '0'}</td>
              <td>
                <button class="btn btn-sm btn-primary" data-ppu="${bus.ppu}">
                  <i class="fas fa-clipboard-check"></i> Inspeccionar
                </button>
              </td>
            </tr>`;
          }).join('');
          
          // Agregar oyentes a botones de inspección
          fleetTable.querySelectorAll('button[data-ppu]').forEach(btn => {
            btn.addEventListener('click', async () => {
              const ppu = btn.dataset.ppu;
              
              try {
                showLoader('Cargando bus...');
                
                const { data } = await sb
                  .from('revision_semanal_buses')
                  .select('*')
                  .eq('ppu', ppu)
                  .maybeSingle();
                
                hideLoader();
                
                if (data) {
                  selectBus(data);
                  showSection('inspection-form');
                }
              } catch (err) {
                hideLoader();
                console.error('Error seleccionando bus:', err);
                showNotification('error', 'Error', 'No se pudo cargar datos del bus');
              }
            });
          });
        } else {
          fleetTable.innerHTML = '<tr><td colspan="10" class="text-center">No se encontraron buses</td></tr>';
        }
      } catch (err) {
        hideLoader();
        console.error('Error cargando estado de flota:', err);
        showNotification('error', 'Error', 'No se pudo cargar datos de la flota');
      }
    }

    // ===================== PREFERENCIAS DE USUARIO =====================
    function loadUserSettings() {
      try {
        // Cargar datos de la sesión actual
        document.getElementById('settingsName').value = SESSION.inspector || '';
        document.getElementById('settingsTerminal').value = SESSION.terminal || '';
        
        // Cargar preferencia de tema
        const theme = localStorage.getItem('theme') || 'light';
        document.querySelector(`input[name="theme"][value="${theme}"]`).checked = true;
        
        // Cargar preferencias de notificaciones
        document.getElementById('notifTickets').checked = localStorage.getItem('notifTickets') !== 'false';
        document.getElementById('notifInspections').checked = localStorage.getItem('notifInspections') !== 'false';
        document.getElementById('notifCritical').checked = localStorage.getItem('notifCritical') !== 'false';
        
        // Cargar vista predeterminada
        document.getElementById('settingsDefaultView').value = localStorage.getItem('defaultView') || 'inspection-form';
      } catch (error) {
        console.error('Error cargando preferencias de usuario:', error);
        showNotification('error', 'Error', 'No se pudieron cargar las preferencias de usuario');
      }
    }

    document.getElementById('btnSaveSettings').addEventListener('click', () => {
      try {
        // Guardar nombre y terminal
        const name = document.getElementById('settingsName').value;
        const terminal = document.getElementById('settingsTerminal').value;
        
        if (name && terminal) {
          SESSION.inspector = name;
          SESSION.terminal = terminal;
          userInfo.textContent = `${name} · ${terminal}`;
          
          localStorage.setItem('session', JSON.stringify({
            inspector: name,
            terminal: terminal
          }));
        }
        
        // Guardar tema
        const theme = document.querySelector('input[name="theme"]:checked').value;
        localStorage.setItem('theme', theme);
        SESSION.theme = theme;
        applyTheme(theme);
        
        // Guardar preferencias de notificaciones
        localStorage.setItem('notifTickets', document.getElementById('notifTickets').checked);
        localStorage.setItem('notifInspections', document.getElementById('notifInspections').checked);
        localStorage.setItem('notifCritical', document.getElementById('notifCritical').checked);
        
        // Guardar vista predeterminada
        localStorage.setItem('defaultView', document.getElementById('settingsDefaultView').value);
        
        showNotification('success', 'Preferencias Guardadas', 'Tus preferencias han sido guardadas correctamente');
        
        // Actualizar datos basados en las nuevas preferencias
        refreshPendingInspections();
        refreshReportTables();
      } catch (error) {
        console.error('Error guardando preferencias:', error);
        showNotification('error', 'Error', 'No se pudieron guardar las preferencias');
      }
    });

    document.getElementById('btnResetSettings').addEventListener('click', () => {
      if (confirm('¿Está seguro de que desea restablecer todas las preferencias?')) {
        // Restablecer valores en formulario
        document.getElementById('settingsName').value = '';
        document.getElementById('settingsTerminal').value = '';
        document.querySelector('input[name="theme"][value="system"]').checked = true;
        document.getElementById('notifTickets').checked = true;
        document.getElementById('notifInspections').checked = true;
        document.getElementById('notifCritical').checked = true;
        document.getElementById('settingsDefaultView').value = 'inspection-form';
        
        // Restablecer localStorage
        localStorage.removeItem('session');
        localStorage.removeItem('theme');
        localStorage.removeItem('notifTickets');
        localStorage.removeItem('notifInspections');
        localStorage.removeItem('notifCritical');
        localStorage.removeItem('defaultView');
        
        // Actualizar estado
        SESSION.inspector = '';
        SESSION.terminal = '';
        SESSION.theme = 'system';
        
        userInfo.textContent = '—';
        applyTheme('system');
        
        showNotification('success', 'Preferencias Restablecidas', 'Todas las preferencias han sido restablecidas a valores predeterminados');
      }
    });

    // ===================== FILTROS =====================
    function setupFilters() {
      // Oyentes para botones de filtro
      document.getElementById('applyCamerasFilters')?.addEventListener('click', () => {
        const filters = {
          terminal: document.getElementById('camerasTerminalFilter')?.value || '',
          make: document.getElementById('camerasMakeFilter')?.value || '',
          monitor: document.getElementById('camerasMonitorFilter')?.value || ''
        };
        FILTER_STATES.cameras = filters;
        refreshCamerasReport(filters);
      });
      
      document.getElementById('resetCamerasFilters')?.addEventListener('click', () => {
        document.getElementById('camerasTerminalFilter').value = '';
        document.getElementById('camerasMakeFilter').value = '';
        document.getElementById('camerasMonitorFilter').value = '';
        FILTER_STATES.cameras = {};
        refreshCamerasReport();
      });
      
      document.getElementById('applyTagFilters')?.addEventListener('click', () => {
        const filters = {
          terminal: document.getElementById('tagTerminalFilter')?.value || '',
          tagStatus: document.getElementById('tagStatusFilter')?.value || ''
        };
        FILTER_STATES.tag = filters;
        refreshTagReport(filters);
      });
      
      document.getElementById('resetTagFilters')?.addEventListener('click', () => {
        document.getElementById('tagTerminalFilter').value = '';
        document.getElementById('tagStatusFilter').value = '';
        FILTER_STATES.tag = {};
        refreshTagReport();
      });
      
      document.getElementById('applyMobileyeFilters')?.addEventListener('click', () => {
        const filters = {
          terminal: document.getElementById('mobileyeTerminalFilter')?.value || '',
          mobileyeStatus: document.getElementById('mobileyeStatusFilter')?.value || ''
        };
        FILTER_STATES.mobileye = filters;
        refreshMobileyeReport(filters);
      });
      
      document.getElementById('resetMobileyeFilters')?.addEventListener('click', () => {
        document.getElementById('mobileyeTerminalFilter').value = '';
        document.getElementById('mobileyeStatusFilter').value = '';
        FILTER_STATES.mobileye = {};
        refreshMobileyeReport();
      });
      
      document.getElementById('applyOdometerFilters')?.addEventListener('click', () => {
        const filters = {
          terminal: document.getElementById('odometerTerminalFilter')?.value || '',
          odometerStatus: document.getElementById('odometerStatusFilter')?.value || ''
        };
        FILTER_STATES.odometer = filters;
        refreshOdometerReport(filters);
      });
      
      document.getElementById('resetOdometerFilters')?.addEventListener('click', () => {
        document.getElementById('odometerTerminalFilter').value = '';
        document.getElementById('odometerStatusFilter').value = '';
        FILTER_STATES.odometer = {};
        refreshOdometerReport();
      });
      
      document.getElementById('applyTicketsFilters')?.addEventListener('click', () => {
        const filters = {
          status: document.getElementById('ticketStatusFilter')?.value || '',
          terminal: document.getElementById('ticketsTerminalFilter')?.value || '',
          component: document.getElementById('ticketsComponentFilter')?.value || '',
          priority: document.getElementById('ticketsPriorityFilter')?.value || '',
          dateFrom: document.getElementById('ticketsDateFrom')?.value || ''
        };
        FILTER_STATES.tickets = filters;
        loadMaintenanceTickets(filters);
      });
      
      document.getElementById('resetTicketsFilters')?.addEventListener('click', () => {
        document.getElementById('ticketStatusFilter').value = '';
        document.getElementById('ticketsTerminalFilter').value = '';
        document.getElementById('ticketsComponentFilter').value = '';
        document.getElementById('ticketsPriorityFilter').value = '';
        document.getElementById('ticketsDateFrom').value = '';
        FILTER_STATES.tickets = {};
        loadMaintenanceTickets();
      });
      
      document.getElementById('applyFleetFilters')?.addEventListener('click', () => {
        const filters = {
          terminal: document.getElementById('fleetTerminalFilter')?.value || '',
          make: document.getElementById('fleetMakeFilter')?.value || '',
          status: document.getElementById('fleetStatusFilter')?.value || '',
          year: document.getElementById('fleetYearFilter')?.value || ''
        };
        FILTER_STATES.fleet = filters;
        loadFleetStatus(filters);
      });
      
      document.getElementById('resetFleetFilters')?.addEventListener('click', () => {
        document.getElementById('fleetTerminalFilter').value = '';
        document.getElementById('fleetMakeFilter').value = '';
        document.getElementById('fleetStatusFilter').value = '';
        document.getElementById('fleetYearFilter').value = '';
        FILTER_STATES.fleet = {};
        loadFleetStatus();
      });
      
      // Oyente para cambios en el filtro de estado de tickets
      document.getElementById('ticketStatusFilter')?.addEventListener('change', () => {
        const status = document.getElementById('ticketStatusFilter').value;
        FILTER_STATES.tickets.status = status;
        loadMaintenanceTickets(FILTER_STATES.tickets);
      });
      
      // Oyente para cambios en el filtro de terminal de flota
      document.getElementById('fleetTerminalFilter')?.addEventListener('change', () => {
        const terminal = document.getElementById('fleetTerminalFilter').value;
        FILTER_STATES.fleet.terminal = terminal;
        loadFleetStatus(FILTER_STATES.fleet);
      });
    }

    // ===================== UTILIDADES MODAL =====================
    function showModal(modal, noBackdrop = false) {
      if (!modal) return;
      modal.classList.add('show');
      
      if (!noBackdrop) {
        modalBackdrop.classList.add('show');
      }
    }

    function hideModal(modal) {
      if (!modal) return;
      modal.classList.remove('show');
      modalBackdrop.classList.remove('show');
    }

    function openLoginModal() {
      showModal(loginModal, true);
      
      const nameInput = document.getElementById('inspectorName');
      const terminalSelect = document.getElementById('inspectorTerminal');
      
      if (nameInput) {
        nameInput.disabled = false;
        nameInput.removeAttribute('readonly');
        if (SESSION.inspector) {
          nameInput.value = SESSION.inspector;
        } else {
          nameInput.value = '';
        }
        requestAnimationFrame(() => nameInput.focus());
      }
      
      if (terminalSelect) {
        terminalSelect.disabled = false;
        if (SESSION.terminal) {
          terminalSelect.value = SESSION.terminal;
        } else {
          terminalSelect.value = '';
        }
      }
    }

    // Configurar botones de cierre de modales
    document.querySelectorAll('.modal-close, #loginModalClose, #pendingModalClose, #busStatusModalClose, #ticketDetailsModalClose').forEach(btn => {
      btn.addEventListener('click', () => {
        const modal = btn.closest('.modal');
        hideModal(modal);
      });
    });

    // Cerrar modales al hacer clic fuera
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          hideModal(modal);
        }
      });
    });

    // ===================== INICIALIZACIÓN =====================
    // Inicializar la aplicación
    document.addEventListener('DOMContentLoaded', () => {
      initialize();
      
      // Registrar actividad de inicio de sesión si hay sesión activa
      if (SESSION.inspector && SESSION.terminal) {
        logActivity({
          type: 'login',
          inspector: SESSION.inspector,
          terminal: SESSION.terminal
        });
      }
    });

    // Hacer funciones disponibles globalmente para manejo de eventos
    window.editTicket = openTicketDetails;
    window.showNotification = showNotification;
    window.showSection = showSection;
  </script>
</body>
</html>
