<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Avanzado de Inspecci√≥n de Buses</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>

:root {
  /* Core Brand Colors */
  --primary: #2563eb;
  --primary-light: #3b82f6;
  --primary-dark: #1e40af;
  --primary-50: #eff6ff;
  --primary-100: #dbeafe;
  --primary-200: #bfdbfe;
  --primary-300: #93c5fd;
  --primary-400: #60a5fa;
  
  /* Status Colors */
  --success: #059669;
  --success-light: #10b981;
  --success-50: #ecfdf5;
  --success-100: #d1fae5;
  --warning: #d97706;
  --warning-light: #f59e0b;
  --warning-50: #fffbeb;
  --warning-100: #fef3c7;
  --danger: #dc2626;
  --danger-light: #ef4444;
  --danger-50: #fef2f2;
  --danger-100: #fee2e2;
  --info: #0284c7;
  --info-light: #0ea5e9;
  --info-50: #f0f9ff;
  --info-100: #e0f2fe;
  
  /* Professional Grayscale */
  --dark: #0f172a;
  --dark-light: #1e293b;
  --text: #334155;
  --text-light: #64748b;
  --text-lighter: #94a3b8;
  --bg: #f8fafc;
  --bg-darker: #f1f5f9;
  --bg-panel: #ffffff;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  
  /* Enterprise-grade Shadows */
  --shadow-xs: 0 1px 2px rgba(15, 23, 42, 0.05);
  --shadow-sm: 0 2px 4px rgba(15, 23, 42, 0.06);
  --shadow: 0 4px 6px rgba(15, 23, 42, 0.07), 0 1px 3px rgba(15, 23, 42, 0.1);
  --shadow-md: 0 8px 10px rgba(15, 23, 42, 0.07), 0 3px 6px rgba(15, 23, 42, 0.08);
  --shadow-lg: 0 20px 25px -5px rgba(15, 23, 42, 0.07), 0 10px 10px -5px rgba(15, 23, 42, 0.02);
  --shadow-xl: 0 25px 50px -12px rgba(15, 23, 42, 0.15);
  
  /* Professional Radii */
  --radius-sm: 0.375rem;
  --radius: 0.5rem;
  --radius-md: 0.75rem;
  --radius-lg: 1rem;
  --radius-xl: 1.5rem;
  
  /* Professional Transitions */
  --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  
  /* Enhanced Spacing System */
  --spacing-1: 0.25rem;
  --spacing-2: 0.5rem;
  --spacing-3: 0.75rem;
  --spacing-4: 1rem;
  --spacing-5: 1.25rem;
  --spacing-6: 1.5rem;
  --spacing-8: 2rem;
  --spacing-10: 2.5rem;
  --spacing-12: 3rem;
  --spacing-16: 4rem;
  
  /* Typography */
  --font-family: 'Outfit', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  
  /* Z-index system */
  --z-dropdown: 1000;
  --z-sticky: 1020;
  --z-fixed: 1030;
  --z-modal-backdrop: 1040;
  --z-modal: 1050;
  --z-popover: 1060;
  --z-tooltip: 1070;
  --z-toast: 1080;
  
  /* Mobile Navbar */
  --mobile-navbar-height: calc(64px + env(safe-area-inset-top));
  --mobile-bottom-nav-height: 60px;
}

/* Dark Mode Enhancement */
.dark-mode {
  --primary: #3b82f6;
  --primary-light: #60a5fa;
  --primary-dark: #1d4ed8;
  --primary-50: #172554;
  --primary-100: #1e3a8a;
  --primary-200: #1e40af;
  --primary-300: #2563eb;
  --primary-400: #3b82f6;
  
  --success: #10b981;
  --success-light: #34d399;
  --success-50: #064e3b;
  --success-100: #065f46;
  
  --warning: #f59e0b;
  --warning-light: #fbbf24;
  --warning-50: #78350f;
  --warning-100: #92400e;
  
  --danger: #ef4444;
  --danger-light: #f87171;
  --danger-50: #7f1d1d;
  --danger-100: #991b1b;
  
  --info: #0ea5e9;
  --info-light: #38bdf8;
  --info-50: #0c4a6e;
  --info-100: #075985;
  
  --dark: #f8fafc;
  --dark-light: #f1f5f9;
  --text: #e2e8f0;
  --text-light: #94a3b8;
  --text-lighter: #64748b;
  --bg: #0f172a;
  --bg-darker: #1e293b;
  --bg-panel: #1e293b;
  --border: #334155;
  --border-light: #1e293b;
}

/* =========== Global Reset & Base Styles =========== */
*, *::before, *::after { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
  -webkit-tap-highlight-color: transparent;
  height: 100%;
  overscroll-behavior: none;
}

body {
  font-family: var(--font-family);
  font-size: 0.9375rem;
  line-height: 1.6;
  color: var(--text);
  background-color: var(--bg);
  min-height: 100vh;
  height: 100%;
  letter-spacing: -0.01em;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  transition: var(--transition);
  overflow-x: hidden;
  position: relative;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

input, button, textarea, select {
  font: inherit;
  color: inherit;
}

a {
  color: var(--primary);
  text-decoration: none;
  transition: var(--transition-fast);
}

a:hover {
  color: var(--primary-dark);
}

/* =========== Typography =========== */
h1, h2, h3, h4, h5, h6 {
  color: var(--dark);
  font-weight: 700;
  line-height: 1.3;
  margin-bottom: 0.5rem;
  letter-spacing: -0.025em;
}

h1 { font-size: 1.75rem; }
h2 { font-size: 1.5rem; }
h3 { font-size: 1.25rem; }
h4 { font-size: 1.125rem; }
h5 { font-size: 1rem; }
h6 { font-size: 0.875rem; }

@media (min-width: 768px) {
  h1 { font-size: 2.25rem; }
  h2 { font-size: 1.875rem; }
  h3 { font-size: 1.5rem; }
  h4 { font-size: 1.25rem; }
  h5 { font-size: 1.125rem; }
  h6 { font-size: 1rem; }
}

p { margin-bottom: 1rem; }

strong, b { font-weight: 600; }

/* =========== Layout Framework =========== */
.app-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  width: 100%;
  position: relative;
  overflow-x: hidden;
}

.main-layout {
  display: flex;
  flex-direction: column;
  flex: 1;
  position: relative;
  height: calc(100vh - var(--mobile-navbar-height));
  padding-bottom: calc(var(--mobile-bottom-nav-height) + env(safe-area-inset-bottom));
}

@media (min-width: 1024px) {
  .main-layout {
    flex-direction: row;
    padding-bottom: 0;
    height: calc(100vh - 64px);
  }
}

.content-area {
  flex: 1;
  padding: var(--spacing-3);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-4);
  position: relative;
  height: 100%;
  /* Critical fix: Ensure proper padding at bottom to prevent overlap with mobile nav */
  padding-bottom: calc(var(--mobile-bottom-nav-height) + var(--spacing-6) + env(safe-area-inset-bottom));
}

@media (min-width: 768px) {
  .content-area {
    padding: var(--spacing-4);
    gap: var(--spacing-5);
  }
}

@media (min-width: 1024px) {
  .content-area {
    padding: var(--spacing-6);
    gap: var(--spacing-6);
    padding-bottom: var(--spacing-6);
  }
}

/* =========== Header & Navigation =========== */
.app-header {
  background: linear-gradient(135deg, var(--primary-dark), var(--primary));
  color: white;
  height: var(--mobile-navbar-height);
  display: flex;
  align-items: center;
  padding: 0 var(--spacing-3);
  box-shadow: var(--shadow);
  position: relative;
  z-index: var(--z-fixed);
}

@media (min-width: 768px) {
  .app-header {
    padding: 0 var(--spacing-4);
  }
}

@media (min-width: 1024px) {
  .app-header {
    padding: 0 var(--spacing-6);
  }
}

.header-brand {
  font-weight: 700;
  font-size: 1rem;
  display: flex;
  align-items: center;
  margin-right: auto;
  gap: var(--spacing-2);
}

@media (min-width: 768px) {
  .header-brand {
    font-size: 1.25rem;
    gap: var(--spacing-3);
  }
}

.header-logo {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  background: rgba(255,255,255,0.2);
  border-radius: var(--radius);
  backdrop-filter: blur(10px);
}

.header-actions {
  display: flex;
  gap: var(--spacing-2);
  align-items: center;
}

@media (min-width: 768px) {
  .header-actions {
    gap: var(--spacing-3);
  }
}

@media (min-width: 1024px) {
  .header-actions {
    gap: var(--spacing-4);
  }
}

/* Fix for mobile pending button */
#btnShowPending {
  display: none;
  white-space: nowrap;
}

@media (min-width: 640px) {
  #btnShowPending {
    display: flex;
  }
}

.theme-toggle {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 1.25rem;
  padding: var(--spacing-2);
  border-radius: var(--radius);
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.theme-toggle:hover {
  background: rgba(255,255,255,0.2);
}

.mobile-nav-toggle {
  display: flex;
  cursor: pointer;
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  z-index: var(--z-fixed);
  width: 40px;
  height: 40px;
  align-items: center;
  justify-content: center;
}

@media (min-width: 1024px) {
  .mobile-nav-toggle {
    display: none;
  }
}

/* Enhanced Sidebar */
.sidebar {
  background-color: var(--bg-panel);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  padding: var(--spacing-4);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-6);
  box-shadow: var(--shadow-sm);
  z-index: var(--z-fixed);
  position: fixed;
  top: var(--mobile-navbar-height);
  left: -280px;
  height: calc(100vh - var(--mobile-navbar-height));
  width: 280px;
  transition: var(--transition);
}

.sidebar.show {
  left: 0;
  box-shadow: var(--shadow-lg);
}

@media (min-width: 1024px) {
  .sidebar {
    position: static;
    width: 280px;
    padding: var(--spacing-5);
    left: 0;
  }
}

.sidebar-section {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-1);
}

.sidebar-title {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-light);
  padding: var(--spacing-2) var(--spacing-3);
  margin-bottom: var(--spacing-1);
}

.nav-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-3);
  padding: var(--spacing-3) var(--spacing-4);
  border-radius: var(--radius);
  color: var(--text);
  font-weight: 500;
  transition: var(--transition);
  text-decoration: none;
  cursor: pointer;
}

.nav-item:hover {
  background-color: var(--bg-darker);
  color: var(--primary);
}

.nav-item.active {
  background-color: var(--primary-50);
  color: var(--primary);
  font-weight: 600;
}

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 4px;
  background-color: var(--primary);
  border-radius: 0 var(--radius) var(--radius) 0;
}

.nav-item i {
  font-size: 1.25rem;
  width: 1.5rem;
  text-align: center;
}

.nav-item .badge {
  margin-left: auto;
}

/* Mobile Bottom Navigation */
.mobile-bottom-nav {
  display: flex;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: var(--bg-panel);
  border-top: 1px solid var(--border);
  height: var(--mobile-bottom-nav-height);
  z-index: var(--z-fixed);
  box-shadow: var(--shadow-lg);
  padding: 0 var(--spacing-2);
  padding-bottom: env(safe-area-inset-bottom);
}

@media (min-width: 1024px) {
  .mobile-bottom-nav {
    display: none;
  }
}

.mobile-bottom-nav .nav-items {
  display: flex;
  justify-content: space-between;
  width: 100%;
  gap: var(--spacing-2);
  overflow-x: auto;
  padding: 0 var(--spacing-1);
  -webkit-overflow-scrolling: touch;
}

.mobile-bottom-nav .nav-item {
  flex-direction: column;
  padding: var(--spacing-2) var(--spacing-1);
  gap: var(--spacing-1);
  font-size: 0.7rem;
  text-align: center;
  height: 100%;
  border-radius: 0;
  flex: 0 0 auto;
  min-width: 72px;
}

.mobile-bottom-nav .nav-item i {
  font-size: 1.25rem;
  margin-right: 0;
  width: auto;
}

/* Floating Action Button */

.fab-button {
  display: flex;
  position: fixed;
  right: var(--spacing-4);
  bottom: calc(var(--mobile-bottom-nav-height) + var(--spacing-4) + env(safe-area-inset-bottom));
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background-color: var(--primary);
  color: white;
  box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
  z-index: calc(var(--z-fixed) + 1);
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  transition: var(--transition);
  align-items: center;
  justify-content: center;
  overflow: visible;
}

.fab-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(30, 64, 175, 0.5);
}

.fab-button.fab-pending {
  background-color: var(--warning);
}

.fab-button.fab-pending:hover {
  box-shadow: 0 8px 20px rgba(217, 119, 6, 0.5);
}

@media (min-width: 1024px) {
  .fab-button {
    display: none;
  }
}

.fab-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background-color: var(--danger);
  color: #fff;
  min-width: 22px;
  height: 22px;
  padding: 0 6px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 700;
  box-shadow: var(--shadow);
  transition: var(--transition-fast);
  pointer-events: none;
}

.fab-badge.hidden {
  opacity: 0;
  transform: scale(0.5);
}


/* Mobile Header Menu Button */
.toggle-icon {
  position: relative;
  width: 18px;
  height: 14px;
}

.toggle-icon span {
  position: absolute;
  height: 2px;
  width: 100%;
  background: white;
  border-radius: 2px;
  display: block;
  transition: all 0.3s ease-in-out;
}

.toggle-icon span:nth-child(1) { top: 0; }
.toggle-icon span:nth-child(2) { top: 6px; }
.toggle-icon span:nth-child(3) { top: 12px; }

.toggle-active span:nth-child(1) {
  transform: rotate(45deg);
  top: 6px;
}

.toggle-active span:nth-child(2) {
  opacity: 0;
}

.toggle-active span:nth-child(3) {
  transform: rotate(-45deg);
  top: 6px;
}

/* Global Search - Mobile Optimized */
.global-search {
  position: relative;
  margin-right: var(--spacing-2);
  display: none;
  width: 100%;
  max-width: 200px;
}

@media (min-width: 768px) {
  .global-search {
    display: block;
    max-width: 240px;
  }
}

@media (min-width: 1024px) {
  .global-search {
    margin-right: var(--spacing-4);
    max-width: 280px;
  }
}

.search-input {
  padding: var(--spacing-2) var(--spacing-4);
  padding-left: 2.5rem;
  background-color: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: var(--radius);
  color: white;
  width: 100%;
  backdrop-filter: blur(10px);
  transition: var(--transition);
}

.search-input::placeholder {
  color: rgba(255, 255, 255, 0.7);
}

.search-input:focus {
  outline: none;
  background-color: rgba(255, 255, 255, 0.15);
  box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
}

.search-icon {
  position: absolute;
  left: var(--spacing-3);
  top: 50%;
  transform: translateY(-50%);
  color: rgba(255, 255, 255, 0.7);
}

/* =========== Cards & Panels =========== */
.card {
  background-color: var(--bg-panel);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  padding: var(--spacing-4);
  transition: var(--transition);
  overflow: hidden;
  width: 100%;
}

@media (min-width: 768px) {
  .card {
    padding: var(--spacing-5);
  }
}

@media (min-width: 1024px) {
  .card {
    padding: var(--spacing-6);
  }
}

.card:hover {
  box-shadow: var(--shadow-md);
}

.card-header {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-3);
  padding-bottom: var(--spacing-4);
  margin-bottom: var(--spacing-4);
  border-bottom: 1px solid var(--border-light);
}

@media (min-width: 768px) {
  .card-header {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding-bottom: var(--spacing-5);
    margin-bottom: var(--spacing-5);
  }
}

.card-title {
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--dark);
  margin: 0;
}

/* Stats Cards Grid - Responsive */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--spacing-4);
  width: 100%;
}

@media (min-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 768px) {
  .stats-grid {
    gap: var(--spacing-5);
  }
}

@media (min-width: 1024px) {
  .stats-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-6);
  }
}

.stat-card {
  background-color: var(--bg-panel);
  border-radius: var(--radius);
  padding: var(--spacing-4);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-2);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

@media (min-width: 768px) {
  .stat-card {
    border-radius: var(--radius-lg);
    padding: var(--spacing-5);
  }
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--primary);
  opacity: 0.8;
}

.stat-card.success::before { background: var(--success); }
.stat-card.warning::before { background: var(--warning); }
.stat-card.danger::before { background: var(--danger); }

.stat-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.stat-value {
  font-size: 1.75rem;
  font-weight: 800;
  color: var(--dark);
  line-height: 1;
  margin: var(--spacing-1) 0;
}

@media (min-width: 768px) {
  .stat-value {
    font-size: 2.25rem;
    margin: var(--spacing-2) 0;
  }
}

.stat-label {
  font-size: 0.75rem;
  color: var(--text-light);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

@media (min-width: 768px) {
  .stat-label {
    font-size: 0.875rem;
  }
}

.stat-change {
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.125rem 0.5rem;
  border-radius: var(--radius-sm);
}

.stat-change-positive {
  background-color: var(--success-50);
  color: var(--success);
}

.stat-change-negative {
  background-color: var(--danger-50);
  color: var(--danger);
}

.stat-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2.25rem;
  height: 2.25rem;
  font-size: 1.125rem;
  border-radius: var(--radius);
  background-color: var(--primary-50);
  color: var(--primary);
}

@media (min-width: 768px) {
  .stat-icon {
    width: 2.5rem;
    height: 2.5rem;
    font-size: 1.25rem;
  }
}

.stat-icon.success {
  background-color: var(--success-50);
  color: var(--success);
}

.stat-icon.warning {
  background-color: var(--warning-50);
  color: var(--warning);
}

.stat-icon.danger {
  background-color: var(--danger-50);
  color: var(--danger);
}

.stat-footer {
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  margin-top: auto;
  padding-top: var(--spacing-3);
  border-top: 1px solid var(--border-light);
  font-size: 0.75rem;
  color: var(--text-light);
}

@media (min-width: 768px) {
  .stat-footer {
    font-size: 0.875rem;
  }
}

/* =========== Form Elements =========== */
.form-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-3);
  margin-bottom: var(--spacing-4);
  width: 100%;
}

@media (min-width: 480px) {
  .form-grid {
    grid-template-columns: repeat(6, 1fr);
    gap: var(--spacing-4);
  }
}

@media (min-width: 768px) {
  .form-grid {
    grid-template-columns: repeat(12, 1fr);
    gap: var(--spacing-5);
    margin-bottom: var(--spacing-5);
  }
}

.col-12, .col-sm-12 { grid-column: span 4; }
.col-6, .col-md-12 { grid-column: span 4; }
.col-4 { grid-column: span 4; }
.col-3 { grid-column: span 4; }
.col-2 { grid-column: span 2; }

@media (min-width: 480px) {
  .col-12 { grid-column: span 6; }
  .col-6 { grid-column: span 6; }
  .col-4 { grid-column: span 4; }
  .col-3 { grid-column: span 3; }
  .col-2 { grid-column: span 2; }
  
  .col-sm-12 { grid-column: span 6; }
}

@media (min-width: 768px) {
  .col-12 { grid-column: span 12; }
  .col-6 { grid-column: span 6; }
  .col-4 { grid-column: span 4; }
  .col-3 { grid-column: span 3; }
  .col-2 { grid-column: span 2; }
  
  .col-sm-12 { grid-column: span 12; }
  .col-md-12 { grid-column: span 12; }
}

.form-group {
  margin-bottom: var(--spacing-3);
}

@media (min-width: 768px) {
  .form-group {
    margin-bottom: var(--spacing-4);
  }
}

.form-label {
  display: block;
  margin-bottom: var(--spacing-1);
  font-weight: 600;
  font-size: 0.875rem;
  color: var(--text);
}

@media (min-width: 768px) {
  .form-label {
    margin-bottom: var(--spacing-2);
  }
}

.form-control {
  display: block;
  width: 100%;
  padding: var(--spacing-2) var(--spacing-3);
  font-size: 0.875rem;
  line-height: 1.5;
  color: var(--dark);
  background-color: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: var(--transition);
}

@media (min-width: 768px) {
  .form-control {
    padding: var(--spacing-3) var(--spacing-4);
  }
}

.d-flex > .form-control {
  flex: 1 1 auto;
  min-width: 0;
  width: auto;
}

.d-flex > .btn,
.d-flex > button {
  flex: 0 0 auto;
}

.search-form {
  width: 100%;
  margin: 0;
  position: relative;
}

.search-action-btn {
  position: relative;
  z-index: 10;
}

.form-control:focus {
  border-color: var(--primary-light);
  outline: 0;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
}

.form-control:disabled {
  background-color: var(--border-light);
  opacity: 1;
}

.form-control.invalid {
  border-color: var(--danger);
  background-color: var(--danger-50);
}

.form-error {
  color: var(--danger);
  font-size: 0.75rem;
  margin-top: var(--spacing-1);
  display: none;
  font-weight: 500;
}

.form-control.invalid + .form-error {
  display: block;
}

select.form-control {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 16px;
  padding-right: 2.5rem;
}

.dark-mode select.form-control {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
}

textarea.form-control {
  min-height: 100px;
  resize: vertical;
}

/* =========== Buttons =========== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-2) var(--spacing-4);
  font-size: 0.875rem;
  font-weight: 600;
  line-height: 1.5;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  cursor: pointer;
  user-select: none;
  border: 1px solid transparent;
  border-radius: var(--radius);
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
}

@media (min-width: 768px) {
  .btn {
    padding: var(--spacing-3) var(--spacing-6);
  }
}

.btn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 5px;
  height: 5px;
  background: rgba(255, 255, 255, 0.5);
  opacity: 0;
  border-radius: 100%;
  transform: scale(1, 1) translate(-50%);
  transform-origin: 50% 50%;
}

@keyframes ripple {
  0% {
    transform: scale(0, 0);
    opacity: 0.5;
  }
  100% {
    transform: scale(100, 100);
    opacity: 0;
  }
}

.btn:active::after {
  animation: ripple 0.6s ease-out;
}

.btn-sm {
  padding: var(--spacing-1) var(--spacing-3);
  font-size: 0.8125rem;
}

@media (min-width: 768px) {
  .btn-sm {
    padding: var(--spacing-2) var(--spacing-4);
  }
}

.btn-lg {
  padding: var(--spacing-3) var(--spacing-6);
  font-size: 1rem;
}

@media (min-width: 768px) {
  .btn-lg {
    padding: var(--spacing-4) var(--spacing-8);
  }
}

.btn i {
  margin-right: var(--spacing-2);
}

.btn-primary {
  color: #fff;
  background-color: var(--primary);
  border-color: var(--primary);
}

.btn-primary:hover {
  background-color: var(--primary-dark);
  border-color: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-outline-primary {
  color: var(--primary);
  background-color: transparent;
  border-color: var(--primary);
}

.btn-outline-primary:hover {
  color: #fff;
  background-color: var(--primary);
  border-color: var(--primary);
  transform: translateY(-1px);
}

.btn-success {
  color: #fff;
  background-color: var(--success);
  border-color: var(--success);
}

.btn-success:hover {
  background-color: var(--success);
  border-color: var(--success);
  filter: brightness(90%);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-warning {
  color: #fff;
  background-color: var(--warning);
  border-color: var(--warning);
}

.btn-warning:hover {
  filter: brightness(90%);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-danger {
  color: #fff;
  background-color: var(--danger);
  border-color: var(--danger);
}

.btn-danger:hover {
  filter: brightness(90%);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-light {
  color: var(--dark);
  background-color: var(--bg-panel);
  border-color: var(--border);
}

.btn-light:hover {
  background-color: var(--border-light);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-icon {
  width: 2.25rem;
  height: 2.25rem;
  padding: 0;
  border-radius: var(--radius);
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

@media (min-width: 768px) {
  .btn-icon {
    width: 2.5rem;
    height: 2.5rem;
  }
}

.btn-icon i {
  margin-right: 0;
}

.btn-icon.btn-sm {
  width: 2rem;
  height: 2rem;
}

/* =========== Badges & Chips =========== */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25em 0.6em;
  font-size: 0.75em;
  font-weight: 600;
  line-height: 1;
  text-align: center;
  white-space: nowrap;
  vertical-align: baseline;
  border-radius: 50rem;
}

.badge-primary {
  color: #fff;
  background-color: var(--primary);
}

.badge-success {
  color: #fff;
  background-color: var(--success);
}

.badge-warning {
  color: #fff;
  background-color: var(--warning);
}

.badge-danger {
  color: #fff;
  background-color: var(--danger);
}

.badge-light {
  color: var(--dark);
  background-color: var(--border-light);
}

.chip {
  display: inline-flex;
  align-items: center;
  padding: var(--spacing-1) var(--spacing-2);
  font-size: 0.8125rem;
  line-height: 1.5;
  white-space: nowrap;
  vertical-align: middle;
  border-radius: 50rem;
  background-color: var(--border-light);
  color: var(--text);
  font-weight: 600;
  gap: var(--spacing-1);
}

@media (min-width: 768px) {
  .chip {
    padding: var(--spacing-2) var(--spacing-3);
    gap: var(--spacing-2);
  }
}

.chip i {
  font-size: 0.875rem;
}

.chip-primary {
  background-color: var(--primary-50);
  color: var(--primary);
}

.chip-success {
  background-color: var(--success-50);
  color: var(--success);
}

.chip-warning {
  background-color: var(--warning-50);
  color: var(--warning);
}

.chip-danger {
  background-color: var(--danger-50);
  color: var(--danger);
}

/* =========== Tables =========== */
.table-container {
  overflow-x: auto;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  width: 100%;
  margin-bottom: var(--spacing-4);
}

@media (min-width: 768px) {
  .table-container {
    border-radius: var(--radius-lg);
  }
}

.table {
  width: 100%;
  margin-bottom: 0;
  color: var(--text);
  border-collapse: collapse;
  min-width: 640px; /* Ensures table doesn't shrink too much on mobile */
}

.table thead th {
  position: sticky;
  top: 0;
  padding: var(--spacing-3);
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  background-color: var(--bg-darker);
  color: var(--text-light);
  text-align: left;
  border-bottom: 1px solid var(--border);
}

@media (min-width: 768px) {
  .table thead th {
    padding: var(--spacing-4);
  }
}

.table tbody td {
  padding: var(--spacing-3);
  vertical-align: middle;
  border-bottom: 1px solid var(--border-light);
  transition: var(--transition-fast);
  font-size: 0.875rem;
}

@media (min-width: 768px) {
  .table tbody td {
    padding: var(--spacing-4);
    font-size: 0.9375rem;
  }
}

.table tbody tr:last-child td {
  border-bottom: none;
}

.table tbody tr {
  transition: var(--transition-fast);
}

.table tbody tr:hover {
  background-color: var(--bg-darker);
}

.table-sm thead th,
.table-sm tbody td {
  padding: var(--spacing-2);
}

#pendingInspectionTable td {
  white-space: nowrap;
}

#pendingInspectionTable .btn {
  padding: var(--spacing-1) var(--spacing-3);
  font-size: 0.75rem;
}

#pendingInspectionTable .chip {
  font-size: 0.75rem;
  padding: var(--spacing-1) var(--spacing-2);
}

@media (min-width: 768px) {
  .table-sm thead th,
  .table-sm tbody td {
    padding: var(--spacing-3);
  }
}

.table-status {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-2);
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}

.status-dot-success { background-color: var(--success); }
.status-dot-warning { background-color: var(--warning); }
.status-dot-danger { background-color: var(--danger); }
.status-dot-primary { background-color: var(--primary); }

/* =========== Modals =========== */
.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  z-index: var(--z-modal-backdrop);
  width: 100vw;
  height: 100vh;
  background-color: rgba(15, 23, 42, 0.65);
  backdrop-filter: blur(4px);
  opacity: 0;
  transition: opacity 0.2s ease-in-out;
  pointer-events: none;
  visibility: hidden;
}

.modal-backdrop.show {
  opacity: 1;
  pointer-events: all;
  visibility: visible;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  z-index: var(--z-modal);
  display: flex;
  width: 100%;
  height: 100%;
  overflow-x: hidden;
  overflow-y: auto;
  outline: 0;
  opacity: 0;
  transform: scale(0.95);
  pointer-events: none;
  transition: opacity 0.2s ease, transform 0.2s ease;
  visibility: hidden;
}

.modal.show {
  opacity: 1;
  transform: scale(1);
  pointer-events: all;
  visibility: visible;
}

.modal-dialog {
  position: relative;
  width: auto;
  margin: auto;
  max-width: calc(100% - 2rem);
  transition: var(--transition);
  pointer-events: none;
}

@media (min-width: 480px) {
  .modal-dialog {
    max-width: 400px;
  }
}

@media (min-width: 768px) {
  .modal-dialog {
    max-width: 500px;
  }
}

.modal.show .modal-dialog {
  pointer-events: auto;
}

.modal-content {
  position: relative;
  display: flex;
  flex-direction: column;
  width: 100%;
  background-color: var(--bg-panel);
  background-clip: padding-box;
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  overflow: hidden;
  pointer-events: auto;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--spacing-4) var(--spacing-4);
  border-bottom: 1px solid var(--border);
}

@media (min-width: 768px) {
  .modal-header {
    padding: var(--spacing-5) var(--spacing-6);
  }
}

.modal-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--dark);
}

.modal-close {
  background: transparent;
  border: 0;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-light);
  cursor: pointer;
  transition: var(--transition);
}

.modal-close:hover {
  color: var(--primary);
}

.modal-body {
  position: relative;
  flex: 1 1 auto;
  padding: var(--spacing-4);
  max-height: 70vh;
  overflow-y: auto;
}

@media (min-width: 768px) {
  .modal-body {
    padding: var(--spacing-6);
  }
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  padding: var(--spacing-4) var(--spacing-4);
  border-top: 1px solid var(--border);
  gap: var(--spacing-2);
}

@media (min-width: 768px) {
  .modal-footer {
    padding: var(--spacing-5) var(--spacing-6);
    gap: var(--spacing-3);
  }
}

/* =========== Week Selector =========== */
.week-selector {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-3);
  margin-bottom: var(--spacing-4);
  padding: var(--spacing-3);
  background-color: var(--bg-panel);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}

@media (min-width: 768px) {
  .week-selector {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-4);
    padding: var(--spacing-4);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-6);
  }
}

.week-label {
  font-weight: 600;
  color: var(--dark);
  flex-shrink: 0;
}

.date-nav {
  display: flex;
  gap: var(--spacing-2);
}

.date-nav-btn {
  background-color: var(--bg-darker);
  border: none;
  width: 32px;
  height: 32px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text);
  cursor: pointer;
  transition: var(--transition);
}

.date-nav-btn:hover {
  background-color: var(--primary-50);
  color: var(--primary);
}

/* =========== Bus Info Section =========== */
.bus-info {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-3);
  padding: var(--spacing-3);
  background-color: var(--bg-darker);
  border-radius: var(--radius);
  margin-bottom: var(--spacing-4);
}

@media (min-width: 480px) {
  .bus-info {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (min-width: 768px) {
  .bus-info {
    grid-template-columns: repeat(3, 1fr);
    padding: var(--spacing-4);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-5);
    gap: var(--spacing-4);
  }
}

@media (min-width: 1024px) {
  .bus-info {
    grid-template-columns: repeat(6, 1fr);
    padding: var(--spacing-5);
    gap: var(--spacing-5);
    margin-bottom: var(--spacing-6);
  }
}

.bus-info-item {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-1);
}

@media (min-width: 768px) {
  .bus-info-item {
    gap: var(--spacing-2);
  }
}

.bus-info-label {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text-light);
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

.bus-info-value {
  font-weight: 600;
  color: var(--dark);
  font-size: 1rem;
}

@media (min-width: 768px) {
  .bus-info-value {
    font-size: 1.125rem;
  }
}

/* =========== Toggle Sections =========== */
.toggle-section {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--spacing-3);
  padding: var(--spacing-3);
  background-color: var(--bg-panel);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  margin-bottom: var(--spacing-3);
  cursor: pointer;
  transition: var(--transition);
}

@media (min-width: 768px) {
  .toggle-section {
    padding: var(--spacing-4);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-4);
  }
}

.toggle-section:hover {
  background-color: var(--bg-darker);
  border-color: var(--primary-200);
}

.toggle-section i {
  transition: transform 0.3s ease;
}

.toggle-section.active i {
  transform: rotate(180deg);
}

.toggle-section-title {
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  font-weight: 600;
  color: var(--dark);
}

@media (min-width: 768px) {
  .toggle-section-title {
    gap: var(--spacing-3);
  }
}

.toggle-section-title .section-icon {
  width: 28px;
  height: 28px;
  background-color: var(--primary-50);
  color: var(--primary);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.875rem;
}

@media (min-width: 768px) {
  .toggle-section-title .section-icon {
    width: 32px;
    height: 32px;
    font-size: 1rem;
  }
}

.toggle-section-content {
  padding: 0 var(--spacing-3) var(--spacing-3);
  display: none;
}

@media (min-width: 768px) {
  .toggle-section-content {
    padding: 0 var(--spacing-4) var(--spacing-4);
  }
}

.toggle-section-content.show {
  display: block;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* =========== Activity List =========== */
.activity-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-2);
}

@media (min-width: 768px) {
  .activity-list {
    gap: var(--spacing-3);
  }
}

.activity-item {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-2);
  padding: var(--spacing-3);
  background-color: var(--bg-panel);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  transition: var(--transition);
}

@media (min-width: 768px) {
  .activity-item {
    gap: var(--spacing-3);
    padding: var(--spacing-4);
    border-radius: var(--radius-lg);
  }
}

.activity-item:hover {
  transform: translateX(4px);
  box-shadow: var(--shadow);
}

.activity-icon {
  width: 32px;
  height: 32px;
  background-color: var(--primary-50);
  color: var(--primary);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  flex-shrink: 0;
}

@media (min-width: 768px) {
  .activity-icon {
    width: 36px;
    height: 36px;
    font-size: 1.125rem;
  }
}

.activity-icon.success {
  background-color: var(--success-50);
  color: var(--success);
}

.activity-icon.warning {
  background-color: var(--warning-50);
  color: var(--warning);
}

.activity-icon.danger {
  background-color: var(--danger-50);
  color: var(--danger);
}

.activity-content {
  flex: 1;
  min-width: 0; /* Fix for text overflow in flex child */
}

.activity-title {
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.activity-details {
  font-size: 0.8125rem;
  color: var(--text-light);
}

.activity-time {
  font-size: 0.75rem;
  color: var(--text-lighter);
  white-space: nowrap;
}

/* =========== Notification System =========== */
.notification-container {
  position: fixed;
  top: var(--spacing-3);
  right: var(--spacing-3);
  z-index: var(--z-toast);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-2);
  width: calc(100% - var(--spacing-6));
  max-width: 400px;
  pointer-events: none;
}

@media (min-width: 768px) {
  .notification-container {
    top: var(--spacing-4);
    right: var(--spacing-4);
    gap: var(--spacing-3);
  }
}

.notification {
  background-color: var(--bg-panel);
  border-radius: var(--radius);
  border-left: 4px solid var(--primary);
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-2);
  padding: var(--spacing-3);
  animation: slide-in 0.3s ease-out forwards, fade-out 0.3s ease-in forwards 3.7s;
  opacity: 0;
  transform: translateX(100%);
  position: relative;
  pointer-events: auto;
}

@media (min-width: 768px) {
  .notification {
    border-radius: var(--radius-md);
    gap: var(--spacing-3);
    padding: var(--spacing-4);
  }
}

@keyframes slide-in {
  0% { 
    transform: translateX(100%);
    opacity: 0;
  }
  100% { 
    transform: translateX(0%);
    opacity: 1;
  }
}

@keyframes fade-out {
  0% { 
    opacity: 1;
    transform: translateX(0);
  }
  100% { 
    opacity: 0;
    transform: translateX(10%);
  }
}

.notification-success { border-left-color: var(--success); }
.notification-warning { border-left-color: var(--warning); }
.notification-danger { border-left-color: var(--danger); }

.notification-icon {
  font-size: 1.125rem;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

@media (min-width: 768px) {
  .notification-icon {
    font-size: 1.25rem;
  }
}

.notification-success .notification-icon { color: var(--success); }
.notification-warning .notification-icon { color: var(--warning); }
.notification-danger .notification-icon { color: var(--danger); }

.notification-content {
  flex: 1;
  min-width: 0; /* Fix for text overflow in flex child */
}

.notification-title {
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: var(--dark);
  line-height: 1.2;
}

.notification-message {
  font-size: 0.875rem;
  color: var(--text);
  margin: 0;
  line-height: 1.4;
}

.notification-close {
  position: absolute;
  top: var(--spacing-2);
  right: var(--spacing-2);
  background: none;
  border: none;
  color: var(--text-light);
  font-size: 0.875rem;
  cursor: pointer;
  padding: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.7;
  transition: var(--transition);
}

.notification-close:hover {
  opacity: 1;
  color: var(--text);
}

/* Live alert banner */
.live-alert {
  position: fixed;
  top: calc(var(--spacing-4) + env(safe-area-inset-top));
  left: 50%;
  transform: translate(-50%, -20px);
  background-color: var(--bg-panel);
  color: var(--dark);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  padding: var(--spacing-2) var(--spacing-4);
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  z-index: calc(var(--z-toast) + 5);
  opacity: 0;
  pointer-events: none;
  transition: transform 0.3s ease, opacity 0.3s ease;
}

.live-alert.show {
  opacity: 1;
  transform: translate(-50%, 0);
  pointer-events: auto;
}

.live-alert i {
  font-size: 1rem;
}

.live-alert-success {
  border-left: 4px solid var(--success);
}

.live-alert-warning {
  border-left: 4px solid var(--warning);
}

.live-alert-danger {
  border-left: 4px solid var(--danger);
}

.live-alert-info {
  border-left: 4px solid var(--info);
}

/* =========== Loader =========== */
.loader-container {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(15, 23, 42, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: var(--z-tooltip);
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
  backdrop-filter: blur(4px);
}

.loader-container.show {
  opacity: 1;
  visibility: visible;
}

.loader {
  position: relative;
  width: 40px;
  height: 40px;
}

@media (min-width: 768px) {
  .loader {
    width: 50px;
    height: 50px;
  }
}

.loader::before,
.loader::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
}

.loader::before {
  border: 3px solid rgba(255, 255, 255, 0.2);
}

.loader::after {
  border: 3px solid transparent;
  border-top-color: var(--primary);
  animation: spin 1s linear infinite;
}

.loader-text {
  position: absolute;
  bottom: -30px;
  color: white;
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* =========== Filters =========== */
.filters-container {
  margin-bottom: var(--spacing-4);
  background-color: var(--bg-panel);
  border-radius: var(--radius);
  padding: var(--spacing-3);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--spacing-3);
}

@media (min-width: 480px) {
  .filters-container {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 768px) {
  .filters-container {
    border-radius: var(--radius-lg);
    padding: var(--spacing-5);
    margin-bottom: var(--spacing-5);
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-5);
  }
}

@media (min-width: 1024px) {
  .filters-container {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    margin-bottom: var(--spacing-6);
  }
}

.filter-title {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  margin-bottom: var(--spacing-2);
}

.filter-title h5 {
  margin: 0;
  font-size: 1rem;
}

.filter-actions {
  grid-column: 1 / -1;
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-2);
}

@media (min-width: 768px) {
  .filter-actions {
    gap: var(--spacing-3);
  }
}

/* =========== Utility Classes =========== */
.d-flex { display: flex !important; }
.align-center { align-items: center !important; }
.align-start { align-items: flex-start !important; }
.align-end { align-items: flex-end !important; }
.justify-between { justify-content: space-between !important; }
.justify-center { justify-content: center !important; }
.justify-start { justify-content: flex-start !important; }
.justify-end { justify-content: flex-end !important; }
.flex-column { flex-direction: column !important; }
.flex-wrap { flex-wrap: wrap !important; }
.gap-1 { gap: var(--spacing-1) !important; }
.gap-2 { gap: var(--spacing-2) !important; }
.gap-3 { gap: var(--spacing-3) !important; }
.gap-4 { gap: var(--spacing-4) !important; }
.gap-5 { gap: var(--spacing-5) !important; }
.gap-6 { gap: var(--spacing-6) !important; }
.mb-0 { margin-bottom: 0 !important; }
.mb-1 { margin-bottom: var(--spacing-1) !important; }
.mb-2 { margin-bottom: var(--spacing-2) !important; }
.mb-3 { margin-bottom: var(--spacing-3) !important; }
.mb-4 { margin-bottom: var(--spacing-4) !important; }
.mb-5 { margin-bottom: var(--spacing-5) !important; }
.mb-6 { margin-bottom: var(--spacing-6) !important; }
.mt-0 { margin-top: 0 !important; }
.mt-1 { margin-top: var(--spacing-1) !important; }
.mt-2 { margin-top: var(--spacing-2) !important; }
.mt-3 { margin-top: var(--spacing-3) !important; }
.mt-4 { margin-top: var(--spacing-4) !important; }
.mt-5 { margin-top: var(--spacing-5) !important; }
.mt-6 { margin-top: var(--spacing-6) !important; }

/* Critical mobile spacing fix */
@media (max-width: 1023px) {
  .mt-md-5 { margin-top: var(--spacing-5) !important; }
}

.ml-auto { margin-left: auto !important; }
.mr-auto { margin-right: auto !important; }
.mx-auto { margin-left: auto !important; margin-right: auto !important; }
.p-0 { padding: 0 !important; }
.p-1 { padding: var(--spacing-1) !important; }
.p-2 { padding: var(--spacing-2) !important; }
.p-3 { padding: var(--spacing-3) !important; }
.p-4 { padding: var(--spacing-4) !important; }
.text-success { color: var(--success) !important; }
.text-warning { color: var(--warning) !important; }
.text-danger { color: var(--danger) !important; }
.text-primary { color: var(--primary) !important; }
.text-info { color: var(--info) !important; }
.fw-bold { font-weight: 700 !important; }
.fw-medium { font-weight: 600 !important; }
.fw-normal { font-weight: 400 !important; }
.hidden { display: none !important; }
.text-center { text-align: center !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.section-divider {
  height: 1px;
  background-color: var(--border);
  margin: var(--spacing-4) 0;
  width: 100%;
}

@media (min-width: 768px) {
  .section-divider {
    margin: var(--spacing-6) 0;
  }
}

/* =========== Enhanced Scrollbar =========== */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

@media (min-width: 768px) {
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
}

::-webkit-scrollbar-track {
  background: var(--bg-darker);
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-lighter);
}

/* =========== Animations =========== */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.fadeIn {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes scaleIn {
  from { 
    opacity: 0;
    transform: scale(0.95);
  }
  to { 
    opacity: 1;
    transform: scale(1);
  }
}

.scaleIn {
  animation: scaleIn 0.3s ease-out;
}

/* =========== Print Styles =========== */
@media print {
  body {
    background-color: white;
    color: black;
  }
  
  .app-header, 
  .sidebar, 
  .mobile-bottom-nav, 
  .fab-button,
  .notification-container,
  .btn:not(.btn-print) {
    display: none !important;
  }
  
  .main-layout {
    display: block;
    height: auto;
    padding-bottom: 0 !important;
  }
  
  .content-area {
    padding: 0 !important;
    overflow: visible;
  }
  
  .card {
    box-shadow: none;
    border: 1px solid #ddd;
    page-break-inside: avoid;
  }
  
  .table-container {
    overflow: visible;
    border: 1px solid #ddd;
  }
  
  .toggle-section-content {
    display: block !important;
  }
}
  </style>
</head>
<body>
  <!-- Loader -->
  <div class="loader-container" id="loaderContainer">
    <div class="loader"></div>
    <div class="loader-text" id="loaderText">Cargando...</div>
  </div>

  <!-- Notificaciones -->
  <div class="notification-container" id="notificationContainer"></div>

  <div class="app-container">
    <!-- Cabecera -->
    <header class="app-header">
      <button class="mobile-nav-toggle" id="sidebarToggle">
        <div class="toggle-icon">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>

      <div class="header-brand">
        <div class="header-logo">
          <i class="fas fa-bus-alt"></i>
        </div>
        <span>Inspecci√≥n de Buses</span>
      </div>

      <div class="global-search">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="globalSearch" placeholder="Buscar por PPU o #interno...">
      </div>

      <div class="header-actions">
        <div class="chip chip-primary">
          <i class="fas fa-calendar-week"></i>
          <span id="currentWeekLabel"></span>
        </div>
        <button class="btn btn-outline-primary btn-sm" id="btnShowPending">
          <i class="fas fa-clipboard-list"></i>
          Pendientes <span class="badge badge-primary" id="pendingCount">0</span>
        </button>
        <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
          <i class="fas fa-moon"></i>
        </button>
        <div class="chip" id="userInfoChip">
          <i class="fas fa-user-hard-hat"></i>
          <span id="userInfo">‚Äî</span>
        </div>
      </div>
    </header>

    <!-- Layout Principal -->
    <div class="main-layout">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-title">Operaci√≥n</div>
          <div class="nav-item active" data-section="inspection-form">
            <i class="fas fa-clipboard-check"></i>
            <span>Formulario de Inspecci√≥n</span>
          </div>
          <div class="nav-item" data-section="dashboard">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-title">Informes</div>
          <div class="nav-item" data-section="cameras-report">
            <i class="fas fa-video"></i>
            <span>C√°maras</span>
            <span class="badge badge-light" id="cameraCount">0</span>
          </div>
          <div class="nav-item" data-section="tag-report">
            <i class="fas fa-tag"></i>
            <span>TAG</span>
            <span class="badge badge-light" id="tagCount">0</span>
          </div>
          <div class="nav-item" data-section="extinguisher-report">
            <i class="fas fa-fire-extinguisher"></i>
            <span>Extintores</span>
            <span class="badge badge-light" id="extinguisherCount">0</span>
          </div>
          <div class="nav-item" data-section="mobileye-report">
            <i class="fas fa-eye"></i>
            <span>Mobileye</span>
            <span class="badge badge-light" id="mobiCount">0</span>
          </div>
          <div class="nav-item" data-section="odometer-report">
            <i class="fas fa-tachometer-alt"></i>
            <span>Od√≥metro</span>
            <span class="badge badge-light" id="odoCount">0</span>
          </div>
          <div class="nav-item" data-section="advertising-report">
            <i class="fas fa-ad"></i>
            <span>Publicidad</span>
            <span class="badge badge-light" id="advertisingCount">0</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-title">Gesti√≥n</div>
          <div class="nav-item" data-section="maintenance-tickets">
            <i class="fas fa-ticket-alt"></i>
            <span>Tickets de Mantenimiento</span>
          </div>
          <div class="nav-item" data-section="session-report">
            <i class="fas fa-user-clock"></i>
            <span>Ingresos</span>
            <span class="badge badge-light" id="sessionCount">0</span>
          </div>
          <div class="nav-item" data-section="fleet-status">
            <i class="fas fa-bus"></i>
            <span>Estado de Flota</span>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-title">Configuraci√≥n</div>
          <div class="nav-item" data-section="user-settings">
            <i class="fas fa-cog"></i>
            <span>Preferencias</span>
          </div>
          <div class="nav-item" data-section="help">
            <i class="fas fa-question-circle"></i>
            <span>Ayuda</span>
          </div>
          <div class="nav-item" id="btnLogout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Cerrar Sesi√≥n</span>
          </div>
        </div>
      </aside>

      <!-- √Årea de Contenido -->
      <main class="content-area">
        <!-- DASHBOARD -->
        <section id="section-dashboard" class="hidden">
          <div class="d-flex justify-between align-center mb-5">
            <h2>Dashboard de Inspecci√≥n Semanal</h2>
            <div class="date-nav">
              <button class="date-nav-btn" id="prevWeekDash">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="date-nav-btn" id="nextWeekDash">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
          
          <div class="week-selector">
            <div class="d-flex align-center gap-3">
              <h4 class="mb-0">Semana:</h4>
              <select id="dashboardWeekSelector" class="form-control">
                <!-- Opciones de semana ser√°n agregadas por JS -->
              </select>
            </div>
            
            <div class="d-flex align-center gap-3">
              <label class="form-label mb-0">Terminal:</label>
              <select id="dashboardTerminalFilter" class="form-control">
                <option value="">Todos los Terminales</option>
                <option>El Roble</option>
                <option>La Reina</option>
                <option>Maria Angelica</option>
                <option>El Descanso</option>
              </select>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-icon">
                  <i class="fas fa-bus"></i>
                </div>
                <div class="stat-change stat-change-positive">
                  <i class="fas fa-arrow-up"></i> 3%
                </div>
              </div>
              <div class="stat-label">Flota Total</div>
              <div class="stat-value" id="totalFleetCount">0</div>
              <div class="stat-footer">
                <div class="chip">
                  <span class="status-dot status-dot-success"></span>
                  <span>Operativos: <strong id="operationalCount">0</strong></span>
                </div>
              </div>
            </div>
            
            <div class="stat-card success">
              <div class="stat-card-header">
                <div class="stat-icon success">
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="stat-change stat-change-positive">
                  <i class="fas fa-arrow-up"></i> 5%
                </div>
              </div>
              <div class="stat-label">Inspecciones</div>
              <div class="stat-value" id="inspectionCount">0</div>
              <div class="stat-footer">
                <div class="chip">
                  <span>Avance: <strong id="inspectionPercentage">0%</strong></span>
                </div>
              </div>
            </div>
            
            <div class="stat-card warning">
              <div class="stat-card-header">
                <div class="stat-icon warning">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-change stat-change-negative">
                  <i class="fas fa-arrow-down"></i> 2%
                </div>
              </div>
              <div class="stat-label">Problemas Encontrados</div>
              <div class="stat-value" id="issuesCount">0</div>
              <div class="stat-footer">
                <div class="chip">
                  <span class="status-dot status-dot-danger"></span>
                  <span>Cr√≠ticos: <strong id="criticalIssuesCount">0</strong></span>
                </div>
              </div>
            </div>
            
            <div class="stat-card danger">
              <div class="stat-card-header">
                <div class="stat-icon danger">
                  <i class="fas fa-ticket-alt"></i>
                </div>
                <div class="stat-change stat-change-negative">
                  <i class="fas fa-arrow-up"></i> 8%
                </div>
              </div>
              <div class="stat-label">Tickets de Mantenimiento</div>
              <div class="stat-value" id="ticketsCount">0</div>
              <div class="stat-footer">
                <div class="chip">
                  <span class="status-dot status-dot-warning"></span>
                  <span>Abiertos: <strong id="openTicketsCount">0</strong></span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card mt-5 scaleIn">
            <div class="card-header">
              <h3 class="card-title">Estado de Inspecci√≥n por Terminal</h3>
            </div>
            <div class="chart-container" style="height: 300px;">
              <canvas id="inspectionByTerminalChart"></canvas>
            </div>
          </div>
          
          <div class="form-grid mt-5">
            <div class="col-6 col-md-12">
              <div class="card scaleIn">
                <div class="card-header">
                  <h3 class="card-title">Problemas Recientes</h3>
                  <button class="btn btn-outline-primary btn-sm">Ver Todo</button>
                </div>
                <div class="table-container">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>PPU Bus</th>
                        <th>Componente</th>
                        <th>Problema</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                      </tr>
                    </thead>
                    <tbody id="recentIssuesTable">
                      <!-- Ser√° poblado por JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <div class="col-6 col-md-12">
              <div class="card mt-0 mt-md-5 scaleIn">
                <div class="card-header">
                  <h3 class="card-title">Buses Pendientes de Inspecci√≥n</h3>
                </div>
                <div class="table-container">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>PPU</th>
                        <th># Interno</th>
                        <th>Terminal</th>
                        <th>Estado</th>
                        <th>Acci√≥n</th>
                      </tr>
                    </thead>
                    <tbody id="pendingInspectionTable">
                      <!-- Ser√° poblado por JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card mt-5 scaleIn">
            <div class="card-header">
              <h3 class="card-title">Actividad Reciente</h3>
            </div>
            <div class="activity-list" id="activityList">
              <!-- Ser√° poblado por JS -->
            </div>
          </div>
        </section>

        <!-- FORMULARIO DE INSPECCI√ìN -->
        <section id="section-inspection-form">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Inspecci√≥n Semanal de Buses</h3>
              <div class="d-flex align-center gap-3">
                <div class="date-nav">
                  <button class="date-nav-btn" id="prevWeekForm">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <select id="weekSelector" class="form-control">
                    <!-- Opciones de semana ser√°n agregadas por JS -->
                  </select>
                  <button class="date-nav-btn" id="nextWeekForm">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                <span class="chip chip-primary" id="statusBadge">Listo</span>
              </div>
            </div>
            
            <!-- B√∫squeda de Bus -->
            <div class="form-grid mb-0">
              <div class="col-6 col-md-12 form-group">
                <label class="form-label">Buscar por PPU</label>
                <form class="search-form d-flex gap-2" id="searchPPUForm" novalidate>
                  <input type="text" class="form-control" id="searchPPU" placeholder="ej., XXYY11" autocomplete="off">
                  <button type="submit" class="btn btn-primary search-action-btn" id="btnSearchPPU">
                    <i class="fas fa-search"></i> Buscar
                  </button>
                </form>
              </div>
              
              <div class="col-6 col-md-12 form-group">
                <label class="form-label">Buscar por # Interno</label>
                <form class="search-form d-flex gap-2" id="searchInternalForm" novalidate>
                  <input type="text" class="form-control" id="searchInternal" placeholder="ej., 1234" autocomplete="off">
                  <button type="submit" class="btn btn-primary search-action-btn" id="btnSearchInternal">
                    <i class="fas fa-search"></i> Buscar
                  </button>
                </form>
              </div>
            </div>
            
            <!-- Informaci√≥n del Bus (inicialmente oculto) -->
            <div id="busInfoSection" class="hidden">
              <div class="section-divider"></div>
              
              <div class="d-flex justify-between align-center mb-4">
                <h4>Informaci√≥n del Bus</h4>
                <div class="chip" id="inspectionStatus">
                  <i class="fas fa-clock"></i>
                  <span>Sin inspecci√≥n a√∫n</span>
                </div>
              </div>
              
              <div class="bus-info">
                <div class="bus-info-item">
                  <div class="bus-info-label">PPU</div>
                  <div class="bus-info-value" id="ppuDisplay">‚Äî</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label"># Interno</div>
                  <div class="bus-info-value" id="internalDisplay">‚Äî</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label">Marca</div>
                  <div class="bus-info-value" id="makeDisplay">‚Äî</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label">Modelo</div>
                  <div class="bus-info-value" id="modelDisplay">‚Äî</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label">A√±o</div>
                  <div class="bus-info-value" id="yearDisplay">‚Äî</div>
                </div>
                
                <div class="bus-info-item">
                  <div class="bus-info-label">Terminal</div>
                  <div class="bus-info-value" id="terminalDisplay">‚Äî</div>
                </div>
              </div>
              
              <!-- Secciones Plegables -->
              <div class="toggle-section" id="toggleCameras">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-video"></i>
                  </div>
                  <span>C√°maras</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="camerasSection">
                <div class="form-grid">
                  <div class="col-6 col-md-12 form-group">
                    <label class="form-label">Monitor de C√°maras La pantalla Esta Buena?</label>
                    <select class="form-control" id="monitorCamera">
                      <option value="">‚Äî Seleccionar ‚Äî</option>
                      <option value="SI">S√ç</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-monitor">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-6 col-md-12 form-group">
                    <label class="form-label">Detalles del Monitor</label>
                    <input type="text" class="form-control" id="monitorDetail" placeholder="ej., Todo OK / C√°mara 2 sin se√±al">
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">C√°mara Delantera (estado fisico)</label>
                    <select class="form-control" id="frontCamera">
                      <option>tiene</option>
                      <option>no tiene</option>
                      <option>da√±ada</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">C√°mara de Cabina (estado fisico)</label>
                    <select class="form-control" id="cabinCamera">
                      <option>tiene</option>
                      <option>no tiene</option>
                      <option>da√±ada</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">C√°maras Interiores (estado fisico)</label>
                    <select class="form-control" id="interiorCamera">
                      <option>tiene</option>
                      <option>no tiene</option>
                      <option>da√±ada</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">C√°mara Trasera (estado fisico)</label>
                    <select class="form-control" id="rearCamera">
                      <option>tiene</option>
                      <option>no tiene</option>
                      <option>da√±ada</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¬øTodas las c√°maras son visibles en el monitor?</label>
                    <select class="form-control" id="allVisible">
                      <option value="">‚Äî Seleccionar ‚Äî</option>
                      <option value="SI">S√ç</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-all">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¬øLa c√°mara trasera se activa con la marcha atr√°s?</label>
                    <select class="form-control" id="reverseActive">
                      <option value="">‚Äî Seleccionar ‚Äî</option>
                      <option value="SI">S√ç</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-rev">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¬øLas c√°maras de las puertas se activan al abrirse?</label>
                    <select class="form-control" id="doorsOpen">
                      <option value="">‚Äî Seleccionar ‚Äî</option>
                      <option value="SI">S√ç</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-open">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¬øSe muestran todas las c√°maras con puertas cerradas?</label>
                    <select class="form-control" id="doorsClosed">
                      <option value="">‚Äî Seleccionar ‚Äî</option>
                      <option value="SI">S√ç</option>
                      <option value="NO">NO</option>
                    </select>
                    <div class="form-error" id="w-closed">Esta pregunta es obligatoria.</div>
                  </div>
                  
                  <div class="col-12 form-group">
                    <label class="form-label">Observaciones de C√°maras</label>
                    <textarea class="form-control" id="cameraObservations" placeholder="Detalle cualquier hallazgo"></textarea>
                  </div>
                </div>
              </div>
              
              <div class="toggle-section" id="toggleTag">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-tag"></i>
                  </div>
                  <span>TAG</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="tagSection">
                <div class="form-grid">
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">¬øTiene TAG?</label>
                    <select class="form-control" id="hasTag">
                      <option value="yes">s√≠</option>
                      <option value="no">no</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Serie del TAG (editable)</label>
                    <input type="text" class="form-control" id="tagSerial" placeholder="Serie del TAG">
                  </div>
                  
                  <div class="col-6 col-sm-12 form-group">
                    <label class="form-label">Observaciones del TAG</label>
                    <input type="text" class="form-control" id="tagObservations" placeholder="Detalles">
                  </div>
                </div>
              </div>

              <div class="toggle-section" id="toggleExtinguisher">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                  </div>
                  <span>Extintores</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="extinguisherSection">
                <div class="form-grid">
                  <div class="col-4 col-sm-12 form-group">
                    <label class="form-label">Ubicaci√≥n (Terminal)</label>
                    <input type="text" class="form-control" id="extinguisherLocation" placeholder="Ej., El Roble / Patio Norte">
                  </div>
                  
                  <div class="col-4 col-sm-12 form-group">
                    <label class="form-label">Fecha de Vencimiento</label>
                    <input type="date" class="form-control" id="extinguisherExpiry">
                  </div>
                  
                  <div class="col-4 col-sm-12 form-group">
                    <label class="form-label">Estado Extintor</label>
                    <select class="form-control" id="extinguisherStatus">
                      <option value="TIENE">TIENE</option>
                      <option value="NO TIENE">NO TIENE</option>
                      <option value="DA√ëADO">DA√ëADO</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Estado Certificaci√≥n</label>
                    <select class="form-control" id="certificationStatus">
                      <option value="TIENE">TIENE</option>
                      <option value="NO TIENE">NO TIENE</option>
                      <option value="DA√ëADO">DA√ëADO</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Estado Sonda</label>
                    <select class="form-control" id="probeStatus">
                      <option value="TIENE">TIENE</option>
                      <option value="NO TIENE">NO TIENE</option>
                      <option value="DA√ëADO">DA√ëADO</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Estado Man√≥metro</label>
                    <select class="form-control" id="manometerStatus">
                      <option value="TIENE">TIENE</option>
                      <option value="NO TIENE">NO TIENE</option>
                      <option value="DA√ëADO">DA√ëADO</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Presi√≥n / Carga</label>
                    <select class="form-control" id="pressureStatus">
                      <option value="OPTIMA">OPTIMA</option>
                      <option value="BAJA CARGA">BAJA CARGA</option>
                      <option value="SOBRE CARGA">SOBRE CARGA</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Cilindro</label>
                    <select class="form-control" id="cylinderStatus">
                      <option value="BUEN ESTADO">BUEN ESTADO</option>
                      <option value="ABOLLADO">ABOLLADO</option>
                    </select>
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Estado Porta Extintor</label>
                    <select class="form-control" id="holderStatus">
                      <option value="TIENE">TIENE</option>
                      <option value="NO TIENE">NO TIENE</option>
                      <option value="DA√ëADO">DA√ëADO</option>
                      <option value="EXTINTOR NO ENTRA">EXTINTOR NO ENTRA</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Secci√≥n Mobileye (condicionalmente visible) -->
              <div id="mobileyeSection">
                <div class="toggle-section" id="toggleMobileye">
                  <div class="toggle-section-title">
                    <div class="section-icon">
                      <i class="fas fa-eye"></i>
                    </div>
                    <span>Mobileye (solo VOLVO)</span>
                  </div>
                  <i class="fas fa-chevron-down"></i>
                </div>
                
                <div class="toggle-section-content" id="mobileyeContentSection">
                  <div class="form-grid">
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Estado Mobileye</label>
                      <select class="form-control" id="mobileyeStatus">
                        <option value="">‚Äî Seleccionar ‚Äî</option>
                        <option>tiene</option>
                        <option>no tiene</option>
                        <option>da√±ado</option>
                      </select>
                      <div class="form-error" id="w-me">El estado de Mobileye es obligatorio.</div>
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Alerta IZQUIERDA</label>
                      <select class="form-control" id="leftAlert">
                        <option value="BUENO">BUENO</option>
                        <option value="MALO">MALO</option>
                        <option value="DA√ëADO">DA√ëADO</option>
                        <option value="NO TIENE">NO TIENE</option>
                      </select>
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Alerta DERECHA</label>
                      <select class="form-control" id="rightAlert">
                        <option value="BUENO">BUENO</option>
                        <option value="MALO">MALO</option>
                        <option value="DA√ëADO">DA√ëADO</option>
                        <option value="NO TIENE">NO TIENE</option>
                      </select>
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Consola</label>
                      <select class="form-control" id="console">
                        <option value="BUENO">BUENO</option>
                        <option value="MALO">MALO</option>
                        <option value="DA√ëADO">DA√ëADO</option>
                        <option value="NO TIENE">NO TIENE</option>
                      </select>
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor Frontal</label>
                      <select class="form-control" id="frontSensor">
                        <option value="BUENO">BUENO</option>
                        <option value="MALO">MALO</option>
                        <option value="DA√ëADO">DA√ëADO</option>
                        <option value="NO TIENE">NO TIENE</option>
                      </select>
                    </div>
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor IZQUIERDO</label>
                      <select class="form-control" id="leftSensor">
                        <option value="BUENO">BUENO</option>
                        <option value="MALO">MALO</option>
                        <option value="DA√ëADO">DA√ëADO</option>
                        <option value="NO TIENE">NO TIENE</option>
                      </select>
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor DERECHO</label>
                      <select class="form-control" id="rightSensor">
                        <option value="BUENO">BUENO</option>
                        <option value="MALO">MALO</option>
                        <option value="DA√ëADO">DA√ëADO</option>
                        <option value="NO TIENE">NO TIENE</option>
                      </select>
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor Trasero IZQUIERDO (ART)</label>
                      <select class="form-control" id="rearLeftSensor">
                        <option value="BUENO">BUENO</option>
                        <option value="MALO">MALO</option>
                        <option value="DA√ëADO">DA√ëADO</option>
                        <option value="NO TIENE">NO TIENE</option>
                      </select>
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Sensor Trasero DERECHO (ART)</label>
                      <select class="form-control" id="rearRightSensor">
                        <option value="BUENO">BUENO</option>
                        <option value="MALO">MALO</option>
                        <option value="DA√ëADO">DA√ëADO</option>
                        <option value="NO TIENE">NO TIENE</option>
                      </select>
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">Fecha de Incidente</label>
                      <input type="date" class="form-control" id="incidentDate">
                    </div>
                    
                    <div class="col-3 col-sm-12 form-group">
                      <label class="form-label">N¬∞ de Incidente</label>
                      <input type="text" class="form-control" id="incidentNumber">
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="toggle-section" id="toggleOdometer">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-tachometer-alt"></i>
                  </div>
                  <span>Od√≥metro</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="odometerSection">
                <div class="form-grid">
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Lectura de Od√≥metro (km)</label>
                    <input type="number" class="form-control" id="odometerReading" min="0" step="1" placeholder="ej., 123456">
                  </div>
                  
                  <div class="col-3 col-sm-12 form-group">
                    <label class="form-label">Estado del Od√≥metro</label>
                    <select class="form-control" id="odometerStatus">
                      <option>funcionando</option>
                      <option>no funciona</option>
                      <option>da√±ado</option>
                    </select>
                  </div>
                  
                  <div class="col-6 col-sm-12 form-group">
                    <label class="form-label">Observaciones del Od√≥metro</label>
                    <input type="text" class="form-control" id="odometerObservations" placeholder="Detalles">
                  </div>
                </div>
              </div>
              
              <div class="toggle-section" id="toggleAdvertising">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-ad"></i>
                  </div>
                  <span>Publicidad</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="advertisingSection">
                <div class="form-grid">
                  <div class="col-12 col-md-4 form-group">
                    <label class="form-label">Publicidad Izquierda</label>
                    <select class="form-control" id="publicityLeftStatus">
                      <option value="NO TIENE">NO TIENE</option>
                      <option value="TIENE">TIENE</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-8 form-group">
                    <label class="form-label">Detalle Publicidad Izquierda</label>
                    <input type="text" class="form-control" id="publicityLeftDetail" placeholder="Especificar la publicidad instalada">
                  </div>
                  <div class="col-12 col-md-4 form-group">
                    <label class="form-label">Da√±o por Retiro (Izquierda)</label>
                    <select class="form-control" id="publicityLeftDamage">
                      <option value="NO">NO</option>
                      <option value="SI">SI</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-8 form-group">
                    <label class="form-label">Detalle del Da√±o (Izquierda)</label>
                    <input type="text" class="form-control" id="publicityLeftDamageDetail" placeholder="Describe el da√±o por retiro si aplica">
                  </div>
                  <div class="col-12 col-md-4 form-group">
                    <label class="form-label">Residuos de Pegamento (Izquierda)</label>
                    <select class="form-control" id="publicityLeftResidue">
                      <option value="NO">NO</option>
                      <option value="SI">SI</option>
                    </select>
                  </div>
                  
                  <div class="col-12 col-md-4 form-group">
                    <label class="form-label">Publicidad Derecha</label>
                    <select class="form-control" id="publicityRightStatus">
                      <option value="NO TIENE">NO TIENE</option>
                      <option value="TIENE">TIENE</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-8 form-group">
                    <label class="form-label">Detalle Publicidad Derecha</label>
                    <input type="text" class="form-control" id="publicityRightDetail" placeholder="Especificar la publicidad instalada">
                  </div>
                  <div class="col-12 col-md-4 form-group">
                    <label class="form-label">Da√±o por Retiro (Derecha)</label>
                    <select class="form-control" id="publicityRightDamage">
                      <option value="NO">NO</option>
                      <option value="SI">SI</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-8 form-group">
                    <label class="form-label">Detalle del Da√±o (Derecha)</label>
                    <input type="text" class="form-control" id="publicityRightDamageDetail" placeholder="Describe el da√±o por retiro si aplica">
                  </div>
                  <div class="col-12 col-md-4 form-group">
                    <label class="form-label">Residuos de Pegamento (Derecha)</label>
                    <select class="form-control" id="publicityRightResidue">
                      <option value="NO">NO</option>
                      <option value="SI">SI</option>
                    </select>
                  </div>
                  
                  <div class="col-12 col-md-4 form-group">
                    <label class="form-label">Publicidad Luneta</label>
                    <select class="form-control" id="publicityRearStatus">
                      <option value="NO TIENE">NO TIENE</option>
                      <option value="TIENE">TIENE</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-8 form-group">
                    <label class="form-label">Detalle Publicidad Luneta</label>
                    <input type="text" class="form-control" id="publicityRearDetail" placeholder="Especificar la publicidad instalada">
                  </div>
                  <div class="col-12 col-md-4 form-group">
                    <label class="form-label">Da√±o por Retiro (Luneta)</label>
                    <select class="form-control" id="publicityRearDamage">
                      <option value="NO">NO</option>
                      <option value="SI">SI</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-8 form-group">
                    <label class="form-label">Detalle del Da√±o (Luneta)</label>
                    <input type="text" class="form-control" id="publicityRearDamageDetail" placeholder="Describe el da√±o por retiro si aplica">
                  </div>
                  <div class="col-12 col-md-4 form-group">
                    <label class="form-label">Residuos de Pegamento (Luneta)</label>
                    <select class="form-control" id="publicityRearResidue">
                      <option value="NO">NO</option>
                      <option value="SI">SI</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="toggle-section" id="toggleSummary">
                <div class="toggle-section-title">
                  <div class="section-icon">
                    <i class="fas fa-save"></i>
                  </div>
                  <span>Resumen y Guardar</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              
              <div class="toggle-section-content" id="summarySection">
                <div class="form-grid">
                  <div class="col-4 col-sm-12 form-group">
                    <label class="form-label">Estado General</label>
                    <select class="form-control" id="globalStatus">
                      <option>OK</option>
                      <option>Observaciones</option>
                      <option>Cr√≠tico</option>
                    </select>
                  </div>
                  
                  <div class="col-8 col-sm-12 form-group">
                    <label class="form-label">Observaciones Generales</label>
                    <input type="text" class="form-control" id="generalObservations" placeholder="Notas generales de la inspecci√≥n">
                  </div>
                  
                  <div class="col-12 d-flex gap-3">
                    <button class="btn btn-primary" id="btnSave">
                      <i class="fas fa-save"></i> Guardar/Actualizar Inspecci√≥n
                    </button>
                    <span class="chip" id="saveMsg">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- INFORME DE C√ÅMARAS -->
        <section id="section-cameras-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Informe de C√°maras</h3>
              <div class="d-flex align-center gap-3">
                <span class="chip">Registros: <strong id="cameraReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportCameras">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="camerasFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="camerasTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Marca</label>
                <select class="form-control" id="camerasMakeFilter">
                  <option value="">Todas</option>
                  <option>Volvo</option>
                  <option>Scania</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado Monitor</label>
                <select class="form-control" id="camerasMonitorFilter">
                  <option value="">Todos</option>
                  <option value="SI">Funcional</option>
                  <option value="NO">Con Problemas</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetCamerasFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyCamerasFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="camerasTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>PPU</th>
                    <th>Terminal</th>
                    <th>Asignaci√≥n</th>
                    <th>Modelo Chasis</th>
                    <th>Marca</th>
                    <th>A√±o</th>
                    <th>Monitor C√°mara</th>
                    <th>C√°mara Delantera</th>
                    <th>C√°mara Cabina</th>
                    <th>C√°maras Interiores</th>
                    <th>C√°mara Trasera</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- INFORME DE TAG -->
        <section id="section-tag-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Informe de TAG</h3>
              <div class="d-flex align-center gap-3">
                <span class="chip">Registros: <strong id="tagReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportTag">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="tagFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="tagTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado TAG</label>
                <select class="form-control" id="tagStatusFilter">
                  <option value="">Todos</option>
                  <option value="yes">Con TAG</option>
                  <option value="no">Sin TAG</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetTagFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyTagFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="tagTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>PPU</th>
                    <th>TAG</th>
                    <th>Serie TAG</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- INFORME DE EXTINTORES -->
        <section id="section-extinguisher-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Informe de Extintores</h3>
              <div class="d-flex align-center gap-3">
                <span class="chip">Registros: <strong id="extinguisherReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportExtinguishers">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="extinguisherFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="extinguisherTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado Extintor</label>
                <select class="form-control" id="extinguisherStatusFilter">
                  <option value="">Todos</option>
                  <option value="TIENE">Tiene</option>
                  <option value="NO TIENE">No tiene</option>
                  <option value="DA√ëADO">Da√±ado</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado Certificaci√≥n</label>
                <select class="form-control" id="extinguisherCertificationFilter">
                  <option value="">Todos</option>
                  <option value="TIENE">Tiene</option>
                  <option value="NO TIENE">No tiene</option>
                  <option value="DA√ëADO">Da√±ado</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Presi√≥n / Carga</label>
                <select class="form-control" id="extinguisherPressureFilter">
                  <option value="">Todas</option>
                  <option value="OPTIMA">√ìptima</option>
                  <option value="BAJA CARGA">Baja carga</option>
                  <option value="SOBRE CARGA">Sobre carga</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado Porta Extintor</label>
                <select class="form-control" id="extinguisherHolderFilter">
                  <option value="">Todos</option>
                  <option value="TIENE">Tiene</option>
                  <option value="NO TIENE">No tiene</option>
                  <option value="DA√ëADO">Da√±ado</option>
                  <option value="EXTINTOR NO ENTRA">Extintor no entra</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetExtinguisherFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyExtinguisherFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="extinguisherTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>PPU</th>
                    <th>Ubicaci√≥n</th>
                    <th>Fecha Vencimiento</th>
                    <th>Estado Extintor</th>
                    <th>Estado Certificaci√≥n</th>
                    <th>Estado Sonda</th>
                    <th>Estado Man√≥metro</th>
                    <th>Presi√≥n / Carga</th>
                    <th>Cilindro</th>
                    <th>Estado Porta Extintor</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- INFORME DE MOBILEYE -->
        <section id="section-mobileye-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Informe de Mobileye</h3>
              <div class="d-flex align-center gap-3">
                <span class="chip">Registros: <strong id="mobileyeReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportMobileye">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="mobileyeFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="mobileyeTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado Mobileye</label>
                <select class="form-control" id="mobileyeStatusFilter">
                  <option value="">Todos</option>
                  <option value="tiene">Funcional</option>
                  <option value="no tiene">Sin Mobileye</option>
                  <option value="da√±ado">Da√±ado</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetMobileyeFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyMobileyeFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="mobileyeTable">
                <thead>
                  <tr>
                    <th>PPU</th>
                    <th>Modelo</th>
                    <th>Marca</th>
                    <th>A√±o</th>
                    <th>Terminal</th>
                    <th>Tipo</th>
                    <th>Alerta IZQUIERDA</th>
                    <th>Alerta DERECHA</th>
                    <th>Consola</th>
                    <th>Sensor Frontal</th>
                    <th>Sensor IZQUIERDO</th>
                    <th>Sensor DERECHO</th>
                    <th>Sensor Trasero IZQUIERDO (ART)</th>
                    <th>Sensor Trasero DERECHO (ART)</th>
                    <th>Fecha Incidente</th>
                    <th>N¬∞ Incidente</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- INFORME DE OD√ìMETRO -->
        <section id="section-odometer-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Informe de Od√≥metro</h3>
              <div class="d-flex align-center gap-3">
                <span class="chip">Registros: <strong id="odometerReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportOdometer">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="odometerFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="odometerTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado Od√≥metro</label>
                <select class="form-control" id="odometerStatusFilter">
                  <option value="">Todos</option>
                  <option value="funcionando">Funcional</option>
                  <option value="no funciona">No Funciona</option>
                  <option value="da√±ado">Da√±ado</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetOdometerFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyOdometerFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="odometerTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>PPU</th>
                    <th>Terminal</th>
                    <th>Asignaci√≥n</th>
                    <th>Modelo Chasis</th>
                    <th>Marca</th>
                    <th>A√±o</th>
                    <th>Lectura Od√≥metro (km)</th>
                    <th>Estado Od√≥metro</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- TICKETS DE MANTENIMIENTO -->
        <section id="section-maintenance-tickets" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Tickets de Mantenimiento</h3>
              <div class="d-flex align-center gap-3 flex-wrap">
                <select id="ticketStatusFilter" class="form-control">
                  <option value="">Todos los Estados</option>
                  <option value="open">Abierto</option>
                  <option value="in_progress">En Progreso</option>
                  <option value="closed">Cerrado</option>
                </select>
                <button class="btn btn-success btn-sm" id="btnNewTicket">
                  <i class="fas fa-plus"></i> Nuevo Ticket
                </button>
                <button class="btn btn-primary btn-sm" id="btnExportTickets">
                  <i class="fas fa-file-excel"></i> Exportar Tickets
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="ticketsFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros Avanzados</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="ticketsTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Componente</label>
                <select class="form-control" id="ticketsComponentFilter">
                  <option value="">Todos</option>
                  <option>C√°maras</option>
                  <option>TAG</option>
                  <option>Extintor</option>
                  <option>Mobileye</option>
                  <option>Od√≥metro</option>
                  <option>Publicidad</option>
                  <option>Otro</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Prioridad</label>
                <select class="form-control" id="ticketsPriorityFilter">
                  <option value="">Todas</option>
                  <option value="low">Baja</option>
                  <option value="medium">Media</option>
                  <option value="high">Alta</option>
                  <option value="critical">Cr√≠tica</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Fecha Desde</label>
                <input type="date" class="form-control" id="ticketsDateFrom">
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetTicketsFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyTicketsFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="ticketsTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>PPU</th>
                    <th>Terminal</th>
                    <th>Componente</th>
                    <th>Descripci√≥n</th>
                    <th>Prioridad</th>
                    <th>Estado</th>
                    <th>Creado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
        
        <!-- INFORME DE INGRESOS -->
        <section id="section-session-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header flex-wrap">
              <h3 class="card-title">Ingresos a la Aplicaci√≥n</h3>
              <div class="d-flex align-center gap-3 flex-wrap">
                <select id="sessionTerminalFilter" class="form-control">
                  <option value="">Todos los terminales</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
                <input type="date" class="form-control" id="sessionDateFrom" title="Desde">
                <input type="date" class="form-control" id="sessionDateTo" title="Hasta">
                <button class="btn btn-primary btn-sm" id="btnApplySessionFilters">
                  <i class="fas fa-filter"></i> Aplicar
                </button>
                <button class="btn btn-light btn-sm" id="btnResetSessionFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
              </div>
            </div>
            
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-card-header">
                  <div class="stat-icon">
                    <i class="fas fa-user-check"></i>
                  </div>
                </div>
                <div class="stat-label">Inspectores Activos</div>
                <div class="stat-value" id="activeInspectorCount">0</div>
                <div class="stat-footer">
                  <span>√öltimas 24h</span>
                </div>
              </div>
              
              <div class="stat-card success">
                <div class="stat-card-header">
                  <div class="stat-icon success">
                    <i class="fas fa-bus"></i>
                  </div>
                </div>
                <div class="stat-label">Buses Revisados</div>
                <div class="stat-value" id="sessionBusTotal">0</div>
                <div class="stat-footer">
                  <span>Con registros de las sesiones</span>
                </div>
              </div>
              
              <div class="stat-card warning">
                <div class="stat-card-header">
                  <div class="stat-icon warning">
                    <i class="fas fa-ticket-alt"></i>
                  </div>
                </div>
                <div class="stat-label">Tickets Generados</div>
                <div class="stat-value" id="sessionTicketTotal">0</div>
                <div class="stat-footer">
                  <span>Derivados de hallazgos</span>
                </div>
              </div>
              
              <div class="stat-card">
                <div class="stat-card-header">
                  <div class="stat-icon">
                    <i class="fas fa-star"></i>
                  </div>
                </div>
                <div class="stat-label">Evaluaci√≥n Promedio</div>
                <div class="stat-value" id="sessionAverageScore">‚Äî</div>
                <div class="stat-footer">
                  <span id="sessionEvaluationNote">Sin datos</span>
                </div>
              </div>
            </div>
            
            <div class="table-container mt-4">
              <table class="table" id="sessionTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Inspector</th>
                    <th>Terminal</th>
                    <th>Inicio</th>
                    <th>Cierre</th>
                    <th>Buses Revisados</th>
                    <th>Tickets</th>
                    <th>Evaluaci√≥n</th>
                    <th>Acci√≥n</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- INFORME DE PUBLICIDAD -->
        <section id="section-advertising-report" class="hidden">
          <div class="card scaleIn">
            <div class="card-header flex-wrap">
              <h3 class="card-title">Informe de Publicidad</h3>
              <div class="d-flex align-center gap-3 flex-wrap">
                <span class="chip">Registros: <strong id="advertisingReportCount">0</strong></span>
                <button class="btn btn-primary btn-sm" id="btnExportAdvertising">
                  <i class="fas fa-file-excel"></i> Exportar .XLSX
                </button>
              </div>
            </div>
            
            <div class="filters-container" id="advertisingFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Terminal</label>
                <select class="form-control" id="advertisingTerminalFilter">
                  <option value="">Todos</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Ubicaci√≥n</label>
                <select class="form-control" id="advertisingSideFilter">
                  <option value="">Todas</option>
                  <option value="Izquierda">Izquierda</option>
                  <option value="Derecha">Derecha</option>
                  <option value="Luneta">Luneta</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Condici√≥n</label>
                <select class="form-control" id="advertisingIssueFilter">
                  <option value="">Todas</option>
                  <option value="con-dano">Con da√±o por retiro</option>
                  <option value="con-residuos">Con residuos de pegamento</option>
                  <option value="sin-issues">Sin incidencias</option>
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetAdvertisingFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyAdvertisingFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table class="table" id="advertisingTable">
                <thead>
                  <tr>
                    <th rowspan="2">#</th>
                    <th rowspan="2">PPU</th>
                    <th rowspan="2">Terminal</th>
                    <th colspan="5" class="text-center">Publicidad Izquierda</th>
                    <th colspan="5" class="text-center">Publicidad Derecha</th>
                    <th colspan="5" class="text-center">Publicidad Luneta</th>
                  </tr>
                  <tr>
                    <th>Estado</th>
                    <th>Publicidad</th>
                    <th>Da√±o</th>
                    <th>Residuos</th>
                    <th>Observaciones</th>
                    <th>Estado</th>
                    <th>Publicidad</th>
                    <th>Da√±o</th>
                    <th>Residuos</th>
                    <th>Observaciones</th>
                    <th>Estado</th>
                    <th>Publicidad</th>
                    <th>Da√±o</th>
                    <th>Residuos</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ESTADO DE FLOTA -->
        <section id="section-fleet-status" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Resumen de Estado de Flota</h3>
              <div class="d-flex align-center gap-3">
                <select id="fleetTerminalFilter" class="form-control">
                  <option value="">Todos los Terminales</option>
                  <option>El Roble</option>
                  <option>La Reina</option>
                  <option>Maria Angelica</option>
                  <option>El Descanso</option>
                </select>
                <button class="btn btn-primary btn-sm" id="btnExportFleet">
                  <i class="fas fa-file-excel"></i> Exportar Datos de Flota
                </button>
              </div>
            </div>
            
            <!-- Estad√≠sticas de Flota -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-card-header">
                  <div class="stat-icon">
                    <i class="fas fa-bus"></i>
                  </div>
                </div>
                <div class="stat-label">Total de Buses</div>
                <div class="stat-value" id="fleetTotalCount">0</div>
              </div>
              
              <div class="stat-card success">
                <div class="stat-card-header">
                  <div class="stat-icon success">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </div>
                <div class="stat-label">Operativos</div>
                <div class="stat-value text-success" id="fleetOperationalCount">0</div>
              </div>
              
              <div class="stat-card warning">
                <div class="stat-card-header">
                  <div class="stat-icon warning">
                    <i class="fas fa-tools"></i>
                  </div>
                </div>
                <div class="stat-label">En Mantenimiento</div>
                <div class="stat-value text-warning" id="fleetMaintenanceCount">0</div>
              </div>
              
              <div class="stat-card danger">
                <div class="stat-card-header">
                  <div class="stat-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                </div>
                <div class="stat-label">Problemas Cr√≠ticos</div>
                <div class="stat-value text-danger" id="fleetCriticalCount">0</div>
              </div>
            </div>
            
            <div class="filters-container mt-4" id="fleetFilterContainer">
              <div class="filter-title">
                <i class="fas fa-filter text-primary"></i>
                <h5>Filtros</h5>
              </div>
              
              <div class="form-group">
                <label class="form-label">Marca</label>
                <select class="form-control" id="fleetMakeFilter">
                  <option value="">Todas</option>
                  <option>Volvo</option>
                  <option>Scania</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Estado</label>
                <select class="form-control" id="fleetStatusFilter">
                  <option value="">Todos</option>
                  <option value="Operational">Operativo</option>
                  <option value="Maintenance">En Mantenimiento</option>
                  <option value="Critical">Problemas Cr√≠ticos</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">A√±o</label>
                <select class="form-control" id="fleetYearFilter">
                  <option value="">Todos</option>
                  <!-- Se llenar√° din√°micamente -->
                </select>
              </div>
              
              <div class="filter-actions">
                <button class="btn btn-light btn-sm" id="resetFleetFilters">
                  <i class="fas fa-redo"></i> Restablecer
                </button>
                <button class="btn btn-primary btn-sm" id="applyFleetFilters">
                  <i class="fas fa-check"></i> Aplicar
                </button>
              </div>
            </div>
            
            <div class="table-container mt-4">
              <table class="table" id="fleetStatusTable">
                <thead>
                  <tr>
                    <th>PPU</th>
                    <th># Interno</th>
                    <th>Marca/Modelo</th>
                    <th>A√±o</th>
                    <th>Terminal</th>
                    <th>√öltima Inspecci√≥n</th>
                    <th>Estado</th>
                    <th>Od√≥metro</th>
                    <th>Problemas Abiertos</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
        
        <!-- PREFERENCIAS DE USUARIO -->
        <section id="section-user-settings" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Preferencias de Usuario</h3>
            </div>
            
            <div class="form-grid">
              <div class="col-6 col-md-12">
                <div class="form-group">
                  <label class="form-label">Nombre del Inspector</label>
                  <input type="text" class="form-control" id="settingsName">
                </div>
                
                <div class="form-group">
                  <label class="form-label">Terminal Predeterminado</label>
                  <select class="form-control" id="settingsTerminal">
                    <option value="">‚Äî Seleccionar ‚Äî</option>
                    <option>El Roble</option>
                    <option>La Reina</option>
                    <option>Maria Angelica</option>
                    <option>El Descanso</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Tema</label>
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input type="radio" id="themeLight" name="theme" value="light" class="form-check">
                      <label for="themeLight">Claro</label>
                    </div>
                    <div class="form-check">
                      <input type="radio" id="themeDark" name="theme" value="dark" class="form-check">
                      <label for="themeDark">Oscuro</label>
                    </div>
                    <div class="form-check">
                      <input type="radio" id="themeSystem" name="theme" value="system" class="form-check">
                      <label for="themeSystem">Sistema</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-6 col-md-12">
                <div class="form-group">
                  <label class="form-label">Notificaciones</label>
                  <div class="d-flex flex-column gap-2">
                    <div class="form-check">
                      <input type="checkbox" id="notifTickets" class="form-check">
                      <label for="notifTickets">Nuevos tickets de mantenimiento</label>
                    </div>
                    <div class="form-check">
                      <input type="checkbox" id="notifInspections" class="form-check">
                      <label for="notifInspections">Inspecciones pendientes</label>
                    </div>
                    <div class="form-check">
                      <input type="checkbox" id="notifCritical" class="form-check">
                      <label for="notifCritical">Problemas cr√≠ticos</label>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Vista Predeterminada</label>
                  <select class="form-control" id="settingsDefaultView">
                    <option value="inspection-form">Formulario de Inspecci√≥n</option>
                    <option value="dashboard">Dashboard</option>
                    <option value="fleet-status">Estado de Flota</option>
                  </select>
                </div>
              </div>
              
              <div class="col-12 d-flex justify-end mt-4">
                <button class="btn btn-light" id="btnResetSettings">
                  <i class="fas fa-undo"></i> Restablecer
                </button>
                <button class="btn btn-primary ml-3" id="btnSaveSettings">
                  <i class="fas fa-save"></i> Guardar Preferencias
                </button>
              </div>
            </div>
          </div>
        </section>
        
        <!-- AYUDA -->
        <section id="section-help" class="hidden">
          <div class="card scaleIn">
            <div class="card-header">
              <h3 class="card-title">Ayuda y Soporte</h3>
            </div>
            
            <div class="toggle-section active">
              <div class="toggle-section-title">
                <div class="section-icon">
                  <i class="fas fa-question-circle"></i>
                </div>
                <span>¬øC√≥mo empezar?</span>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="toggle-section-content show">
              <p>Para comenzar a utilizar el Sistema de Inspecci√≥n de Buses, sigue estos pasos:</p>
              <ol>
                <li>Inicia sesi√≥n con tu nombre y terminal asignado</li>
                <li>Selecciona la semana de inspecci√≥n actual</li>
                <li>Busca un bus por su PPU o n√∫mero interno</li>
                <li>Completa el formulario de inspecci√≥n para cada secci√≥n</li>
                <li>Guarda los cambios utilizando el bot√≥n "Guardar/Actualizar Inspecci√≥n"</li>
              </ol>
              <p>Los registros se guardar√°n autom√°ticamente y estar√°n disponibles en los informes correspondientes.</p>
            </div>
            
            <div class="toggle-section">
              <div class="toggle-section-title">
                <div class="section-icon">
                  <i class="fas fa-file-alt"></i>
                </div>
                <span>Informes Disponibles</span>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="toggle-section-content">
              <p>El sistema ofrece varios informes que te ayudar√°n a analizar el estado de la flota:</p>
              <ul>
                <li><strong>Informe de C√°maras:</strong> Estado y funcionamiento de todas las c√°maras en los buses.</li>
                <li><strong>Informe de TAG:</strong> Revisi√≥n de presencia y funcionamiento de dispositivos TAG.</li>
                <li><strong>Informe de Mobileye:</strong> Estado de los sistemas Mobileye en buses Volvo.</li>
                <li><strong>Informe de Od√≥metro:</strong> Registro de lecturas y estado del od√≥metro.</li>
              </ul>
              <p>Todos los informes pueden filtrarse y exportarse a Excel para an√°lisis adicional.</p>
            </div>
            
            <div class="toggle-section">
              <div class="toggle-section-title">
                <div class="section-icon">
                  <i class="fas fa-ticket-alt"></i>
                </div>
                <span>Sistema de Tickets</span>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="toggle-section-content">
              <p>El sistema de tickets de mantenimiento permite seguir y resolver problemas detectados durante las inspecciones:</p>
              <ul>
                <li>Los tickets se crean autom√°ticamente cuando se detectan problemas en la inspecci√≥n</li>
                <li>Tambi√©n puedes crear tickets manualmente para reportar otros problemas</li>
                <li>Cada ticket tiene un estado (Abierto, En Progreso, Cerrado) y una prioridad</li>
                <li>Puedes actualizar el estado y a√±adir notas de resoluci√≥n</li>
              </ul>
              <p>Mant√©n actualizados los tickets para asegurar que todos los problemas sean atendidos oportunamente.</p>
            </div>
            
            <div class="toggle-section">
              <div class="toggle-section-title">
                <div class="section-icon">
                  <i class="fas fa-cog"></i>
                </div>
                <span>Contacto de Soporte</span>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="toggle-section-content">
              <p>Si necesitas ayuda adicional o encuentras alg√∫n problema con el sistema: Isaac Avila Gomez.</p>
              <div class="d-flex flex-column gap-2 mt-3">
                <div><i class="fas fa-envelope"></i> <strong>Email:</strong>isaac_avila.gomez@outlook.com</div>
                <div><i class="fas fa-phone"></i> <strong>Tel√©fono:</strong> +56984752936</div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Navegaci√≥n M√≥vil -->
  <div class="mobile-bottom-nav">
    <div class="nav-items">
      <div class="nav-item active" data-section="inspection-form">
        <i class="fas fa-clipboard-check"></i>
        <span>Inspecci√≥n</span>
      </div>
      <div class="nav-item" data-section="dashboard">
        <i class="fas fa-chart-line"></i>
        <span>Dashboard</span>
      </div>
      <div class="nav-item" data-section="cameras-report">
        <i class="fas fa-video"></i>
        <span>C√°maras</span>
      </div>
      <div class="nav-item" data-section="tag-report">
        <i class="fas fa-tag"></i>
        <span>Tag</span>
      </div>
      <div class="nav-item" data-section="extinguisher-report">
        <i class="fas fa-fire-extinguisher"></i>
        <span>Extintores</span>
      </div>
      <div class="nav-item" data-section="session-report">
        <i class="fas fa-user-clock"></i>
        <span>Ingresos</span>
      </div>
      <div class="nav-item" data-section="fleet-status">
        <i class="fas fa-bus"></i>
        <span>Flota</span>
      </div>
    </div>
  </div>

  <!-- Bot√≥n FAB -->
  <button class="fab-button" id="fabAction" aria-label="Guardar inspecci√≥n">
    <i class="fas fa-save"></i>
    <span class="fab-badge hidden" id="fabBadge">0</span>
  </button>

  <!-- MODALES -->
  <!-- Fondo de Modal -->
  <div class="modal-backdrop" id="modalBackdrop"></div>

  <!-- Modal de Inicio de Sesi√≥n -->
  <div class="modal" id="loginModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Iniciar Registro</h4>
          <button class="modal-close" id="loginModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group mb-4">
            <label class="form-label">Nombre del Inspector</label>
            <input type="text" class="form-control" id="inspectorName">
          </div>
          <div class="form-group">
            <label class="form-label">Terminal</label>
            <select class="form-control" id="inspectorTerminal">
              <option value="">‚Äî Seleccionar ‚Äî</option>
              <option>El Roble</option>
              <option>La Reina</option>
              <option>Maria Angelica</option>
              <option>El Descanso</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="btnStartSession">Iniciar Sesi√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Inspecciones Pendientes -->
  <div class="modal" id="pendingModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Inspecciones Pendientes</h4>
          <button class="modal-close" id="pendingModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-between align-center mb-4">
            <span class="chip chip-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <span id="pendingListCount">0</span> inspecciones pendientes
            </span>
            <select class="form-control" id="pendingFilterTerminal">
              <option value="">Todos los terminales</option>
              <option>El Roble</option>
              <option>La Reina</option>
              <option>Maria Angelica</option>
              <option>El Descanso</option>
            </select>
          </div>
          <div id="pendingList">
            <!-- Ser√° poblado por JS -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" id="btnClosePending">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Estado del Bus -->
  <div class="modal" id="busStatusModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Estado del Bus</h4>
          <button class="modal-close" id="busStatusModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¬øEl bus est√° operativo o fuera de servicio?</label>
            <select class="form-control" id="busPanneStatus">
              <option value="operational">Operativo</option>
              <option value="out_of_service">Fuera de Servicio</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="btnConfirmBusStatus">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalles de Ticket -->
  <div class="modal" id="ticketDetailsModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Detalles del Ticket de Mantenimiento</h4>
          <button class="modal-close" id="ticketDetailsModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-between align-center mb-4">
            <span class="chip" id="ticketIdChip">Ticket #<span id="ticketIdDisplay">0</span></span>
            <span class="chip" id="ticketDateChip"><i class="fas fa-calendar"></i> <span id="ticketDateDisplay">‚Äî</span></span>
          </div>
          
          <div class="form-group mb-3">
            <label class="form-label">PPU del Bus</label>
            <input type="text" class="form-control" id="ticketBusPPU" disabled>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Componente</label>
            <input type="text" class="form-control" id="ticketComponent" disabled>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Descripci√≥n del Problema</label>
            <textarea class="form-control" id="ticketDescription" disabled></textarea>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Prioridad</label>
            <select class="form-control" id="ticketPriority">
              <option value="low">Baja</option>
              <option value="medium">Media</option>
              <option value="high">Alta</option>
              <option value="critical">Cr√≠tica</option>
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Estado</label>
            <select class="form-control" id="ticketStatus">
              <option value="open">Abierto</option>
              <option value="in_progress">En Progreso</option>
              <option value="closed">Cerrado</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Notas de Resoluci√≥n</label>
            <textarea class="form-control" id="ticketResolution" placeholder="Detalles sobre la resoluci√≥n o progreso"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="btnDeleteTicket">
            <i class="fas fa-trash"></i> Eliminar
          </button>
          <button class="btn btn-success" id="btnUpdateTicket">
            <i class="fas fa-check-circle"></i> Actualizar Ticket
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalle de Sesi√≥n -->
  <div class="modal" id="sessionDetailModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Detalle de Desempe√±o</h4>
          <button class="modal-close" id="sessionDetailClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="d-flex flex-column gap-3 mb-4">
            <div class="chip chip-primary" id="sessionDetailInspector">
              <i class="fas fa-user-check"></i>
              <span>‚Äî</span>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <span class="chip" id="sessionDetailTerminal"><i class="fas fa-map-marker-alt"></i> ‚Äî</span>
              <span class="chip" id="sessionDetailRange"><i class="fas fa-clock"></i> ‚Äî</span>
              <span class="chip chip-success" id="sessionDetailBuses"><i class="fas fa-bus"></i> 0 buses</span>
              <span class="chip chip-warning" id="sessionDetailTickets"><i class="fas fa-ticket-alt"></i> 0 tickets</span>
            </div>
            <p class="text-info" id="sessionDetailEvaluation">Evaluaci√≥n pendiente.</p>
          </div>
          
          <div class="table-container">
            <table class="table table-sm" id="sessionDetailTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>PPU</th>
                  <th>Terminal</th>
                  <th>Fecha</th>
                  <th>Estado</th>
                  <th>Tickets</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
          <div class="mt-4">
            <h5>Hallazgos que generaron tickets</h5>
            <ul id="sessionDetailFindings" class="mt-2" style="padding-left: 1.25rem;"></ul>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" id="sessionDetailDismiss">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Nuevo Ticket -->
  <div class="modal" id="newTicketModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Crear Nuevo Ticket de Mantenimiento</h4>
          <button class="modal-close" id="newTicketModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group mb-3">
            <label class="form-label">PPU del Bus</label>
            <div class="d-flex gap-2">
              <input type="text" class="form-control" id="newTicketPPU" placeholder="Ej. XXYY11">
              <button type="button" class="btn btn-light" id="btnSearchTicketBus">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div id="newTicketBusInfo" class="hidden mb-3">
            <div class="chip chip-primary" id="newTicketBusDisplay">
              <i class="fas fa-bus"></i>
              <span>‚Äî</span>
            </div>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Componente</label>
            <select class="form-control" id="newTicketComponent">
              <option value="">‚Äî Seleccionar ‚Äî</option>
              <option>C√°maras</option>
              <option>TAG</option>
              <option>Extintor</option>
              <option>Mobileye</option>
              <option>Od√≥metro</option>
              <option>Otro</option>
            </select>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Descripci√≥n del Problema</label>
            <textarea class="form-control" id="newTicketDescription" placeholder="Describa el problema en detalle..."></textarea>
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Prioridad</label>
            <select class="form-control" id="newTicketPriority">
              <option value="low">Baja</option>
              <option value="medium">Media</option>
              <option value="high">Alta</option>
              <option value="critical">Cr√≠tica</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" id="btnCancelNewTicket">Cancelar</button>
          <button class="btn btn-primary" id="btnCreateTicket">Crear Ticket</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencias: Supabase JS, SheetJS, y Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <script>
   /**
 * Sistema Avanzado de Inspecci√≥n de Buses
 * Enhanced JavaScript Core
 * Version: 2.0.0
 * Author: Claude - Professional Web Developer
 */

// ===================== GLOBAL CONFIGURATION =====================
const APP_CONFIG = {
  supabase: {
    url: "https://wvcplgwemvqhvtstlqmt.supabase.co",
    anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2Y3BsZ3dlbXZxaHZ0c3RscW10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjIyMDUsImV4cCI6MjA3NTkzODIwNX0.K1YOv5lRn9fOous3AyG2gPxsQBzqOXRfYHgrCmO5zxk",
  },
  dateFormat: {
    short: { day: '2-digit', month: '2-digit', year: 'numeric' },
    medium: { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' },
    long: { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }
  },
  maxActivityItems: 50,
  storageKeys: {
    theme: 'bus_inspection_theme',
    session: 'bus_inspection_session',
    recentActivity: 'bus_inspection_activity',
    lastSection: 'bus_inspection_last_section',
    sessionLog: 'bus_inspection_session_log',
    preferences: 'bus_inspection_preferences'
  },
  terminals: ['El Roble', 'La Reina', 'Maria Angelica', 'El Descanso'],
  debounceTime: 300,
  notificationDuration: 4000,
  loaderDelay: 300
};

// ===================== GLOBAL STATE =====================
const APP_STATE = {
  session: {
    inspector: "",
    terminal: "",
    week: getISOWeek(),
    theme: localStorage.getItem(APP_CONFIG.storageKeys.theme) || 'system'
  },
  currentBus: null,
  inspectionId: null,
  filters: {
    cameras: {},
    tag: {},
    extinguishers: {},
    sessions: {},
    mobileye: {},
    odometer: {},
    advertising: {},
    tickets: {},
    fleet: {}
  },
  pendingRequests: 0,
  charts: {},
  currentSession: {
    logId: null,
    startedAt: null,
    buses: [],
    ticketCount: 0
  },
  sessionLoggingDisabled: false,
  sessionReportRows: [],
  initialized: false
};

// ===================== DATABASE INITIALIZATION =====================
const supabase = initSupabase();

function initSupabase() {
  try {
    if (!window.supabase || typeof window.supabase.createClient !== 'function') {
      throw new Error('Supabase library is not available');
    }
    
    return window.supabase.createClient(
      APP_CONFIG.supabase.url, 
      APP_CONFIG.supabase.anonKey
    );
  } catch (error) {
    console.error('Failed to initialize Supabase client:', error);
    showNotification('error', 'Error de Conexi√≥n', 'No se pudo establecer conexi√≥n con la base de datos');
    return null;
  }
}

// ===================== UTILITY FUNCTIONS =====================
/**
 * Gets the ISO week from a date
 * @param {Date} date - Date to get ISO week from (defaults to current date)
 * @returns {string} ISO week string in YYYY-Wnn format
 */
function getISOWeek(date = new Date()) {
  const localDate = new Date(date);
  const utcDate = new Date(Date.UTC(localDate.getFullYear(), localDate.getMonth(), localDate.getDate()));
  const dayNum = utcDate.getUTCDay() || 7;
  utcDate.setUTCDate(utcDate.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(utcDate.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((utcDate - yearStart) / 86400000) + 1) / 7);
  return `${utcDate.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
}

/**
 * Gets a list of ISO weeks for the selector
 * @param {number} range - Number of weeks to include
 * @returns {string[]} Array of ISO week strings
 */
function getISOWeeksForSelect(range = 12) {
  const list = [];
  const now = new Date();
  for (let i = 0; i <= range; i++) {
    const d = new Date(now);
    d.setDate(d.getDate() - (i * 7));
    list.push(getISOWeek(d));
  }
  return list;
}

/**
 * Gets the date range for a given ISO week
 * @param {string} isoWeek - ISO week string in YYYY-Wnn format
 * @returns {string} Formatted date range string
 */
function getWeekRange(isoWeek) {
  try {
    const [yearStr, weekStr] = isoWeek.split('-W');
    const year = parseInt(yearStr, 10);
    const week = parseInt(weekStr, 10);
    
    if (Number.isNaN(year) || Number.isNaN(week)) {
      throw new Error('Semana ISO inv√°lida');
    }
    
    // Fecha aproximada del jueves de la semana ISO solicitada
    const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
    const dayOfWeek = simple.getUTCDay() || 7; // 1..7 (lunes=1)
    
    // Retroceder hasta el lunes de esa semana ISO
    const weekStartUTC = new Date(simple);
    weekStartUTC.setUTCDate(simple.getUTCDate() - (dayOfWeek - 1));
    
    const start = new Date(
      weekStartUTC.getUTCFullYear(),
      weekStartUTC.getUTCMonth(),
      weekStartUTC.getUTCDate()
    );
    
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    
    const formatDate = (date) =>
      date.toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit' });
    
    return `${formatDate(start)} - ${formatDate(end)}`;
  } catch (error) {
    console.error('Error calculating week range:', error);
    return 'Rango de fecha inv√°lido';
  }
}

/**
 * Normalizes inspector names to a consistent Title Case format
 * @param {string} name - Raw inspector name input
 * @returns {string} Normalized inspector name
 */
function normalizeInspectorName(name) {
  if (!name) return '';
  return name
    .toString()
    .trim()
    .replace(/\s+/g, ' ')
    .toLowerCase()
    .split(' ')
    .filter(Boolean)
    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');
}

/**
 * Generates a normalized key for inspector names (lowercase, sin acentos)
 * @param {string} name - Inspector name
 * @returns {string}
 */
function normalizeInspectorKey(name) {
  return normalizeInspectorName(name)
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase();
}

/**
 * Inserts or updates an inspection section ensuring a single row per inspeccion_id
 * @param {string} table - Supabase table name
 * @param {Object} payload - Row data including inspeccion_id
 * @returns {Promise<number|null>} Row id if available
 */
async function upsertInspectionSection(table, payload) {
  if (!supabase) throw new Error('Supabase client not initialized');
  if (!payload || !payload.inspeccion_id) {
    throw new Error(`Payload for ${table} missing inspeccion_id`);
  }
  
  const inspeccionId = payload.inspeccion_id;
  const { data: existing, error: selectError } = await supabase
    .from(table)
    .select('id')
    .eq('inspeccion_id', inspeccionId)
    .maybeSingle();
  
  if (selectError && selectError.code !== 'PGRST116') {
    throw selectError;
  }
  
  if (existing?.id) {
    const { error: updateError } = await supabase
      .from(table)
      .update(payload)
      .eq('inspeccion_id', inspeccionId);
    
    if (updateError) {
      throw updateError;
    }
    
    return existing.id;
  }
  
  const { data: inserted, error: insertError } = await supabase
    .from(table)
    .insert(payload)
    .select('id')
    .maybeSingle();
  
  if (insertError) {
    throw insertError;
  }
  
  return inserted?.id || null;
}

function isMobileView() {
  return window.matchMedia('(max-width: 768px)').matches;
}

function updateFabAppearance() {
  const fabButton = document.getElementById('fabAction');
  const icon = fabButton?.querySelector('i');
  const badge = document.getElementById('fabBadge');
  if (!fabButton || !icon || !badge) return;

  if (isMobileView()) {
    fabButton.classList.add('fab-pending');
    fabButton.setAttribute('aria-label', 'Ver inspecciones pendientes');
    icon.className = 'fas fa-clipboard-list';
    const count = parseInt(badge.textContent || '0', 10) || 0;
    badge.classList.toggle('hidden', count === 0);
  } else {
    fabButton.classList.remove('fab-pending');
    fabButton.setAttribute('aria-label', 'Guardar inspecci√≥n');
    icon.className = 'fas fa-save';
    badge.classList.add('hidden');
  }
}

function updatePendingFabCount(count) {
  const badge = document.getElementById('fabBadge');
  if (!badge) return;

  badge.textContent = Math.max(0, count || 0).toString();
  if (isMobileView()) {
    badge.classList.toggle('hidden', count === 0);
  } else {
    badge.classList.add('hidden');
  }
}

/**
 * Debounces a function call
 * @param {Function} func - The function to debounce
 * @param {number} wait - The time to wait in milliseconds
 * @returns {Function} Debounced function
 */
function debounce(func, wait = APP_CONFIG.debounceTime) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ===================== UI UTILITIES =====================
/**
 * Shows the loading indicator with a message
 * @param {string} message - Message to display
 */
function showLoader(message = 'Cargando...') {
  const loaderContainer = document.getElementById('loaderContainer');
  const loaderText = document.getElementById('loaderText');
  
  if (!loaderContainer || !loaderText) return;
  
  loaderText.textContent = message;
  loaderContainer.classList.add('show');
  
  // Track pending requests for better UX
  APP_STATE.pendingRequests++;
  
  // Prevent flashing loader for quick operations
  return setTimeout(() => {
    if (APP_STATE.pendingRequests > 0) {
      loaderContainer.style.opacity = '1';
    }
  }, APP_CONFIG.loaderDelay);
}

/**
 * Hides the loading indicator
 */
function hideLoader() {
  const loaderContainer = document.getElementById('loaderContainer');
  if (!loaderContainer) return;
  
  // Decrement pending requests counter
  APP_STATE.pendingRequests = Math.max(0, APP_STATE.pendingRequests - 1);
  
  // Only hide loader if all pending requests are complete
  if (APP_STATE.pendingRequests === 0) {
    loaderContainer.style.opacity = '0';
    setTimeout(() => {
      loaderContainer.classList.remove('show');
    }, 300);
  }
}

/**
 * Shows a notification
 * @param {string} type - Notification type (success, warning, error, info)
 * @param {string} title - Notification title
 * @param {string} message - Notification message
 * @param {number} duration - Duration to show notification in milliseconds
 */
function showNotification(type, title, message, duration = APP_CONFIG.notificationDuration) {
  const container = document.getElementById('notificationContainer');
  if (!container) return;
  
  const notificationId = `notification-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
  
  const notificationHTML = `
    <div class="notification notification-${type} fadeIn" id="${notificationId}">
      <div class="notification-icon">
        <i class="fas ${
          type === 'success' ? 'fa-check-circle' : 
          type === 'warning' ? 'fa-exclamation-triangle' : 
          type === 'error' ? 'fa-times-circle' : 
          'fa-info-circle'
        }"></i>
      </div>
      <div class="notification-content">
        <div class="notification-title">${escapeHTML(title)}</div>
        <p class="notification-message">${escapeHTML(message)}</p>
      </div>
      <button class="notification-close" aria-label="Cerrar notificaci√≥n">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', notificationHTML);
  
  const notificationElement = document.getElementById(notificationId);
  if (!notificationElement) return;
  
  // Add click listener to close button
  const closeButton = notificationElement.querySelector('.notification-close');
  if (closeButton) {
    closeButton.addEventListener('click', () => {
      notificationElement.classList.add('fade-out');
      setTimeout(() => {
        notificationElement.remove();
      }, 300);
    });
  }
  
  // Auto-remove after duration
  if (duration > 0) {
    setTimeout(() => {
      if (notificationElement && notificationElement.parentNode) {
        notificationElement.classList.add('fade-out');
        setTimeout(() => {
          if (notificationElement && notificationElement.parentNode) {
            notificationElement.remove();
          }
        }, 300);
      }
    }, duration);
  }
  
  // Log notifications to console for debugging
  console.info(`Notification [${type}]: ${title} - ${message}`);
}

let liveAlertTimeout = null;

function showLiveAlert(message, type = 'success') {
  if (!message) return;
  
  const alertType = ['success', 'warning', 'danger', 'info'].includes(type) ? type : 'success';
  if (liveAlertTimeout) {
    clearTimeout(liveAlertTimeout);
    liveAlertTimeout = null;
  }
  
  const existing = document.getElementById('liveAlertBanner');
  if (existing) {
    existing.remove();
  }
  
  const banner = document.createElement('div');
  banner.id = 'liveAlertBanner';
  banner.className = `live-alert live-alert-${alertType}`;
  
  const iconMap = {
    success: 'fa-check-circle',
    warning: 'fa-exclamation-triangle',
    danger: 'fa-times-circle',
    info: 'fa-info-circle'
  };
  
  banner.innerHTML = `
    <i class="fas ${iconMap[alertType] || iconMap.success}"></i>
    <span>${escapeHTML(message)}</span>
  `;
  
  document.body.appendChild(banner);
  
  requestAnimationFrame(() => banner.classList.add('show'));
  
  liveAlertTimeout = setTimeout(() => {
    banner.classList.remove('show');
    banner.addEventListener('transitionend', () => {
      banner.remove();
    }, { once: true });
  }, 3500);
}


function resetSessionLogState() {
  APP_STATE.currentSession = {
    logId: null,
    startedAt: null,
    buses: [],
    ticketCount: 0
  };
}

function getStoredSessionLogMetadata() {
  try {
    const raw = localStorage.getItem(APP_CONFIG.storageKeys.sessionLog);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (error) {
    console.error('Error parsing stored session log metadata:', error);
    return null;
  }
}

function storeSessionLogMetadata(metadata) {
  if (!metadata || !metadata.id) return;
  try {
    localStorage.setItem(APP_CONFIG.storageKeys.sessionLog, JSON.stringify(metadata));
  } catch (error) {
    console.error('Error storing session log metadata:', error);
  }
}

function clearStoredSessionLogMetadata() {
  localStorage.removeItem(APP_CONFIG.storageKeys.sessionLog);
}

function setCurrentSessionFromRecord(record) {
  if (!record) return;
  
  APP_STATE.currentSession.logId = record.id;
  
  const startedAt = record.started_at || new Date().toISOString();
  APP_STATE.currentSession.startedAt = startedAt;
  
  let buses = [];
  if (Array.isArray(record.buses)) {
    buses = record.buses;
  } else if (typeof record.buses === 'string' && record.buses.trim() !== '') {
    try {
      buses = JSON.parse(record.buses) || [];
    } catch (error) {
      buses = [];
    }
  }
  
  APP_STATE.currentSession.buses = buses;
  APP_STATE.currentSession.ticketCount = typeof record.ticket_count === 'number'
    ? record.ticket_count
    : buses.reduce((sum, bus) => {
        if (!bus) return sum;
        const tickets = Array.isArray(bus.tickets) ? bus.tickets.length : 0;
        return sum + tickets;
      }, 0);
  
  storeSessionLogMetadata({
    id: record.id,
    inspector: APP_STATE.session.inspector,
    terminal: APP_STATE.session.terminal,
    startedAt
  });
}

async function closeDuplicateSessionLogs(inspector, terminal, excludeId = null) {
  if (!supabase) return;
  
  const normalizedInspector = normalizeInspectorName(inspector);
  const normalizedTerminalLower = terminal.trim().toLowerCase();
  
  try {
    const { data, error } = await supabase
      .from('revision_semanal_ingresos')
      .select('id, inspector, terminal')
      .ilike('inspector', normalizedInspector)
      .is('ended_at', null);
    
    if (error) throw error;
    
    const duplicates = (data || []).filter(row => {
      if (!row) return false;
      if (excludeId && row.id === excludeId) return false;
      const rowInspector = normalizeInspectorName(row.inspector || '');
      const rowTerminal = (row.terminal || '').trim().toLowerCase();
      return rowInspector === normalizedInspector && rowTerminal === normalizedTerminalLower;
    });
    
    if (duplicates.length === 0) return;
    
    const duplicateIds = duplicates.map(row => row.id);
    await supabase
      .from('revision_semanal_ingresos')
      .update({ ended_at: new Date().toISOString() })
      .in('id', duplicateIds);
  } catch (error) {
    console.error('Error closing duplicate session logs:', error);
  }
}


async function createSessionLog(inspector, terminal, options = {}) {
  if (!supabase || !inspector || !terminal) return null;
  if (APP_STATE.sessionLoggingDisabled) return null;
  
  const normalizedInspector = normalizeInspectorName(inspector);
  const cleanTerminal = terminal.trim();
  const normalizedTerminalLower = cleanTerminal.toLowerCase();
  
  try {
    if (options.reuseExisting !== false) {
      const { data: existingRows, error: existingError } = await supabase
        .from('revision_semanal_ingresos')
        .select('id, inspector, terminal, started_at, ended_at, bus_count, ticket_count, buses')
        .ilike('inspector', normalizedInspector)
        .is('ended_at', null)
        .order('started_at', { ascending: false });
      
      if (existingError) throw existingError;
      
      const existingLog = (existingRows || []).find(row => {
        const rowTerminal = (row.terminal || '').trim().toLowerCase();
        return normalizeInspectorName(row.inspector) === normalizedInspector && rowTerminal === normalizedTerminalLower;
      });
      if (existingLog) {
        storeSessionLogMetadata({
          id: existingLog.id,
          inspector: normalizedInspector,
          terminal: cleanTerminal,
          startedAt: existingLog.started_at || new Date().toISOString()
        });
        await closeDuplicateSessionLogs(normalizedInspector, cleanTerminal, existingLog.id);
        return existingLog;
      }
    }
    
    const startedAt = new Date().toISOString();
    
    const { data, error } = await supabase
      .from('revision_semanal_ingresos')
      .insert({
        inspector: normalizedInspector,
        terminal: cleanTerminal,
        started_at: startedAt,
        ended_at: null,
        bus_count: 0,
        ticket_count: 0,
        buses: []
      })
      .select('id, inspector, terminal, started_at, ended_at, bus_count, ticket_count, buses')
      .maybeSingle();
    
    if (error) throw error;
    
    if (data) {
      storeSessionLogMetadata({
        id: data.id,
        inspector: normalizedInspector,
        terminal: cleanTerminal,
        startedAt: data.started_at || startedAt
      });
      await closeDuplicateSessionLogs(normalizedInspector, cleanTerminal, data.id);
    }
    
    return data || null;
  } catch (error) {
    console.error('Error creating session log:', error);
    if (error?.code === '42501') {
      APP_STATE.sessionLoggingDisabled = true;
      showNotification(
        'warning',
        'Registro de Ingreso',
        'El usuario actual no tiene permisos para insertar en "revision_semanal_ingresos". Se deshabilita temporalmente el registro de ingresos hasta configurar las pol√≠ticas RLS.'
      );
    } else {
      showNotification('warning', 'Registro de Ingreso', 'No se pudo registrar el ingreso en la base de datos.');
    }
    return null;
  }
}


async function updateSessionLogStats() {
  const { currentSession } = APP_STATE;
  if (!supabase || !currentSession || !currentSession.logId || APP_STATE.sessionLoggingDisabled) return;
  
  try {
    await supabase
      .from('revision_semanal_ingresos')
      .update({
        bus_count: currentSession.buses.length,
        ticket_count: currentSession.ticketCount,
        buses: currentSession.buses
      })
      .eq('id', currentSession.logId);
  } catch (error) {
    console.error('Error updating session log stats:', error);
  }
}


async function finalizeSessionLog() {
  const { currentSession } = APP_STATE;
  if (!supabase || !currentSession || !currentSession.logId || APP_STATE.sessionLoggingDisabled) {
    clearStoredSessionLogMetadata();
    resetSessionLogState();
    return;
  }
  
  try {
    await supabase
      .from('revision_semanal_ingresos')
      .update({
        ended_at: new Date().toISOString(),
        bus_count: currentSession.buses.length,
        ticket_count: currentSession.ticketCount,
        buses: currentSession.buses
      })
      .eq('id', currentSession.logId);
  } catch (error) {
    console.error('Error finalizing session log:', error);
  } finally {
    clearStoredSessionLogMetadata();
    resetSessionLogState();
  }
}


async function recordSessionActivity(inspectionId, ticketsCreated = [], status = 'OK') {
  if (!APP_STATE.currentBus || !APP_STATE.session.inspector || APP_STATE.sessionLoggingDisabled) return;
  await ensureActiveSessionLog();
  if (!APP_STATE.currentSession.logId) return;
  
  const busEntry = {
    inspection_id: inspectionId,
    bus_ppu: APP_STATE.currentBus.ppu || '',
    terminal: APP_STATE.currentBus.terminal || APP_STATE.session.terminal || '',
    fecha: new Date().toISOString(),
    estado: status || 'OK',
    tickets: (ticketsCreated || []).map(ticket => ({
      id: ticket?.id || null,
      componente: ticket?.componente || '‚Äî',
      descripcion: ticket?.descripcion_falla || ticket?.descripcion || '‚Äî'
    }))
  };
  
  APP_STATE.currentSession.buses.push(busEntry);
  APP_STATE.currentSession.ticketCount += busEntry.tickets.length;
  
  if (APP_STATE.currentSession.logId) {
    await updateSessionLogStats();
  }
}


async function ensureActiveSessionLog() {
  if (!APP_STATE.session.inspector || !APP_STATE.session.terminal) return;
  if (APP_STATE.sessionLoggingDisabled) return;
  if (APP_STATE.currentSession && APP_STATE.currentSession.logId) return;
  
  const normalizedInspector = normalizeInspectorName(APP_STATE.session.inspector);
  const normalizedTerminal = APP_STATE.session.terminal.trim();
  
  const storedMetadata = getStoredSessionLogMetadata();
  if (storedMetadata && storedMetadata.id) {
    try {
      const { data: storedLog, error: storedError } = await supabase
        .from('revision_semanal_ingresos')
        .select('id, inspector, terminal, started_at, ended_at, bus_count, ticket_count, buses')
        .eq('id', storedMetadata.id)
        .maybeSingle();
      
      if (!storedError && storedLog && !storedLog.ended_at && normalizeInspectorName(storedLog.inspector) === normalizedInspector) {
        resetSessionLogState();
        setCurrentSessionFromRecord(storedLog);
        await closeDuplicateSessionLogs(normalizedInspector, normalizedTerminal, storedLog.id);
        return;
      }
    } catch (error) {
      console.error('Error restoring stored session log:', error);
    }
    
    clearStoredSessionLogMetadata();
  }
  
  resetSessionLogState();
  const sessionLog = await createSessionLog(normalizedInspector, normalizedTerminal);
  if (sessionLog) {
    setCurrentSessionFromRecord(sessionLog);
  }
}


function formatDateTime(value, includeTime = true) {
  if (!value) return '‚Äî';
  try {
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '‚Äî';
    return date.toLocaleString('es-CL', includeTime ? { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' } : { day: '2-digit', month: '2-digit', year: 'numeric' });
  } catch (error) {
    return '‚Äî';
  }
}


function getSessionEvaluation(row) {
  const busCount = Number(row?.bus_count) || 0;
  const ticketCount = Number(row?.ticket_count) || 0;
  
  if (busCount <= 0) {
    return {
      label: 'Sin actividad',
      className: 'text-info fw-medium',
      note: 'No se registraron buses durante la sesi√≥n.',
      score: '‚Äî',
      ratio: 0
    };
  }
  
  const ratio = ticketCount / busCount;
  
  if (ratio < 0.05) {
    return {
      label: 'Baja detecci√≥n',
      className: 'text-danger fw-bold',
      note: 'Se registran muy pocos hallazgos. Revisar a fondo los criterios y profundidad de la inspecci√≥n.',
      score: 'D',
      ratio
    };
  }
  
  if (ratio < 0.15) {
    return {
      label: 'Detalle mejorable',
      className: 'text-warning fw-bold',
      note: 'Nivel de hallazgos bajo. Reforzar la revisi√≥n para asegurar que ninguna falla quede sin registrar.',
      score: 'C',
      ratio
    };
  }
  
  if (ratio < 0.3) {
    return {
      label: 'Buen nivel',
      className: 'text-primary fw-bold',
      note: 'Detecci√≥n consistente de oportunidades de mejora; seguir monitoreando el est√°ndar.',
      score: 'B',
      ratio
    };
  }
  
  return {
    label: 'Excelente detalle',
    className: 'text-success fw-bold',
    note: 'Alta capacidad para identificar fallas y generar tickets que protegen la operaci√≥n.',
    score: 'A',
    ratio
  };
}


/**
 * Extracts bus entries from a stored session log payload.
 * Handles JSON strings, indexed objects and single objects as fallbacks.
 * @param {*} rawBuses - Raw buses payload from database
 * @returns {Array<Object>} Normalized array of bus entries
 */
function extractSessionBusEntries(rawBuses) {
  if (!rawBuses) return [];
  
  if (Array.isArray(rawBuses)) {
    return rawBuses.filter(entry => entry && typeof entry === 'object');
  }
  
  if (typeof rawBuses === 'string') {
    const trimmed = rawBuses.trim();
    if (!trimmed) return [];
    try {
      const parsed = JSON.parse(trimmed);
      return extractSessionBusEntries(parsed);
    } catch (error) {
      console.debug('No se pudo parsear la lista de buses de la sesi√≥n:', error);
      return [];
    }
  }
  
  if (typeof rawBuses === 'object') {
    if (rawBuses.bus_ppu || rawBuses.ppu || rawBuses.inspection_id) {
      return [rawBuses];
    }
    
    const values = Object.values(rawBuses);
    if (values.length > 0 && values.every(value => value && typeof value === 'object')) {
      return extractSessionBusEntries(values);
    }
  }
  
  return [];
}

/**
 * Normalises a database row from revision_semanal_ingresos ensuring
 * bus and ticket counts are consistent even if the numeric columns were not updated.
 * @param {Object} row - Raw database row
 * @returns {Object} Normalized row
 */
function normalizeSessionLogRow(row = {}) {
  const normalized = { ...row };
  const inspector = normalizeInspectorName(row.inspector || '');
  normalized.inspector = inspector;
  normalized.terminal = (row.terminal || '').trim();
  
  const buses = extractSessionBusEntries(row.buses);
  const normalizedBuses = buses
    .map(entry => {
      if (!entry || typeof entry !== 'object') return null;
      
      const busEntry = { ...entry };
      busEntry.bus_ppu = busEntry.bus_ppu || busEntry.ppu || busEntry.bus || '';
      busEntry.terminal = busEntry.terminal || normalized.terminal || entry?.terminal || '';
      busEntry.estado = busEntry.estado || busEntry.status || 'OK';
      
      const rawTickets = entry.tickets ?? entry.ticketList ?? entry.ticket_count ?? entry.ticketCount;
      let tickets = [];
      let ticketCount = 0;
      
      if (Array.isArray(rawTickets)) {
        tickets = rawTickets.filter(ticket => ticket && typeof ticket === 'object');
        ticketCount = tickets.length;
      } else if (typeof rawTickets === 'string') {
        const trimmedTickets = rawTickets.trim();
        if (trimmedTickets) {
          try {
            const parsedTickets = JSON.parse(trimmedTickets);
            if (Array.isArray(parsedTickets)) {
              tickets = parsedTickets.filter(ticket => ticket && typeof ticket === 'object');
              ticketCount = tickets.length;
            } else if (parsedTickets && typeof parsedTickets === 'object') {
              tickets = [parsedTickets];
              ticketCount = 1;
            }
          } catch (error) {
            console.debug('No se pudo parsear la lista de tickets de la sesi√≥n:', error);
          }
        }
      } else if (typeof rawTickets === 'number') {
        ticketCount = Number.isFinite(rawTickets) && rawTickets > 0 ? rawTickets : 0;
      } else if (rawTickets && typeof rawTickets === 'object') {
        tickets = [rawTickets];
        ticketCount = 1;
      }
      
      if (ticketCount === 0) {
        const altCount = Number(entry.ticket_count ?? entry.ticketCount);
        if (Number.isFinite(altCount) && altCount > 0) {
          ticketCount = altCount;
        }
      }
      
      busEntry.tickets = tickets;
      busEntry.ticket_count = ticketCount;
      
      return busEntry;
    })
    .filter(Boolean);
  
  const computedBusCount = normalizedBuses.length;
  const computedTicketCount = normalizedBuses.reduce(
    (sum, busEntry) => sum + (Number(busEntry.ticket_count) || 0),
    0
  );
  
  const rawBusCount = Number(row.bus_count);
  const rawTicketCount = Number(row.ticket_count);
  
  normalized.bus_count = Number.isFinite(rawBusCount) && rawBusCount > 0
    ? rawBusCount
    : computedBusCount;
  
  normalized.ticket_count = Number.isFinite(rawTicketCount) && rawTicketCount > 0
    ? rawTicketCount
    : computedTicketCount;
  
  normalized.buses = normalizedBuses;
  return normalized;
}


function escapeHTML(unsafe) {
  if (unsafe === null || unsafe === undefined) return '';
  const value = typeof unsafe === 'string' ? unsafe : String(unsafe);
  return value
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}


function showModal(modal, noBackdrop = false) {
  if (!modal) return;
  
  const modalBackdrop = document.getElementById('modalBackdrop');
  
  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');
  
  // Handle backdrop
  if (modalBackdrop && !noBackdrop) {
    modalBackdrop.classList.add('show');
  }
  
  // Focus first input if exists
  setTimeout(() => {
    const firstInput = modal.querySelector('input, select, textarea, button:not(.modal-close)');
    if (firstInput) {
      firstInput.focus();
    }
  }, 100);
  
  // Disable background scrolling
  document.body.style.overflow = 'hidden';
  
  // Listen for escape key
  document.addEventListener('keydown', handleEscapeKey);
}


function hideModal(modal) {
  if (!modal) return;
  
  const modalBackdrop = document.getElementById('modalBackdrop');
  
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden', 'true');
  
  // Hide backdrop if no other modals are open
  if (modalBackdrop) {
    const visibleModals = document.querySelectorAll('.modal.show');
    if (visibleModals.length <= 1) {
      modalBackdrop.classList.remove('show');
    }
  }
  
  // Re-enable background scrolling
  document.body.style.overflow = '';
  
  // Remove escape key listener
  document.removeEventListener('keydown', handleEscapeKey);
}


function handleEscapeKey(e) {
  if (e.key === 'Escape') {
    const visibleModals = document.querySelectorAll('.modal.show');
    if (visibleModals.length > 0) {
      // Close the last opened modal
      hideModal(visibleModals[visibleModals.length - 1]);
    }
  }
}


function applyTheme(theme) {
  if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.classList.add('dark-mode');
    updateThemeIcon('dark');
  } else {
    document.body.classList.remove('dark-mode');
    updateThemeIcon('light');
  }
  
  // Store theme preference
  localStorage.setItem(APP_CONFIG.storageKeys.theme, theme);
  APP_STATE.session.theme = theme;
}

/**
 * Updates the theme toggle icon
 * @param {string} currentTheme - Current theme (light, dark)
 */
function updateThemeIcon(currentTheme) {
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.innerHTML = currentTheme === 'dark' ? 
      '<i class="fas fa-sun"></i>' : 
      '<i class="fas fa-moon"></i>';
    
    themeToggle.setAttribute('aria-label', 
      currentTheme === 'dark' ? 
      'Cambiar a tema claro' : 
      'Cambiar a tema oscuro'
    );
  }
}

/**
 * Shows a specific section of the application
 * @param {string} sectionId - ID of the section to show
 */
function showSection(sectionId) {
  // Get section elements
  const sections = {
    'inspection-form': document.getElementById('section-inspection-form'),
    'dashboard': document.getElementById('section-dashboard'),
    'cameras-report': document.getElementById('section-cameras-report'),
    'tag-report': document.getElementById('section-tag-report'),
    'extinguisher-report': document.getElementById('section-extinguisher-report'),
    'mobileye-report': document.getElementById('section-mobileye-report'),
    'odometer-report': document.getElementById('section-odometer-report'),
    'advertising-report': document.getElementById('section-advertising-report'),
    'maintenance-tickets': document.getElementById('section-maintenance-tickets'),
    'session-report': document.getElementById('section-session-report'),
    'fleet-status': document.getElementById('section-fleet-status'),
    'user-settings': document.getElementById('section-user-settings'),
    'help': document.getElementById('section-help')
  };
  
  // Hide all sections
  Object.values(sections).forEach(section => {
    if (section) section.classList.add('hidden');
  });
  
  // Show requested section with animation
  if (sections[sectionId]) {
    sections[sectionId].classList.remove('hidden');
    
    // Add entrance animation
    sections[sectionId].classList.add('fadeIn');
    
    // Remove animation class after it completes
    setTimeout(() => {
      sections[sectionId].classList.remove('fadeIn');
    }, 500);
  }
  
  // Update navigation active states
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.section === sectionId) {
      item.classList.add('active');
    }
  });
  
  // Save last section
  localStorage.setItem(APP_CONFIG.storageKeys.lastSection, sectionId);
  
  // Load section-specific data
  loadSectionData(sectionId);
  
  // Close sidebar on mobile
  if (window.innerWidth <= 1024) {
    const sidebar = document.getElementById('sidebar');
    const toggleIcon = document.querySelector('.toggle-icon');
    const modalBackdrop = document.getElementById('modalBackdrop');
    
    if (sidebar) sidebar.classList.remove('show');
    if (toggleIcon) toggleIcon.classList.remove('toggle-active');
    if (modalBackdrop) modalBackdrop.classList.remove('show');
  }
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Loads data specific to a section
 * @param {string} sectionId - ID of the section
 */
function loadSectionData(sectionId) {
  switch(sectionId) {
    case 'dashboard':
      refreshDashboardData();
      break;
    case 'maintenance-tickets':
      loadMaintenanceTickets();
      break;
    case 'fleet-status':
      loadFleetStatus();
      break;
    case 'cameras-report':
      refreshCamerasReport();
      break;
    case 'tag-report':
      refreshTagReport();
      break;
    case 'extinguisher-report':
      refreshExtinguisherReport();
      break;
    case 'session-report':
      refreshSessionReport();
      break;
    case 'mobileye-report':
      refreshMobileyeReport();
      break;
    case 'odometer-report':
      refreshOdometerReport();
      break;
    case 'advertising-report':
      refreshAdvertisingReport(APP_STATE.filters.advertising || {});
      break;
    case 'user-settings':
      loadUserSettings();
      break;
  }
}

/**
 * Configures togglable sections
 * @param {Object} toggleSection - Object with toggle and content elements
 */
function setupToggleSection(toggleSection) {
  if (!toggleSection || !toggleSection.toggle || !toggleSection.content) return;
  
  toggleSection.toggle.addEventListener('click', (event) => {
    toggleSection.toggle.classList.toggle('active');
    toggleSection.content.classList.toggle('show');
    
    const icon = toggleSection.toggle.querySelector('i.fas.fa-chevron-down');
    if (icon) {
      icon.style.transform = toggleSection.content.classList.contains('show') ? 'rotate(180deg)' : '';
    }
    
    // Prevent event propagation
    event.stopPropagation();
  });
}

// ===================== TABLE UTILITIES =====================
/**
 * Sets up table header from column definitions
 * @param {string} tableId - Table element ID
 * @param {string[]} headers - Array of header labels
 */
function setTableHeader(tableId, headers) {
  const thead = document.querySelector(`#${tableId} thead tr`);
  const tbody = document.querySelector(`#${tableId} tbody`);
  
  if (!thead || !tbody) return;
  
  thead.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
  tbody.innerHTML = '';
}

/**
 * Exports table data to Excel
 * @param {string} name - File name
 * @param {string[]} headers - Column headers
 * @param {string} tableId - Table element ID
 */
function exportTableToXLSX(name, headers, tableId) {
  try {
    const table = document.getElementById(tableId);
    if (!table) throw new Error(`Tabla con ID "${tableId}" no encontrada`);
    
    // Extract data from the table
    const rows = Array.from(table.querySelectorAll('tbody tr'))
      .map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
    
    // Create array of arrays with headers and data
    const aoa = [headers, ...rows];
    
    // Create worksheet and workbook
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Informe');
    
    // Write to file
    XLSX.writeFile(wb, `${name}.xlsx`);
    
    showNotification('success', 'Exportaci√≥n Completa', 'Datos exportados con √©xito a Excel');
  } catch (error) {
    console.error('Error exporting to Excel:', error);
    showNotification('error', 'Error de Exportaci√≥n', 'No se pudieron exportar los datos a Excel');
  }
}

// ===================== AUTHENTICATION & SESSION =====================
/**
 * Opens the login modal
 */
function openLoginModal() {
  const loginModal = document.getElementById('loginModal');
  if (!loginModal) return;
  
  // Get form elements
  const nameInput = document.getElementById('inspectorName');
  const terminalSelect = document.getElementById('inspectorTerminal');
  
  // Pre-fill form with existing session data if available
  if (nameInput) {
    nameInput.disabled = false;
    nameInput.removeAttribute('readonly');
    nameInput.value = APP_STATE.session.inspector || '';
  }
  
  if (terminalSelect) {
    terminalSelect.disabled = false;
    terminalSelect.value = APP_STATE.session.terminal || '';
  }
  
  // Show the modal with backdrop disabled
  showModal(loginModal, true);
  
  // Focus on name input
  if (nameInput) {
    requestAnimationFrame(() => {
      nameInput.focus();
    });
  }
}

/**
 * Starts a new session
 * @param {string} name - Inspector name
 * @param {string} terminal - Terminal name
 */
async function startSession(name, terminal) {
  if (!name || !terminal) {
    showNotification('error', 'Datos Incompletos', 'Por favor, complete tanto el nombre como el terminal');
    return false;
  }
  
  try {
    await finalizeSessionLog();
    resetSessionLogState();
    
    const normalizedName = normalizeInspectorName(name);
    const normalizedTerminal = terminal.trim();
    
    // Update application state
    APP_STATE.session.inspector = normalizedName;
    APP_STATE.session.terminal = normalizedTerminal;
    autoFillExtinguisherLocation(true);
    
    // Update UI
    const userInfo = document.getElementById('userInfo');
    if (userInfo) {
      userInfo.textContent = `${normalizedName} ¬∑ ${normalizedTerminal}`;
    }
    
    // Save to localStorage
    localStorage.setItem(APP_CONFIG.storageKeys.session, JSON.stringify({
      inspector: normalizedName,
      terminal: normalizedTerminal
    }));
    
    // Log activity
    logActivity({
      type: 'login',
      inspector: normalizedName,
      terminal: normalizedTerminal
    });
    
    // Hide login modal
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
      hideModal(loginModal);
    }
    
    // Load initial data
    refreshPendingInspections();
    refreshReportTables();
    loadRecentActivity();
    
    const sessionLog = await createSessionLog(normalizedName, normalizedTerminal);
    if (sessionLog) {
      setCurrentSessionFromRecord(sessionLog);
    }
    refreshSessionReport(APP_STATE.filters.sessions || {});
    
    showNotification('success', 'Sesi√≥n Iniciada', 'Has iniciado sesi√≥n y puedes comenzar las inspecciones');
    return true;
  } catch (error) {
    console.error('Error starting session:', error);
    showNotification('error', 'Error', 'No se pudo iniciar sesi√≥n');
    return false;
  }
}

/**
 * Handles user logout
 */
async function handleLogout() {
  // Show confirmation dialog
  if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
    try {
      // Log activity first before clearing data
      if (APP_STATE.session.inspector && APP_STATE.session.terminal) {
        logActivity({
          type: 'logout',
          inspector: APP_STATE.session.inspector,
          terminal: APP_STATE.session.terminal
        });
      }
      
      await finalizeSessionLog();
      
      // Clear session state
      APP_STATE.session.inspector = "";
      APP_STATE.session.terminal = "";
      localStorage.removeItem(APP_CONFIG.storageKeys.session);
      
      // Clear form data
      clearForm();
      
      // Update UI
      const userInfo = document.getElementById('userInfo');
      if (userInfo) {
        userInfo.textContent = "‚Äî";
      }
      
      showNotification('info', 'Sesi√≥n Cerrada', 'Has cerrado sesi√≥n correctamente');
      refreshSessionReport(APP_STATE.filters.sessions || {});
      
      // Show login modal
      openLoginModal();
    } catch (error) {
      console.error('Error during logout:', error);
      showNotification('error', 'Error', 'Ocurri√≥ un error al cerrar sesi√≥n');
    }
  }
}

// ===================== WEEK MANAGEMENT =====================
/**
 * Updates the week selectors and related UI elements
 * @param {string} isoWeek - ISO week string (YYYY-Wnn)
 */
function updateWeekSelectors(isoWeek) {
  if (!isoWeek) return;
  
  try {
    // Update state
    APP_STATE.session.week = isoWeek;
    
    // Update selectors
    const weekSelector = document.getElementById('weekSelector');
    const dashboardWeekSelector = document.getElementById('dashboardWeekSelector');
    
    if (weekSelector) weekSelector.value = isoWeek;
    if (dashboardWeekSelector) dashboardWeekSelector.value = isoWeek;
    
    // Update week label
    const currentWeekLabel = document.getElementById('currentWeekLabel');
    if (currentWeekLabel) {
      currentWeekLabel.textContent = getWeekRange(isoWeek);
    }
    
    // Update any current inspection data
    if (APP_STATE.currentBus) {
      loadWeeklyInspection(APP_STATE.currentBus.id);
    }
    
    // Refresh related data
    refreshPendingInspections();
    refreshReportTables();
    
    // If on dashboard, refresh its data too
    const dashboardSection = document.getElementById('section-dashboard');
    if (dashboardSection && !dashboardSection.classList.contains('hidden')) {
      refreshDashboardData();
      loadRecentActivity();
    }
    
    return true;
  } catch (error) {
    console.error('Error updating week selectors:', error);
    showNotification('error', 'Error', 'Error actualizando selectores de semana');
    return false;
  }
}

// ===================== BUS SELECTION & INSPECTION =====================
/**
 * Searches for buses by field and value
 * @param {string} field - Field to search (ppu, numero_interno, etc.)
 * @param {string} value - Value to search for
 * @param {string} notFoundMessage - Message to show if no buses found
 */
async function searchBus(field, value, notFoundMessage) {
  if (!field || !value) return null;
  
  const loaderId = showLoader('Buscando bus...');
  
  try {
    // Validate search term
    if (value.length < 2) {
      throw new Error('T√©rmino de b√∫squeda demasiado corto');
    }
    
    // Perform search
    const { data, error } = await supabase
      .from('revision_semanal_buses')
      .select('*')
      .ilike(field, `%${value}%`)
      .limit(1);
    
    if (error) throw error;
    
    // Clear loader
    clearTimeout(loaderId);
    hideLoader();
    
    if (data && data.length > 0) {
      selectBus(data[0]);
      return data[0];
    } else {
      showNotification('error', 'No Encontrado', notFoundMessage || 'No se encontraron buses con ese criterio');
      return null;
    }
  } catch (error) {
    // Clear loader
    clearTimeout(loaderId);
    hideLoader();
    
    console.error(`Error buscando bus por ${field}:`, error);
    showNotification('error', 'Error', `No se pudo completar la b√∫squeda de buses: ${error.message}`);
    return null;
  }
}

/**
 * Selects a bus and loads its data
 * @param {Object} bus - Bus data object
 */
function selectBus(bus) {
  if (!bus || !bus.id) {
    console.error('Invalid bus data:', bus);
    return false;
  }
  
  try {
    // Update state
    APP_STATE.currentBus = bus;
    autoFillExtinguisherLocation(true);
    
    // Get display elements
    const busInfoElements = {
      ppuDisplay: document.getElementById('ppuDisplay'),
      internalDisplay: document.getElementById('internalDisplay'),
      makeDisplay: document.getElementById('makeDisplay'),
      modelDisplay: document.getElementById('modelDisplay'),
      yearDisplay: document.getElementById('yearDisplay'),
      terminalDisplay: document.getElementById('terminalDisplay'),
      inspectionStatus: document.getElementById('inspectionStatus')
    };
    
    // Update display elements
    if (busInfoElements.ppuDisplay) busInfoElements.ppuDisplay.textContent = bus.ppu || '‚Äî';
    if (busInfoElements.internalDisplay) busInfoElements.internalDisplay.textContent = bus.numero_interno || '‚Äî';
    if (busInfoElements.makeDisplay) busInfoElements.makeDisplay.textContent = bus.marca || '‚Äî';
    if (busInfoElements.modelDisplay) busInfoElements.modelDisplay.textContent = bus.modelo_chasis || '‚Äî';
    if (busInfoElements.yearDisplay) busInfoElements.yearDisplay.textContent = bus.anio || '‚Äî';
    if (busInfoElements.terminalDisplay) busInfoElements.terminalDisplay.textContent = bus.terminal || '‚Äî';
    
    // Show/hide Mobileye section based on make
    const mobileyeSection = document.getElementById('mobileyeSection');
    if (mobileyeSection) {
      mobileyeSection.classList.toggle('hidden', (bus.marca || '').toUpperCase() !== 'VOLVO');
    }
    
    // Show the bus info section with animation
    const busInfoSection = document.getElementById('busInfoSection');
    if (busInfoSection) {
      busInfoSection.classList.remove('hidden');
      busInfoSection.classList.add('fadeIn');
      setTimeout(() => {
        busInfoSection.classList.remove('fadeIn');
      }, 500);
    }
    
    // Expand first collapsible section
    const camerasToggle = document.getElementById('toggleCameras');
    const camerasContent = document.getElementById('camerasSection');
    if (camerasToggle && camerasContent) {
      camerasToggle.classList.add('active');
      camerasContent.classList.add('show');
      const icon = camerasToggle.querySelector('i.fas.fa-chevron-down');
      if (icon) {
        icon.style.transform = 'rotate(180deg)';
      }
    }
    
    // Show bus status modal to confirm operational status
    showBusStatusModal();
    
    // Load inspection data for the current week
    loadWeeklyInspection(bus.id);
    
    return true;
  } catch (error) {
    console.error('Error selecting bus:', error);
    showNotification('error', 'Error', 'No se pudo cargar la informaci√≥n del bus');
    return false;
  }
}

/**
 * Shows the bus status modal
 */
function showBusStatusModal() {
  const busStatusModal = document.getElementById('busStatusModal');
  if (!busStatusModal) return;
  
  const statusSelect = document.getElementById('busPanneStatus');
  if (statusSelect) {
    statusSelect.value = 'operational';
  }
  
  showModal(busStatusModal);
}

/**
 * Loads inspection data for a bus and week
 * @param {number} busId - Bus ID
 */
async function loadWeeklyInspection(busId) {
  if (!busId) return;
  
  // Clear form first
  clearForm();
  
  const loaderId = showLoader('Cargando inspecci√≥n...');
  
  try {
    // Query the database for existing inspection
    const { data, error } = await supabase
      .from('revision_semanal_inspecciones')
      .select('id, fecha_inspeccion, inspector_nombre, estado_global, observacion_general')
      .eq('bus_id', busId)
      .eq('semana_iso', APP_STATE.session.week)
      .maybeSingle();
    
    clearTimeout(loaderId);
    hideLoader();
    
    if (error) throw error;
    
    const inspectionStatus = document.getElementById('inspectionStatus');
    
    if (data) {
      // Update state with inspection ID
      APP_STATE.inspectionId = data.id;
      
      // Format inspection date
      const inspectionDate = new Date(data.fecha_inspeccion).toLocaleDateString('es-ES', APP_CONFIG.dateFormat.medium);
      
      // Update status display
      if (inspectionStatus) {
        inspectionStatus.innerHTML = `
          <i class="fas fa-check-circle"></i> 
          Inspeccionado el ${inspectionDate} por ${data.inspector_nombre || 'Inspector'}
        `;
        inspectionStatus.className = 'chip status-completed';
      }
      
      // Update form fields
      const formInputs = getFormInputs();
      if (formInputs.globalStatus) formInputs.globalStatus.value = data.estado_global || 'OK';
      if (formInputs.generalObservations) formInputs.generalObservations.value = data.observacion_general || '';
      
      // Load inspection section data
      await loadInspectionSections(data.id);
    } else {
      // No inspection exists yet
      APP_STATE.inspectionId = null;
      
      // Update status display based on operational status
      const busPanneStatus = document.getElementById('busPanneStatus');
      if (inspectionStatus && busPanneStatus) {
        const status = busPanneStatus.value;
        
        if (status === 'out_of_service') {
          inspectionStatus.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> 
            Bus fuera de servicio ‚Äî inspecci√≥n pendiente
          `;
          inspectionStatus.className = 'chip status-warning';
        } else {
          inspectionStatus.innerHTML = `
            <i class="fas fa-clock"></i> 
            Sin inspecci√≥n a√∫n
          `;
          inspectionStatus.className = 'chip';
        }
      }
    }
    
    return true;
  } catch (error) {
    clearTimeout(loaderId);
    hideLoader();
    
    console.error('Error loading inspection:', error);
    showNotification('error', 'Error', 'No se pudo cargar los datos de la inspecci√≥n');
    return false;
  }
}

/**
 * Loads individual sections of an inspection
 * @param {number} inspectionId - Inspection ID
 */
async function loadInspectionSections(inspectionId) {
  if (!inspectionId) return;
  
  const loaderId = showLoader('Cargando datos de la inspecci√≥n...');
  
  try {
    const formInputs = getFormInputs();
    
    // 1. Load camera data
    const { data: cameraData } = await supabase
      .from('revision_semanal_camara_inspeccion')
      .select('*')
      .eq('inspeccion_id', inspectionId)
      .maybeSingle();
    
    if (cameraData) {
      if (formInputs.monitorCamera) formInputs.monitorCamera.value = cameraData.monitor_camara ? 'SI' : 'NO';
      if (formInputs.monitorDetail) formInputs.monitorDetail.value = cameraData.monitor_detalle || '';
      if (formInputs.frontCamera) formInputs.frontCamera.value = cameraData.camara_frontal || 'tiene';
      if (formInputs.cabinCamera) formInputs.cabinCamera.value = cameraData.camara_cabina || 'tiene';
      if (formInputs.interiorCamera) formInputs.interiorCamera.value = cameraData.camaras_interior || 'tiene';
      if (formInputs.rearCamera) formInputs.rearCamera.value = cameraData.camara_trasera || 'tiene';
      if (formInputs.cameraObservations) formInputs.cameraObservations.value = cameraData.observacion || '';
      
      if (formInputs.allVisible) formInputs.allVisible.value = cameraData.q_all_visible || '';
      if (formInputs.reverseActive) formInputs.reverseActive.value = cameraData.q_reverse || '';
      if (formInputs.doorsOpen) formInputs.doorsOpen.value = cameraData.q_doors_open || '';
      if (formInputs.doorsClosed) formInputs.doorsClosed.value = cameraData.q_doors_closed || '';
    }
    
    // 2. Load tag data
    const { data: tagData } = await supabase
      .from('revision_semanal_tag_inspeccion')
      .select('*')
      .eq('inspeccion_id', inspectionId)
      .maybeSingle();
    
    if (tagData) {
      if (formInputs.hasTag) formInputs.hasTag.value = tagData.tag_tiene ? 'yes' : 'no';
      if (formInputs.tagSerial) formInputs.tagSerial.value = tagData.tag_serie || '';
      if (formInputs.tagObservations) formInputs.tagObservations.value = tagData.observacion || '';
    }
    
    // 3. Load extinguisher data
    const { data: extinguisherData } = await supabase
      .from('revision_semanal_extintor_inspeccion')
      .select('*')
      .eq('inspeccion_id', inspectionId)
      .maybeSingle();
    
    if (extinguisherData) {
      if (formInputs.extinguisherLocation) formInputs.extinguisherLocation.value = extinguisherData.ubicacion || '';
      if (formInputs.extinguisherExpiry) {
        formInputs.extinguisherExpiry.value = extinguisherData.fecha_vencimiento ? extinguisherData.fecha_vencimiento.substring(0, 10) : '';
      }
      if (formInputs.extinguisherStatus) formInputs.extinguisherStatus.value = extinguisherData.estado_extintor || 'TIENE';
      if (formInputs.certificationStatus) formInputs.certificationStatus.value = extinguisherData.estado_certificacion || 'TIENE';
      if (formInputs.probeStatus) formInputs.probeStatus.value = extinguisherData.estado_sonda || 'TIENE';
      if (formInputs.manometerStatus) formInputs.manometerStatus.value = extinguisherData.estado_manometro || 'TIENE';
      if (formInputs.pressureStatus) formInputs.pressureStatus.value = extinguisherData.presion_carga || 'OPTIMA';
      if (formInputs.cylinderStatus) formInputs.cylinderStatus.value = extinguisherData.cilindro_estado || 'BUEN ESTADO';
      if (formInputs.holderStatus) formInputs.holderStatus.value = extinguisherData.estado_porta_extintor || 'TIENE';
    }
    
    // 4. Load Mobileye data (if applicable)
    if (APP_STATE.currentBus && (APP_STATE.currentBus.marca || '').toUpperCase() === 'VOLVO') {
      const { data: mobileyeData } = await supabase
        .from('revision_semanal_movileye_inspeccion')
        .select('*')
        .eq('inspeccion_id', inspectionId)
        .maybeSingle();
      
      if (mobileyeData) {
        if (formInputs.mobileyeStatus) formInputs.mobileyeStatus.value = mobileyeData.estado || '';
        if (formInputs.leftAlert) formInputs.leftAlert.value = (mobileyeData.alerta_izq || 'BUENO').toUpperCase();
        if (formInputs.rightAlert) formInputs.rightAlert.value = (mobileyeData.alerta_der || 'BUENO').toUpperCase();
        if (formInputs.console) formInputs.console.value = (mobileyeData.consola || 'BUENO').toUpperCase();
        if (formInputs.frontSensor) formInputs.frontSensor.value = (mobileyeData.sensor_frontal || 'BUENO').toUpperCase();
        if (formInputs.leftSensor) formInputs.leftSensor.value = (mobileyeData.sensor_izq || 'BUENO').toUpperCase();
        if (formInputs.rightSensor) formInputs.rightSensor.value = (mobileyeData.sensor_der || 'BUENO').toUpperCase();
        if (formInputs.rearLeftSensor) formInputs.rearLeftSensor.value = (mobileyeData.sensor_traser_izq_art || 'BUENO').toUpperCase();
        if (formInputs.rearRightSensor) formInputs.rearRightSensor.value = (mobileyeData.sensor_traser_der_art || 'BUENO').toUpperCase();
        
        if (mobileyeData.fecha_siniestro && formInputs.incidentDate) {
          formInputs.incidentDate.value = mobileyeData.fecha_siniestro.substring(0, 10);
        }
        
        if (formInputs.incidentNumber) formInputs.incidentNumber.value = mobileyeData.nro_siniestro || '';
      }
    }
    
    // 5. Load odometer data
    const { data: odometerData } = await supabase
      .from('revision_semanal_odometro_inspeccion')
      .select('*')
      .eq('inspeccion_id', inspectionId)
      .maybeSingle();
    
    if (odometerData) {
    if (formInputs.odometerReading) formInputs.odometerReading.value = odometerData.lectura_km || '';
    if (formInputs.odometerStatus) formInputs.odometerStatus.value = odometerData.estado_odometro || 'funcionando';
    if (formInputs.odometerObservations) formInputs.odometerObservations.value = odometerData.observacion || '';
  }
  
  // 6. Load advertising data
  const { data: advertisingData, error: advertisingError } = await supabase
    .from('revision_semanal_publicidad_inspeccion')
    .select('*')
    .eq('inspeccion_id', inspectionId)
    .maybeSingle();
  
  if (advertisingError && advertisingError.code !== 'PGRST116') {
    console.error('Error cargando secci√≥n de publicidad:', advertisingError);
  }
  
  if (advertisingData) {
    if (formInputs.publicityLeftStatus) formInputs.publicityLeftStatus.value = advertisingData.publicidad_izquierda_estado || 'NO TIENE';
    if (formInputs.publicityLeftDetail) formInputs.publicityLeftDetail.value = advertisingData.publicidad_izquierda_detalle || '';
    if (formInputs.publicityLeftDamage) formInputs.publicityLeftDamage.value = advertisingData.publicidad_izquierda_danio || 'NO';
    if (formInputs.publicityLeftDamageDetail) formInputs.publicityLeftDamageDetail.value = advertisingData.publicidad_izquierda_danio_detalle || '';
    if (formInputs.publicityLeftResidue) formInputs.publicityLeftResidue.value = advertisingData.publicidad_izquierda_residuos || 'NO';
    
    if (formInputs.publicityRightStatus) formInputs.publicityRightStatus.value = advertisingData.publicidad_derecha_estado || 'NO TIENE';
    if (formInputs.publicityRightDetail) formInputs.publicityRightDetail.value = advertisingData.publicidad_derecha_detalle || '';
    if (formInputs.publicityRightDamage) formInputs.publicityRightDamage.value = advertisingData.publicidad_derecha_danio || 'NO';
    if (formInputs.publicityRightDamageDetail) formInputs.publicityRightDamageDetail.value = advertisingData.publicidad_derecha_danio_detalle || '';
    if (formInputs.publicityRightResidue) formInputs.publicityRightResidue.value = advertisingData.publicidad_derecha_residuos || 'NO';
    
    if (formInputs.publicityRearStatus) formInputs.publicityRearStatus.value = advertisingData.publicidad_luneta_estado || 'NO TIENE';
    if (formInputs.publicityRearDetail) formInputs.publicityRearDetail.value = advertisingData.publicidad_luneta_detalle || '';
    if (formInputs.publicityRearDamage) formInputs.publicityRearDamage.value = advertisingData.publicidad_luneta_danio || 'NO';
    if (formInputs.publicityRearDamageDetail) formInputs.publicityRearDamageDetail.value = advertisingData.publicidad_luneta_danio_detalle || '';
    if (formInputs.publicityRearResidue) formInputs.publicityRearResidue.value = advertisingData.publicidad_luneta_residuos || 'NO';
  }
  
  autoFillExtinguisherLocation(false);
  
  clearTimeout(loaderId);
  hideLoader();
  return true;
  } catch (error) {
    clearTimeout(loaderId);
    hideLoader();
    
    console.error('Error loading inspection sections:', error);
    showNotification('error', 'Error', 'No se pudieron cargar los datos completos de la inspecci√≥n');
    return false;
  }
}

/**
 * Gets all form input elements
 * @returns {Object} Object with form input references
 */
function getFormInputs() {
  // Cache result for better performance
  if (APP_STATE.formInputs) return APP_STATE.formInputs;
  
  APP_STATE.formInputs = {
    // Search fields
    searchPPU: document.getElementById('searchPPU'),
    searchInternal: document.getElementById('searchInternal'),
    
    // Bus info display
    ppuDisplay: document.getElementById('ppuDisplay'),
    internalDisplay: document.getElementById('internalDisplay'),
    makeDisplay: document.getElementById('makeDisplay'),
    modelDisplay: document.getElementById('modelDisplay'),
    yearDisplay: document.getElementById('yearDisplay'),
    terminalDisplay: document.getElementById('terminalDisplay'),
    inspectionStatus: document.getElementById('inspectionStatus'),
    
    // Cameras section
    monitorCamera: document.getElementById('monitorCamera'),
    monitorDetail: document.getElementById('monitorDetail'),
    frontCamera: document.getElementById('frontCamera'),
    cabinCamera: document.getElementById('cabinCamera'),
    interiorCamera: document.getElementById('interiorCamera'),
    rearCamera: document.getElementById('rearCamera'),
    allVisible: document.getElementById('allVisible'),
    reverseActive: document.getElementById('reverseActive'),
    doorsOpen: document.getElementById('doorsOpen'),
    doorsClosed: document.getElementById('doorsClosed'),
    cameraObservations: document.getElementById('cameraObservations'),
    
    // TAG section
    hasTag: document.getElementById('hasTag'),
    tagSerial: document.getElementById('tagSerial'),
    tagObservations: document.getElementById('tagObservations'),
    
    // Extinguisher section
    extinguisherLocation: document.getElementById('extinguisherLocation'),
    extinguisherExpiry: document.getElementById('extinguisherExpiry'),
    extinguisherStatus: document.getElementById('extinguisherStatus'),
    certificationStatus: document.getElementById('certificationStatus'),
    probeStatus: document.getElementById('probeStatus'),
    manometerStatus: document.getElementById('manometerStatus'),
    pressureStatus: document.getElementById('pressureStatus'),
    cylinderStatus: document.getElementById('cylinderStatus'),
    holderStatus: document.getElementById('holderStatus'),
    
    // Mobileye section
    mobileyeStatus: document.getElementById('mobileyeStatus'),
    leftAlert: document.getElementById('leftAlert'),
    rightAlert: document.getElementById('rightAlert'),
    console: document.getElementById('console'),
    frontSensor: document.getElementById('frontSensor'),
    leftSensor: document.getElementById('leftSensor'),
    rightSensor: document.getElementById('rightSensor'),
    rearLeftSensor: document.getElementById('rearLeftSensor'),
    rearRightSensor: document.getElementById('rearRightSensor'),
    incidentDate: document.getElementById('incidentDate'),
    incidentNumber: document.getElementById('incidentNumber'),
    
    // Odometer section
    odometerReading: document.getElementById('odometerReading'),
    odometerStatus: document.getElementById('odometerStatus'),
    odometerObservations: document.getElementById('odometerObservations'),
    
    // Advertising section
    publicityLeftStatus: document.getElementById('publicityLeftStatus'),
    publicityLeftDetail: document.getElementById('publicityLeftDetail'),
    publicityLeftDamage: document.getElementById('publicityLeftDamage'),
    publicityLeftDamageDetail: document.getElementById('publicityLeftDamageDetail'),
    publicityLeftResidue: document.getElementById('publicityLeftResidue'),
    publicityRightStatus: document.getElementById('publicityRightStatus'),
    publicityRightDetail: document.getElementById('publicityRightDetail'),
    publicityRightDamage: document.getElementById('publicityRightDamage'),
    publicityRightDamageDetail: document.getElementById('publicityRightDamageDetail'),
    publicityRightResidue: document.getElementById('publicityRightResidue'),
    publicityRearStatus: document.getElementById('publicityRearStatus'),
    publicityRearDetail: document.getElementById('publicityRearDetail'),
    publicityRearDamage: document.getElementById('publicityRearDamage'),
    publicityRearDamageDetail: document.getElementById('publicityRearDamageDetail'),
    publicityRearResidue: document.getElementById('publicityRearResidue'),
    
    // Summary section
    globalStatus: document.getElementById('globalStatus'),
    generalObservations: document.getElementById('generalObservations'),
    saveMsg: document.getElementById('saveMsg')
  };
  
  return APP_STATE.formInputs;
}

/**
 * Automatically fills the extinguisher location field using the active session
 * or the terminal of the bus currently inspeccionado.
 * @param {boolean} force - When true, always overwrite the current value.
 */
function autoFillExtinguisherLocation(force = false) {
  const formInputs = getFormInputs();
  const locationInput = formInputs.extinguisherLocation;
  if (!locationInput) return;
  
  const inspectorActive = (APP_STATE.session?.inspector || '').trim() !== '';
  if (!inspectorActive) return;
  
  const busTerminal = (APP_STATE.currentBus?.terminal || '').trim();
  const sessionTerminal = (APP_STATE.session?.terminal || '').trim();
  const suggestedTerminal = busTerminal || sessionTerminal;
  if (!suggestedTerminal) return;
  
  const currentValue = (locationInput.value || '').trim();
  if (force || currentValue === '') {
    locationInput.value = suggestedTerminal;
  }
}

/**
 * Clears all form fields
 */
function clearForm() {
  const formInputs = getFormInputs();
  
  // Reset form fields to defaults
  if (formInputs.monitorCamera) formInputs.monitorCamera.value = '';
  if (formInputs.monitorDetail) formInputs.monitorDetail.value = '';
  if (formInputs.frontCamera) formInputs.frontCamera.value = 'tiene';
  if (formInputs.cabinCamera) formInputs.cabinCamera.value = 'tiene';
  if (formInputs.interiorCamera) formInputs.interiorCamera.value = 'tiene';
  if (formInputs.rearCamera) formInputs.rearCamera.value = 'tiene';
  if (formInputs.allVisible) formInputs.allVisible.value = '';
  if (formInputs.reverseActive) formInputs.reverseActive.value = '';
  if (formInputs.doorsOpen) formInputs.doorsOpen.value = '';
  if (formInputs.doorsClosed) formInputs.doorsClosed.value = '';
  if (formInputs.cameraObservations) formInputs.cameraObservations.value = '';
  
  if (formInputs.hasTag) formInputs.hasTag.value = 'yes';
  if (formInputs.tagSerial) formInputs.tagSerial.value = '';
  if (formInputs.tagObservations) formInputs.tagObservations.value = '';
  
  if (formInputs.extinguisherLocation) formInputs.extinguisherLocation.value = '';
  if (formInputs.extinguisherExpiry) formInputs.extinguisherExpiry.value = '';
  if (formInputs.extinguisherStatus) formInputs.extinguisherStatus.value = 'TIENE';
  if (formInputs.certificationStatus) formInputs.certificationStatus.value = 'TIENE';
  if (formInputs.probeStatus) formInputs.probeStatus.value = 'TIENE';
  if (formInputs.manometerStatus) formInputs.manometerStatus.value = 'TIENE';
  if (formInputs.pressureStatus) formInputs.pressureStatus.value = 'OPTIMA';
  if (formInputs.cylinderStatus) formInputs.cylinderStatus.value = 'BUEN ESTADO';
  if (formInputs.holderStatus) formInputs.holderStatus.value = 'TIENE';
  
  if (formInputs.mobileyeStatus) formInputs.mobileyeStatus.value = '';
  if (formInputs.leftAlert) formInputs.leftAlert.value = 'BUENO';
  if (formInputs.rightAlert) formInputs.rightAlert.value = 'BUENO';
  if (formInputs.console) formInputs.console.value = 'BUENO';
  if (formInputs.frontSensor) formInputs.frontSensor.value = 'BUENO';
  if (formInputs.leftSensor) formInputs.leftSensor.value = 'BUENO';
  if (formInputs.rightSensor) formInputs.rightSensor.value = 'BUENO';
  if (formInputs.rearLeftSensor) formInputs.rearLeftSensor.value = 'BUENO';
  if (formInputs.rearRightSensor) formInputs.rearRightSensor.value = 'BUENO';
  if (formInputs.incidentDate) formInputs.incidentDate.value = '';
  if (formInputs.incidentNumber) formInputs.incidentNumber.value = '';
  
  if (formInputs.odometerReading) formInputs.odometerReading.value = '';
  if (formInputs.odometerStatus) formInputs.odometerStatus.value = 'funcionando';
  if (formInputs.odometerObservations) formInputs.odometerObservations.value = '';
  
  if (formInputs.publicityLeftStatus) formInputs.publicityLeftStatus.value = 'NO TIENE';
  if (formInputs.publicityLeftDetail) formInputs.publicityLeftDetail.value = '';
  if (formInputs.publicityLeftDamage) formInputs.publicityLeftDamage.value = 'NO';
  if (formInputs.publicityLeftDamageDetail) formInputs.publicityLeftDamageDetail.value = '';
  if (formInputs.publicityLeftResidue) formInputs.publicityLeftResidue.value = 'NO';
  
  if (formInputs.publicityRightStatus) formInputs.publicityRightStatus.value = 'NO TIENE';
  if (formInputs.publicityRightDetail) formInputs.publicityRightDetail.value = '';
  if (formInputs.publicityRightDamage) formInputs.publicityRightDamage.value = 'NO';
  if (formInputs.publicityRightDamageDetail) formInputs.publicityRightDamageDetail.value = '';
  if (formInputs.publicityRightResidue) formInputs.publicityRightResidue.value = 'NO';
  
  if (formInputs.publicityRearStatus) formInputs.publicityRearStatus.value = 'NO TIENE';
  if (formInputs.publicityRearDetail) formInputs.publicityRearDetail.value = '';
  if (formInputs.publicityRearDamage) formInputs.publicityRearDamage.value = 'NO';
  if (formInputs.publicityRearDamageDetail) formInputs.publicityRearDamageDetail.value = '';
  if (formInputs.publicityRearResidue) formInputs.publicityRearResidue.value = 'NO';
  
  autoFillExtinguisherLocation(true);
  
  if (formInputs.globalStatus) formInputs.globalStatus.value = 'OK';
  if (formInputs.generalObservations) formInputs.generalObservations.value = '';
  if (formInputs.saveMsg) formInputs.saveMsg.textContent = '‚Äî';
  
  // Clear validation errors
  document.querySelectorAll('.form-control.invalid').forEach(el => {
    el.classList.remove('invalid');
  });
  
  document.querySelectorAll('.form-error').forEach(el => {
    el.style.display = 'none';
  });
}

/**
 * Validates the inspection form
 * @returns {number} Number of validation errors
 */
function validateForm() {
  let errors = 0;
  const formInputs = getFormInputs();
  
  // Helper function to mark fields as invalid
  function markInvalid(input, errorId) {
    if (!input) return 0;
    
    if (!input.value) {
      input.classList.add('invalid');
      const errorElement = document.getElementById(errorId);
      if (errorElement) errorElement.style.display = 'block';
      
      // Add animation to highlight error
      input.classList.add('shake');
      setTimeout(() => {
        input.classList.remove('shake');
      }, 500);
      
      return 1;
    }
    
    input.classList.remove('invalid');
    const errorElement = document.getElementById(errorId);
    if (errorElement) errorElement.style.display = 'none';
    return 0;
  }
  
  // Required camera fields
  errors += markInvalid(formInputs.monitorCamera, 'w-monitor');
  errors += markInvalid(formInputs.allVisible, 'w-all');
  errors += markInvalid(formInputs.reverseActive, 'w-rev');
  errors += markInvalid(formInputs.doorsOpen, 'w-open');
  errors += markInvalid(formInputs.doorsClosed, 'w-closed');
  
  // Mobileye status for VOLVO buses
  if (APP_STATE.currentBus && (APP_STATE.currentBus.marca || '').toUpperCase() === 'VOLVO') {
    errors += markInvalid(formInputs.mobileyeStatus, 'w-me');
  }
  
  // Scroll to first error if any
  if (errors > 0) {
    const firstError = document.querySelector('.form-control.invalid');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => firstError.focus(), 500);
    }
  }
  
  return errors;
}

/**
 * Evaluates inspection criticality based on form data
 * @returns {string} Status (OK, Observaciones, Cr√≠tico)
 */
function evaluateCriticality() {
  const formInputs = getFormInputs();
  let status = 'OK';
  const issues = [];
  
  // Check camera issues
  const cameraIssues = [];
  
  if (formInputs.monitorCamera && formInputs.monitorCamera.value === 'NO') {
    cameraIssues.push('El monitor no muestra todas las c√°maras');
  }
  
  if (formInputs.allVisible && formInputs.allVisible.value === 'NO') {
    cameraIssues.push('No todas las c√°maras son visibles en el monitor');
  }
  
  if (formInputs.reverseActive && formInputs.reverseActive.value === 'NO') {
    cameraIssues.push('La c√°mara trasera no se activa con la marcha atr√°s');
  }
  
  if (formInputs.doorsOpen && formInputs.doorsOpen.value === 'NO') {
    cameraIssues.push('Las c√°maras de las puertas no se activan al abrirse');
  }
  
  if (formInputs.doorsClosed && formInputs.doorsClosed.value === 'NO') {
    cameraIssues.push('No se muestran todas las c√°maras con las puertas cerradas');
  }
  
  // Check camera status
  const cameraFields = [
    { key: 'frontCamera', name: 'delantera' },
    { key: 'cabinCamera', name: 'cabina' },
    { key: 'interiorCamera', name: 'interiores' },
    { key: 'rearCamera', name: 'trasera' }
  ];
  
  cameraFields.forEach(field => {
    if (formInputs[field.key] && 
        (formInputs[field.key].value === 'da√±ada' || 
         formInputs[field.key].value === 'no tiene')) {
      cameraIssues.push(`c√°mara ${field.name}: ${formInputs[field.key].value}`);
    }
  });
  
  if (cameraIssues.length > 0) {
    status = 'Observaciones';
    issues.push(...cameraIssues);
  }
  
  // Check TAG status
  if (formInputs.hasTag && formInputs.hasTag.value === 'no') {
    status = 'Observaciones';
    issues.push('Bus sin TAG');
  }
  
  // Check extinguisher section
  const criticalExtinguisherStates = ['NO TIENE', 'DA√ëADO'];
  if (formInputs.extinguisherStatus && criticalExtinguisherStates.includes(formInputs.extinguisherStatus.value)) {
    status = 'Observaciones';
    issues.push(`Extintor: ${formInputs.extinguisherStatus.value}`);
  }
  
  if (formInputs.certificationStatus && criticalExtinguisherStates.includes(formInputs.certificationStatus.value)) {
    status = 'Observaciones';
    issues.push(`Certificaci√≥n extintor: ${formInputs.certificationStatus.value}`);
  }
  
  if (formInputs.probeStatus && criticalExtinguisherStates.includes(formInputs.probeStatus.value)) {
    status = 'Observaciones';
    issues.push(`Sonda extintor: ${formInputs.probeStatus.value}`);
  }
  
  if (formInputs.manometerStatus && criticalExtinguisherStates.includes(formInputs.manometerStatus.value)) {
    status = 'Observaciones';
    issues.push(`Man√≥metro extintor: ${formInputs.manometerStatus.value}`);
  }
  
  if (formInputs.pressureStatus && formInputs.pressureStatus.value !== 'OPTIMA') {
    status = 'Observaciones';
    issues.push(`Presi√≥n extintor: ${formInputs.pressureStatus.value}`);
  }
  
  if (formInputs.cylinderStatus && formInputs.cylinderStatus.value === 'ABOLLADO') {
    status = 'Observaciones';
    issues.push('Cilindro de extintor abollado');
  }
  
  if (formInputs.holderStatus && formInputs.holderStatus.value !== 'TIENE') {
    status = 'Observaciones';
    issues.push(`Porta extintor: ${formInputs.holderStatus.value}`);
  }
  
  // Check advertising section
  const publicitySections = [
    {
      label: 'Izquierda',
      damage: formInputs.publicityLeftDamage ? formInputs.publicityLeftDamage.value : 'NO',
      damageDetail: formInputs.publicityLeftDamageDetail ? formInputs.publicityLeftDamageDetail.value : '',
      residue: formInputs.publicityLeftResidue ? formInputs.publicityLeftResidue.value : 'NO'
    },
    {
      label: 'Derecha',
      damage: formInputs.publicityRightDamage ? formInputs.publicityRightDamage.value : 'NO',
      damageDetail: formInputs.publicityRightDamageDetail ? formInputs.publicityRightDamageDetail.value : '',
      residue: formInputs.publicityRightResidue ? formInputs.publicityRightResidue.value : 'NO'
    },
    {
      label: 'Luneta',
      damage: formInputs.publicityRearDamage ? formInputs.publicityRearDamage.value : 'NO',
      damageDetail: formInputs.publicityRearDamageDetail ? formInputs.publicityRearDamageDetail.value : '',
      residue: formInputs.publicityRearResidue ? formInputs.publicityRearResidue.value : 'NO'
    }
  ];
  
  publicitySections.forEach(section => {
    const issuesFound = [];
    if (section.damage === 'SI') {
      issuesFound.push(`da√±o por retiro${section.damageDetail ? ` (${section.damageDetail})` : ''}`);
    }
    if (section.residue === 'SI') {
      issuesFound.push('residuos de pegamento');
    }
    
    if (issuesFound.length > 0) {
      if (status === 'OK') status = 'Observaciones';
      issues.push(`Publicidad ${section.label}: ${issuesFound.join(' y ')}`);
    }
  });
  
  // Check Mobileye for VOLVO buses
  if (APP_STATE.currentBus && (APP_STATE.currentBus.marca || '').toUpperCase() === 'VOLVO') {
    const mobileyeStatusValue = formInputs.mobileyeStatus ? (formInputs.mobileyeStatus.value || '').toLowerCase() : '';
    if (mobileyeStatusValue === 'da√±ado' || mobileyeStatusValue === 'no tiene') {
      status = 'Observaciones';
      issues.push(`Mobileye: ${formInputs.mobileyeStatus.value}`);
    }
  }
  
  // Check odometer status
  if (formInputs.odometerStatus && 
      (formInputs.odometerStatus.value === 'da√±ado' || 
       formInputs.odometerStatus.value === 'no funciona')) {
    status = 'Observaciones';
    issues.push(`Od√≥metro: ${formInputs.odometerStatus.value}`);
  }
  
  // Update status field if necessary
  if (status !== 'OK' && formInputs.globalStatus && formInputs.globalStatus.value === 'OK') {
    formInputs.globalStatus.value = status;
  }
  
  // Set critical status if there are multiple serious issues
  if (issues.length >= 3) {
    status = 'Cr√≠tico';
    
    if (formInputs.globalStatus) {
      formInputs.globalStatus.value = status;
    }
  }
  
  return status;
}

/**
 * Saves the inspection data
 */
async function saveInspection() {
  // Validation
  if (!APP_STATE.session.inspector || !APP_STATE.session.terminal) {
    showNotification('error', 'Sesi√≥n Requerida', 'Debes iniciar una sesi√≥n primero');
    openLoginModal();
    return false;
  }
  
  if (!APP_STATE.currentBus) {
    showNotification('warning', 'Bus No Seleccionado', 'Por favor, seleccione un bus para inspeccionar');
    return false;
  }
  
  const validationErrors = validateForm();
  if (validationErrors > 0) {
    showNotification('error', 'Error de Validaci√≥n', `Hay ${validationErrors} preguntas sin responder. Por favor, revise los campos destacados.`);
    return false;
  }
  
  // Auto-evaluate criticality based on responses
  evaluateCriticality();
  
  const formInputs = getFormInputs();
  
  // Update save message
  if (formInputs.saveMsg) formInputs.saveMsg.textContent = 'Guardando...';
  
  const loaderId = showLoader('Guardando inspecci√≥n...');
  
  try {
    // 1. Create or update the main inspection record
    const inspectionPayload = {
      bus_id: APP_STATE.currentBus.id,
      semana_iso: APP_STATE.session.week,
      fecha_inspeccion: new Date().toISOString(),
      inspector_nombre: APP_STATE.session.inspector,
      terminal: APP_STATE.session.terminal,
      observacion_general: formInputs.generalObservations ? formInputs.generalObservations.value || null : null,
      estado_global: formInputs.globalStatus ? formInputs.globalStatus.value : 'OK'
    };
    
    const { data: inspData, error: inspError } = await supabase
      .from('revision_semanal_inspecciones')
      .upsert(inspectionPayload, { onConflict: 'bus_id,semana_iso' })
      .select('id');
    
    if (inspError) {
      console.error('Error guardando inspecci√≥n principal:', inspError);
      throw inspError;
    }
    
    const inspectionRecord = Array.isArray(inspData) ? inspData[0] : inspData;
    const inspectionId = inspectionRecord?.id;
    
    if (!inspectionId) {
      throw new Error('No se pudo obtener el ID de la inspecci√≥n guardada');
    }
    
    APP_STATE.inspectionId = inspectionId;
    
    // 2. Save cameras section
    try {
      await upsertInspectionSection('revision_semanal_camara_inspeccion', {
        inspeccion_id: inspectionId,
        monitor_camara: formInputs.monitorCamera ? formInputs.monitorCamera.value === 'SI' : false,
        monitor_detalle: formInputs.monitorDetail ? formInputs.monitorDetail.value || null : null,
        camara_frontal: formInputs.frontCamera ? formInputs.frontCamera.value : 'tiene',
        camara_cabina: formInputs.cabinCamera ? formInputs.cabinCamera.value : 'tiene',
        camaras_interior: formInputs.interiorCamera ? formInputs.interiorCamera.value : 'tiene',
        camara_trasera: formInputs.rearCamera ? formInputs.rearCamera.value : 'tiene',
        q_all_visible: formInputs.allVisible ? formInputs.allVisible.value || null : null,
        q_reverse: formInputs.reverseActive ? formInputs.reverseActive.value || null : null,
        q_doors_open: formInputs.doorsOpen ? formInputs.doorsOpen.value || null : null,
        q_doors_closed: formInputs.doorsClosed ? formInputs.doorsClosed.value || null : null,
        observacion: formInputs.cameraObservations ? formInputs.cameraObservations.value || null : null
      });
    } catch (cameraError) {
      console.error('Error guardando secci√≥n de c√°maras:', cameraError);
      throw cameraError;
    }
    
    // 3. Save TAG section
    try {
      await upsertInspectionSection('revision_semanal_tag_inspeccion', {
        inspeccion_id: inspectionId,
        tag_tiene: formInputs.hasTag ? formInputs.hasTag.value === 'yes' : true,
        tag_serie: formInputs.tagSerial ? formInputs.tagSerial.value || null : null,
        observacion: formInputs.tagObservations ? formInputs.tagObservations.value || null : null
      });
    } catch (tagError) {
      console.error('Error guardando secci√≥n de TAG:', tagError);
      throw tagError;
    }
    
    // 4. Save extinguisher section
    try {
      await upsertInspectionSection('revision_semanal_extintor_inspeccion', {
        inspeccion_id: inspectionId,
        ubicacion: formInputs.extinguisherLocation ? formInputs.extinguisherLocation.value.trim() || null : null,
        fecha_vencimiento: formInputs.extinguisherExpiry && formInputs.extinguisherExpiry.value ?
          new Date(formInputs.extinguisherExpiry.value).toISOString() : null,
        estado_extintor: formInputs.extinguisherStatus ? formInputs.extinguisherStatus.value || null : null,
        estado_certificacion: formInputs.certificationStatus ? formInputs.certificationStatus.value || null : null,
        estado_sonda: formInputs.probeStatus ? formInputs.probeStatus.value || null : null,
        estado_manometro: formInputs.manometerStatus ? formInputs.manometerStatus.value || null : null,
        presion_carga: formInputs.pressureStatus ? formInputs.pressureStatus.value || null : null,
        cilindro_estado: formInputs.cylinderStatus ? formInputs.cylinderStatus.value || null : null,
        estado_porta_extintor: formInputs.holderStatus ? formInputs.holderStatus.value || null : null
      });
    } catch (extinguisherError) {
      console.error('Error guardando secci√≥n de extintor:', extinguisherError);
      throw extinguisherError;
    }
    
    // 5. Save Mobileye section (if applicable)
    if (APP_STATE.currentBus && (APP_STATE.currentBus.marca || '').toUpperCase() === 'VOLVO') {
      try {
        await upsertInspectionSection('revision_semanal_movileye_inspeccion', {
          inspeccion_id: inspectionId,
          estado: formInputs.mobileyeStatus ? formInputs.mobileyeStatus.value || null : null,
          alerta_izq: formInputs.leftAlert ? formInputs.leftAlert.value || null : null,
          alerta_der: formInputs.rightAlert ? formInputs.rightAlert.value || null : null,
          consola: formInputs.console ? formInputs.console.value || null : null,
          sensor_frontal: formInputs.frontSensor ? formInputs.frontSensor.value || null : null,
          sensor_izq: formInputs.leftSensor ? formInputs.leftSensor.value || null : null,
          sensor_der: formInputs.rightSensor ? formInputs.rightSensor.value || null : null,
          sensor_traser_izq_art: formInputs.rearLeftSensor ? formInputs.rearLeftSensor.value || null : null,
          sensor_traser_der_art: formInputs.rearRightSensor ? formInputs.rearRightSensor.value || null : null,
          fecha_siniestro: formInputs.incidentDate && formInputs.incidentDate.value ? 
            new Date(formInputs.incidentDate.value).toISOString() : null,
          nro_siniestro: formInputs.incidentNumber ? formInputs.incidentNumber.value || null : null
        });
      } catch (mobileyeError) {
        console.error('Error guardando secci√≥n de Mobileye:', mobileyeError);
        throw mobileyeError;
      }
    }
    
    // 6. Save odometer section
    try {
      await upsertInspectionSection('revision_semanal_odometro_inspeccion', {
        inspeccion_id: inspectionId,
        lectura_km: formInputs.odometerReading && formInputs.odometerReading.value ? 
          Number(formInputs.odometerReading.value) : null,
        estado_odometro: formInputs.odometerStatus ? formInputs.odometerStatus.value : 'funcionando',
        observacion: formInputs.odometerObservations ? formInputs.odometerObservations.value || null : null
      });
    } catch (odometerError) {
      console.error('Error guardando secci√≥n de od√≥metro:', odometerError);
      throw odometerError;
    }
    
    // 7. Save advertising section
    try {
      await upsertInspectionSection('revision_semanal_publicidad_inspeccion', {
        inspeccion_id: inspectionId,
        publicidad_izquierda_estado: formInputs.publicityLeftStatus ? formInputs.publicityLeftStatus.value || 'NO TIENE' : 'NO TIENE',
        publicidad_izquierda_detalle: formInputs.publicityLeftDetail ? formInputs.publicityLeftDetail.value || null : null,
        publicidad_izquierda_danio: formInputs.publicityLeftDamage ? formInputs.publicityLeftDamage.value || 'NO' : 'NO',
        publicidad_izquierda_danio_detalle: formInputs.publicityLeftDamageDetail ? formInputs.publicityLeftDamageDetail.value || null : null,
        publicidad_izquierda_residuos: formInputs.publicityLeftResidue ? formInputs.publicityLeftResidue.value || 'NO' : 'NO',
        publicidad_derecha_estado: formInputs.publicityRightStatus ? formInputs.publicityRightStatus.value || 'NO TIENE' : 'NO TIENE',
        publicidad_derecha_detalle: formInputs.publicityRightDetail ? formInputs.publicityRightDetail.value || null : null,
        publicidad_derecha_danio: formInputs.publicityRightDamage ? formInputs.publicityRightDamage.value || 'NO' : 'NO',
        publicidad_derecha_danio_detalle: formInputs.publicityRightDamageDetail ? formInputs.publicityRightDamageDetail.value || null : null,
        publicidad_derecha_residuos: formInputs.publicityRightResidue ? formInputs.publicityRightResidue.value || 'NO' : 'NO',
        publicidad_luneta_estado: formInputs.publicityRearStatus ? formInputs.publicityRearStatus.value || 'NO TIENE' : 'NO TIENE',
        publicidad_luneta_detalle: formInputs.publicityRearDetail ? formInputs.publicityRearDetail.value || null : null,
        publicidad_luneta_danio: formInputs.publicityRearDamage ? formInputs.publicityRearDamage.value || 'NO' : 'NO',
        publicidad_luneta_danio_detalle: formInputs.publicityRearDamageDetail ? formInputs.publicityRearDamageDetail.value || null : null,
        publicidad_luneta_residuos: formInputs.publicityRearResidue ? formInputs.publicityRearResidue.value || 'NO' : 'NO'
      });
    } catch (advertisingError) {
      console.error('Error guardando secci√≥n de publicidad:', advertisingError);
      throw advertisingError;
    }
    
    // 8. Generate maintenance tickets
    const createdTickets = await createMaintenanceTickets(inspectionId) || [];
    
    clearTimeout(loaderId);
    hideLoader();
    
    // Update UI
    if (formInputs.saveMsg) formInputs.saveMsg.innerHTML = 'Guardado <i class="fas fa-check-circle text-success"></i>';
    
    // Update inspection status
    if (formInputs.inspectionStatus) {
      formInputs.inspectionStatus.innerHTML = `
        <i class="fas fa-check-circle"></i> Inspeccionado el ${
          new Date().toLocaleDateString('es-ES', APP_CONFIG.dateFormat.medium)
        } por ${APP_STATE.session.inspector}
      `;
      formInputs.inspectionStatus.className = 'chip status-completed';
    }
    
    showNotification('success', 'Guardado Exitoso', 'Datos de la inspecci√≥n guardados correctamente');
    showLiveAlert('Inspecci√≥n registrada correctamente', 'success');
    
    // Update related data
    refreshPendingInspections();
    refreshReportTables();
    await recordSessionActivity(
      inspectionId,
      createdTickets,
      formInputs.globalStatus ? formInputs.globalStatus.value : 'OK'
    );
    
    // Log activity
    logActivity({
      type: 'inspection',
      action: APP_STATE.inspectionId ? 'update' : 'create',
      ppu: APP_STATE.currentBus.ppu,
      status: formInputs.globalStatus ? formInputs.globalStatus.value : 'OK'
    });
    
    return true;
  } catch (error) {
    clearTimeout(loaderId);
    hideLoader();
    
    console.error('Error saving inspection:', error);
    if (formInputs.saveMsg) formInputs.saveMsg.innerHTML = '¬°Error al guardar! <i class="fas fa-times-circle text-danger"></i>';
    
    const saveErrorMessage = error?.message ?
      `No se pudieron guardar los datos: ${error.message}` :
      'No se pudieron guardar los datos de la inspecci√≥n';
    
    showNotification('error', 'Error de Guardado', saveErrorMessage);
    showLiveAlert(saveErrorMessage, 'danger');
    return false;
  }
}

/**
 * Creates maintenance tickets based on inspection issues
 * @param {number} inspectionId - Inspection ID
 */
async function createMaintenanceTickets(inspectionId) {
  if (!inspectionId || !APP_STATE.currentBus) return;
  if (!supabase) return [];
  
  const formInputs = getFormInputs();
  const tickets = [];
  const createdTicketRecords = [];
  
  // 1. Check for camera issues
  const cameraIssues = [];
  
  if (formInputs.monitorCamera && formInputs.monitorCamera.value === 'NO') {
    cameraIssues.push('Monitor no muestra todas las c√°maras');
  }
  
  if (formInputs.allVisible && formInputs.allVisible.value === 'NO') {
    cameraIssues.push('No todas las c√°maras son visibles en el monitor');
  }
  
  if (formInputs.reverseActive && formInputs.reverseActive.value === 'NO') {
    cameraIssues.push('C√°mara trasera no se activa con marcha atr√°s');
  }
  
  if (formInputs.doorsOpen && formInputs.doorsOpen.value === 'NO') {
    cameraIssues.push('C√°maras de puertas no se activan al abrirse');
  }
  
  if (formInputs.doorsClosed && formInputs.doorsClosed.value === 'NO') {
    cameraIssues.push('No se muestran todas las c√°maras con puertas cerradas');
  }
  
  // Check camera status
  const cameraFields = [
    { key: 'frontCamera', name: 'delantera' },
    { key: 'cabinCamera', name: 'cabina' },
    { key: 'interiorCamera', name: 'interiores' },
    { key: 'rearCamera', name: 'trasera' }
  ];
  
  cameraFields.forEach(field => {
    if (formInputs[field.key] && 
        (formInputs[field.key].value === 'da√±ada' || 
         formInputs[field.key].value === 'no tiene')) {
      cameraIssues.push(`c√°mara ${field.name}: ${formInputs[field.key].value}`);
    }
  });
  
  if (cameraIssues.length > 0) {
    tickets.push({
      origin: 'cameras',
      component: 'C√°maras',
      description: `Reportar a SRL ‚Äî ${cameraIssues.join('; ')}. ${
        formInputs.monitorDetail ? `Detalle del monitor: ${formInputs.monitorDetail.value || '‚Äî'}. ` : ''
      }${
        formInputs.cameraObservations ? `Observaciones: ${formInputs.cameraObservations.value || '‚Äî'}` : ''
      }`
    });
  }
  
  // 2. Check for TAG issues
  if (formInputs.hasTag && formInputs.hasTag.value === 'no') {
    tickets.push({
      origin: 'tag',
      component: 'TAG',
      description: `Bus sin TAG. ${
        formInputs.tagObservations ? `Observaciones: ${formInputs.tagObservations.value || '‚Äî'}` : ''
      }`
    });
  }
  
  // 3. Check for extinguisher issues
  const extinguisherIssues = [];
  const extinguisherStatusValue = formInputs.extinguisherStatus ? formInputs.extinguisherStatus.value : '';
  const certificationStatusValue = formInputs.certificationStatus ? formInputs.certificationStatus.value : '';
  const probeStatusValue = formInputs.probeStatus ? formInputs.probeStatus.value : '';
  const manometerStatusValue = formInputs.manometerStatus ? formInputs.manometerStatus.value : '';
  const pressureStatusValue = formInputs.pressureStatus ? formInputs.pressureStatus.value : '';
  const cylinderStatusValue = formInputs.cylinderStatus ? formInputs.cylinderStatus.value : '';
  const holderStatusValue = formInputs.holderStatus ? formInputs.holderStatus.value : '';
  
  if (extinguisherStatusValue === 'NO TIENE') extinguisherIssues.push('Extintor ausente');
  if (extinguisherStatusValue === 'DA√ëADO') extinguisherIssues.push('Extintor da√±ado');
  if (certificationStatusValue === 'NO TIENE') extinguisherIssues.push('Sin certificaci√≥n vigente');
  if (certificationStatusValue === 'DA√ëADO') extinguisherIssues.push('Certificaci√≥n da√±ada');
  if (probeStatusValue === 'NO TIENE') extinguisherIssues.push('Sonda no disponible');
  if (probeStatusValue === 'DA√ëADO') extinguisherIssues.push('Sonda da√±ada');
  if (manometerStatusValue === 'NO TIENE') extinguisherIssues.push('Man√≥metro no disponible');
  if (manometerStatusValue === 'DA√ëADO') extinguisherIssues.push('Man√≥metro da√±ado');
  if (pressureStatusValue && pressureStatusValue !== 'OPTIMA') extinguisherIssues.push(`Presi√≥n fuera de rango (${pressureStatusValue})`);
  if (cylinderStatusValue === 'ABOLLADO') extinguisherIssues.push('Cilindro abollado');
  if (holderStatusValue && holderStatusValue !== 'TIENE') extinguisherIssues.push(`Porta extintor: ${holderStatusValue}`);
  
  if (extinguisherIssues.length > 0) {
    const locationValue = formInputs.extinguisherLocation ? formInputs.extinguisherLocation.value.trim() : '';
    const expiryValue = formInputs.extinguisherExpiry ? formInputs.extinguisherExpiry.value : '';
    
    const details = [
      extinguisherIssues.join('; ')
    ];
    
    if (locationValue) {
      details.push(`Ubicaci√≥n reportada: ${locationValue}`);
    }
    
    if (expiryValue) {
      const formattedExpiry = new Date(expiryValue).toLocaleDateString('es-ES');
      details.push(`Vencimiento: ${formattedExpiry}`);
    }
    
    tickets.push({
      origin: 'extinguisher',
      component: 'Extintor',
      description: details.filter(Boolean).join('. ') + '.'
    });
  }
  
  // 4. Check for Mobileye issues
  if (APP_STATE.currentBus && (APP_STATE.currentBus.marca || '').toUpperCase() === 'VOLVO') {
    if (formInputs.mobileyeStatus && 
        (formInputs.mobileyeStatus.value === 'da√±ado' || 
         formInputs.mobileyeStatus.value === 'no tiene')) {
      tickets.push({
        origin: 'mobileye',
        component: 'Mobileye',
        description: `Estado: ${formInputs.mobileyeStatus.value}. ${
          formInputs.console ? `Consola: ${formInputs.console.value || '‚Äî'}; ` : ''
        }${
          formInputs.frontSensor ? `Sensores F: ${formInputs.frontSensor.value || '‚Äî'} ` : ''
        }${
          formInputs.leftSensor ? `IZQ: ${formInputs.leftSensor.value || '‚Äî'} ` : ''
        }${
          formInputs.rightSensor ? `DER: ${formInputs.rightSensor.value || '‚Äî'} ` : ''
        }${
          formInputs.rearLeftSensor ? `TIZQ: ${formInputs.rearLeftSensor.value || '‚Äî'} ` : ''
        }${
          formInputs.rearRightSensor ? `TDER: ${formInputs.rearRightSensor.value || '‚Äî'}` : ''
        }`
      });
    }
  }
  
  // 5. Check for odometer issues
  if (formInputs.odometerStatus && 
      (formInputs.odometerStatus.value === 'da√±ado' || 
       formInputs.odometerStatus.value === 'no funciona')) {
    tickets.push({
      origin: 'odometer',
      component: 'Od√≥metro',
      description: `${
        formInputs.odometerReading ? `Lectura: ${formInputs.odometerReading.value || '‚Äî'} km; ` : ''
      }Estado: ${formInputs.odometerStatus.value}. ${
        formInputs.odometerObservations ? formInputs.odometerObservations.value || '' : ''
      }`
    });
  }
  
  // 6. Check advertising issues
  const publicityTickets = [
    {
      label: 'Izquierda',
      status: formInputs.publicityLeftStatus ? formInputs.publicityLeftStatus.value : 'NO TIENE',
      detail: formInputs.publicityLeftDetail ? formInputs.publicityLeftDetail.value : '',
      damage: formInputs.publicityLeftDamage ? formInputs.publicityLeftDamage.value : 'NO',
      damageDetail: formInputs.publicityLeftDamageDetail ? formInputs.publicityLeftDamageDetail.value : '',
      residue: formInputs.publicityLeftResidue ? formInputs.publicityLeftResidue.value : 'NO'
    },
    {
      label: 'Derecha',
      status: formInputs.publicityRightStatus ? formInputs.publicityRightStatus.value : 'NO TIENE',
      detail: formInputs.publicityRightDetail ? formInputs.publicityRightDetail.value : '',
      damage: formInputs.publicityRightDamage ? formInputs.publicityRightDamage.value : 'NO',
      damageDetail: formInputs.publicityRightDamageDetail ? formInputs.publicityRightDamageDetail.value : '',
      residue: formInputs.publicityRightResidue ? formInputs.publicityRightResidue.value : 'NO'
    },
    {
      label: 'Luneta',
      status: formInputs.publicityRearStatus ? formInputs.publicityRearStatus.value : 'NO TIENE',
      detail: formInputs.publicityRearDetail ? formInputs.publicityRearDetail.value : '',
      damage: formInputs.publicityRearDamage ? formInputs.publicityRearDamage.value : 'NO',
      damageDetail: formInputs.publicityRearDamageDetail ? formInputs.publicityRearDamageDetail.value : '',
      residue: formInputs.publicityRearResidue ? formInputs.publicityRearResidue.value : 'NO'
    }
  ];
  
  publicityTickets.forEach(section => {
    const issues = [];
    if (section.damage === 'SI') {
      issues.push(`da√±o por retiro${section.damageDetail ? `: ${section.damageDetail}` : ''}`);
    }
    if (section.residue === 'SI') {
      issues.push('residuos de pegamento');
    }
    
    if (issues.length > 0) {
      const detailText = section.detail ? `Publicidad: ${section.detail}. ` : '';
      const statusText = section.status ? `Estado: ${section.status}. ` : '';
      const ppuText = APP_STATE.currentBus?.ppu ? `PPU ${APP_STATE.currentBus.ppu}. ` : '';
      tickets.push({
        origin: 'advertising',
        component: `Publicidad ${section.label}`,
        description: `${ppuText}${detailText}${statusText}${issues.join(' ¬∑ ')}`
      });
    }
  });
  
  // Create tickets in database
  for (const ticket of tickets) {
    try {
      const { data: insertedTicket, error: insertError } = await supabase
        .from('revision_semanal_tickets_mantencion')
        .insert({
          inspeccion_id: inspectionId,
          bus_id: APP_STATE.currentBus.id,
          terminal: APP_STATE.currentBus.terminal || APP_STATE.session.terminal,
          origen: ticket.origin,
          componente: ticket.component,
          descripcion_falla: ticket.description,
          prioridad: 'medium',
          estado: 'open',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        })
        .select()
        .maybeSingle();
      
      if (insertError) throw insertError;
      if (insertedTicket) {
        createdTicketRecords.push(insertedTicket);
      } else {
        createdTicketRecords.push({
          componente: ticket.component,
          descripcion_falla: ticket.description,
          terminal: APP_STATE.currentBus.terminal || APP_STATE.session.terminal
        });
      }
    } catch (error) {
      console.error('Error creating ticket:', error);
    }
  }
  
  if (tickets.length > 0) {
    showNotification(
      'info', 
      'Tickets de Mantenimiento', 
      `Se han creado autom√°ticamente ${tickets.length} ticket${tickets.length !== 1 ? 's' : ''} de mantenimiento`
    );
  }

  return createdTicketRecords;
}

// ===================== PENDING INSPECTIONS =====================
/**
 * Retrieves pending buses for the active ISO week.
 * @param {string|null} terminalFilter - Terminal filter or null for all.
 * @returns {Promise<Array>} Pending buses.
 */
async function getPendingBuses(terminalFilter = null) {
  if (!supabase) throw new Error('Supabase client not initialized');
  
  let busQuery = supabase
    .from('revision_semanal_buses')
    .select('id, ppu, numero_interno, terminal, marca, modelo_chasis')
    .order('terminal', { ascending: true })
    .order('ppu', { ascending: true });
  
  if (terminalFilter) {
    busQuery = busQuery.eq('terminal', terminalFilter);
  }
  
  const { data: buses, error: busesError } = await busQuery;
  if (busesError) throw busesError;
  
  let inspectionQuery = supabase
    .from('revision_semanal_inspecciones')
    .select('bus_id')
    .eq('semana_iso', APP_STATE.session.week);
  
  if (terminalFilter) {
    inspectionQuery = inspectionQuery.eq('terminal', terminalFilter);
  }
  
  const { data: inspections, error: inspectionsError } = await inspectionQuery;
  if (inspectionsError) throw inspectionsError;
  
  const inspectedBuses = new Set((inspections || []).map(i => i.bus_id));
  return (buses || []).filter(bus => !inspectedBuses.has(bus.id));
}

/**
 * Refreshes the list of pending inspections
 */
async function refreshPendingInspections() {
  const pendingCount = document.getElementById('pendingCount');
  if (!pendingCount) return;
  
  try {
    const pendingBuses = await getPendingBuses(null);
    pendingCount.textContent = pendingBuses.length.toString();
    updatePendingFabCount(pendingBuses.length);
    updateFabAppearance();
  } catch (error) {
    console.error('Error refreshing pending inspections:', error);
    pendingCount.textContent = '?';
    updatePendingFabCount(0);
  }
}

/**
 * Refreshes the pending inspections list in the modal
 */
async function refreshPendingList() {
  const pendingListElement = document.getElementById('pendingList');
  const pendingListCount = document.getElementById('pendingListCount');
  
  if (!pendingListElement || !pendingListCount) return;
  
  const terminalSelect = document.getElementById('pendingFilterTerminal');
  const selectedTerminalValue = terminalSelect ? terminalSelect.value.trim() : '';
  const terminalFilter = selectedTerminalValue === '' ? null : selectedTerminalValue;
  
  const loaderId = showLoader('Cargando buses pendientes...');
  
  try {
    const pendingBuses = await getPendingBuses(terminalFilter);
    
    clearTimeout(loaderId);
    hideLoader();
    
    pendingListCount.textContent = pendingBuses.length.toString();
    const globalPendingCount = document.getElementById('pendingCount');
    if (globalPendingCount && !terminalFilter) {
      globalPendingCount.textContent = pendingBuses.length.toString();
      updatePendingFabCount(pendingBuses.length);
      updateFabAppearance();
    }
    
      if (pendingBuses.length > 0) {
        pendingListElement.innerHTML = pendingBuses.map(bus => {
          const rawPpu = bus.ppu || '';
          const displayPpu = rawPpu ? escapeHTML(rawPpu) : '‚Äî';
          const interno = escapeHTML(bus.numero_interno || '‚Äî');
          const terminalName = escapeHTML(bus.terminal || '‚Äî');
          const marca = escapeHTML(bus.marca || '‚Äî');
          const modelo = escapeHTML(bus.modelo_chasis || '‚Äî');
          return `
            <div class="pending-item">
              <div class="pending-info">
                <strong>${displayPpu}</strong>
                <span class="text-light">${interno} ¬∑ ${terminalName} ¬∑ ${marca} ${modelo}</span>
              </div>
              <button class="btn btn-primary btn-sm" data-ppu="${encodeURIComponent(rawPpu)}">
                <i class="fas fa-clipboard-check"></i> Inspeccionar
              </button>
            </div>
          `;
        }).join('');
      
      pendingListElement.querySelectorAll('button[data-ppu]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const ppu = decodeURIComponent(btn.dataset.ppu || '');
          
          try {
            const loaderToken = showLoader('Cargando bus...');
            
            const { data, error } = await supabase
              .from('revision_semanal_buses')
              .select('*')
              .eq('ppu', ppu)
              .maybeSingle();
            
            clearTimeout(loaderToken);
            hideLoader();
            
            if (error) throw error;
            
            if (data) {
              selectBus(data);
              
              const pendingModal = document.getElementById('pendingModal');
              if (pendingModal) {
                hideModal(pendingModal);
              }
              
              showSection('inspection-form');
            } else {
              throw new Error('No se encontr√≥ el bus');
            }
          } catch (error) {
            console.error('Error selecting bus:', error);
            showNotification('error', 'Error', 'No se pudo cargar datos del bus');
          }
        });
      });
    } else {
      pendingListElement.innerHTML = '<div class="chip chip-success" style="margin: 1rem 0; justify-content: center; width: 100%">¬°No hay inspecciones pendientes! üéâ</div>';
    }
    updateFabAppearance();
  } catch (error) {
    clearTimeout(loaderId);
    hideLoader();
    
    console.error('Error updating pending inspections list:', error);
    pendingListElement.innerHTML = '<div class="chip chip-danger" style="margin: 1rem 0">Error al cargar inspecciones pendientes</div>';
    updatePendingFabCount(0);
    updateFabAppearance();
  }
}

// ===================== REPORT TABLES =====================
/**
 * Refreshes all report tables
 */
async function refreshReportTables() {
  try {
    await Promise.all([
      refreshCamerasReport(),
      refreshTagReport(),
      refreshExtinguisherReport(),
      refreshSessionReport(),
      refreshMobileyeReport(),
      refreshOdometerReport(),
      refreshAdvertisingReport(APP_STATE.filters.advertising || {})
    ]);
  } catch (error) {
    console.error('Error refreshing report tables:', error);
  }
}

/**
 * Refreshes the cameras report table
 * @param {Object} filters - Filter criteria
 */
async function refreshCamerasReport(filters = {}) {
  try {
    const loaderId = showLoader('Cargando informe de c√°maras...');
    
    let cameraQuery = supabase
      .from('revision_semanal_camara_inspeccion')
      .select(`
        *,
        inspeccion:revision_semanal_inspecciones!inner(
          bus_id,
          semana_iso,
          terminal,
          bus:revision_semanal_buses!inner(
            ppu,
            asignacion,
            modelo_chasis,
            marca,
            anio,
            terminal
          )
        )
      `)
      .eq('inspeccion.semana_iso', APP_STATE.session.week);
    
    if (filters.terminal) {
      cameraQuery = cameraQuery.eq('inspeccion.terminal', filters.terminal);
    }
    
    if (filters.monitor) {
      cameraQuery = cameraQuery.eq('monitor_camara', filters.monitor === 'SI');
    }
    
    const { data: cameraRows, error: cameraError } = await cameraQuery;
    
    if (cameraError) throw cameraError;
    
    // Apply client-side filtering for make
    let filteredCameraRows = cameraRows || [];
    
    if (filters.make) {
      const desired = filters.make.toLowerCase();
      filteredCameraRows = filteredCameraRows.filter(row => (row.inspeccion?.bus?.marca || '').toLowerCase() === desired);
    }
    
    // Update count displays
    const cameraReportCount = document.getElementById('cameraReportCount');
    const cameraCount = document.getElementById('cameraCount');
    
    if (cameraReportCount) cameraReportCount.textContent = filteredCameraRows.length.toString();
    if (cameraCount) cameraCount.textContent = filteredCameraRows.length.toString();
    
    // Update table
    const cameraTableBody = document.querySelector('#camerasTable tbody');
    
    if (cameraTableBody) {
      if (filteredCameraRows.length > 0) {
        cameraTableBody.innerHTML = filteredCameraRows.map((row, index) => {
          const bus = row.inspeccion?.bus || {};
          const monitorStatus = row.monitor_camara ? 'S√ç' : 'NO';
          
          return `<tr>
            <td>${index + 1}</td>
            <td>${escapeHTML(bus.ppu || '')}</td>
            <td>${escapeHTML(bus.terminal || '')}</td>
            <td>${escapeHTML(bus.asignacion || '')}</td>
            <td>${escapeHTML(bus.modelo_chasis || '')}</td>
            <td>${escapeHTML(bus.marca || '')}</td>
            <td>${escapeHTML(bus.anio || '')}</td>
            <td class="${monitorStatus === 'NO' ? 'text-danger fw-bold' : ''}">${monitorStatus}</td>
            <td>${escapeHTML(row.camara_frontal || '')}</td>
            <td>${escapeHTML(row.camara_cabina || '')}</td>
            <td>${escapeHTML(row.camaras_interior || '')}</td>
            <td>${escapeHTML(row.camara_trasera || '')}</td>
            <td>${escapeHTML(row.observacion || '')}</td>
          </tr>`;
        }).join('');
      } else {
        cameraTableBody.innerHTML = '<tr><td colspan="13" class="text-center">No hay datos disponibles</td></tr>';
      }
    }
    
    clearTimeout(loaderId);
    hideLoader();
  } catch (error) {
    hideLoader();
    console.error('Error refreshing cameras report:', error);
    showNotification('error', 'Error', 'No se pudo cargar el informe de c√°maras');
  }
}

/**
 * Refreshes the TAG report table
 * @param {Object} filters - Filter criteria
 */
async function refreshTagReport(filters = {}) {
  try {
    const loaderId = showLoader('Cargando informe de TAG...');
    
    let tagQuery = supabase
      .from('revision_semanal_tag_inspeccion')
      .select(`
        *,
        inspeccion:revision_semanal_inspecciones!inner(
          bus_id,
          semana_iso,
          terminal,
          bus:revision_semanal_buses!inner(
            ppu,
            terminal
          )
        )
      `)
      .eq('inspeccion.semana_iso', APP_STATE.session.week);
    
    if (filters.terminal) {
      tagQuery = tagQuery.eq('inspeccion.terminal', filters.terminal);
    }
    
    if (filters.tagStatus) {
      tagQuery = tagQuery.eq('tag_tiene', filters.tagStatus === 'yes');
    }
    
    const { data: tagRows, error: tagError } = await tagQuery;
    
    if (tagError) throw tagError;
    
    // Update count displays
    const tagReportCount = document.getElementById('tagReportCount');
    const tagCount = document.getElementById('tagCount');
    
    const rows = tagRows || [];
    if (tagReportCount) tagReportCount.textContent = rows.length.toString();
    if (tagCount) tagCount.textContent = rows.length.toString();
    
    // Update table
    const tagTableBody = document.querySelector('#tagTable tbody');
    
    if (tagTableBody) {
      if (rows.length > 0) {
        tagTableBody.innerHTML = rows.map((row, index) => {
          const bus = row.inspeccion?.bus || {};
          const tagStatus = row.tag_tiene ? 'S√ç' : 'NO';
          
          return `<tr>
            <td>${index + 1}</td>
            <td>${escapeHTML(bus.ppu || '')}</td>
            <td class="${!row.tag_tiene ? 'text-danger fw-bold' : ''}">${tagStatus}</td>
            <td>${escapeHTML(row.tag_serie || '')}</td>
            <td>${escapeHTML(row.observacion || '')}</td>
          </tr>`;
        }).join('');
      } else {
        tagTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No hay datos disponibles</td></tr>';
      }
    }
    
    clearTimeout(loaderId);
    hideLoader();
  } catch (error) {
    hideLoader();
    console.error('Error refreshing TAG report:', error);
    showNotification('error', 'Error', 'No se pudo cargar el informe de TAG');
  }
}

/**
 * Refreshes the extinguisher report table
 * @param {Object} filters - Filter criteria
 */
async function refreshExtinguisherReport(filters = {}) {
  const loaderId = showLoader('Cargando informe de extintores...');
  
  try {
    let inspectionQuery = supabase
      .from('revision_semanal_inspecciones')
      .select('id, bus_id, terminal')
      .eq('semana_iso', APP_STATE.session.week);
    
    if (filters.terminal) {
      inspectionQuery = inspectionQuery.eq('terminal', filters.terminal);
    }
    
    const { data: inspectionRows, error: inspectionError } = await inspectionQuery;
    if (inspectionError) throw inspectionError;
    
    const inspectionById = new Map();
    const busIds = new Set();
    
    (inspectionRows || []).forEach(row => {
      if (!row) return;
      inspectionById.set(row.id, row);
      if (row.bus_id) busIds.add(row.bus_id);
    });
    
    let extinguisherRows = [];
    
    if (inspectionById.size > 0) {
      const inspectionIds = Array.from(inspectionById.keys());
      if (inspectionIds.length > 0) {
        const { data: extinguisherData, error: extinguisherError } = await supabase
          .from('revision_semanal_extintor_inspeccion')
          .select('*')
          .in('inspeccion_id', inspectionIds);
        
        if (extinguisherError) throw extinguisherError;
        extinguisherRows = extinguisherData || [];
      }
    }
    
    const busMap = new Map();
    if (busIds.size > 0) {
      const { data: busRows, error: busError } = await supabase
        .from('revision_semanal_buses')
        .select('id, ppu, asignacion, modelo_chasis, marca, anio, terminal')
        .in('id', Array.from(busIds));
      if (busError) throw busError;
      (busRows || []).forEach(bus => {
        busMap.set(bus.id, bus);
      });
    }
    
    let filteredRows = extinguisherRows.slice();
    
    const applyExactFilter = (value, expected) =>
      (value || '').toUpperCase() === (expected || '').toUpperCase();
    
    if (filters.extinguisherStatus) {
      filteredRows = filteredRows.filter(row => applyExactFilter(row.estado_extintor, filters.extinguisherStatus));
    }
    
    if (filters.certificationStatus) {
      filteredRows = filteredRows.filter(row => applyExactFilter(row.estado_certificacion, filters.certificationStatus));
    }
    
    if (filters.pressureStatus) {
      filteredRows = filteredRows.filter(row => applyExactFilter(row.presion_carga, filters.pressureStatus));
    }
    
    if (filters.holderStatus) {
      filteredRows = filteredRows.filter(row => applyExactFilter(row.estado_porta_extintor, filters.holderStatus));
    }
    
    // Remove rows whose inspection is not available (safety net)
    filteredRows = filteredRows.filter(row => inspectionById.has(row.inspeccion_id));
    
    // Sort by PPU for consistent display
    filteredRows.sort((a, b) => {
      const inspectionA = inspectionById.get(a.inspeccion_id);
      const inspectionB = inspectionById.get(b.inspeccion_id);
      const busA = inspectionA ? busMap.get(inspectionA.bus_id) : null;
      const busB = inspectionB ? busMap.get(inspectionB.bus_id) : null;
      const ppuA = (busA?.ppu || '').toUpperCase();
      const ppuB = (busB?.ppu || '').toUpperCase();
      return ppuA.localeCompare(ppuB);
    });
    
    const extinguisherReportCount = document.getElementById('extinguisherReportCount');
    const extinguisherCount = document.getElementById('extinguisherCount');
    
    if (extinguisherReportCount) extinguisherReportCount.textContent = filteredRows.length.toString();
    if (extinguisherCount) extinguisherCount.textContent = filteredRows.length.toString();
    
    const extinguisherTableBody = document.querySelector('#extinguisherTable tbody');
    
    if (extinguisherTableBody) {
      if (filteredRows.length > 0) {
        extinguisherTableBody.innerHTML = filteredRows.map((row, index) => {
          const inspection = inspectionById.get(row.inspeccion_id) || {};
          const bus = busMap.get(inspection.bus_id) || {};
          const formattedExpiry = row.fecha_vencimiento ? new Date(row.fecha_vencimiento).toLocaleDateString('es-ES') : '‚Äî';
          const location = row.ubicacion || bus.terminal || inspection.terminal || '';
          
          const statusHighlight = (value) => {
            const normalized = (value || '').toUpperCase();
            if (!normalized) return '';
            if (normalized === 'NO TIENE') return 'text-danger fw-bold';
            if (normalized === 'DA√ëADO') return 'text-warning fw-bold';
            if (normalized === 'BAJA CARGA' || normalized === 'SOBRE CARGA') return 'text-warning fw-bold';
            if (normalized === 'ABOLLADO') return 'text-warning fw-bold';
            if (normalized === 'EXTINTOR NO ENTRA') return 'text-warning fw-bold';
            return '';
          };
          
          return `<tr>
            <td>${index + 1}</td>
            <td>${escapeHTML(bus.ppu || '')}</td>
            <td>${escapeHTML(location)}</td>
            <td>${formattedExpiry}</td>
            <td class="${statusHighlight(row.estado_extintor)}">${escapeHTML(row.estado_extintor || '')}</td>
            <td class="${statusHighlight(row.estado_certificacion)}">${escapeHTML(row.estado_certificacion || '')}</td>
            <td class="${statusHighlight(row.estado_sonda)}">${escapeHTML(row.estado_sonda || '')}</td>
            <td class="${statusHighlight(row.estado_manometro)}">${escapeHTML(row.estado_manometro || '')}</td>
            <td class="${statusHighlight(row.presion_carga)}">${escapeHTML(row.presion_carga || '')}</td>
            <td class="${statusHighlight(row.cilindro_estado)}">${escapeHTML(row.cilindro_estado || '')}</td>
            <td class="${statusHighlight(row.estado_porta_extintor)}">${escapeHTML(row.estado_porta_extintor || '')}</td>
          </tr>`;
        }).join('');
      } else {
        extinguisherTableBody.innerHTML = '<tr><td colspan="11" class="text-center">No hay datos disponibles</td></tr>';
      }
    }
    
    clearTimeout(loaderId);
    hideLoader();
  } catch (error) {
    clearTimeout(loaderId);
    hideLoader();
    console.error('Error refreshing extinguisher report:', error);
    let errorMessage = error?.message || 'No se pudo cargar el informe de extintores';
    if (error?.code === '42P01') {
      errorMessage = 'La tabla "revision_semanal_extintor_inspeccion" no existe en la base de datos. Crea la tabla y vuelve a intentarlo.';
    }
    showNotification('error', 'Error', errorMessage);
    const extinguisherReportCount = document.getElementById('extinguisherReportCount');
    const extinguisherCount = document.getElementById('extinguisherCount');
    if (extinguisherReportCount) extinguisherReportCount.textContent = '0';
    if (extinguisherCount) extinguisherCount.textContent = '0';
    const extinguisherTableBody = document.querySelector('#extinguisherTable tbody');
    if (extinguisherTableBody) {
      extinguisherTableBody.innerHTML = `<tr><td colspan="11" class="text-center text-danger">${escapeHTML(errorMessage)}</td></tr>`;
    }
  }
}

/**
 * Refreshes the session ingress report
 * @param {Object} filters - Filter criteria
 */
async function hydrateSessionSessions(sessions = []) {
  if (!supabase) return;
  if (!Array.isArray(sessions) || sessions.length === 0) return;
  
  const nowIso = new Date().toISOString();
  
  for (const session of sessions) {
    const existingBusCount = Array.isArray(session?.buses) ? session.buses.length : 0;
    
    if (existingBusCount > 0) {
      continue;
    }
    
    const inspector = normalizeInspectorName(session?.inspector || '');
    if (!inspector) continue;
    
    const terminal = (session?.terminal || '').trim();
    const startIso = session?.started_at ? new Date(session.started_at).toISOString() : null;
    const endIso = session?.ended_at ? new Date(session.ended_at).toISOString() : nowIso;
    
    if (!startIso) continue;
    
    let inspectionQuery = supabase
      .from('revision_semanal_inspecciones')
      .select('id, bus_id, inspector_nombre, terminal, fecha_inspeccion, estado_global')
      .eq('inspector_nombre', inspector)
      .gte('fecha_inspeccion', startIso)
      .lte('fecha_inspeccion', endIso)
      .order('fecha_inspeccion', { ascending: true });
    
    if (terminal) {
      inspectionQuery = inspectionQuery.eq('terminal', terminal);
    }
    
    const { data: inspections, error: inspectionsError } = await inspectionQuery;
    if (inspectionsError) {
      console.error('Error fetching inspections for session:', inspectionsError);
      continue;
    }
    
    const inspectionRows = inspections || [];
    if (inspectionRows.length === 0) {
      session.buses = [];
      session.bus_count = 0;
      session.ticket_count = 0;
      continue;
    }
    
    const inspectionIds = inspectionRows.map(row => row.id).filter(Boolean);
    const busIds = inspectionRows.map(row => row.bus_id).filter(Boolean);
    
    let busMap = new Map();
    if (busIds.length > 0) {
      const { data: busRows, error: busError } = await supabase
        .from('revision_semanal_buses')
        .select('id, ppu, terminal, asignacion, modelo_chasis, marca, anio')
        .in('id', busIds);
      
      if (!busError) {
        (busRows || []).forEach(bus => {
          if (bus && bus.id) {
            busMap.set(bus.id, bus);
          }
        });
      }
    }
    
    let ticketRows = [];
    if (inspectionIds.length > 0) {
      const { data: tickets, error: ticketError } = await supabase
        .from('revision_semanal_tickets_mantencion')
        .select('id, inspeccion_id, componente, descripcion_falla, created_at')
        .in('inspeccion_id', inspectionIds);
      
      if (!ticketError) {
        ticketRows = tickets || [];
      }
    }
    
    const ticketsByInspection = new Map();
    ticketRows.forEach(ticket => {
      if (!ticket || !ticket.inspeccion_id) return;
      if (!ticketsByInspection.has(ticket.inspeccion_id)) {
        ticketsByInspection.set(ticket.inspeccion_id, []);
      }
      ticketsByInspection.get(ticket.inspeccion_id).push({
        id: ticket.id,
        componente: ticket.componente || '‚Äî',
        descripcion: ticket.descripcion_falla || '‚Äî',
        fecha: ticket.created_at || null
      });
    });
    
    const busEntries = inspectionRows.map((inspection, index) => {
      const bus = inspection.bus_id ? (busMap.get(inspection.bus_id) || {}) : {};
      const tickets = ticketsByInspection.get(inspection.id) || [];
      return {
        inspection_id: inspection.id,
        index: index + 1,
        bus_ppu: bus.ppu || '‚Äî',
        terminal: bus.terminal || inspection.terminal || terminal || '‚Äî',
        fecha: inspection.fecha_inspeccion || null,
        estado: inspection.estado_global || 'OK',
        tickets
      };
    });
    
    session.buses = busEntries;
    session.bus_count = busEntries.length;
    session.ticket_count = ticketRows.length;
  }
}

/**
 * Aggregates sessions for the same inspector/terminal/day into a single consolidated row.
 * @param {Array} sessions - Session rows
 * @returns {Array} Aggregated rows
 */
function aggregateSessionRows(sessions = []) {
  if (!Array.isArray(sessions) || sessions.length === 0) return [];
  
  const aggregates = new Map();
  
  sessions.forEach(session => {
    if (!session) return;
    
    const inspectorName = normalizeInspectorName(session.inspector || '');
    const inspectorKey = normalizeInspectorKey(session.inspector || '');
    const terminal = (session.terminal || '').trim();
    const terminalKey = terminal.toLowerCase();
    
    const startedDate = session.started_at ? new Date(session.started_at) : null;
    const dateKey = startedDate && !Number.isNaN(startedDate.getTime())
      ? startedDate.toISOString().slice(0, 10)
      : 'unknown';
    
    const key = [inspectorKey, terminalKey, dateKey].join('|');
    
    const createBusKey = (bus) => {
      if (!bus) return '';
      if (bus.inspection_id) return `insp_${bus.inspection_id}`;
      const fecha = bus.fecha ? new Date(bus.fecha).toISOString() : '';
      return `bus_${(bus.bus_ppu || '').toUpperCase()}_${fecha}_${bus.estado || ''}`;
    };
    
    const finalizeCounts = (aggregate) => {
      aggregate.bus_count = aggregate.__buses.length;
      aggregate.ticket_count = aggregate.__buses.reduce((sum, bus) => {
        const tickets = Array.isArray(bus.tickets) ? bus.tickets : [];
        return sum + tickets.length;
      }, 0);
      aggregate.buses = aggregate.__buses;
    };
    
    const ensureTicketArrays = (busEntries = []) => {
      return busEntries.map(bus => {
        if (!bus) return null;
        const clone = { ...bus };
        clone.tickets = Array.isArray(bus.tickets)
          ? bus.tickets.map(ticket => ({ ...ticket }))
          : [];
        return clone;
      }).filter(Boolean);
    };
    
    if (!aggregates.has(key)) {
      const aggregate = {
        ...session,
        inspector: inspectorName,
        terminal,
        started_at: session.started_at,
        ended_at: session.ended_at,
        __busKeys: new Set(),
        __buses: []
      };
      
      const buses = ensureTicketArrays(session.buses);
      buses.forEach(bus => {
        const busKey = createBusKey(bus);
        if (!aggregate.__busKeys.has(busKey)) {
          aggregate.__busKeys.add(busKey);
          aggregate.__buses.push(bus);
        }
      });
      
      finalizeCounts(aggregate);
      aggregates.set(key, aggregate);
      return;
    }
    
    const aggregate = aggregates.get(key);
    
    // Merge time range
    const existingStart = aggregate.started_at ? new Date(aggregate.started_at) : null;
    const incomingStart = session.started_at ? new Date(session.started_at) : null;
    if (existingStart && incomingStart && incomingStart < existingStart) {
      aggregate.started_at = incomingStart.toISOString();
    } else if (!existingStart && incomingStart) {
      aggregate.started_at = incomingStart.toISOString();
    }
    
    const existingEnd = aggregate.ended_at ? new Date(aggregate.ended_at) : null;
    const incomingEnd = session.ended_at ? new Date(session.ended_at) : null;
    if (!existingEnd && incomingEnd) {
      aggregate.ended_at = incomingEnd.toISOString();
    } else if (existingEnd && incomingEnd && incomingEnd > existingEnd) {
      aggregate.ended_at = incomingEnd.toISOString();
    }
    
    // Merge buses
    const buses = ensureTicketArrays(session.buses);
    buses.forEach(bus => {
      const busKey = createBusKey(bus);
      if (!aggregate.__busKeys.has(busKey)) {
        aggregate.__busKeys.add(busKey);
        aggregate.__buses.push(bus);
      }
    });
    
    finalizeCounts(aggregate);
  });
  
  return Array.from(aggregates.values()).map(item => {
    const clean = { ...item };
    delete clean.__busKeys;
    delete clean.__buses;
    return clean;
  }).sort((a, b) => {
    const dateA = a.started_at ? new Date(a.started_at).getTime() : 0;
    const dateB = b.started_at ? new Date(b.started_at).getTime() : 0;
    return dateB - dateA;
  });
}

async function refreshSessionReport(filters = {}) {
  if (!supabase) return;
  const loaderId = showLoader('Cargando ingresos del personal...');
  
  try {
    let sessionQuery = supabase
      .from('revision_semanal_ingresos')
      .select('*')
      .order('started_at', { ascending: false });
    
    if (filters.terminal) {
      sessionQuery = sessionQuery.eq('terminal', filters.terminal);
    }
    
    if (filters.dateFrom) {
      const fromIso = new Date(filters.dateFrom + 'T00:00:00').toISOString();
      sessionQuery = sessionQuery.gte('started_at', fromIso);
    }
    
    if (filters.dateTo) {
      const toIso = new Date(filters.dateTo + 'T23:59:59').toISOString();
      sessionQuery = sessionQuery.lte('started_at', toIso);
    }
    
    const { data: rows, error } = await sessionQuery;
    if (error) throw error;
    
    const deduplicateSessionsByInspectorHour = (items = []) => {
      const result = [];
      const seen = new Set();
      
      items.forEach((row) => {
        // Ensure the report shows a single session per inspector/terminal/hour slot
        const inspector = normalizeInspectorName(row?.inspector || '');
        const terminal = (row?.terminal || '').trim();
        const startedAt = row?.started_at ? new Date(row.started_at) : null;
        
        if (!inspector || !startedAt || Number.isNaN(startedAt.getTime())) {
          if (inspector && row) row.inspector = inspector;
          result.push(row);
          return;
        }
        
        if (row) row.inspector = inspector;
        
        const key = [
          inspector.toLowerCase(),
          terminal.toLowerCase(),
          startedAt.getFullYear(),
          startedAt.getMonth(),
          startedAt.getDate(),
          startedAt.getHours()
        ].join('|');
        
        if (seen.has(key)) return;
        
        seen.add(key);
        result.push(row);
      });
      
      return result;
    };
    
    const sessions = (rows || []).map(normalizeSessionLogRow);
    const sessionsDeduped = deduplicateSessionsByInspectorHour(sessions);
    
    await hydrateSessionSessions(sessionsDeduped);
    
    const aggregatedSessions = aggregateSessionRows(sessionsDeduped);
    APP_STATE.sessionReportRows = aggregatedSessions;
    
    const uniqueInspectors = new Set(
      aggregatedSessions
        .map(row => normalizeInspectorName(row.inspector || ''))
        .filter(Boolean)
    );
    const totalBuses = aggregatedSessions.reduce((sum, row) => sum + (Number(row.bus_count) || 0), 0);
    const totalTickets = aggregatedSessions.reduce((sum, row) => sum + (Number(row.ticket_count) || 0), 0);
    
    const ratioAggregate = aggregatedSessions.reduce((acc, row) => {
      const buses = Number(row.bus_count) || 0;
      const tickets = Number(row.ticket_count) || 0;
      if (buses > 0) {
        acc.sum += tickets / buses;
        acc.count += 1;
      }
      return acc;
    }, { sum: 0, count: 0 });
    
    const averageRatio = ratioAggregate.count > 0 ? ratioAggregate.sum / ratioAggregate.count : 0;
    const averageEvaluation = ratioAggregate.count > 0
      ? getSessionEvaluation({ bus_count: 1, ticket_count: averageRatio })
      : { score: '‚Äî', note: 'Sin datos suficientes para evaluar.', label: 'Sin datos', className: 'text-info fw-medium' };
    
    const inspectorEl = document.getElementById('activeInspectorCount');
    const busTotalEl = document.getElementById('sessionBusTotal');
    const ticketTotalEl = document.getElementById('sessionTicketTotal');
    const avgScoreEl = document.getElementById('sessionAverageScore');
    const avgNoteEl = document.getElementById('sessionEvaluationNote');
    const sessionCountBadge = document.getElementById('sessionCount');
    
    if (inspectorEl) inspectorEl.textContent = uniqueInspectors.size.toString();
    if (busTotalEl) busTotalEl.textContent = totalBuses.toString();
    if (ticketTotalEl) ticketTotalEl.textContent = totalTickets.toString();
    if (avgScoreEl) avgScoreEl.textContent = averageEvaluation.score;
    if (avgNoteEl) avgNoteEl.textContent = averageEvaluation.note;
    if (sessionCountBadge) sessionCountBadge.textContent = aggregatedSessions.length.toString();
    
    const tableBody = document.querySelector('#sessionTable tbody');
    if (tableBody) {
      if (aggregatedSessions.length > 0) {
        tableBody.innerHTML = aggregatedSessions.map((row, index) => {
          const evaluation = getSessionEvaluation(row);
          const started = formatDateTime(row.started_at);
          const ended = row.ended_at ? formatDateTime(row.ended_at) : 'En curso';
          
          return `<tr>
            <td>${index + 1}</td>
            <td>${escapeHTML(row.inspector || '‚Äî')}</td>
            <td>${escapeHTML(row.terminal || '‚Äî')}</td>
            <td>${started}</td>
            <td>${ended}</td>
            <td>${Number(row.bus_count || 0)}</td>
            <td>${Number(row.ticket_count || 0)}</td>
            <td class="${evaluation.className}">${escapeHTML(evaluation.label)}</td>
            <td>
              <button class="btn btn-light btn-sm" data-action="session-detail" data-session-index="${index}">
                <i class="fas fa-eye"></i> Ver detalle
              </button>
            </td>
          </tr>`;
        }).join('');
        
        tableBody.querySelectorAll('button[data-action="session-detail"]').forEach(button => {
          button.addEventListener('click', () => {
            const index = Number(button.dataset.sessionIndex || -1);
            openSessionDetail(index);
          });
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center">No hay ingresos registrados para los filtros seleccionados.</td></tr>';
      }
    }
  } catch (error) {
    console.error('Error refreshing session report:', error);
    let message = error?.message || 'No se pudo cargar el informe de ingresos';
    if (error?.code === '42P01') {
      message = 'La tabla "revision_semanal_ingresos" no existe. Por favor cr√©ala para habilitar el informe.';
    } else if (error?.code === '42501') {
      message = 'Permisos insuficientes para leer "revision_semanal_ingresos". Verifica las pol√≠ticas de seguridad (RLS).';
    } else if (error?.details) {
      message = `${message}. Detalle: ${error.details}`;
    }
    showNotification('error', 'Error', message);
    const tableBody = document.querySelector('#sessionTable tbody');
    if (tableBody) {
      tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">${escapeHTML(message)}</td></tr>`;
    }
  } finally {
    clearTimeout(loaderId);
    hideLoader();
  }
}

function openSessionDetail(index) {
  const sessions = APP_STATE.sessionReportRows || [];
  const row = sessions[index];
  if (!row) {
    showNotification('warning', 'Detalle no disponible', 'No se encontr√≥ la sesi√≥n solicitada.');
    return;
  }
  
  const modal = document.getElementById('sessionDetailModal');
  if (!modal) return;
  
  const busesRaw = row.buses;
  let busEntries = [];
  if (Array.isArray(busesRaw)) {
    busEntries = busesRaw;
  } else if (typeof busesRaw === 'string') {
    try {
      busEntries = JSON.parse(busesRaw) || [];
    } catch (error) {
      busEntries = [];
    }
  }
  
  const evaluation = getSessionEvaluation(row);
  const inspectorChip = document.getElementById('sessionDetailInspector');
  const terminalChip = document.getElementById('sessionDetailTerminal');
  const rangeChip = document.getElementById('sessionDetailRange');
  const busesChip = document.getElementById('sessionDetailBuses');
  const ticketsChip = document.getElementById('sessionDetailTickets');
  const evaluationText = document.getElementById('sessionDetailEvaluation');
  const tableBody = document.querySelector('#sessionDetailTable tbody');
  const findingsList = document.getElementById('sessionDetailFindings');
  
  if (inspectorChip) inspectorChip.innerHTML = `<i class="fas fa-user-check"></i><span>${escapeHTML(row.inspector || '‚Äî')}</span>`;
  if (terminalChip) terminalChip.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${escapeHTML(row.terminal || '‚Äî')}`;
  const dateRangeText = `${formatDateTime(row.started_at)} ‚Äî ${row.ended_at ? formatDateTime(row.ended_at) : 'En curso'}`;
  if (rangeChip) rangeChip.innerHTML = `<i class="fas fa-clock"></i> ${dateRangeText}`;
  if (busesChip) busesChip.innerHTML = `<i class="fas fa-bus"></i> ${Number(row.bus_count || 0)} buses`;
  if (ticketsChip) ticketsChip.innerHTML = `<i class="fas fa-ticket-alt"></i> ${Number(row.ticket_count || 0)} tickets`;
  if (evaluationText) evaluationText.textContent = evaluation.note;
  evaluationText?.classList.remove('text-success', 'text-primary', 'text-warning', 'text-danger', 'text-info', 'fw-bold', 'fw-medium');
  evaluationText?.classList.add(...evaluation.className.split(' '));
  
  if (tableBody) {
    if (busEntries.length > 0) {
      tableBody.innerHTML = busEntries.map((bus, indexBus) => {
        const ticketEntries = Array.isArray(bus.tickets)
          ? bus.tickets.filter(ticket => ticket && typeof ticket === 'object')
          : [];
        const ticketCount = ticketEntries.length > 0
          ? ticketEntries.length
          : Math.max(Number(bus.ticket_count) || 0, 0);
        return `<tr>
          <td>${indexBus + 1}</td>
          <td>${escapeHTML(bus.bus_ppu || '‚Äî')}</td>
          <td>${escapeHTML(bus.terminal || '‚Äî')}</td>
          <td>${formatDateTime(bus.fecha)}</td>
          <td>${escapeHTML(bus.estado || '‚Äî')}</td>
          <td>${ticketCount}</td>
        </tr>`;
      }).join('');
    } else {
      tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No se registraron buses en esta sesi√≥n.</td></tr>';
    }
  }
  
  if (findingsList) {
    const findings = [];
    busEntries.forEach(bus => {
      const ticketEntries = Array.isArray(bus.tickets)
        ? bus.tickets.filter(ticket => ticket && typeof ticket === 'object')
        : [];
      const totalTickets = ticketEntries.length > 0
        ? ticketEntries.length
        : Math.max(Number(bus.ticket_count) || 0, 0);
      
      ticketEntries.forEach(ticket => {
        findings.push(`<li><strong>${escapeHTML(bus.bus_ppu || 'Bus')}</strong> ‚Äî ${escapeHTML(ticket.componente || 'Componente')} ¬∑ ${escapeHTML(ticket.descripcion || ticket.descripcion_falla || 'Hallazgo')}</li>`);
      });
      
      if (ticketEntries.length === 0 && totalTickets > 0) {
        const label = totalTickets === 1 ? 'ticket' : 'tickets';
        findings.push(`<li><strong>${escapeHTML(bus.bus_ppu || 'Bus')}</strong> ‚Äî ${totalTickets} ${label} registrados (detalle no disponible)</li>`);
      }
    });
    
    findingsList.innerHTML = findings.length > 0
      ? findings.join('')
      : '<li>No se generaron tickets durante esta sesi√≥n.</li>';
  }
  
  showModal(modal);
}

/**
 * Refreshes the Mobileye report table
 * @param {Object} filters - Filter criteria
 */
async function refreshMobileyeReport(filters = {}) {
  try {
    const loaderId = showLoader('Cargando informe de Mobileye...');
    
    let mobileyeQuery = supabase
      .from('revision_semanal_movileye_inspeccion')
      .select(`
        *,
        inspeccion:revision_semanal_inspecciones!inner(
          bus_id,
          semana_iso,
          terminal,
          bus:revision_semanal_buses!inner(
            ppu,
            asignacion,
            modelo_chasis,
            marca,
            anio,
            terminal
          )
        )
      `)
      .eq('inspeccion.semana_iso', APP_STATE.session.week);
    
    if (filters.terminal) {
      mobileyeQuery = mobileyeQuery.eq('inspeccion.terminal', filters.terminal);
    }
    
    if (filters.mobileyeStatus) {
      mobileyeQuery = mobileyeQuery.eq('estado', filters.mobileyeStatus);
    }
    
    const { data: mobileyeRows, error: mobileyeError } = await mobileyeQuery;
    
    if (mobileyeError) throw mobileyeError;
    
    // Update count displays
    const mobileyeReportCount = document.getElementById('mobileyeReportCount');
    const mobiCount = document.getElementById('mobiCount');
    
    let rows = mobileyeRows || [];
    
    if (filters.make) {
      const desired = filters.make.toLowerCase();
      rows = rows.filter(row => (row.inspeccion?.bus?.marca || '').toLowerCase() === desired);
    } else {
      rows = rows.filter(row => (row.inspeccion?.bus?.marca || '').toUpperCase() === 'VOLVO');
    }
    if (mobileyeReportCount) mobileyeReportCount.textContent = rows.length.toString();
    if (mobiCount) mobiCount.textContent = rows.length.toString();
    
    // Update table
    const mobileyeTableBody = document.querySelector('#mobileyeTable tbody');
    
    if (mobileyeTableBody) {
      if (rows.length > 0) {
        mobileyeTableBody.innerHTML = rows.map((row) => {
          const bus = row.inspeccion?.bus || {};
          const incidentDate = row.fecha_siniestro ? 
            new Date(row.fecha_siniestro).toLocaleDateString('es-ES') : '';
          
          // Apply status highlight classes
          const statusValue = (row.estado || '').toLowerCase();
          const statusClass = statusValue === 'da√±ado' || statusValue === 'no tiene' ? 
            'text-danger fw-bold' : '';
          
          return `<tr>
            <td>${escapeHTML(bus.ppu || '')}</td>
            <td>${escapeHTML(row.modelo || bus.modelo_chasis || '')}</td>
            <td>${escapeHTML(bus.marca || row.marca || '')}</td>
            <td>${escapeHTML(bus.anio || row.anio || '')}</td>
            <td>${escapeHTML(bus.terminal || row.terminal || '')}</td>
            <td class="${statusClass}">${escapeHTML(row.estado || '')}</td>
            <td>${escapeHTML(row.alerta_izq || '')}</td>
            <td>${escapeHTML(row.alerta_der || '')}</td>
            <td>${escapeHTML(row.consola || '')}</td>
            <td>${escapeHTML(row.sensor_frontal || '')}</td>
            <td>${escapeHTML(row.sensor_izq || '')}</td>
            <td>${escapeHTML(row.sensor_der || '')}</td>
            <td>${escapeHTML(row.sensor_traser_izq_art || '')}</td>
            <td>${escapeHTML(row.sensor_traser_der_art || '')}</td>
            <td>${escapeHTML(incidentDate)}</td>
            <td>${escapeHTML(row.nro_siniestro || '')}</td>
          </tr>`;
        }).join('');
      } else {
        mobileyeTableBody.innerHTML = '<tr><td colspan="16" class="text-center">No hay datos disponibles</td></tr>';
      }
    }
    
    clearTimeout(loaderId);
    hideLoader();
  } catch (error) {
    hideLoader();
    console.error('Error refreshing Mobileye report:', error);
    showNotification('error', 'Error', 'No se pudo cargar el informe de Mobileye');
  }
}

/**
 * Refreshes the odometer report table
 * @param {Object} filters - Filter criteria
 */
async function refreshOdometerReport(filters = {}) {
  try {
    const loaderId = showLoader('Cargando informe de od√≥metro...');
    
    let odometerQuery = supabase
      .from('revision_semanal_odometro_inspeccion')
      .select(`
        *,
        inspeccion:revision_semanal_inspecciones!inner(
          bus_id,
          semana_iso,
          terminal,
          bus:revision_semanal_buses!inner(
            ppu,
            asignacion,
            modelo_chasis,
            marca,
            anio,
            terminal
          )
        )
      `)
      .eq('inspeccion.semana_iso', APP_STATE.session.week);
    
    if (filters.terminal) {
      odometerQuery = odometerQuery.eq('inspeccion.terminal', filters.terminal);
    }
    
    if (filters.odometerStatus) {
      odometerQuery = odometerQuery.eq('estado_odometro', filters.odometerStatus);
    }
    
    const { data: odometerRows, error: odometerError } = await odometerQuery;
    
    if (odometerError) throw odometerError;
    
    // Update count displays
    const odometerReportCount = document.getElementById('odometerReportCount');
    const odoCount = document.getElementById('odoCount');
    
    const rows = odometerRows || [];
    if (odometerReportCount) odometerReportCount.textContent = rows.length.toString();
    if (odoCount) odoCount.textContent = rows.length.toString();
    
    // Update table
    const odometerTableBody = document.querySelector('#odometerTable tbody');
    
    if (odometerTableBody) {
      if (rows.length > 0) {
        odometerTableBody.innerHTML = rows.map((row, index) => {
          const bus = row.inspeccion?.bus || {};
          
          // Apply status highlight classes
          const statusClass = row.estado_odometro === 'da√±ado' || row.estado_odometro === 'no funciona' ? 
            'text-danger fw-bold' : '';
          
          return `<tr>
            <td>${index + 1}</td>
            <td>${escapeHTML(bus.ppu || '')}</td>
            <td>${escapeHTML(bus.terminal || '')}</td>
            <td>${escapeHTML(bus.asignacion || '')}</td>
            <td>${escapeHTML(bus.modelo_chasis || '')}</td>
            <td>${escapeHTML(bus.marca || '')}</td>
            <td>${escapeHTML(bus.anio || '')}</td>
            <td>${
              row.lectura_km !== null && row.lectura_km !== undefined && row.lectura_km !== '' && !Number.isNaN(Number(row.lectura_km))
                ? Number(row.lectura_km).toLocaleString('es-ES')
                : '‚Äî'
            }</td>
            <td class="${statusClass}">${escapeHTML(row.estado_odometro || '')}</td>
            <td>${escapeHTML(row.observacion || '')}</td>
          </tr>`;
        }).join('');
      } else {
        odometerTableBody.innerHTML = '<tr><td colspan="10" class="text-center">No hay datos disponibles</td></tr>';
      }
    }
    
    clearTimeout(loaderId);
    hideLoader();
  } catch (error) {
    hideLoader();
    console.error('Error refreshing odometer report:', error);
    showNotification('error', 'Error', 'No se pudo cargar el informe de od√≥metro');
  }
}


/**
 * Refreshes the advertising report table
 * @param {Object} filters - Filter criteria
 */
async function refreshAdvertisingReport(filters = {}) {
  const activeFilters = Object.keys(filters || {}).length > 0
    ? filters
    : (APP_STATE.filters.advertising || {});
  
  const loaderId = showLoader('Cargando informe de publicidad...');
  
  try {
    let advertisingQuery = supabase
      .from('revision_semanal_publicidad_inspeccion')
      .select(`
        *,
        inspeccion:revision_semanal_inspecciones!inner(
          bus_id,
          semana_iso,
          terminal,
          bus:revision_semanal_buses!inner(
            ppu,
            asignacion,
            modelo_chasis,
            marca,
            anio,
            terminal
          )
        )
      `)
      .eq('inspeccion.semana_iso', APP_STATE.session.week);
    
    if (activeFilters.terminal) {
      advertisingQuery = advertisingQuery.eq('inspeccion.terminal', activeFilters.terminal);
    }
    
    const { data: advertisingRows, error } = await advertisingQuery;
    if (error) throw error;
    
    const entryRows = [];
    const sides = [
      { key: 'izquierda', label: 'Izquierda' },
      { key: 'derecha', label: 'Derecha' },
      { key: 'luneta', label: 'Luneta' }
    ];
    
    (advertisingRows || []).forEach(row => {
      const bus = row.inspeccion?.bus || {};
      const terminal = row.inspeccion?.terminal || bus.terminal || '';
      sides.forEach(side => {
        const estado = row[`publicidad_${side.key}_estado`] || 'NO TIENE';
        const detalle = row[`publicidad_${side.key}_detalle`] || '';
        const danio = row[`publicidad_${side.key}_danio`] || 'NO';
        const danioDetalle = row[`publicidad_${side.key}_danio_detalle`] || '';
        const residuos = row[`publicidad_${side.key}_residuos`] || 'NO';
        
        entryRows.push({
          ppu: bus.ppu || '‚Äî',
          terminal,
          side: side.label,
          state: estado,
          detail: detalle,
          damage: danio,
          damageDetail: danioDetalle,
          residue: residuos
        });
      });
    });
    
    let filteredRows = entryRows.slice();
    
    if (activeFilters.side) {
      filteredRows = filteredRows.filter(row => row.side === activeFilters.side);
    }
    
    if (activeFilters.issue) {
      filteredRows = filteredRows.filter(row => {
        if (activeFilters.issue === 'con-dano') return row.damage === 'SI';
        if (activeFilters.issue === 'con-residuos') return row.residue === 'SI';
        if (activeFilters.issue === 'sin-issues') return row.damage !== 'SI' && row.residue !== 'SI';
        return true;
      });
    }
    
    const groupedRows = [];
    const groupMap = new Map();
    
    filteredRows.forEach(row => {
      const key = `${(row.ppu || '').toUpperCase()}|${(row.terminal || '').toUpperCase()}`;
      if (!groupMap.has(key)) {
        groupMap.set(key, {
          ppu: row.ppu,
          terminal: row.terminal,
          izquierda: { state: 'NO TIENE', detail: '', damage: 'NO', damageDetail: '', residue: 'NO' },
          derecha: { state: 'NO TIENE', detail: '', damage: 'NO', damageDetail: '', residue: 'NO' },
          luneta: { state: 'NO TIENE', detail: '', damage: 'NO', damageDetail: '', residue: 'NO' }
        });
      }
      
      const group = groupMap.get(key);
      const sideKey = row.side.toLowerCase();
      if (group[sideKey]) {
        group[sideKey] = {
          state: row.state || 'NO TIENE',
          detail: row.detail || '',
          damage: row.damage || 'NO',
          damageDetail: row.damageDetail || '',
          residue: row.residue || 'NO'
        };
      }
    });
    
    groupMap.forEach(value => groupedRows.push(value));
    
    groupedRows.sort((a, b) => {
      const ppuA = (a.ppu || '').toUpperCase();
      const ppuB = (b.ppu || '').toUpperCase();
      if (ppuA !== ppuB) return ppuA.localeCompare(ppuB);
      return (a.terminal || '').localeCompare(b.terminal || '');
    });
    
    const totalCount = groupedRows.length;
    
    const reportCount = document.getElementById('advertisingReportCount');
    const badgeCount = document.getElementById('advertisingCount');
    
    if (reportCount) reportCount.textContent = totalCount.toString();
    if (badgeCount) badgeCount.textContent = totalCount.toString();
    
    const tableBody = document.querySelector('#advertisingTable tbody');
    
    if (tableBody) {
      if (groupedRows.length > 0) {
        tableBody.innerHTML = groupedRows.map((row, index) => {
          const buildCell = (section) => {
            const { state, detail, damage, damageDetail, residue } = row[section];
            const damageText = damage === 'SI' ? 'S√≠' : 'No';
            const residueText = residue === 'SI' ? 'S√≠' : 'No';
            const notes = [
              detail ? `Publicidad: ${detail}` : '',
              damage === 'SI' && damageDetail ? `Da√±o: ${damageDetail}` : ''
            ].filter(Boolean).join(' ¬∑ ') || '‚Äî';
            
            const damageClass = damage === 'SI' ? 'text-danger fw-bold' : '';
            const residueClass = residue === 'SI' ? 'text-warning fw-medium' : '';
            
            return `
              <td>${escapeHTML(state || 'NO TIENE')}</td>
              <td>${escapeHTML(detail || '‚Äî')}</td>
              <td class="${damageClass}">${damageText}</td>
              <td class="${residueClass}">${residueText}</td>
              <td>${escapeHTML(notes)}</td>
            `;
          };
          
          return `<tr>
            <td>${index + 1}</td>
            <td>${escapeHTML(row.ppu || '‚Äî')}</td>
            <td>${escapeHTML(row.terminal || '‚Äî')}</td>
            ${buildCell('izquierda')}
            ${buildCell('derecha')}
            ${buildCell('luneta')}
          </tr>`;
        }).join('');
      } else {
        tableBody.innerHTML = '<tr><td colspan="17" class="text-center">No hay datos disponibles para los filtros seleccionados.</td></tr>';
      }
    }
  } catch (error) {
    console.error('Error refreshing advertising report:', error);
    let errorMessage = 'No se pudo cargar el informe de publicidad';
    if (error?.code === '42P01') {
      errorMessage = 'La tabla "revision_semanal_publicidad_inspeccion" no existe. Crea la tabla para habilitar el informe de publicidad.';
    } else if (error?.code === '42501') {
      errorMessage = 'Permisos insuficientes para leer "revision_semanal_publicidad_inspeccion". Revisa las pol√≠ticas de seguridad.';
    } else if (error?.message) {
      errorMessage = `${errorMessage}. Detalle: ${error.message}`;
    }
    showNotification('error', 'Error', errorMessage);
    
    const reportCount = document.getElementById('advertisingReportCount');
    const badgeCount = document.getElementById('advertisingCount');
    if (reportCount) reportCount.textContent = '0';
    if (badgeCount) badgeCount.textContent = '0';
    
    const tableBody = document.querySelector('#advertisingTable tbody');
    if (tableBody) {
      tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">${escapeHTML(errorMessage)}</td></tr>`;
    }
  } finally {
    clearTimeout(loaderId);
    hideLoader();
  }
}

// ===================== DASHBOARD DATA =====================
/**
 * Refreshes dashboard data and visualizations
 */
async function refreshDashboardData() {
  try {
    const loaderId = showLoader('Cargando dashboard...');
    
    // Get filter values
    const terminalSelect = document.getElementById('dashboardTerminalFilter');
    const selectedTerminal = terminalSelect ? terminalSelect.value : '';
    const terminal = selectedTerminal || null;
    
    // 1. Get fleet count
    let fleetQuery = supabase
      .from('revision_semanal_buses')
      .select('id', { count: 'exact', head: true });
    
    if (terminal) {
      fleetQuery = fleetQuery.eq('terminal', terminal);
    }
    
    const { count: fleetCount, error: fleetError } = await fleetQuery;
    if (fleetError) throw fleetError;
    const totalFleet = fleetCount || 0;
    
    // 2. Get inspection data for current week
    let inspectionQuery = supabase
      .from('revision_semanal_inspecciones')
      .select('id, bus_id, terminal, estado_global', { count: 'exact' })
      .eq('semana_iso', APP_STATE.session.week);
    
    if (terminal) {
      inspectionQuery = inspectionQuery.eq('terminal', terminal);
    }
    
    const { 
      data: inspectionData, 
      count: totalInspections = 0, 
      error: inspectionError 
    } = await inspectionQuery;
    
    if (inspectionError) throw inspectionError;
    
    // Calculate completion percentage
    const completionPercentage = totalFleet > 0 ? 
      Math.round((totalInspections / totalFleet) * 100) : 0;
    
    // Count issues based on estado_global
    let totalIssues = 0;
    let criticalIssues = 0;
    
    if (inspectionData && inspectionData.length > 0) {
      totalIssues = inspectionData.filter(i => i.estado_global !== 'OK').length;
      criticalIssues = inspectionData.filter(i => i.estado_global === 'Cr√≠tico').length;
    }
    
    // 3. Get maintenance ticket data
    let ticketsQuery = supabase
      .from('revision_semanal_tickets_mantencion')
      .select('id, estado, terminal', { count: 'exact' });
    
    if (terminal) {
      ticketsQuery = ticketsQuery.eq('terminal', terminal);
    }
    
    const { 
      data: ticketsData, 
      count: totalTickets = 0, 
      error: ticketsError 
    } = await ticketsQuery;
    
    if (ticketsError) throw ticketsError;
    
    // Count open tickets
    const openTickets = ticketsData ? 
      ticketsData.filter(t => t.estado === 'open').length : 0;
    
    // 4. Update dashboard KPIs
    const operationalCount = Math.max(totalFleet - totalIssues, 0);
    
    const dashboardElements = {
      totalFleetCount: document.getElementById('totalFleetCount'),
      operationalCount: document.getElementById('operationalCount'),
      inspectionCount: document.getElementById('inspectionCount'),
      inspectionPercentage: document.getElementById('inspectionPercentage'),
      issuesCount: document.getElementById('issuesCount'),
      criticalIssuesCount: document.getElementById('criticalIssuesCount'),
      ticketsCount: document.getElementById('ticketsCount'),
      openTicketsCount: document.getElementById('openTicketsCount')
    };
    
    if (dashboardElements.totalFleetCount) dashboardElements.totalFleetCount.textContent = totalFleet;
    if (dashboardElements.operationalCount) dashboardElements.operationalCount.textContent = operationalCount;
    if (dashboardElements.inspectionCount) dashboardElements.inspectionCount.textContent = totalInspections;
    if (dashboardElements.inspectionPercentage) dashboardElements.inspectionPercentage.textContent = `${completionPercentage}%`;
    if (dashboardElements.issuesCount) dashboardElements.issuesCount.textContent = totalIssues;
    if (dashboardElements.criticalIssuesCount) dashboardElements.criticalIssuesCount.textContent = criticalIssues;
    if (dashboardElements.ticketsCount) dashboardElements.ticketsCount.textContent = totalTickets;
    if (dashboardElements.openTicketsCount) dashboardElements.openTicketsCount.textContent = openTickets;
    
    // 5. Load recent issues data
    let recentIssuesQuery = supabase
      .from('revision_semanal_tickets_mantencion')
      .select('id, bus_id, componente, descripcion_falla, estado, created_at, bus:revision_semanal_buses(ppu)');
    
    if (terminal) {
      recentIssuesQuery = recentIssuesQuery.eq('terminal', terminal);
    }
    
    const { 
      data: recentIssues, 
      error: recentIssuesError 
    } = await recentIssuesQuery
      .order('created_at', { ascending: false })
      .limit(5);
    
    if (recentIssuesError) throw recentIssuesError;
    
    // Update recent issues table
    const recentIssuesTable = document.getElementById('recentIssuesTable');
    
    if (recentIssuesTable) {
      if (recentIssues && recentIssues.length > 0) {
        recentIssuesTable.innerHTML = recentIssues.map(issue => {
          const date = new Date(issue.created_at).toLocaleDateString('es-ES');
          const statusMap = {
            'open': { class: 'text-warning', text: 'Abierto' },
            'in_progress': { class: 'text-primary', text: 'En Progreso' },
            'closed': { class: 'text-success', text: 'Cerrado' }
          };
          
          const status = statusMap[issue.estado] || { class: '', text: issue.estado };
          
          return `<tr>
            <td>${escapeHTML(issue.bus?.ppu || '‚Äî')}</td>
            <td>${escapeHTML(issue.componente || '‚Äî')}</td>
            <td class="text-truncate" style="max-width: 200px;">${
              escapeHTML(issue.descripcion_falla ? 
                issue.descripcion_falla.substring(0, 50) + (issue.descripcion_falla.length > 50 ? '...' : '') 
                : '‚Äî')
            }</td>
            <td><span class="${status.class} fw-bold">${status.text}</span></td>
            <td>${date}</td>
          </tr>`;
        }).join('');
      } else {
        recentIssuesTable.innerHTML = '<tr><td colspan="5" class="text-center">No hay problemas recientes</td></tr>';
      }
    }
    
    // 6. Load pending inspection buses
    // Create set of inspected bus IDs
    const inspectedBusIds = new Set((inspectionData || []).map(i => i.bus_id));
    
    let pendingBusesQuery = supabase
      .from('revision_semanal_buses')
      .select('id, ppu, numero_interno, terminal');
    
    if (terminal) {
      pendingBusesQuery = pendingBusesQuery.eq('terminal', terminal);
    }
    
    const { 
      data: pendingBuses, 
      error: pendingBusesError 
    } = await pendingBusesQuery.limit(5);
    
    if (pendingBusesError) throw pendingBusesError;
    
    // Update pending inspection table
    const pendingInspectionTable = document.getElementById('pendingInspectionTable');
    
    if (pendingInspectionTable) {
      if (pendingBuses && pendingBuses.length > 0) {
        const filteredPendingBuses = pendingBuses.filter(bus => !inspectedBusIds.has(bus.id));
        
        if (filteredPendingBuses.length > 0) {
          pendingInspectionTable.innerHTML = filteredPendingBuses.map(bus => `
            <tr>
              <td>${escapeHTML(bus.ppu || '‚Äî')}</td>
              <td>${escapeHTML(bus.numero_interno || '‚Äî')}</td>
              <td>${escapeHTML(bus.terminal || '‚Äî')}</td>
              <td><span class="chip chip-warning">Pendiente</span></td>
              <td>
                <button class="btn btn-primary btn-sm" data-action="inspect-bus" data-ppu="${bus.ppu}">
                  <i class="fas fa-clipboard-check"></i> Inspeccionar
                </button>
              </td>
            </tr>
          `).join('');
          
          // Add click listeners to inspection buttons
          pendingInspectionTable.querySelectorAll('button[data-action="inspect-bus"]').forEach(btn => {
            btn.addEventListener('click', async () => {
              const ppu = btn.dataset.ppu;
              
              try {
                const loaderId = showLoader('Cargando bus...');
                
                const { data, error } = await supabase
                  .from('revision_semanal_buses')
                  .select('*')
                  .eq('ppu', ppu)
                  .maybeSingle();
                
                clearTimeout(loaderId);
                hideLoader();
                
                if (error) throw error;
                
                if (data) {
                  selectBus(data);
                  showSection('inspection-form');
                } else {
                  throw new Error('Bus no encontrado');
                }
              } catch (error) {
                console.error('Error selecting bus:', error);
                showNotification('error', 'Error', 'No se pudo cargar datos del bus');
              }
            });
          });
        } else {
          pendingInspectionTable.innerHTML = '<tr><td colspan="5" class="text-center">Todos los buses han sido inspeccionados</td></tr>';
        }
      } else {
        pendingInspectionTable.innerHTML = '<tr><td colspan="5" class="text-center">No se encontraron buses</td></tr>';
      }
    }
    
    // 7. Load recent activity
    loadRecentActivity();
    
    // 8. Create or update inspection by terminal chart
    await updateTerminalChart();
    
    clearTimeout(loaderId);
    hideLoader();
  } catch (error) {
    hideLoader();
    console.error('Error refreshing dashboard:', error);
    showNotification('error', 'Error', 'No se pudo cargar los datos del dashboard');
  }
}

/**
 * Updates the terminal inspection chart
 */
async function updateTerminalChart() {
  // Check if Chart.js is available and the canvas element exists
  if (window.Chart && document.getElementById('inspectionByTerminalChart')) {
    try {
      const { data: busRows, error: busError } = await supabase
        .from('revision_semanal_buses')
        .select('id, terminal');
      if (busError) throw busError;
      
      const totalByTerminal = new Map();
      const busTerminalMap = new Map();
      (busRows || []).forEach(bus => {
        const terminal = bus.terminal || 'Sin Terminal';
        totalByTerminal.set(terminal, (totalByTerminal.get(terminal) || 0) + 1);
        busTerminalMap.set(bus.id, terminal);
      });

      // Ensure configured terminals are present even if zero buses currently assigned
      (APP_CONFIG.terminals || []).forEach(term => {
        if (term && !totalByTerminal.has(term)) {
          totalByTerminal.set(term, 0);
        }
      });
      
      const { data: inspectionRows, error: inspError } = await supabase
        .from('revision_semanal_inspecciones')
        .select('bus_id, terminal')
        .eq('semana_iso', APP_STATE.session.week);
      if (inspError) throw inspError;
      
      const inspectedByTerminal = new Map();
      (inspectionRows || []).forEach(row => {
        const busId = row.bus_id;
        const terminal = row.terminal || busTerminalMap.get(busId) || 'Sin Terminal';
        if (!inspectedByTerminal.has(terminal)) {
          inspectedByTerminal.set(terminal, new Set());
        }
        inspectedByTerminal.get(terminal).add(busId);
      });
      
      const terminalLabels = Array.from(totalByTerminal.keys()).sort();
      const terminalData = terminalLabels.map(terminal => {
        const total = totalByTerminal.get(terminal) || 0;
        const inspectedSet = inspectedByTerminal.get(terminal) || new Set();
        const inspectedCount = inspectedSet.size;
        const pendingCount = Math.max(total - inspectedCount, 0);
        return {
          terminal,
          total,
          inspected: inspectedCount,
          pending: pendingCount
        };
      });
      
      if (terminalData.length === 0) {
        const canvas = document.getElementById('inspectionByTerminalChart');
        const ctx = canvas && typeof canvas.getContext === 'function' ? canvas.getContext('2d') : null;
        if (ctx) {
          ctx.clearRect(0, 0, canvas.width || 0, canvas.height || 0);
        }
        if (APP_STATE.charts.terminalChart) {
          APP_STATE.charts.terminalChart.destroy();
        }
        APP_STATE.charts.terminalChart = null;
        return;
      }
      
      // If chart already exists, destroy it first
      if (APP_STATE.charts.terminalChart) {
        APP_STATE.charts.terminalChart.destroy();
      }
      
      const canvas = document.getElementById('inspectionByTerminalChart');
      if (!canvas || typeof canvas.getContext !== 'function') {
        return;
      }
      const ctx = canvas.getContext('2d');
      
      // Create new chart
      APP_STATE.charts.terminalChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: terminalData.map(t => t.terminal),
          datasets: [
            {
              label: 'Inspeccionados',
              data: terminalData.map(t => t.inspected),
              backgroundColor: '#3b82f6',
              borderColor: '#2563eb',
              borderWidth: 1
            },
            {
              label: 'Pendientes',
              data: terminalData.map(t => t.pending),
              backgroundColor: '#f59e0b',
              borderColor: '#d97706',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 15,
                padding: 15,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(15, 23, 42, 0.8)',
              titleFont: {
                size: 14,
                weight: 'bold'
              },
              bodyFont: {
                size: 13
              },
              padding: 12,
              cornerRadius: 8,
              displayColors: true,
              boxWidth: 10,
              boxHeight: 10,
              boxPadding: 3
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: {
                display: false
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    } catch (error) {
      console.error('Error creating terminal chart:', error);
    }
  } else {
    console.log('Chart.js or canvas element not available');
  }
}

// ===================== RECENT ACTIVITY =====================
/**
 * Loads the recent activity list
 */
function loadRecentActivity() {
  const activityList = document.getElementById('activityList');
  if (!activityList) return;
  
  try {
    // Retrieve recent activity from localStorage
    const activity = JSON.parse(localStorage.getItem(APP_CONFIG.storageKeys.recentActivity) || '[]');
    
    if (activity.length === 0) {
      activityList.innerHTML = '<div class="text-center p-4">No hay actividad reciente para mostrar.</div>';
      return;
    }
    
    // Sort by most recent first
    activity.sort((a, b) => b.timestamp - a.timestamp);
    
    // Limit to 10 most recent items
    const recentActivity = activity.slice(0, 10);
    
    // Generate HTML for each activity item
    activityList.innerHTML = recentActivity.map(item => {
      // Determine icon class and type
      let iconClass = 'primary';
      let icon = 'fa-clipboard-check';
      
      if (item.type === 'inspection') {
        icon = 'fa-clipboard-check';
        iconClass = item.status === 'OK' ? 'success' : 
                   item.status === 'Cr√≠tico' ? 'danger' : 'warning';
      } else if (item.type === 'ticket') {
        icon = 'fa-ticket-alt';
        iconClass = item.priority === 'critical' ? 'danger' : 
                   item.priority === 'high' ? 'warning' : 'primary';
      } else if (item.type === 'login') {
        icon = 'fa-user';
      } else if (item.type === 'logout') {
        icon = 'fa-sign-out-alt';
      }
      
      // Format date and time
      const date = new Date(item.timestamp);
      const timeStr = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
      const dateStr = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
      
      // Generate title and details
      let title = '';
      let details = '';
      
      switch (item.type) {
        case 'inspection':
          title = `Inspecci√≥n ${item.action === 'create' ? 'creada' : 'actualizada'}: ${item.ppu}`;
          details = `Estado: ${item.status}`;
          break;
        case 'ticket':
          title = `Ticket ${item.action === 'create' ? 'creado' : item.action === 'update' ? 'actualizado' : 'eliminado'}: ${item.component}`;
          details = `Bus: ${item.ppu} - Prioridad: ${
            item.priority === 'low' ? 'Baja' : 
            item.priority === 'medium' ? 'Media' : 
            item.priority === 'high' ? 'Alta' : 
            'Cr√≠tica'
          }`;
          break;
        case 'login':
          title = `Sesi√≥n iniciada: ${item.inspector}`;
          details = `Terminal: ${item.terminal}`;
          break;
        case 'logout':
          title = `Sesi√≥n cerrada: ${item.inspector}`;
          details = `Terminal: ${item.terminal}`;
          break;
        default:
          title = `Actividad: ${item.type}`;
          details = `Detalles no disponibles`;
      }
      
      return `
        <div class="activity-item">
          <div class="activity-icon ${iconClass}">
            <i class="fas ${icon}"></i>
          </div>
          <div class="activity-content">
            <div class="activity-title">${escapeHTML(title)}</div>
            <div class="activity-details">${escapeHTML(details)}</div>
          </div>
          <div class="activity-time">${timeStr}<br>${dateStr}</div>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Error loading recent activity:', error);
    activityList.innerHTML = '<div class="text-center p-4 text-danger">Error cargando actividad reciente.</div>';
  }
}

/**
 * Logs an activity
 * @param {Object} activity - Activity data object
 */
function logActivity(activity) {
  if (!activity || !activity.type) return;
  
  try {
    // Get existing activity
    const existingActivity = JSON.parse(localStorage.getItem(APP_CONFIG.storageKeys.recentActivity) || '[]');
    
    // Add new activity with timestamp
    const newActivity = {
      ...activity,
      timestamp: Date.now()
    };
    
    // Add to beginning of array
    existingActivity.unshift(newActivity);
    
    // Limit to max items
    if (existingActivity.length > APP_CONFIG.maxActivityItems) {
      existingActivity.length = APP_CONFIG.maxActivityItems;
    }
    
    // Save to localStorage
    localStorage.setItem(APP_CONFIG.storageKeys.recentActivity, JSON.stringify(existingActivity));
    
    // Update activity list if visible
    const activityList = document.getElementById('activityList');
    const dashboardSection = document.getElementById('section-dashboard');
    
    if (activityList && dashboardSection && !dashboardSection.classList.contains('hidden')) {
      loadRecentActivity();
    }
  } catch (error) {
    console.error('Error logging activity:', error);
  }
}

// ===================== MAINTENANCE TICKETS =====================
/**
 * Loads maintenance tickets with optional filters
 * @param {Object} filters - Filter criteria
 */
async function loadMaintenanceTickets(filters = {}) {
  try {
    const loaderId = showLoader('Cargando tickets de mantenimiento...');
    
    // Get filter values
    const statusFilter = document.getElementById('ticketStatusFilter')?.value || filters.status || '';
    
    // Base query
    let query = supabase
      .from('revision_semanal_tickets_mantencion')
      .select(`
        id, 
        bus_id, 
        origen, 
        componente, 
        descripcion_falla, 
        prioridad, 
        estado, 
        resolucion,
        created_at, 
        updated_at, 
        bus:revision_semanal_buses(ppu, terminal)
      `)
      .order('created_at', { ascending: false });
    
    // Apply filters
    if (APP_STATE.session.terminal && !filters.terminal) {
      query = query.eq('terminal', APP_STATE.session.terminal);
    } else if (filters.terminal) {
      query = query.eq('terminal', filters.terminal);
    }
    
    if (statusFilter) {
      query = query.eq('estado', statusFilter);
    }
    
    if (filters.component) {
      if (filters.component === 'Publicidad') {
        query = query.ilike('componente', 'Publicidad%');
      } else {
        query = query.eq('componente', filters.component);
      }
    }
    
    if (filters.priority) {
      query = query.eq('prioridad', filters.priority);
    }
    
    if (filters.dateFrom) {
      query = query.gte('created_at', filters.dateFrom);
    }
    
    // Execute query
    const { data: tickets, error } = await query;
    
    clearTimeout(loaderId);
    hideLoader();
    
    if (error) throw error;
    
    // Update tickets table
    const ticketsTable = document.getElementById('ticketsTable')?.querySelector('tbody');
    
    if (ticketsTable) {
      if (tickets && tickets.length > 0) {
        ticketsTable.innerHTML = tickets.map((ticket, index) => {
          const createdDate = new Date(ticket.created_at).toLocaleDateString('es-ES');
          
          // Map priority values to display text and CSS classes
          const priorityMap = {
            'low': { text: 'Baja', class: 'text-success' },
            'medium': { text: 'Media', class: 'text-primary' },
            'high': { text: 'Alta', class: 'text-warning' },
            'critical': { text: 'Cr√≠tica', class: 'text-danger' }
          };
          
          const priority = priorityMap[ticket.prioridad] || { text: ticket.prioridad, class: '' };
          
          // Map status values to display text and CSS classes
          const statusMap = {
            'open': { text: 'Abierto', dot: 'status-dot-warning' },
            'in_progress': { text: 'En Progreso', dot: 'status-dot-primary' },
            'closed': { text: 'Cerrado', dot: 'status-dot-success' }
          };
          
          const status = statusMap[ticket.estado] || { text: ticket.estado, dot: '' };
          
          return `<tr>
            <td>${index + 1}</td>
            <td>${escapeHTML(ticket.bus?.ppu || '‚Äî')}</td>
            <td>${escapeHTML(ticket.bus?.terminal || '‚Äî')}</td>
            <td>${escapeHTML(ticket.componente || '‚Äî')}</td>
            <td class="text-truncate" style="max-width: 300px;">${escapeHTML(ticket.descripcion_falla || '‚Äî')}</td>
            <td class="${priority.class} fw-bold">${priority.text}</td>
            <td><div class="table-status"><span class="${status.dot}"></span> ${status.text}</div></td>
            <td>${createdDate}</td>
            <td>
              <button class="btn btn-icon btn-light btn-sm" data-action="edit-ticket" data-ticket="${ticket.id}" aria-label="Editar ticket">
                <i class="fas fa-edit"></i>
              </button>
            </td>
          </tr>`;
        }).join('');
        
        // Add click handlers for edit buttons
        ticketsTable.querySelectorAll('button[data-action="edit-ticket"]').forEach(btn => {
          btn.addEventListener('click', () => {
            const ticketId = btn.dataset.ticket;
            openTicketDetails(ticketId);
          });
        });
      } else {
        ticketsTable.innerHTML = '<tr><td colspan="9" class="text-center">No se encontraron tickets</td></tr>';
      }
    }
    
    return tickets;
  } catch (error) {
    hideLoader();
    console.error('Error loading maintenance tickets:', error);
    showNotification('error', 'Error', 'No se pudieron cargar los tickets de mantenimiento');
    return null;
  }
}

/**
 * Opens ticket details in a modal
 * @param {string|number} ticketId - Ticket ID
 */
async function openTicketDetails(ticketId) {
  if (!ticketId) return;
  
  try {
    const loaderId = showLoader('Cargando detalles del ticket...');
    
    // Query ticket data
    const { data: ticket, error } = await supabase
      .from('revision_semanal_tickets_mantencion')
      .select('*, bus:revision_semanal_buses(ppu)')
      .eq('id', ticketId)
      .maybeSingle();
    
    clearTimeout(loaderId);
    hideLoader();
    
    if (error) throw error;
    
    if (!ticket) {
      showNotification('error', 'No Encontrado', 'No se encontr√≥ el ticket solicitado');
      return;
    }
    
    // Format ticket date
    const ticketDate = new Date(ticket.created_at).toLocaleDateString('es-ES', APP_CONFIG.dateFormat.medium);
    
    // Get modal elements
    const modal = document.getElementById('ticketDetailsModal');
    if (!modal) return;
    
    const modalElements = {
      ticketId: document.getElementById('ticketIdDisplay'),
      ticketDate: document.getElementById('ticketDateDisplay'),
      busPPU: document.getElementById('ticketBusPPU'),
      component: document.getElementById('ticketComponent'),
      description: document.getElementById('ticketDescription'),
      priority: document.getElementById('ticketPriority'),
      status: document.getElementById('ticketStatus'),
      resolution: document.getElementById('ticketResolution'),
    };
    
    // Update modal fields
    if (modalElements.ticketId) modalElements.ticketId.textContent = ticket.id;
    if (modalElements.ticketDate) modalElements.ticketDate.textContent = ticketDate;
    if (modalElements.busPPU) modalElements.busPPU.value = ticket.bus?.ppu || '';
    if (modalElements.component) modalElements.component.value = ticket.componente || '';
    if (modalElements.description) modalElements.description.value = ticket.descripcion_falla || '';
    if (modalElements.priority) modalElements.priority.value = ticket.prioridad || 'medium';
    if (modalElements.status) modalElements.status.value = ticket.estado || 'open';
    if (modalElements.resolution) modalElements.resolution.value = ticket.resolucion || '';
    
    // Store ticket ID in modal dataset
    modal.dataset.ticketId = ticketId;
    
    // Show modal
    showModal(modal);
  } catch (error) {
    hideLoader();
    console.error('Error opening ticket details:', error);
    showNotification('error', 'Error', 'No se pudieron cargar los detalles del ticket');
  }
}

/**
 * Updates a ticket
 * @param {string|number} ticketId - Ticket ID
 * @param {Object} updateData - Data to update
 */
async function updateTicket(ticketId, updateData) {
  if (!ticketId) {
    showNotification('error', 'Error', 'ID del ticket no encontrado');
    return false;
  }
  
  try {
    const loaderId = showLoader('Actualizando ticket...');
    
    const { data, error } = await supabase
      .from('revision_semanal_tickets_mantencion')
      .update({
        ...updateData,
        updated_at: new Date().toISOString()
      })
      .eq('id', ticketId)
      .select()
      .single();
    
    clearTimeout(loaderId);
    hideLoader();
    
    if (error) throw error;
    
    showNotification('success', 'Actualizado', 'Ticket actualizado correctamente');
    
    // Hide modal
    const ticketDetailsModal = document.getElementById('ticketDetailsModal');
    if (ticketDetailsModal) {
      hideModal(ticketDetailsModal);
    }
    
    // Refresh tickets list
    loadMaintenanceTickets();
    
    return true;
  } catch (error) {
    hideLoader();
    console.error('Error updating ticket:', error);
    showNotification('error', 'Error', 'No se pudo actualizar el ticket');
    return false;
  }
}

/**
 * Deletes a ticket
 * @param {string|number} ticketId - Ticket ID
 */
async function deleteTicket(ticketId) {
  if (!ticketId) {
    showNotification('error', 'Error', 'ID del ticket no encontrado');
    return false;
  }
  
  if (confirm('¬øEst√° seguro de que desea eliminar este ticket?')) {
    try {
      // Get ticket data for activity log
      const ticketDetailsModal = document.getElementById('ticketDetailsModal');
      const modalElements = {
        component: document.getElementById('ticketComponent'),
        busPPU: document.getElementById('ticketBusPPU'),
        priority: document.getElementById('ticketPriority')
      };
      
      const component = modalElements.component?.value || '';
      const ppu = modalElements.busPPU?.value || '';
      const priority = modalElements.priority?.value || '';
      
      const loaderId = showLoader('Eliminando ticket...');
      
      // Delete the ticket
      const { error } = await supabase
        .from('revision_semanal_tickets_mantencion')
        .delete()
        .eq('id', ticketId);
      
      clearTimeout(loaderId);
      hideLoader();
      
      if (error) throw error;
      
      // Log activity
      logActivity({
        type: 'ticket',
        action: 'delete',
        component,
        ppu,
        priority
      });
      
      showNotification('success', 'Eliminado', 'Ticket eliminado correctamente');
      
      // Hide modal
      if (ticketDetailsModal) {
        hideModal(ticketDetailsModal);
      }
      
      // Refresh tickets list
      loadMaintenanceTickets();
      
      return true;
    } catch (error) {
      hideLoader();
      console.error('Error deleting ticket:', error);
      showNotification('error', 'Error', 'No se pudo eliminar el ticket');
      return false;
    }
  }
  
  return false;
}

/**
 * Creates a new ticket
 * @param {Object} ticketData - Ticket data
 */
async function createTicket(ticketData) {
  if (!ticketData || !ticketData.bus_id || !ticketData.terminal || !ticketData.componente || !ticketData.descripcion_falla) {
    showNotification('error', 'Datos Incompletos', 'Por favor, complete todos los campos requeridos');
    return false;
  }
  
  try {
    const loaderId = showLoader('Creando ticket...');
    
    const {
      bus_id,
      terminal,
      componente,
      descripcion_falla,
      prioridad,
      estado,
      origen,
      ppu
    } = ticketData;
    
    const payload = {
      bus_id,
      terminal,
      componente,
      descripcion_falla,
      prioridad,
      estado: estado || 'open',
      origen: origen || 'manual',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    
    // Create the ticket
    const { data, error } = await supabase
      .from('revision_semanal_tickets_mantencion')
      .insert(payload)
      .select()
      .single();
    
    clearTimeout(loaderId);
    hideLoader();
    
    if (error) throw error;
    
    // Log activity
    logActivity({
      type: 'ticket',
      action: 'create',
      component: componente,
      ppu: ppu || '',
      priority: prioridad
    });
    
    showNotification('success', 'Ticket Creado', 'Ticket de mantenimiento creado correctamente');
    
    // Hide modal
    const newTicketModal = document.getElementById('newTicketModal');
    if (newTicketModal) {
      hideModal(newTicketModal);
    }
    
    // Refresh tickets list
    loadMaintenanceTickets();
    
    return true;
  } catch (error) {
    hideLoader();
    console.error('Error creating ticket:', error);
    showNotification('error', 'Error', 'No se pudo crear el ticket');
    return false;
  }
}

// ===================== FLEET STATUS =====================
/**
 * Loads fleet status data with optional filters
 * @param {Object} filters - Filter criteria
 */
async function loadFleetStatus(filters = {}) {
  try {
    const loaderId = showLoader('Cargando estado de flota...');
    
    // Get filter values
    const terminalFilterValue = document.getElementById('fleetTerminalFilter')?.value || filters.terminal || '';
    const terminalFilter = terminalFilterValue.trim() === '' ? null : terminalFilterValue.trim();
    
    // Query all buses
    let busQuery = supabase
      .from('revision_semanal_buses')
      .select('*');
    
    if (terminalFilter) {
      busQuery = busQuery.eq('terminal', terminalFilter);
    }
    
    // Apply make filter
    if (filters.make) {
      busQuery = busQuery.ilike('marca', `%${filters.make}%`);
    }
    
    // Apply year filter
    if (filters.year) {
      busQuery = busQuery.eq('anio', filters.year);
    }
    
    // Execute query
    const { data: buses, error: busError } = await busQuery;
    
    if (busError) throw busError;
    
    const busIds = (buses || []).map(bus => bus.id);
    const inspectionMap = new Map();
    const inspectionIds = [];
    const odometerByInspection = new Map();
    const latestOdometerByBus = new Map();
    
    if (busIds.length > 0) {
      // Fetch latest inspection per bus
      let inspectionQuery = supabase
        .from('revision_semanal_inspecciones')
        .select('id, bus_id, estado_global, fecha_inspeccion, terminal')
        .in('bus_id', busIds)
        .order('fecha_inspeccion', { ascending: false });
      
      const { data: inspectionRows, error: inspError } = await inspectionQuery;
      if (inspError) throw inspError;
      
      if (inspectionRows) {
        inspectionRows.forEach(row => {
          inspectionIds.push(row.id);
          if (!inspectionMap.has(row.bus_id)) {
            inspectionMap.set(row.bus_id, row);
          }
        });
      }
      
      if (inspectionIds.length > 0) {
        const { data: odometerRows, error: odoError } = await supabase
          .from('revision_semanal_odometro_inspeccion')
          .select('inspeccion_id, lectura_km, estado_odometro')
          .in('inspeccion_id', inspectionIds);
        
        if (odoError) throw odoError;
        
        if (odometerRows) {
          odometerRows.forEach(row => {
            odometerByInspection.set(row.inspeccion_id, row);
          });
          // Determine latest odometer per bus using inspection order
          inspectionRows.forEach(row => {
            const odometer = odometerByInspection.get(row.id);
            if (odometer && !latestOdometerByBus.has(row.bus_id)) {
              latestOdometerByBus.set(row.bus_id, odometer);
            }
          });
        }
      }
    }
    
    // Get maintenance tickets
    let ticketCountMap = new Map();
    if (busIds.length > 0) {
      let ticketQuery = supabase
        .from('revision_semanal_tickets_mantencion')
        .select('bus_id, estado')
        .neq('estado', 'closed')
        .in('bus_id', busIds);
      
      if (terminalFilter) {
        ticketQuery = ticketQuery.eq('terminal', terminalFilter);
      }
      
      const { data: tickets, error: ticketsError } = await ticketQuery;
      if (ticketsError) throw ticketsError;
      
      ticketCountMap = new Map();
      if (tickets) {
        tickets.forEach(ticket => {
          const busId = ticket.bus_id;
          if (!ticketCountMap.has(busId)) {
            ticketCountMap.set(busId, 0);
          }
          ticketCountMap.set(busId, ticketCountMap.get(busId) + 1);
        });
      }
    }
    
    clearTimeout(loaderId);
    hideLoader();
    
    // Calculate fleet statistics
    const totalBuses = buses ? buses.length : 0;
    let operationalCount = 0;
    let maintenanceCount = 0;
    let criticalCount = 0;
    
    // Process each bus to determine its status
    if (buses) {
      buses.forEach(bus => {
        const inspection = inspectionMap.get(bus.id);
        if (!inspection) {
          maintenanceCount++;
          return;
        }
        const estado = (inspection.estado_global || '').toLowerCase();
        if (estado === 'ok' || estado === 'operativo') {
          operationalCount++;
        } else if (estado === 'cr√≠tico' || estado === 'critico') {
          criticalCount++;
        } else {
          maintenanceCount++;
        }
      });
    }
    
    // Update fleet statistics display
    const statElements = {
      fleetTotalCount: document.getElementById('fleetTotalCount'),
      fleetOperationalCount: document.getElementById('fleetOperationalCount'),
      fleetMaintenanceCount: document.getElementById('fleetMaintenanceCount'),
      fleetCriticalCount: document.getElementById('fleetCriticalCount')
    };
    
    if (statElements.fleetTotalCount) statElements.fleetTotalCount.textContent = totalBuses;
    if (statElements.fleetOperationalCount) statElements.fleetOperationalCount.textContent = operationalCount;
    if (statElements.fleetMaintenanceCount) statElements.fleetMaintenanceCount.textContent = maintenanceCount;
    if (statElements.fleetCriticalCount) statElements.fleetCriticalCount.textContent = criticalCount;
    
    // Populate year filter dropdown if not already populated
    const yearFilter = document.getElementById('fleetYearFilter');
    if (yearFilter && yearFilter.options.length <= 1 && buses) {
      // Extract unique years
      const years = new Set();
      buses.forEach(bus => {
        if (bus.anio) {
          years.add(bus.anio.toString());
        }
      });
      
      // Sort years in descending order
      const sortedYears = Array.from(years).sort().reverse();
      
      // Add year options
      sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
      });
    }
    
    // Filter buses by status if needed
    let displayBuses = [...(buses || [])];
    
    if (filters.status) {
      displayBuses = displayBuses.filter(bus => {
        const inspection = inspectionMap.get(bus.id);
        const estado = inspection ? (inspection.estado_global || '').toLowerCase() : '';
        if (filters.status === 'Operational') {
          return inspection && (estado === 'ok' || estado === 'operativo');
        }
        if (filters.status === 'Maintenance') {
          if (!inspection) return true;
          return estado !== 'ok' && estado !== 'operativo' && estado !== 'cr√≠tico' && estado !== 'critico';
        }
        if (filters.status === 'Critical') {
          return inspection && (estado === 'cr√≠tico' || estado === 'critico');
        }
        return true;
      });
    }
    
    // Update fleet status table
    const fleetTable = document.querySelector('#fleetStatusTable tbody');
    
    if (fleetTable) {
      if (displayBuses.length > 0) {
        fleetTable.innerHTML = displayBuses.map(bus => {
          const inspection = inspectionMap.get(bus.id);
          const inspectionDate = inspection ? 
            new Date(inspection.fecha_inspeccion).toLocaleDateString('es-ES') : 
            '‚Äî';
          
          // Determine bus status
          let status = 'Operativo';
          let statusClass = 'text-success';
          
          if (inspection) {
            const estado = (inspection.estado_global || '').toLowerCase();
            if (estado === 'cr√≠tico' || estado === 'critico') {
              status = 'Problemas Cr√≠ticos';
              statusClass = 'text-danger';
            } else if (estado === 'ok' || estado === 'operativo') {
              status = 'Operativo';
              statusClass = 'text-success';
            } else {
              status = 'Mantenimiento Necesario';
              statusClass = 'text-warning';
            }
          } else {
            status = 'Sin Inspecci√≥n';
            statusClass = 'text-info';
          }
          
          // Get odometer reading
          let odometerReading = '‚Äî';
          let odometerState = '';
          if (inspection) {
      const odometer = odometerByInspection.get(inspection.id);
      if (odometer && odometer.lectura_km !== null && odometer.lectura_km !== undefined) {
        const lecturaValue = Number(odometer.lectura_km);
        if (!Number.isNaN(lecturaValue)) {
          odometerReading = `${lecturaValue.toLocaleString('es-ES')} km`;
        }
              if (odometer.estado_odometro) {
                odometerState = odometer.estado_odometro;
              }
            }
          }
          if (odometerReading === '‚Äî') {
            const fallback = latestOdometerByBus.get(bus.id);
            if (fallback && fallback.lectura_km !== null && fallback.lectura_km !== undefined) {
              const lecturaValue = Number(fallback.lectura_km);
              if (!Number.isNaN(lecturaValue)) {
                odometerReading = `${lecturaValue.toLocaleString('es-ES')} km`;
              }
              if (fallback.estado_odometro) {
                odometerState = fallback.estado_odometro;
              }
            }
          }
          if (odometerReading !== '‚Äî' && odometerState) {
            odometerReading = `${odometerReading} ¬∑ ${escapeHTML(odometerState)}`;
          }
          
          // Get open ticket count
          const openTickets = ticketCountMap.get(bus.id) || 0;
          
          const makeModel = [bus.marca, bus.modelo_chasis].filter(Boolean).join(' ').trim();
          return `<tr>
            <td>${escapeHTML(bus.ppu || '‚Äî')}</td>
            <td>${escapeHTML(bus.numero_interno || '‚Äî')}</td>
            <td>${escapeHTML(makeModel || '‚Äî')}</td>
            <td>${escapeHTML(bus.anio || '‚Äî')}</td>
            <td>${escapeHTML(bus.terminal || '‚Äî')}</td>
            <td>${inspectionDate}</td>
            <td class="${statusClass} fw-bold">${status}</td>
            <td>${odometerReading}</td>
            <td>${
              openTickets > 0 ? 
              `<span class="badge badge-warning">${openTickets}</span>` : 
              '0'
            }</td>
            <td>
              <button class="btn btn-sm btn-primary" data-action="inspect-fleet-bus" data-ppu="${bus.ppu}">
                <i class="fas fa-clipboard-check"></i> Inspeccionar
              </button>
            </td>
          </tr>`;
        }).join('');
        
        // Add click handlers for inspection buttons
        fleetTable.querySelectorAll('button[data-action="inspect-fleet-bus"]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const ppu = btn.dataset.ppu;
            
            try {
              const loaderId = showLoader('Cargando bus...');
              
              const { data, error } = await supabase
                .from('revision_semanal_buses')
                .select('*')
                .eq('ppu', ppu)
                .maybeSingle();
              
              clearTimeout(loaderId);
              hideLoader();
              
              if (error) throw error;
              
              if (data) {
                selectBus(data);
                showSection('inspection-form');
              } else {
                throw new Error('Bus no encontrado');
              }
            } catch (error) {
              console.error('Error selecting bus:', error);
              showNotification('error', 'Error', 'No se pudo cargar datos del bus');
            }
          });
        });
      } else {
        fleetTable.innerHTML = '<tr><td colspan="10" class="text-center">No se encontraron buses</td></tr>';
      }
    }
    
    return displayBuses;
  } catch (error) {
    hideLoader();
    console.error('Error loading fleet status:', error);
    showNotification('error', 'Error', 'No se pudo cargar datos de la flota');
    return null;
  }
}

// ===================== USER SETTINGS =====================
/**
 * Loads user settings from localStorage
 */
function loadUserSettings() {
  try {
    // Get current session data
    const settingsElements = {
      name: document.getElementById('settingsName'),
      terminal: document.getElementById('settingsTerminal'),
      themeLight: document.getElementById('themeLight'),
      themeDark: document.getElementById('themeDark'),
      themeSystem: document.getElementById('themeSystem'),
      notifTickets: document.getElementById('notifTickets'),
      notifInspections: document.getElementById('notifInspections'),
      notifCritical: document.getElementById('notifCritical'),
      defaultView: document.getElementById('settingsDefaultView')
    };
    
    // Set current inspector name and terminal
    if (settingsElements.name) settingsElements.name.value = APP_STATE.session.inspector || '';
    if (settingsElements.terminal) settingsElements.terminal.value = APP_STATE.session.terminal || '';
    
    // Load theme preference
    const theme = localStorage.getItem(APP_CONFIG.storageKeys.theme) || 'light';
    const themeRadio = document.querySelector(`input[name="theme"][value="${theme}"]`);
    if (themeRadio) themeRadio.checked = true;
    
    // Load notification preferences
    if (settingsElements.notifTickets) {
      settingsElements.notifTickets.checked = localStorage.getItem('notifTickets') !== 'false';
    }
    
    if (settingsElements.notifInspections) {
      settingsElements.notifInspections.checked = localStorage.getItem('notifInspections') !== 'false';
    }
    
    if (settingsElements.notifCritical) {
      settingsElements.notifCritical.checked = localStorage.getItem('notifCritical') !== 'false';
    }
    
    // Load default view preference
    if (settingsElements.defaultView) {
      settingsElements.defaultView.value = localStorage.getItem('defaultView') || 'inspection-form';
    }
  } catch (error) {
    console.error('Error loading user settings:', error);
    showNotification('error', 'Error', 'No se pudieron cargar las preferencias de usuario');
  }
}

/**
 * Saves user settings to localStorage
 */
function saveUserSettings() {
  try {
    const settingsElements = {
      name: document.getElementById('settingsName'),
      terminal: document.getElementById('settingsTerminal'),
      defaultView: document.getElementById('settingsDefaultView'),
      notifTickets: document.getElementById('notifTickets'),
      notifInspections: document.getElementById('notifInspections'),
      notifCritical: document.getElementById('notifCritical')
    };
    
    // Save name and terminal
    const name = settingsElements.name?.value || '';
    const terminal = settingsElements.terminal?.value || '';
    
    if (name && terminal) {
      APP_STATE.session.inspector = name;
      APP_STATE.session.terminal = terminal;
      
      // Update header display
      const userInfo = document.getElementById('userInfo');
      if (userInfo) userInfo.textContent = `${name} ¬∑ ${terminal}`;
      
      // Save to localStorage
      localStorage.setItem(APP_CONFIG.storageKeys.session, JSON.stringify({
        inspector: name,
        terminal: terminal
      }));
    }
    
    // Save theme preference
    const themeRadio = document.querySelector('input[name="theme"]:checked');
    if (themeRadio) {
      const theme = themeRadio.value;
      localStorage.setItem(APP_CONFIG.storageKeys.theme, theme);
      APP_STATE.session.theme = theme;
      applyTheme(theme);
    }
    
    // Save notification preferences
    if (settingsElements.notifTickets) {
      localStorage.setItem('notifTickets', settingsElements.notifTickets.checked);
    }
    
    if (settingsElements.notifInspections) {
      localStorage.setItem('notifInspections', settingsElements.notifInspections.checked);
    }
    
    if (settingsElements.notifCritical) {
      localStorage.setItem('notifCritical', settingsElements.notifCritical.checked);
    }
    
    // Save default view
    if (settingsElements.defaultView) {
      localStorage.setItem('defaultView', settingsElements.defaultView.value);
    }
    
    // Show success notification
    showNotification('success', 'Preferencias Guardadas', 'Tus preferencias han sido guardadas correctamente');
    
    // Refresh data based on new settings
    refreshPendingInspections();
    refreshReportTables();
    
    return true;
  } catch (error) {
    console.error('Error saving user settings:', error);
    showNotification('error', 'Error', 'No se pudieron guardar las preferencias');
    return false;
  }
}

/**
 * Resets user settings to defaults
 */
function resetUserSettings() {
  if (confirm('¬øEst√° seguro de que desea restablecer todas las preferencias?')) {
    try {
      // Reset form elements
      const settingsElements = {
        name: document.getElementById('settingsName'),
        terminal: document.getElementById('settingsTerminal'),
        themeSystem: document.getElementById('themeSystem'),
        notifTickets: document.getElementById('notifTickets'),
        notifInspections: document.getElementById('notifInspections'),
        notifCritical: document.getElementById('notifCritical'),
        defaultView: document.getElementById('settingsDefaultView')
      };
      
      if (settingsElements.name) settingsElements.name.value = '';
      if (settingsElements.terminal) settingsElements.terminal.value = '';
      if (settingsElements.themeSystem) settingsElements.themeSystem.checked = true;
      if (settingsElements.notifTickets) settingsElements.notifTickets.checked = true;
      if (settingsElements.notifInspections) settingsElements.notifInspections.checked = true;
      if (settingsElements.notifCritical) settingsElements.notifCritical.checked = true;
      if (settingsElements.defaultView) settingsElements.defaultView.value = 'inspection-form';
      
      // Clear localStorage settings
      localStorage.removeItem(APP_CONFIG.storageKeys.session);
      localStorage.removeItem(APP_CONFIG.storageKeys.theme);
      localStorage.removeItem('notifTickets');
      localStorage.removeItem('notifInspections');
      localStorage.removeItem('notifCritical');
      localStorage.removeItem('defaultView');
      
      // Reset application state
      APP_STATE.session.inspector = '';
      APP_STATE.session.terminal = '';
      APP_STATE.session.theme = 'system';
      
      // Update UI
      const userInfo = document.getElementById('userInfo');
      if (userInfo) userInfo.textContent = '‚Äî';
      
      applyTheme('system');
      
      showNotification('success', 'Preferencias Restablecidas', 'Todas las preferencias han sido restablecidas a valores predeterminados');
      
      return true;
    } catch (error) {
      console.error('Error resetting user settings:', error);
      showNotification('error', 'Error', 'No se pudieron restablecer las preferencias');
      return false;
    }
  }
  
  return false;
}

// ===================== FILTER SETUP =====================
/**
 * Sets up all filter handlers
 */
function setupFilters() {
  // Cameras report filters
  document.getElementById('applyCamerasFilters')?.addEventListener('click', () => {
    const filters = {
      terminal: document.getElementById('camerasTerminalFilter')?.value || '',
      make: document.getElementById('camerasMakeFilter')?.value || '',
      monitor: document.getElementById('camerasMonitorFilter')?.value || ''
    };
    
    APP_STATE.filters.cameras = filters;
    refreshCamerasReport(filters);
  });
  
  document.getElementById('resetCamerasFilters')?.addEventListener('click', () => {
    const filterElements = {
      terminal: document.getElementById('camerasTerminalFilter'),
      make: document.getElementById('camerasMakeFilter'),
      monitor: document.getElementById('camerasMonitorFilter')
    };
    
    if (filterElements.terminal) filterElements.terminal.value = '';
    if (filterElements.make) filterElements.make.value = '';
    if (filterElements.monitor) filterElements.monitor.value = '';
    
    APP_STATE.filters.cameras = {};
    refreshCamerasReport();
  });
  
  // TAG report filters
  document.getElementById('applyTagFilters')?.addEventListener('click', () => {
    const filters = {
      terminal: document.getElementById('tagTerminalFilter')?.value || '',
      tagStatus: document.getElementById('tagStatusFilter')?.value || ''
    };
    
    APP_STATE.filters.tag = filters;
    refreshTagReport(filters);
  });
  
  document.getElementById('resetTagFilters')?.addEventListener('click', () => {
    const filterElements = {
      terminal: document.getElementById('tagTerminalFilter'),
      tagStatus: document.getElementById('tagStatusFilter')
    };
    
    if (filterElements.terminal) filterElements.terminal.value = '';
    if (filterElements.tagStatus) filterElements.tagStatus.value = '';
    
    APP_STATE.filters.tag = {};
    refreshTagReport();
  });
  
  // Extinguisher report filters
  document.getElementById('applyExtinguisherFilters')?.addEventListener('click', () => {
    const filters = {
      terminal: document.getElementById('extinguisherTerminalFilter')?.value || '',
      extinguisherStatus: document.getElementById('extinguisherStatusFilter')?.value || '',
      certificationStatus: document.getElementById('extinguisherCertificationFilter')?.value || '',
      pressureStatus: document.getElementById('extinguisherPressureFilter')?.value || '',
      holderStatus: document.getElementById('extinguisherHolderFilter')?.value || ''
    };
    
    APP_STATE.filters.extinguishers = filters;
    refreshExtinguisherReport(filters);
  });
  
  document.getElementById('resetExtinguisherFilters')?.addEventListener('click', () => {
    const filterElements = {
      terminal: document.getElementById('extinguisherTerminalFilter'),
      extinguisherStatus: document.getElementById('extinguisherStatusFilter'),
      certificationStatus: document.getElementById('extinguisherCertificationFilter'),
      pressureStatus: document.getElementById('extinguisherPressureFilter'),
      holderStatus: document.getElementById('extinguisherHolderFilter')
    };
    
    if (filterElements.terminal) filterElements.terminal.value = '';
    if (filterElements.extinguisherStatus) filterElements.extinguisherStatus.value = '';
    if (filterElements.certificationStatus) filterElements.certificationStatus.value = '';
    if (filterElements.pressureStatus) filterElements.pressureStatus.value = '';
    if (filterElements.holderStatus) filterElements.holderStatus.value = '';
    
    APP_STATE.filters.extinguishers = {};
    refreshExtinguisherReport();
  });
  
  // Session report filters
  document.getElementById('btnApplySessionFilters')?.addEventListener('click', () => {
    const filters = {
      terminal: document.getElementById('sessionTerminalFilter')?.value || '',
      dateFrom: document.getElementById('sessionDateFrom')?.value || '',
      dateTo: document.getElementById('sessionDateTo')?.value || ''
    };
    
    APP_STATE.filters.sessions = filters;
    refreshSessionReport(filters);
  });
  
  document.getElementById('btnResetSessionFilters')?.addEventListener('click', () => {
    const elements = {
      terminal: document.getElementById('sessionTerminalFilter'),
      dateFrom: document.getElementById('sessionDateFrom'),
      dateTo: document.getElementById('sessionDateTo')
    };
    
    if (elements.terminal) elements.terminal.value = '';
    if (elements.dateFrom) elements.dateFrom.value = '';
    if (elements.dateTo) elements.dateTo.value = '';
    
    APP_STATE.filters.sessions = {};
    refreshSessionReport();
  });
  
  // Mobileye report filters
  document.getElementById('applyMobileyeFilters')?.addEventListener('click', () => {
    const filters = {
      terminal: document.getElementById('mobileyeTerminalFilter')?.value || '',
      mobileyeStatus: document.getElementById('mobileyeStatusFilter')?.value || ''
    };
    
    APP_STATE.filters.mobileye = filters;
    refreshMobileyeReport(filters);
  });
  
  document.getElementById('resetMobileyeFilters')?.addEventListener('click', () => {
    const filterElements = {
      terminal: document.getElementById('mobileyeTerminalFilter'),
      mobileyeStatus: document.getElementById('mobileyeStatusFilter')
    };
    
    if (filterElements.terminal) filterElements.terminal.value = '';
    if (filterElements.mobileyeStatus) filterElements.mobileyeStatus.value = '';
    
    APP_STATE.filters.mobileye = {};
    refreshMobileyeReport();
  });
  
  // Advertising report filters
  document.getElementById('applyAdvertisingFilters')?.addEventListener('click', () => {
    const filters = {
      terminal: document.getElementById('advertisingTerminalFilter')?.value || '',
      side: document.getElementById('advertisingSideFilter')?.value || '',
      issue: document.getElementById('advertisingIssueFilter')?.value || ''
    };
    
    APP_STATE.filters.advertising = filters;
    refreshAdvertisingReport(filters);
  });
  
  document.getElementById('resetAdvertisingFilters')?.addEventListener('click', () => {
    const filterElements = {
      terminal: document.getElementById('advertisingTerminalFilter'),
      side: document.getElementById('advertisingSideFilter'),
      issue: document.getElementById('advertisingIssueFilter')
    };
    
    if (filterElements.terminal) filterElements.terminal.value = '';
    if (filterElements.side) filterElements.side.value = '';
    if (filterElements.issue) filterElements.issue.value = '';
    
    APP_STATE.filters.advertising = {};
    refreshAdvertisingReport({});
  });
  
  // Odometer report filters
  document.getElementById('applyOdometerFilters')?.addEventListener('click', () => {
    const filters = {
      terminal: document.getElementById('odometerTerminalFilter')?.value || '',
      odometerStatus: document.getElementById('odometerStatusFilter')?.value || ''
    };
    
    APP_STATE.filters.odometer = filters;
    refreshOdometerReport(filters);
  });
  
  document.getElementById('resetOdometerFilters')?.addEventListener('click', () => {
    const filterElements = {
      terminal: document.getElementById('odometerTerminalFilter'),
      odometerStatus: document.getElementById('odometerStatusFilter')
    };
    
    if (filterElements.terminal) filterElements.terminal.value = '';
    if (filterElements.odometerStatus) filterElements.odometerStatus.value = '';
    
    APP_STATE.filters.odometer = {};
    refreshOdometerReport();
  });
  
  // Maintenance tickets filters
  document.getElementById('applyTicketsFilters')?.addEventListener('click', () => {
    const filters = {
      status: document.getElementById('ticketStatusFilter')?.value || '',
      terminal: document.getElementById('ticketsTerminalFilter')?.value || '',
      component: document.getElementById('ticketsComponentFilter')?.value || '',
      priority: document.getElementById('ticketsPriorityFilter')?.value || '',
      dateFrom: document.getElementById('ticketsDateFrom')?.value || ''
    };
    
    APP_STATE.filters.tickets = filters;
    loadMaintenanceTickets(filters);
  });
  
  document.getElementById('resetTicketsFilters')?.addEventListener('click', () => {
    const filterElements = {
      status: document.getElementById('ticketStatusFilter'),
      terminal: document.getElementById('ticketsTerminalFilter'),
      component: document.getElementById('ticketsComponentFilter'),
      priority: document.getElementById('ticketsPriorityFilter'),
      dateFrom: document.getElementById('ticketsDateFrom')
    };
    
    if (filterElements.status) filterElements.status.value = '';
    if (filterElements.terminal) filterElements.terminal.value = '';
    if (filterElements.component) filterElements.component.value = '';
    if (filterElements.priority) filterElements.priority.value = '';
    if (filterElements.dateFrom) filterElements.dateFrom.value = '';
    
    APP_STATE.filters.tickets = {};
    loadMaintenanceTickets();
  });
  
  // Fleet status filters
  document.getElementById('applyFleetFilters')?.addEventListener('click', () => {
    const filters = {
      terminal: document.getElementById('fleetTerminalFilter')?.value || '',
      make: document.getElementById('fleetMakeFilter')?.value || '',
      status: document.getElementById('fleetStatusFilter')?.value || '',
      year: document.getElementById('fleetYearFilter')?.value || ''
    };
    
    APP_STATE.filters.fleet = filters;
    loadFleetStatus(filters);
  });
  
  document.getElementById('resetFleetFilters')?.addEventListener('click', () => {
    const filterElements = {
      terminal: document.getElementById('fleetTerminalFilter'),
      make: document.getElementById('fleetMakeFilter'),
      status: document.getElementById('fleetStatusFilter'),
      year: document.getElementById('fleetYearFilter')
    };
    
    if (filterElements.terminal) filterElements.terminal.value = '';
    if (filterElements.make) filterElements.make.value = '';
    if (filterElements.status) filterElements.status.value = '';
    if (filterElements.year) filterElements.year.value = '';
    
    APP_STATE.filters.fleet = {};
    loadFleetStatus();
  });
  
  // Ticket status filter
  document.getElementById('ticketStatusFilter')?.addEventListener('change', () => {
    const status = document.getElementById('ticketStatusFilter').value;
    APP_STATE.filters.tickets.status = status;
    loadMaintenanceTickets(APP_STATE.filters.tickets);
  });
  
  // Fleet terminal filter
  document.getElementById('fleetTerminalFilter')?.addEventListener('change', () => {
    const terminal = document.getElementById('fleetTerminalFilter').value;
    APP_STATE.filters.fleet.terminal = terminal;
    loadFleetStatus(APP_STATE.filters.fleet);
  });
  
  // Dashboard terminal filter
  document.getElementById('dashboardTerminalFilter')?.addEventListener('change', () => {
    refreshDashboardData();
  });
  
  // Pending inspections filter
  document.getElementById('pendingFilterTerminal')?.addEventListener('change', () => {
    refreshPendingList();
  });
}

// ===================== INITIALIZATION & EVENT LISTENERS =====================
/**
 * Main initialization function
 */
function initializeApp() {
  if (APP_STATE.initialized) return;
  
  try {
    // 1. Initialize week selectors
    const weeks = getISOWeeksForSelect(12);
    
    const weekSelector = document.getElementById('weekSelector');
    const dashboardWeekSelector = document.getElementById('dashboardWeekSelector');
    
    if (weekSelector) {
      weekSelector.innerHTML = weeks.map(w => {
        const range = getWeekRange(w);
        return `<option value="${w}">${w} (${range})</option>`;
      }).join('');
      
      weekSelector.value = APP_STATE.session.week;
    }
    
    if (dashboardWeekSelector) {
      dashboardWeekSelector.innerHTML = weeks.map(w => {
        const range = getWeekRange(w);
        return `<option value="${w}">${w} (${range})</option>`;
      }).join('');
      
      dashboardWeekSelector.value = APP_STATE.session.week;
    }
    
    // Update week label
    const currentWeekLabel = document.getElementById('currentWeekLabel');
    if (currentWeekLabel) {
      currentWeekLabel.textContent = getWeekRange(APP_STATE.session.week);
    }
    
    // 2. Apply theme
    applyTheme(APP_STATE.session.theme);
    
    // 3. Load saved session
    const savedSession = localStorage.getItem(APP_CONFIG.storageKeys.session);
    if (savedSession) {
      try {
        const session = JSON.parse(savedSession);
        const normalizedInspector = normalizeInspectorName(session.inspector);
        const normalizedTerminal = (session.terminal || '').trim();
        APP_STATE.session.inspector = normalizedInspector;
        APP_STATE.session.terminal = normalizedTerminal;
        autoFillExtinguisherLocation(true);
        
        // Update UI
        const userInfo = document.getElementById('userInfo');
        if (userInfo) {
          userInfo.textContent = `${normalizedInspector} ¬∑ ${normalizedTerminal}`;
        }
        
        // Persist normalized values
        localStorage.setItem(APP_CONFIG.storageKeys.session, JSON.stringify({
          inspector: normalizedInspector,
          terminal: normalizedTerminal
        }));
        
        // Load initial data
        refreshPendingInspections();
        refreshReportTables();
        loadRecentActivity();
        ensureActiveSessionLog();
      } catch (error) {
        console.error('Error loading saved session:', error);
        openLoginModal();
      }
    } else {
      // No saved session, show login modal
      openLoginModal();
    }
    
    // 4. Set up collapsible sections
    const toggleSections = {
      'cameras': {
        toggle: document.getElementById('toggleCameras'),
        content: document.getElementById('camerasSection')
      },
      'tag': {
        toggle: document.getElementById('toggleTag'),
        content: document.getElementById('tagSection')
      },
      'mobileye': {
        toggle: document.getElementById('toggleMobileye'),
        content: document.getElementById('mobileyeContentSection')
      },
      'odometer': {
        toggle: document.getElementById('toggleOdometer'),
        content: document.getElementById('odometerSection')
      },
      'advertising': {
        toggle: document.getElementById('toggleAdvertising'),
        content: document.getElementById('advertisingSection')
      },
      'summary': {
        toggle: document.getElementById('toggleSummary'),
        content: document.getElementById('summarySection')
      }
    };
    
    Object.values(toggleSections).forEach(section => {
      setupToggleSection(section);
    });
    
    // 5. Set up help section toggles
    document.querySelectorAll('.toggle-section').forEach(section => {
      if (!Object.values(toggleSections).some(s => s.toggle === section)) {
        setupToggleSection({
          toggle: section,
          content: section.nextElementSibling
        });
      }
    });
    
    // 6. Setup navigation events
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        if (item.id === 'btnLogout') {
          handleLogout();
          return;
        }
        
        const section = item.dataset.section;
        if (section) {
          showSection(section);
        }
      });
    });
    
    // 7. Set up filters
    setupFilters();
    
    // 8. Setup search handlers
    setupSearchHandlers();
    
    // 9. Show last section visited or default
    const lastSection = localStorage.getItem(APP_CONFIG.storageKeys.lastSection) || 'inspection-form';
    showSection(lastSection);
    
    // Mark app as initialized
    APP_STATE.initialized = true;
  } catch (error) {
    console.error('Error initializing application:', error);
    showNotification('error', 'Error de Inicializaci√≥n', 'No se pudo inicializar la aplicaci√≥n correctamente');
  }
}

/**
 * Sets up search handlers for bus selection
 */
function setupSearchHandlers() {
  // PPU search handler
  document.getElementById('searchPPUForm')?.addEventListener('submit', event => {
    event.preventDefault();
    handlePPUSearch();
  });
  
  document.getElementById('btnSearchPPU')?.addEventListener('click', event => {
    event.preventDefault();
    handlePPUSearch();
  });
  
  document.getElementById('searchPPU')?.addEventListener('keyup', event => {
    if (event.key === 'Enter') {
      event.preventDefault();
      handlePPUSearch();
    }
  });
  
  // Internal number search handler
  document.getElementById('searchInternalForm')?.addEventListener('submit', event => {
    event.preventDefault();
    handleInternalSearch();
  });
  
  document.getElementById('btnSearchInternal')?.addEventListener('click', event => {
    event.preventDefault();
    handleInternalSearch();
  });
  
  document.getElementById('searchInternal')?.addEventListener('keyup', event => {
    if (event.key === 'Enter') {
      event.preventDefault();
      handleInternalSearch();
    }
  });
  
  // Global search handler
  document.getElementById('globalSearch')?.addEventListener('keyup', debounce(function(event) {
    if (event.key === 'Enter') {
      const searchTerm = this.value.trim();
      
      if (searchTerm) {
        const loaderId = showLoader('Buscando buses...');
        
        Promise.all([
          supabase.from('revision_semanal_buses').select('*').ilike('ppu', `%${searchTerm}%`).limit(1),
          supabase.from('revision_semanal_buses').select('*').ilike('numero_interno', `%${searchTerm}%`).limit(1)
        ]).then(([ppuResults, internalResults]) => {
          clearTimeout(loaderId);
          hideLoader();
          
          if (ppuResults.data && ppuResults.data.length > 0) {
            selectBus(ppuResults.data[0]);
            showSection('inspection-form');
          } else if (internalResults.data && internalResults.data.length > 0) {
            selectBus(internalResults.data[0]);
            showSection('inspection-form');
          } else {
            showNotification('warning', 'Bus No Encontrado', 'No se encontr√≥ ning√∫n bus con ese PPU o # interno');
          }
          
          // Clear search field
          this.value = '';
        }).catch(error => {
          clearTimeout(loaderId);
          hideLoader();
          
          console.error('Error en b√∫squeda global:', error);
          showNotification('error', 'Error', 'No se pudo completar la b√∫squeda');
        });
      }
    }
  }, 300));
}

/**
 * Handles PPU search
 */
async function handlePPUSearch() {
  const searchPPU = document.getElementById('searchPPU');
  if (!searchPPU) return;
  
  const rawValue = searchPPU.value.trim();
  
  if (!rawValue) {
    showNotification('warning', 'Advertencia', 'Por favor ingrese un PPU para buscar');
    return;
  }
  
  const normalizedValue = rawValue.toUpperCase().replace(/\s+/g, '');
  searchPPU.value = normalizedValue;
  
  await searchBus('ppu', normalizedValue, 'No se encontraron buses con ese PPU');
}

/**
 * Handles internal number search
 */
async function handleInternalSearch() {
  const searchInternal = document.getElementById('searchInternal');
  if (!searchInternal) return;
  
  const rawValue = searchInternal.value.trim();
  
  if (!rawValue) {
    showNotification('warning', 'Advertencia', 'Por favor ingrese un n√∫mero interno para buscar');
    return;
  }
  
  const normalizedValue = rawValue.replace(/\s+/g, '');
  searchInternal.value = normalizedValue;
  
  await searchBus('numero_interno', normalizedValue, 'No se encontraron buses con ese n√∫mero interno');
}

// ===================== EVENT LISTENERS =====================
// Set up event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // 1. Initialize the application
  initializeApp();
  
  // 2. Theme toggle
  document.getElementById('themeToggle')?.addEventListener('click', () => {
    const currentTheme = localStorage.getItem(APP_CONFIG.storageKeys.theme) || 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    
    localStorage.setItem(APP_CONFIG.storageKeys.theme, newTheme);
    APP_STATE.session.theme = newTheme;
    applyTheme(newTheme);
  });
  
  // 3. Week selector change events
  document.getElementById('weekSelector')?.addEventListener('change', () => {
    const selectedWeek = document.getElementById('weekSelector').value;
    updateWeekSelectors(selectedWeek);
  });
  
  document.getElementById('dashboardWeekSelector')?.addEventListener('change', () => {
    const selectedWeek = document.getElementById('dashboardWeekSelector').value;
    updateWeekSelectors(selectedWeek);
  });
  
  // 4. Week navigation events
  document.getElementById('prevWeekForm')?.addEventListener('click', () => {
    const weeks = getISOWeeksForSelect(12);
    const currentIndex = weeks.indexOf(APP_STATE.session.week);
    
    if (currentIndex < weeks.length - 1) {
      updateWeekSelectors(weeks[currentIndex + 1]);
    }
  });
  
  document.getElementById('nextWeekForm')?.addEventListener('click', () => {
    const weeks = getISOWeeksForSelect(12);
    const currentIndex = weeks.indexOf(APP_STATE.session.week);
    
    if (currentIndex > 0) {
      updateWeekSelectors(weeks[currentIndex - 1]);
    }
  });
  
  document.getElementById('prevWeekDash')?.addEventListener('click', () => {
    const weeks = getISOWeeksForSelect(12);
    const currentIndex = weeks.indexOf(APP_STATE.session.week);
    
    if (currentIndex < weeks.length - 1) {
      updateWeekSelectors(weeks[currentIndex + 1]);
    }
  });
  
  document.getElementById('nextWeekDash')?.addEventListener('click', () => {
    const weeks = getISOWeeksForSelect(12);
    const currentIndex = weeks.indexOf(APP_STATE.session.week);
    
    if (currentIndex > 0) {
      updateWeekSelectors(weeks[currentIndex - 1]);
    }
  });
  
  // 5. Login form submit
  document.getElementById('btnStartSession')?.addEventListener('click', () => {
    const name = document.getElementById('inspectorName')?.value.trim() || '';
    const terminal = document.getElementById('inspectorTerminal')?.value.trim() || '';
    
    startSession(name, terminal);
  });
  
  // 6. Show pending inspections
  document.getElementById('btnShowPending')?.addEventListener('click', () => {
    const pendingModal = document.getElementById('pendingModal');
    if (pendingModal) {
      showModal(pendingModal);
      
      // Reset terminal filter to show all by default
      const pendingFilterTerminal = document.getElementById('pendingFilterTerminal');
      if (pendingFilterTerminal) {
        pendingFilterTerminal.value = '';
      }
      
      // Refresh pending list
      refreshPendingList();
    }
  });
  
  // 7. Confirm bus status
  document.getElementById('btnConfirmBusStatus')?.addEventListener('click', () => {
    const status = document.getElementById('busPanneStatus')?.value || 'operational';
    const inspectionStatus = document.getElementById('inspectionStatus');
    
    if (inspectionStatus) {
      if (status === 'out_of_service') {
        inspectionStatus.innerHTML = `
          <i class="fas fa-exclamation-triangle"></i> 
          Bus fuera de servicio ‚Äî inspecci√≥n pendiente
        `;
        inspectionStatus.className = 'chip status-warning';
      } else {
        inspectionStatus.innerHTML = `<i class="fas fa-clock"></i> Sin inspecci√≥n a√∫n`;
        inspectionStatus.className = 'chip';
      }
    }
    
    // Hide modal
    const busStatusModal = document.getElementById('busStatusModal');
    if (busStatusModal) {
      hideModal(busStatusModal);
    }
    
    // Load inspection data
    if (APP_STATE.currentBus) {
      loadWeeklyInspection(APP_STATE.currentBus.id);
    }
  });
  
  // 8. Save inspection
  document.getElementById('btnSave')?.addEventListener('click', saveInspection);

  const fabButton = document.getElementById('fabAction');
  if (fabButton) {
    fabButton.addEventListener('click', () => {
      if (isMobileView()) {
        const pendingModal = document.getElementById('pendingModal');
        if (pendingModal) {
          showModal(pendingModal);
          refreshPendingList();
        }
      } else {
        saveInspection();
      }
    });
    updateFabAppearance();
    window.addEventListener('resize', debounce(updateFabAppearance, 150));
  }
  
  // 9. Handle ticket actions
  document.getElementById('btnUpdateTicket')?.addEventListener('click', () => {
    const ticketDetailsModal = document.getElementById('ticketDetailsModal');
    const ticketId = ticketDetailsModal?.dataset?.ticketId;
    
    if (ticketId) {
      const updateData = {
        prioridad: document.getElementById('ticketPriority')?.value || 'medium',
        estado: document.getElementById('ticketStatus')?.value || 'open',
        resolucion: document.getElementById('ticketResolution')?.value || null
      };
      
      updateTicket(ticketId, updateData);
      
      // Log activity
      logActivity({
        type: 'ticket',
        action: 'update',
        component: document.getElementById('ticketComponent')?.value || '',
        ppu: document.getElementById('ticketBusPPU')?.value || '',
        priority: updateData.prioridad
      });
    }
  });
  
  document.getElementById('btnDeleteTicket')?.addEventListener('click', () => {
    const ticketDetailsModal = document.getElementById('ticketDetailsModal');
    const ticketId = ticketDetailsModal?.dataset?.ticketId;
    
    if (ticketId) {
      deleteTicket(ticketId);
    }
  });
  
  // 10. New ticket
  document.getElementById('btnNewTicket')?.addEventListener('click', () => {
    const newTicketModal = document.getElementById('newTicketModal');
    if (newTicketModal) {
      // Reset form
      document.getElementById('newTicketPPU').value = '';
      document.getElementById('newTicketComponent').value = '';
      document.getElementById('newTicketDescription').value = '';
      document.getElementById('newTicketPriority').value = 'medium';
      document.getElementById('newTicketBusInfo').classList.add('hidden');
      document.getElementById('newTicketBusDisplay').textContent = '‚Äî';
      
      // Show modal
      showModal(newTicketModal);
    }
  });
  
  document.getElementById('btnSearchTicketBus')?.addEventListener('click', async () => {
    const ppu = document.getElementById('newTicketPPU')?.value.trim();
    if (!ppu) {
      showNotification('warning', 'Advertencia', 'Por favor, ingrese un PPU para buscar');
      return;
    }
    
    try {
      const loaderId = showLoader('Buscando bus...');
      
      const { data, error } = await supabase
        .from('revision_semanal_buses')
        .select('*')
        .ilike('ppu', `%${ppu}%`)
        .limit(1);
      
      clearTimeout(loaderId);
      hideLoader();
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        const bus = data[0];
        const busInfo = document.getElementById('newTicketBusInfo');
        const busDisplay = document.getElementById('newTicketBusDisplay');
        const ppuField = document.getElementById('newTicketPPU');
        
        if (busInfo) busInfo.classList.remove('hidden');
        
        if (busDisplay) {
          busDisplay.innerHTML = `
            <i class="fas fa-bus"></i>
            <span>${bus.ppu} | ${bus.marca || '‚Äî'} ${bus.modelo_chasis || '‚Äî'}</span>
          `;
        }
        
        if (ppuField) {
          ppuField.dataset.busId = bus.id;
          ppuField.dataset.terminal = bus.terminal;
        }
      } else {
        showNotification('error', 'No Encontrado', 'No se encontraron buses con ese PPU');
      }
    } catch (error) {
      hideLoader();
      console.error('Error buscando bus para nuevo ticket:', error);
      showNotification('error', 'Error', 'No se pudo buscar el bus');
    }
  });
  
  document.getElementById('btnCreateTicket')?.addEventListener('click', () => {
    const ppuField = document.getElementById('newTicketPPU');
    const busId = ppuField?.dataset?.busId;
    const terminal = ppuField?.dataset?.terminal || APP_STATE.session.terminal;
    const ppu = ppuField?.value.trim();
    const component = document.getElementById('newTicketComponent')?.value;
    const description = document.getElementById('newTicketDescription')?.value;
    const priority = document.getElementById('newTicketPriority')?.value;
    
    if (!busId) {
      showNotification('warning', 'Advertencia', 'Por favor, busque y seleccione un bus v√°lido');
      return;
    }
    
    if (!component) {
      showNotification('warning', 'Advertencia', 'Por favor, seleccione un componente');
      return;
    }
    
    if (!description) {
      showNotification('warning', 'Advertencia', 'Por favor, ingrese una descripci√≥n del problema');
      return;
    }
    
    const ticketData = {
      bus_id: busId,
      terminal: terminal,
      origen: 'manual',
      componente: component,
      descripcion_falla: description,
      prioridad: priority,
      estado: 'open',
      ppu: ppu
    };
    
    createTicket(ticketData);
  });
  
  document.getElementById('btnCancelNewTicket')?.addEventListener('click', () => {
    const newTicketModal = document.getElementById('newTicketModal');
    if (newTicketModal) {
      hideModal(newTicketModal);
    }
  });
  
  // 11. Export reports
  document.getElementById('btnExportCameras')?.addEventListener('click', () => {
    exportTableToXLSX('Informe_Camaras_' + APP_STATE.session.week, 
                     ['#', 'PPU', 'TERMINAL', 'ASIGNACI√ìN', 'MODELO CHASIS', 'MARCA', 'A√ëO', 
                      'MONITOR C√ÅMARA', 'C√ÅMARA DELANTERA', 'C√ÅMARA CABINA', 'C√ÅMARAS INTERIORES', 
                      'C√ÅMARA TRASERA', 'OBSERVACIONES'], 
                     'camerasTable');
  });
  
  document.getElementById('btnExportTag')?.addEventListener('click', () => {
    exportTableToXLSX('Informe_TAG_' + APP_STATE.session.week, 
                     ['#', 'PPU', 'TAG', 'SERIE TAG', 'OBSERVACIONES'], 
                     'tagTable');
  });
  
  document.getElementById('btnExportExtinguishers')?.addEventListener('click', () => {
    exportTableToXLSX('Informe_Extintores_' + APP_STATE.session.week, 
                     ['#', 'PPU', 'UBICACI√ìN', 'FECHA VENCIMIENTO', 'ESTADO EXTINTOR', 'ESTADO CERTIFICACI√ìN', 'ESTADO SONDA', 'ESTADO MAN√ìMETRO', 'PRESI√ìN / CARGA', 'CILINDRO', 'ESTADO PORTA EXTINTOR'], 
                     'extinguisherTable');
  });
  
  document.getElementById('btnExportMobileye')?.addEventListener('click', () => {
    exportTableToXLSX('Informe_Mobileye_' + APP_STATE.session.week,
                     ['PPU', 'MODELO', 'MARCA', 'A√ëO', 'TERMINAL', 'TIPO', 'ALERTA IZQUIERDA', 
                      'ALERTA DERECHA', 'CONSOLA', 'SENSOR FRONTAL', 'SENSOR IZQUIERDO', 
                      'SENSOR DERECHO', 'SENSOR TRASERO IZQUIERDO', 'SENSOR TRASERO DERECHO', 
                      'FECHA INCIDENTE', 'N¬∫ INCIDENTE'], 
                     'mobileyeTable');
  });
  
  document.getElementById('btnExportOdometer')?.addEventListener('click', () => {
    exportTableToXLSX('Informe_Odometro_' + APP_STATE.session.week, 
                     ['#', 'PPU', 'TERMINAL', 'ASIGNACI√ìN', 'MODELO CHASIS', 'MARCA', 'A√ëO', 
                      'LECTURA OD√ìMETRO (KM)', 'ESTADO OD√ìMETRO', 'OBSERVACIONES'], 
                     'odometerTable');
  });
  
  document.getElementById('btnExportAdvertising')?.addEventListener('click', () => {
    exportTableToXLSX('Informe_Publicidad_' + APP_STATE.session.week,
                     ['#', 'PPU', 'TERMINAL',
                      'ESTADO IZQ', 'PUBLICIDAD IZQ', 'DA√ëO IZQ', 'RESIDUOS IZQ', 'OBSERVACIONES IZQ',
                      'ESTADO DER', 'PUBLICIDAD DER', 'DA√ëO DER', 'RESIDUOS DER', 'OBSERVACIONES DER',
                      'ESTADO LUNETA', 'PUBLICIDAD LUNETA', 'DA√ëO LUNETA', 'RESIDUOS LUNETA', 'OBSERVACIONES LUNETA'],
                     'advertisingTable');
  });
  
  document.getElementById('btnExportTickets')?.addEventListener('click', () => {
    exportTableToXLSX('Tickets_Mantenimiento', 
                     ['#', 'PPU', 'TERMINAL', 'COMPONENTE', 'DESCRIPCI√ìN', 'PRIORIDAD', 
                      'ESTADO', 'FECHA CREACI√ìN', 'FECHA ACTUALIZACI√ìN', 'RESOLUCI√ìN'], 
                     'ticketsTable');
  });
  
  document.getElementById('btnExportFleet')?.addEventListener('click', () => {
    exportTableToXLSX('Estado_Flota', 
                     ['PPU', 'N¬∫ INTERNO', 'MARCA/MODELO', 'A√ëO', 'TERMINAL', 
                      '√öLTIMA INSPECCI√ìN', 'ESTADO', 'OD√ìMETRO', 'TICKETS ABIERTOS'], 
                     'fleetStatusTable');
  });
  
  // 12. User settings
  document.getElementById('btnSaveSettings')?.addEventListener('click', saveUserSettings);
  document.getElementById('btnResetSettings')?.addEventListener('click', resetUserSettings);
  
  // 13. Modal close handlers
  document.querySelectorAll('.modal-close, #loginModalClose, #pendingModalClose, #busStatusModalClose, #ticketDetailsModalClose, #newTicketModalClose').forEach(btn => {
    btn.addEventListener('click', () => {
      const modal = btn.closest('.modal');
      if (modal) {
        hideModal(modal);
      }
    });
  });
  
  document.getElementById('btnClosePending')?.addEventListener('click', () => {
    const pendingModal = document.getElementById('pendingModal');
    if (pendingModal) {
      hideModal(pendingModal);
    }
  });

  // Session detail modal controls
  const sessionDetailModal = document.getElementById('sessionDetailModal');
  const closeSessionDetail = () => {
    if (sessionDetailModal) hideModal(sessionDetailModal);
  };
  document.getElementById('sessionDetailClose')?.addEventListener('click', closeSessionDetail);
  document.getElementById('sessionDetailDismiss')?.addEventListener('click', closeSessionDetail);
  
  // 14. Close modals when clicking outside
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', event => {
      if (event.target === modal) {
        hideModal(modal);
      }
    });
  });
  
  // 15. Mobile navigation toggle
  document.getElementById('sidebarToggle')?.addEventListener('click', () => {
    const sidebar = document.getElementById('sidebar');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const toggleIcon = document.querySelector('.toggle-icon');
    
    if (sidebar && modalBackdrop && toggleIcon) {
      sidebar.classList.toggle('show');
      modalBackdrop.classList.toggle('show');
      toggleIcon.classList.toggle('toggle-active');
    }
  });
  
  // Log initial activity if logged in
  if (APP_STATE.session.inspector && APP_STATE.session.terminal) {
    logActivity({
      type: 'login',
      inspector: APP_STATE.session.inspector,
      terminal: APP_STATE.session.terminal
    });
  }
});

// Make functions available globally for event handlers
window.editTicket = openTicketDetails;
window.showNotification = showNotification;
window.showSection = showSection;
      
        
        
        
</script>
</body>
</html>
